
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="li-xiaoçš„ä¸ªäººç½‘ç«™">
      
      
        <meta name="author" content="li-xiao">
      
      
        <link rel="canonical" href="https://melodylx666.github.io/lx-bigdata/LANG/JUC-SUC/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../DS-leetcode/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>JUC-SUC - lx-bigdata</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#juc-suc" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="é¡µçœ‰">
    <a href="../.." title="lx-bigdata" class="md-header__button md-logo" aria-label="lx-bigdata" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            lx-bigdata
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              JUC-SUC
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="orange"  aria-label="åˆ‡æ¢è‡³å¤œé—´æ¨¡å¼"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="åˆ‡æ¢è‡³å¤œé—´æ¨¡å¼" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="orange"  aria-label="åˆ‡æ¢è‡³æ—¥é—´æ¨¡å¼"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="åˆ‡æ¢è‡³æ—¥é—´æ¨¡å¼" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="æŸ¥æ‰¾">
        
        <button type="reset" class="md-search__icon md-icon" title="æ¸…ç©ºå½“å‰å†…å®¹" aria-label="æ¸…ç©ºå½“å‰å†…å®¹" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/melodylx666/lx-bigdata" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    lx-bigdata
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="æ ‡ç­¾" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../TEST/" class="md-tabs__link">
          
  
    
  
  è€ƒè¯•

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Project/" class="md-tabs__link">
          
  
    
  
  é£æ§é¡¹ç›®

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  è¯­è¨€åŸºç¡€

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="å¯¼èˆªæ " data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="lx-bigdata" class="md-nav__button md-logo" aria-label="lx-bigdata" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    lx-bigdata
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/melodylx666/lx-bigdata" title="å‰å¾€ä»“åº“" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    lx-bigdata
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../TEST/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    è€ƒè¯•
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            è€ƒè¯•
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/javaweb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    javaweb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    æ•°å­—å›¾åƒå¤„ç†
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/blockchain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    blockchain
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../TEST/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    è½¯ä»¶å·¥ç¨‹
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Project/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    é£æ§é¡¹ç›®
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            é£æ§é¡¹ç›®
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/dynamic-Cep/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    åŠ¨æ€CEPå®ç°
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/econ-rule-engine/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    é‡‘èé£æ§å¼•æ“
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Project/AbstractStreamOperatorDesign/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    è‡ªå®šä¹‰StreamOperator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    è¯­è¨€åŸºç¡€
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            è¯­è¨€åŸºç¡€
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    JUC-SUC
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    JUC-SUC
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘ç®€ä»‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘ç®€ä»‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 çº¿ç¨‹çš„åˆ›å»º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2å¹¶å‘åŸºç¡€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2 . çº¿ç¨‹å®‰å…¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 . çº¿ç¨‹å®‰å…¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 çº¿ç¨‹å®‰å…¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 åŸå­æ€§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 å†…ç½®é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 ä½¿ç”¨é”æ¥ä¿æŠ¤çŠ¶æ€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3 .å¯¹è±¡çš„å…±äº«
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 .å¯¹è±¡çš„å…±äº«">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 å¯è§æ€§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 å‘å¸ƒå’Œé€¸å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 çº¿ç¨‹å°é—­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 ä¸å¯å˜å¯¹è±¡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4 .å¯¹è±¡çš„ç»„åˆ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 .å¯¹è±¡çš„ç»„åˆ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 è®¾è®¡çº¿ç¨‹å®‰å…¨çš„ç±»
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 å®ä¾‹å°é—­ï¼š
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DS-leetcode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    æ•°æ®ç»“æ„ä¸ç®—æ³•
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      å¹¶å‘ç®€ä»‹
    </span>
  </a>
  
    <nav class="md-nav" aria-label="å¹¶å‘ç®€ä»‹">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 çº¿ç¨‹çš„åˆ›å»º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      1.2å¹¶å‘åŸºç¡€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2 . çº¿ç¨‹å®‰å…¨
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 . çº¿ç¨‹å®‰å…¨">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 çº¿ç¨‹å®‰å…¨
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 åŸå­æ€§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 å†…ç½®é”
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 ä½¿ç”¨é”æ¥ä¿æŠ¤çŠ¶æ€
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      3 .å¯¹è±¡çš„å…±äº«
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 .å¯¹è±¡çš„å…±äº«">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 å¯è§æ€§
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 å‘å¸ƒå’Œé€¸å‡º
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 çº¿ç¨‹å°é—­
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 ä¸å¯å˜å¯¹è±¡
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4 .å¯¹è±¡çš„ç»„åˆ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 .å¯¹è±¡çš„ç»„åˆ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 è®¾è®¡çº¿ç¨‹å®‰å…¨çš„ç±»
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 å®ä¾‹å°é—­ï¼š
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/melodylx666/lx-bigdata/edit/main/docs/LANG/JUC-SUC.md" title="ç¼–è¾‘æ­¤é¡µ" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="juc-suc">JUC-SUC<a class="headerlink" href="#juc-suc" title="Permanent link">&para;</a></h1>
<blockquote>
<p>éƒ¨åˆ†ç›®å½•ç¼ºå¤±</p>
</blockquote>
<h2 id="_1">å¹¶å‘ç®€ä»‹<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 çº¿ç¨‹çš„åˆ›å»º<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<ol>
<li>åˆ›å»ºæ–¹æ³•ï¼š</li>
<li>ç»§æ‰¿Threadç±»ï¼š<ol>
<li>ç»§æ‰¿Threadç±»ï¼Œå¹¶é‡å†™run()æ–¹æ³•ï¼Œrunå°±æ˜¯æ–°çº¿ç¨‹è¦æ‰§è¡Œçš„äº‹æƒ…ã€‚</li>
<li>åˆ›å»ºThreadå­ç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨start()æ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1">package com.atguigu.thread;
</span><span id="__span-0-2">
</span><span id="__span-0-3">//è‡ªå®šä¹‰çº¿ç¨‹ç±»
</span><span id="__span-0-4">public class MyThread extends Thread {
</span><span id="__span-0-5">     //å®šä¹‰æŒ‡å®šçº¿ç¨‹åç§°çš„æ„é€ æ–¹æ³•
</span><span id="__span-0-6">     public MyThread(String name) {
</span><span id="__span-0-7">         //è°ƒç”¨çˆ¶ç±»çš„ String å‚æ•°çš„æ„é€ æ–¹æ³•ï¼ŒæŒ‡å®šçº¿ç¨‹çš„åç§°
</span><span id="__span-0-8">         super(name);
</span><span id="__span-0-9">     }
</span><span id="__span-0-10">     /**
</span><span id="__span-0-11">     * é‡å†™ run æ–¹æ³•ï¼Œå®Œæˆè¯¥çº¿ç¨‹æ‰§è¡Œçš„é€»è¾‘
</span><span id="__span-0-12">     */
</span><span id="__span-0-13">     @Override
</span><span id="__span-0-14">     public void run() {
</span><span id="__span-0-15">         for (int i = 0; i &lt; 10; i++) {
</span><span id="__span-0-16">         System.out.println(getName()+&quot;ï¼šæ­£åœ¨æ‰§è¡Œï¼&quot;+i);
</span><span id="__span-0-17">         }
</span><span id="__span-0-18">     }
</span><span id="__span-0-19">}
</span><span id="__span-0-20">
</span><span id="__span-0-21">//æµ‹è¯•ç±»
</span><span id="__span-0-22">package com.atguigu.thread;
</span><span id="__span-0-23">public class TestMyThread {
</span><span id="__span-0-24"> public static void main(String[] args) {
</span><span id="__span-0-25">     //åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹å¯¹è±¡ 1
</span><span id="__span-0-26">     MyThread mt1 = new MyThread(&quot;å­çº¿ç¨‹ 1&quot;);
</span><span id="__span-0-27">     //å¼€å¯å­çº¿ç¨‹ 1
</span><span id="__span-0-28">     mt1.start();
</span><span id="__span-0-29">
</span><span id="__span-0-30">     //åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹å¯¹è±¡ 2
</span><span id="__span-0-31">     MyThread mt2 = new MyThread(&quot;å­çº¿ç¨‹ 2&quot;);
</span><span id="__span-0-32">     //å¼€å¯å­çº¿ç¨‹ 2
</span><span id="__span-0-33">     mt2.start();
</span><span id="__span-0-34">
</span><span id="__span-0-35">     //åœ¨ä¸»æ–¹æ³•ä¸­æ‰§è¡Œ for å¾ªç¯
</span><span id="__span-0-36">     for (int i = 0; i &lt; 10; i++) {
</span><span id="__span-0-37">         System.out.println(&quot;main çº¿ç¨‹ï¼&quot;+i);
</span><span id="__span-0-38">     }
</span><span id="__span-0-39"> }
</span><span id="__span-0-40">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®ç°Runnableæ¥å£ï¼š</li>
<li>èƒŒæ™¯ï¼šJavaæœ‰å•ç»§æ‰¿é™åˆ¶ï¼Œå½“æ— æ³•ç»§æ‰¿Threadç±»çš„æ—¶å€™ï¼Œå¯ä»¥å®ç°Runnableæ¥å£</li>
<li>æ­¥éª¤ï¼š<ol>
<li>å®ç°Runnableæ¥å£ï¼Œå¹¶é‡å†™runæ–¹æ³•ï¼Œè¯¥runæ–¹æ³•å°±æ˜¯çº¿ç¨‹çš„æ‰§è¡Œä½“ã€‚</li>
<li>åˆ›å»ºRunnableæ¥å£å®ç°ç±»çš„å®ä¾‹ï¼Œå¹¶ä½œä¸ºtargetå‚æ•°ä¼ äººThreadç±»çš„å®ä¾‹(çº¿ç¨‹å¯¹è±¡)</li>
<li>å¯åŠ¨çº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•</li>
</ol>
</li>
</ol>
<p><strong>ğŸ“Œ</strong></p>
<p>çº¿ç¨‹å¯¹è±¡ä¸€ç›´éƒ½æ˜¯Threadå¯¹è±¡ã€‚</p>
<ol>
<li>å¦‚æœå¯ä»¥ç›´æ¥ç»§æ‰¿ï¼Œå¹¶é‡å†™runæ–¹æ³•ï¼Œå°±å¯ä»¥ç›´æ¥æä¾›çº¿ç¨‹æ‰§è¡Œä½“</li>
<li>å¦‚æœä¸å¯ä»¥ç»§æ‰¿Threadï¼Œå°±éœ€ç”¨ä¸€ä¸ªå®ç°Runnableæ¥å£çš„å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥Threadå¯¹è±¡ä¸­ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œä½“ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1">package com.atguigu.thread;
</span><span id="__span-1-2">public class MyRunnable implements Runnable {
</span><span id="__span-1-3">     @Override
</span><span id="__span-1-4">     public void run() {
</span><span id="__span-1-5">         for (int i = 0; i &lt; 20; i++) {
</span><span id="__span-1-6">             System.out.println(Thread.currentThread().getName() + &quot; &quot;
</span><span id="__span-1-7">            + i);
</span><span id="__span-1-8">         }
</span><span id="__span-1-9">     }
</span><span id="__span-1-10">}
</span><span id="__span-1-11">æµ‹è¯•ç±»ï¼š
</span><span id="__span-1-12">package com.atguigu.thread;
</span><span id="__span-1-13">public class TestMyRunnable {
</span><span id="__span-1-14">     public static void main(String[] args) {
</span><span id="__span-1-15">         //åˆ›å»ºè‡ªå®šä¹‰ç±»å¯¹è±¡ çº¿ç¨‹ä»»åŠ¡å¯¹è±¡
</span><span id="__span-1-16">         MyRunnable mr = new MyRunnable();
</span><span id="__span-1-17">         //åˆ›å»ºçº¿ç¨‹å¯¹è±¡
</span><span id="__span-1-18">         Thread t = new Thread(mr, &quot;é•¿æ±Ÿ&quot;);
</span><span id="__span-1-19">         t.start();
</span><span id="__span-1-20">         for (int i = 0; i &lt; 20; i++) {
</span><span id="__span-1-21">             System.out.println(&quot;é»„æ²³ &quot; + i);
</span><span id="__span-1-22">         }
</span><span id="__span-1-23">     }
</span><span id="__span-1-24">}
</span></code></pre></div></td></tr></table></div>
<h3 id="12">1.2å¹¶å‘åŸºç¡€<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<ol>
<li>æ“ä½œç³»ç»Ÿå¤šè¿›ç¨‹çš„åŸå› ï¼š</li>
<li>èµ„æºåˆ©ç”¨ç‡ï¼šé€šè¿‡è¿›ç¨‹åˆ‡æ¢æ¥é«˜æ•ˆåˆ©ç”¨CPU</li>
<li>å…¬å¹³æ€§ï¼šé€šè¿‡æ—¶é—´åˆ†ç‰‡ç­‰æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å…±äº«CPUï¼Œè€Œä¸æ˜¯ä»å¤´åˆ°å°¾çš„ä¸²è¡Œ</li>
<li>ä¾¿åˆ©æ€§(çº¿ç¨‹)ï¼š<ol>
<li>é€šè¿‡åœ¨è¿›ç¨‹ä¸­åŠ å…¥çº¿ç¨‹ï¼Œä½¿å¾—å•ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªç¨‹åºæ§åˆ¶æµã€‚å¤šä¸ªçº¿ç¨‹å…±äº«å †åŒºåŸŸå’Œä»£ç åŒºï¼Œä»¥åŠæ–‡ä»¶å¥æŸ„ç­‰èµ„æºï¼Œ</li>
<li>ä½†æ˜¯åˆæœ‰å„è‡ªçš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ ˆåŒºã€‚åŒä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹å®¢å¯ä»¥è¢«åŒæ—¶è°ƒåº¦åˆ°å¤šä¸ªCPUä¸Šæ‰§è¡Œã€‚</li>
<li>çº¿ç¨‹æ˜¯ç¨‹åºè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚</li>
</ol>
</li>
<li>å¤šçº¿ç¨‹çš„ä¼˜åŠ¿ï¼š</li>
<li>å‘æŒ¥å¤šå¤„ç†å™¨çš„æ€§èƒ½ï¼šç”±äºè°ƒåº¦çš„åŸºæœ¬å•ä½æ˜¯çº¿ç¨‹ï¼Œè€Œå¤šçº¿ç¨‹å°±å¯ä»¥åŒæ—¶è°ƒåº¦åœ¨å¤šä¸ªæ ¸ä¸Šã€‚å°±ç®—åªæœ‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¤šçº¿ç¨‹ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒIOçš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæé«˜CPUåˆ©ç”¨ç‡ï¼Œè€Œä¸æ˜¯ç­‰å¾…é˜»å¡çš„è¿”å›ã€‚</li>
<li>å»ºæ¨¡ç®€å•ï¼šå¯ä»¥ä¸ºæ¨¡å‹ä¸­æ¯æ¯ç§ä»»åŠ¡çš„éƒ½åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œå½¢æˆä¸²è¡Œæ‰§è¡Œçš„å‡è±¡ã€‚å¤šçº¿ç¨‹å¯ä»¥å°†å¤æ‚ä¸”å¼‚æ­¥çš„å·¥ä½œæµè¿›ä¸€æ­¥åˆ†è§£ä¸ºä¸€ç»„ç®€å•å¹¶ä¸”åŒæ­¥çš„å·¥ä½œæµï¼Œä¸åŒçš„å·¥ä½œæµåœ¨ç‰¹å®šä½ç½®äº¤äº’ã€‚</li>
<li>å¼‚æ­¥äº‹ä»¶çš„ç®€åŒ–å¤„ç†ï¼šæœåŠ¡å™¨ç¨‹åºåœ¨æ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯çš„Socketè¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœä¸ºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½åˆ†é…å•ç‹¬çš„çº¿ç¨‹å¹¶ä¸”ä½¿ç”¨åŒæ­¥IO,å°±ä¼šé™ä½å¼€å‘éš¾åº¦</li>
</ol>
<p><strong>ğŸ””</strong></p>
<p>åŒæ­¥å’Œå¼‚æ­¥(æ˜¯æ¶ˆæ¯çš„é€šçŸ¥æœºåˆ¶)ï¼š</p>
<p>åŒæ­¥IOï¼šåœ¨åŒæ­¥IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œå¿…é¡»ç­‰å¾…IOæ“ä½œå®Œæˆï¼Œæ‰å¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚</p>
<p>å¼‚æ­¥IOï¼šåœ¨å¼‚æ­¥IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚å½“IOå®Œæˆä¹‹åï¼Œä¼šé€šè¿‡æŸç§æ–¹å¼é€šçŸ¥(æ¯”å¦‚å›è°ƒå‡½æ•°)é€šçŸ¥è¿›ç¨‹ã€‚</p>
<p>é˜»å¡å’Œéé˜»å¡(æ˜¯ç¨‹åºåœ¨ç­‰å¾…æ¶ˆæ¯(æ— æ‰€è°“åŒæ­¥å¼‚æ­¥)æ—¶å€™çš„çŠ¶æ€)ï¼š</p>
<p>é˜»å¡IOï¼šåœ¨é˜»å¡IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘èµ·IOæ“ä½œï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ä¸ºæ­¢ã€‚</p>
<p>éé˜»å¡IOï¼šè¿›ç¨‹å‘å‡ºè¯·æ±‚ä¹‹åç«‹å³è¿”å›</p>
<p>å››è€…ä¹‹é—´æ²¡æœ‰ç»å¯¹å…³ç³»ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªé˜»å¡çš„å¼‚æ­¥IOæ¨¡å‹ï¼šè¿›ç¨‹å‘èµ·ä¸€ä¸ªIOæ“ä½œåï¼Œä¸éœ€è¦ç­‰å¾…IOæ“ä½œçš„å®Œæˆï¼Œä½†å¦‚æœæ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¿›ç¨‹å°±ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ä¸ºæ­¢ã€‚</p>
<p>åŒæ­¥/å¼‚æ­¥ä¸é˜»å¡/éé˜»å¡æ˜¯ä¸¤ç»„ä¸åŒçš„æ¦‚å¿µï¼Œå®ƒä»¬å¯ä»¥å…±å­˜ç»„åˆï¼Œè€Œå¾ˆå¤šäººä¹‹æ‰€ä»¥æŠŠåŒæ­¥å’Œé˜»å¡æ··æ·†ï¼Œæˆ‘æƒ³ä¹Ÿæ˜¯å› ä¸ºæ²¡æœ‰åŒºåˆ†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œæ¯”å¦‚åœ¨è¿›ç¨‹é˜»å¡çš„ read/write æ“ä½œä¸­ï¼Œå…¶å®æ˜¯æŠŠæ¶ˆæ¯é€šçŸ¥å’Œå¤„ç†æ¶ˆæ¯ç»“åˆåœ¨äº†ä¸€èµ·ï¼Œåœ¨è¿™é‡Œæ‰€å…³æ³¨çš„æ¶ˆæ¯å°±æ˜¯ fd æ˜¯å¦å¯è¯»/å†™ï¼Œè€Œå¤„ç†æ¶ˆæ¯åˆ™æ˜¯å¯¹ fd è¯»/å†™ï¼Œå½“æˆ‘ä»¬å°†è¿™ä¸ª fd è®¾ç½®ä¸ºéé˜»å¡çš„æ—¶å€™ï¼Œread/write æ“ä½œå°±ä¸ä¼šåœ¨ç­‰å¾…æ¶ˆæ¯é€šçŸ¥è¿™é‡Œé˜»å¡ï¼Œå¦‚æœ fd ä¸å¯è¯»/å†™åˆ™æ“ä½œç«‹å³è¿”å›ã€‚</p>
<ol>
<li>å¤šçº¿ç¨‹çš„é£é™©ï¼š</li>
<li>å®‰å…¨æ€§é—®é¢˜ï¼š<ol>
<li>æ¡ˆä¾‹ï¼šéçº¿ç¨‹å®‰å…¨çš„æ•°å€¼åºåˆ—ç”Ÿæˆå™¨ï¼š<ol>
<li>å¦‚ä¸‹é¢çš„æ–¹æ³•getNextï¼Œå…¶ä¸­valueæ˜¯æˆå‘˜å˜é‡è¿›ç¨‹å†…çº¿ç¨‹å…±äº«ã€‚</li>
<li>åœ¨å•çº¿ç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œæ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œvalue++çš„æ“ä½œå®é™…ä¸Šæ˜¯å†…å­˜-&gt;å¯„å­˜å™¨ï¼Œvalue+1ï¼Œå°†valueå†è¿”å›å†…å­˜åŒºåŸŸã€‚æ“ä½œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æƒ…å†µã€‚</li>
<li>è¯¥æ¡ˆä¾‹è¯´æ˜çš„æ˜¯å¸¸è§çš„ç«æ€æ¡ä»¶(race condition)ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸã€‚</li>
<li>æ”¹æ­£ï¼šä½¿ç”¨synchronizedå…³é”®å­—ï¼Œrace conditionéƒ¨åˆ†å®ç°é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢äº¤æ›¿æ‰§è¡Œçš„æƒ…å†µå‘ç”Ÿã€‚</li>
</ol>
</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"># éçº¿ç¨‹å®‰å…¨
</span><span id="__span-2-2">public class unsafeSequence {
</span><span id="__span-2-3">    private int value;
</span><span id="__span-2-4">
</span><span id="__span-2-5">    public int getNext() {
</span><span id="__span-2-6">        return value++;
</span><span id="__span-2-7">    }
</span><span id="__span-2-8">}
</span><span id="__span-2-9">
</span><span id="__span-2-10">#ä¿®æ­£ï¼çº¿ç¨‹å®‰å…¨ï¼š
</span><span id="__span-2-11">@ThreadSafe
</span><span id="__span-2-12">public class Sequence {
</span><span id="__span-2-13">    private int value;
</span><span id="__span-2-14">    public synchronized int getNext(){
</span><span id="__span-2-15">        return value++;
</span><span id="__span-2-16">    }
</span><span id="__span-2-17">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®‰å…¨æ€§é—®é¢˜ï¼š</li>
<li>æ— é™å¾ªç¯ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚</li>
<li>æ­»é”ï¼Œé¥¥é¥¿ï¼Œæ´»é”</li>
<li>æ€§èƒ½é—®é¢˜ï¼š</li>
<li>ä¸Šä¸‹æ–‡åˆ‡æ¢å¼•å‘çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—ç¨‹åºä¸¢å¤±å±€éƒ¨æ€§ï¼Œå¹¶ä¸”CPUèŠ±è´¹è¿‡å¤šæ—¶é—´åœ¨è°ƒåº¦ä¸Šã€‚</li>
<li>åŒæ­¥æœºåˆ¶ï¼Œå¯èƒ½ä¼šé˜»æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚</li>
</ol>
<h2 id="2">2 . çº¿ç¨‹å®‰å…¨<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 çº¿ç¨‹å®‰å…¨<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<ol>
<li>å½“å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯å˜å˜é‡çš„æ—¶å€™ï¼Œå¤„ç†æ–¹æ³•ï¼š</li>
<li>ä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«è¯¥å˜é‡</li>
<li>å°†å˜é‡æ”¹ä¸ºä¸å¯å˜ç±»å‹</li>
<li>åœ¨è®¿é—®çŠ¶æ€å˜é‡çš„æ—¶å€™ä½¿ç”¨åŒæ­¥å˜é‡</li>
<li>çº¿ç¨‹å®‰å…¨æ€§ï¼š</li>
<li>å®šä¹‰ï¼šæŸä¸ªç±»çš„è¡Œä¸ºä¸å…¶è§„èŒƒå®Œå…¨ä¸€è‡´ã€‚è‰¯å¥½çš„è§„èŒƒåŒ…æ‹¬å„ç§ä¸å˜æ¡ä»¶æ¥çº¦æŸå¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥åŠå®šä¹‰å„ç§åéªŒæ¡ä»¶æ¥æè¿°å¯¹è±¡æ“ä½œçš„ç»“æœã€‚å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»çš„æ—¶å€™ï¼Œè¯¥ç±»å§‹ç»ˆå¯ä»¥è¡¨ç°æ­£ç¡®çš„è¡Œä¸ºï¼Œè€Œä¸”ä¸»è°ƒå‡½æ•°ä¸ç”¨ä½¿ç”¨é¢å¤–çš„åŒæ­¥æˆ–è€…åè°ƒï¼Œè¯¥ç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚</li>
<li>ä¾‹å­ï¼š</li>
<li>Servlet:Servletï¼ˆServer Appletï¼‰æ˜¯Java Servletçš„ç®€ç§°ï¼Œç§°ä¸ºå°æœåŠ¡ç¨‹åºæˆ–æœåŠ¡è¿æ¥å™¨ï¼Œæ³›æŒ‡ç”¨ <strong>Javaç¼–å†™çš„æœåŠ¡å™¨ç«¯ç¨‹åº</strong>ã€‚åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­ä¹ŸæŒ‡ä¸€åˆ‡ <strong>å®ç°äº†Servletæ¥å£çš„ç±»</strong>ï¼ˆçº¦å®šä»¥Servletç»“å°¾å‘½åï¼‰ã€‚</li>
<li>ä¸‹é¢çš„Servletä»è¯·æ±‚ä¸­æå–å‡ºæ•°å€¼ï¼Œè¿›è¡Œå› å¼åˆ†è§£ï¼Œç„¶åå°†æ•°æ®å°è£…è¿›å…¥è¯¥Servletçš„ç›¸åº”ä¸­ã€‚</li>
<li>å®‰å…¨æ€§ï¼šç”±äºè¯¥ç±»æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒæ—¢ä¸åŒ…å«ä»»ä½•æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸åŒ…å«å¯¹å…¶ä»–ç±»çš„æˆå‘˜å˜é‡çš„å¼•ç”¨ã€‚è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€åªå­˜åœ¨äºçº¿ç¨‹æ ˆä¸Šçš„å±€éƒ¨å˜é‡ä¸­ï¼Œè€Œçº¿ç¨‹æ ˆæ˜¯ç§æœ‰çš„ã€‚ä¸ä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹ä¹‹é—´æœ‰å…±äº«çš„çŠ¶æ€ã€‚æ‰€ä»¥çº¿ç¨‹è®¿é—®æ— çŠ¶æ€å¯¹è±¡å¹¶ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>æ— çŠ¶æ€å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1">public class StatelessFactorizer extends GenericServlet implements Servlet {
</span><span id="__span-3-2">
</span><span id="__span-3-3">    public void service(ServletRequest req, ServletResponse resp) {
</span><span id="__span-3-4">        BigInteger i = extractFromRequest(req);
</span><span id="__span-3-5">        BigInteger[] factors = factor(i);
</span><span id="__span-3-6">        encodeIntoResponse(resp, factors);
</span><span id="__span-3-7">    }
</span><span id="__span-3-8">
</span><span id="__span-3-9">    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
</span><span id="__span-3-10">    }
</span><span id="__span-3-11">
</span><span id="__span-3-12">    BigInteger extractFromRequest(ServletRequest req) {
</span><span id="__span-3-13">        return new BigInteger(&quot;7&quot;);
</span><span id="__span-3-14">    }
</span><span id="__span-3-15">
</span><span id="__span-3-16">    BigInteger[] factor(BigInteger i) {
</span><span id="__span-3-17">        // Doesn&#39;t really factor
</span><span id="__span-3-18">        return new BigInteger[] { i };
</span><span id="__span-3-19">    }
</span><span id="__span-3-20">}
</span></code></pre></div></td></tr></table></div>
<h3 id="22">2.2 åŸå­æ€§<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<ol>
<li>å‡è®¾åœ¨æ— çŠ¶æ€å¯¹è±¡ä¸­å¢åŠ ä¸€ä¸ªçŠ¶æ€</li>
<li>ä¸‹è¿°ä¾‹å­ä¸­ï¼Œå¢åŠ ä¸€ä¸ªå‘½ä¸­è®¡æ•°å™¨çš„æˆå‘˜å±æ€§æ¥ç»Ÿè®¡è¯·æ±‚æ¬¡æ•°ã€‚</li>
<li>ç”±äºæ“ä½œä¸æ˜¯åŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼Œå¹¶ä¸”ä¾èµ–äºä¹‹å‰çš„çŠ¶æ€</li>
<li>è¯¥æƒ…å†µç§°ä¸ºç«æ€æ¡ä»¶ã€‚</li>
</ol>
<p><strong>ğŸ‘‹</strong></p>
<p>æœ€å¸¸è§çš„ç«æ€æ¡ä»¶ï¼šå…ˆæ£€æŸ¥åæ‰§è¡Œ</p>
<p>æœ¬è´¨æ˜¯å…ˆè§‚å¯Ÿåˆ°æŸä¸ªæ¡ä»¶ï¼Œç„¶ååŸºäºè§‚å¯Ÿçš„ç»“æœè¿›è¡Œç›¸åº”çš„åŠ¨ä½œã€‚ä½†æ˜¯å®é™…ä¸Šåœ¨è§‚å¯Ÿåˆ°é‡‡å–åŠ¨ä½œä¹‹é—´ï¼Œä¹‹å‰çš„è§‚å¯Ÿç»“æœå¯èƒ½å·²ç»æ— æ•ˆï¼Œä»è€Œä¼šå¯¼è‡´å„ç§é—®é¢˜ã€‚</p>
<p>ç«æ€æ¡ä»¶å¹¶ä¸ç­‰äºæ•°æ®ç«äº‰ï¼</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1">public class UnsafeCountingFactorizer extends GenericServlet implements Servlet {
</span><span id="__span-4-2">    private long count = 0;
</span><span id="__span-4-3">
</span><span id="__span-4-4">    public long getCount() {
</span><span id="__span-4-5">        return count;
</span><span id="__span-4-6">    }
</span><span id="__span-4-7">
</span><span id="__span-4-8">    public void service(ServletRequest req, ServletResponse resp) {
</span><span id="__span-4-9">        BigInteger i = extractFromRequest(req);
</span><span id="__span-4-10">        BigInteger[] factors = factor(i);
</span><span id="__span-4-11">        //è¯¥æ“ä½œå¹¶éåŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªè¯»å–-ä¿®æ”¹-å†™å…¥çš„æ“ä½œåºåˆ—ã€‚
</span><span id="__span-4-12">        ++count;
</span><span id="__span-4-13">        encodeIntoResponse(resp, factors);
</span><span id="__span-4-14">    }
</span><span id="__span-4-15">
</span><span id="__span-4-16">    void encodeIntoResponse(ServletResponse res, BigInteger[] factors) {
</span><span id="__span-4-17">    }
</span><span id="__span-4-18">
</span><span id="__span-4-19">    BigInteger extractFromRequest(ServletRequest req) {
</span><span id="__span-4-20">        return new BigInteger(&quot;7&quot;);
</span><span id="__span-4-21">    }
</span><span id="__span-4-22">
</span><span id="__span-4-23">    BigInteger[] factor(BigInteger i) {
</span><span id="__span-4-24">        // Doesn&#39;t really factor
</span><span id="__span-4-25">        return new BigInteger[] { i };
</span><span id="__span-4-26">    }
</span><span id="__span-4-27">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å…¸å‹æƒ…å†µï¼šå»¶è¿Ÿåˆå§‹åŒ–</li>
<li>æ“ä½œæœ¬æ„ï¼šå°†å¯¹è±¡çš„åˆå§‹åŒ–å»¶è¿Ÿåˆ°å®é™…è¢«ä½¿ç”¨çš„æ—¶å€™ã€‚</li>
<li>ç«æ€æ¡ä»¶ï¼š<ol>
<li>Açœ‹åˆ°instanceä¸ºnullï¼Œå› æ­¤åˆ›å»ºäº†ExpensiveObjectå®ä¾‹ã€‚</li>
<li>å¦‚æœå½“Aæ­£åœ¨è¿›è¡Œåˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œæ­¤æ—¶Bçº¿ç¨‹è¿›å…¥ï¼Œåˆ¤æ–­instanceä»ç„¶ä¸ºç©ºï¼Œä¹Ÿè¿›è¡Œåˆ›å»ºå¯¹è±¡ã€‚</li>
<li>åˆ™ä¸¤æ¬¡è°ƒç”¨getInstanceæ–¹æ³•è¿”å›çš„å…¶å®æ˜¯ä¸¤æ¬¡newçš„ç¤ºä¾‹ï¼Œè€Œä¸æ˜¯å•ä¾‹æ¨¡å¼ã€‚å¦‚æœè¯¥ç±»è¢«ç”¨äºæ³¨å†Œä¿¡æ¯ç­‰åœºæ™¯ï¼Œå¿…ç„¶ä¼šå¯¼è‡´ä¿¡æ¯ä¸¢å¤±ã€‚
  4.</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1">public class LazyInitRace {
</span><span id="__span-5-2">    private ExpensiveObject instance = null;
</span><span id="__span-5-3">
</span><span id="__span-5-4">    public ExpensiveObject getInstance() {
</span><span id="__span-5-5">        if (instance == null)
</span><span id="__span-5-6">            instance = new ExpensiveObject();
</span><span id="__span-5-7">        return instance;
</span><span id="__span-5-8">    }
</span><span id="__span-5-9">}
</span><span id="__span-5-10">
</span><span id="__span-5-11">class ExpensiveObject { }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ä¸Šè¿°çš„ä¸¤ç§æƒ…å†µéƒ½å±äºå¤åˆæ“ä½œ(éåŸå­)æ“ä½œå¯¼è‡´çš„ç«æ€æ¡ä»¶ã€‚</li>
<li>è§£å†³åŠæ³•ï¼š</li>
<li>é€šè¿‡å®‰å…¨ç±»æ¥ç®¡ç†å‘æ— çŠ¶æ€ç±»ä¸­å¼•å…¥çš„çŠ¶æ€ï¼Œæ­¤æ—¶ä»ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ol>
<p>å¼•å…¥çº¿ç¨‹å®‰å…¨ç±»:AtomicLongæ¥ç®¡ç†è®¡æ•°å™¨çš„çŠ¶æ€ã€‚</p>
<p>ä½†æ˜¯å½“çŠ¶æ€å˜é‡çš„æ•°é‡ä¸å†æ˜¯ä¸€ä¸ªçš„æ—¶å€™ï¼Œå°±ä¸å†é€‚ç”¨ï¼Œå› ä¸ºæ— æ³•ä¿è¯å¤šä¸ªå˜é‡ä¹‹é—´çš„çº¦æŸå¯ä»¥åŒæ­¥å‘ç”Ÿå˜åŒ–ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1">public class CountingFactorizer extends GenericServlet implements Servlet {
</span><span id="__span-6-2">    private final AtomicLong count = new AtomicLong(0);
</span><span id="__span-6-3">
</span><span id="__span-6-4">    public long getCount() { return count.get(); }
</span><span id="__span-6-5">
</span><span id="__span-6-6">    public void service(ServletRequest req, ServletResponse resp) {
</span><span id="__span-6-7">        BigInteger i = extractFromRequest(req);
</span><span id="__span-6-8">        BigInteger[] factors = factor(i);
</span><span id="__span-6-9">        count.incrementAndGet();
</span><span id="__span-6-10">        encodeIntoResponse(resp, factors);
</span><span id="__span-6-11">    }
</span><span id="__span-6-12">
</span><span id="__span-6-13">    void encodeIntoResponse(ServletResponse res, BigInteger[] factors) {}
</span><span id="__span-6-14">    BigInteger extractFromRequest(ServletRequest req) {return null; }
</span><span id="__span-6-15">    BigInteger[] factor(BigInteger i) { return null; }
</span><span id="__span-6-16">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>é€šè¿‡åŠ é”æœºåˆ¶ï¼Œæ¥ä¿è¯åŸå­æ€§ã€‚</li>
</ol>
<h3 id="23">2.3 å†…ç½®é”<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<ol>
<li>åŒæ­¥ä»£ç å—ï¼š</li>
<li>ç»„æˆï¼š<ol>
<li>é”çš„å¯¹è±¡å¼•ç”¨ï¼šä¸€èˆ¬æ˜¯æ–¹æ³•è°ƒç”¨æ‰€åœ¨çš„å¯¹è±¡ã€‚é™æ€çš„synchronizedæ–¹æ³•ä»¥Classå¯¹è±¡ä½œä¸ºé”ã€‚</li>
<li>ç”±è¯¥é”ä¿æŠ¤çš„ä»£ç å—</li>
</ol>
</li>
<li>Javaçš„å†…ç½®é”ï¼Œæ˜¯ä¸€ç§äº’æ–¥é”ï¼ŒåŒæ—¶æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥é”ã€‚</li>
<li>ä¾‹å­ï¼šä¸‹é¢çš„ç±»é€šè¿‡ä½¿ç”¨å†…ç½®é”ï¼Œå®ç°äº†åŒæ­¥æœºåˆ¶ã€‚ä½†æ˜¯åŒæ—¶å¹¶å‘åº¦å¤§å¤§é™ä½ï¼Œä½¿å¾—æ€§èƒ½éš¾ä»¥æ¥å—</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1">public class SynchronizedFactorizer extends GenericServlet implements Servlet {
</span><span id="__span-7-2">    @GuardedBy(&quot;this&quot;) private BigInteger lastNumber;
</span><span id="__span-7-3">    @GuardedBy(&quot;this&quot;) private BigInteger[] lastFactors;
</span><span id="__span-7-4">
</span><span id="__span-7-5">    public synchronized void service(ServletRequest req,
</span><span id="__span-7-6">                                     ServletResponse resp) {
</span><span id="__span-7-7">        BigInteger i = extractFromRequest(req);
</span><span id="__span-7-8">        if (i.equals(lastNumber))
</span><span id="__span-7-9">            encodeIntoResponse(resp, lastFactors);
</span><span id="__span-7-10">        else {
</span><span id="__span-7-11">            BigInteger[] factors = factor(i);
</span><span id="__span-7-12">            lastNumber = i;
</span><span id="__span-7-13">            lastFactors = factors;
</span><span id="__span-7-14">            encodeIntoResponse(resp, factors);
</span><span id="__span-7-15">        }
</span><span id="__span-7-16">    }
</span><span id="__span-7-17">
</span><span id="__span-7-18">    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
</span><span id="__span-7-19">    }
</span><span id="__span-7-20">
</span><span id="__span-7-21">    BigInteger extractFromRequest(ServletRequest req) {
</span><span id="__span-7-22">        return new BigInteger(&quot;7&quot;);
</span><span id="__span-7-23">    }
</span><span id="__span-7-24">
</span><span id="__span-7-25">    BigInteger[] factor(BigInteger i) {
</span><span id="__span-7-26">        // Doesn&#39;t really factor
</span><span id="__span-7-27">        return new BigInteger[] { i };
</span><span id="__span-7-28">    }
</span><span id="__span-7-29">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>é‡å…¥ï¼š</li>
<li>èƒŒæ™¯ï¼šå½“æŸä¸ªçº¿ç¨‹è¯·æ±‚ä¸€ä¸ªç”±å…¶ä»–çº¿ç¨‹æŒæœ‰çš„é”çš„æ—¶å€™ï¼Œå‘å‡ºè¯·æ±‚çš„çº¿ç¨‹å°±ä¼šé˜»å¡ã€‚ä½†æ˜¯ç”±äºå†…ç½®é”æ˜¯å¯ä»¥é‡å…¥çš„ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹è·å–å®ƒè‡ªå·±æŒæœ‰çš„é”ï¼Œåˆ™ä¼šæˆåŠŸã€‚</li>
<li>é‡å…¥çš„æ„ä¹‰ï¼šæ„å‘³ç€è·å–é”çš„æ“ä½œçš„ç²’åº¦æ˜¯çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è°ƒç”¨ã€‚è€Œpthreadé‡Œé¢äº’æ–¥é”çš„è·å–æ“ä½œæ˜¯ä»¥è°ƒç”¨ä¸ºç²’åº¦çš„ã€‚</li>
<li>å®ç°æ–¹æ³•ï¼š<ol>
<li>ä¸ºæ¯ä¸ªé”å…³è”ä¸€ä¸ªè·å–è®¡æ•°å€¼ï¼Œä»¥åŠæ‰€æœ‰è€…çº¿ç¨‹ã€‚</li>
<li>å½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œè¯¥é”å°±è¢«è®¤ä¸ºæ˜¯æ²¡æœ‰è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ã€‚</li>
<li>å½“çº¿ç¨‹è¯·æ±‚ä¸€ä¸ªæœªè¢«æŒæœ‰çš„é”çš„æ—¶å€™ï¼ŒJVMå°±ä¼šå°†è¯¥çº¿ç¨‹æ ‡è®°ä¸ºè¯¥é”çš„æ‰€æœ‰è€…çº¿ç¨‹ï¼Œå¹¶å°†è·å–è®¡æ•°å€¼è®¾ç½®ä¸º1ã€‚å¦‚æœåŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å¾—è¯¥é”ï¼Œåˆ™å°†è®¡æ•°å€¼é€’å¢ã€‚å½“çº¿ç¨‹é€€å‡ºåŒæ­¥ä»£ç å—çš„æ—¶å€™ï¼Œè®¡æ•°å™¨ä¼šé€’å‡ï¼Œå½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œé”è¢«é‡Šæ”¾ã€‚</li>
</ol>
</li>
<li>ä¾‹å­ï¼š</li>
<li>å­ç±»é‡å†™äº†çˆ¶ç±»çš„synchronizedæ–¹æ³•ï¼Œç„¶åè°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•ã€‚</li>
</ol>
<p><strong>ğŸ””</strong></p>
<p>å­ç±»ä¸­çš„superå’Œthiså±…ç„¶æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œè€Œä¸”çˆ¶ç±»çš„thisä¹Ÿæ˜¯ã€‚æ‰€ä»¥æ‰ä¼šè¯´é”ä½çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯superæœ¬èº«ä»ç„¶æ˜¯å­ç±»çš„å¼•ç”¨ï¼Œåªä¸è¿‡å®ƒå¯ä»¥è°ƒç”¨åˆ°çˆ¶ç±»çš„æ–¹æ³•æˆ–å˜é‡ã€‚</p>
<ol>
<li>å¦‚æœæ²¡æœ‰å¯é‡å…¥çš„é”ï¼Œåˆ™è¯¥ä»£ç ä¼šäº§ç”Ÿæ­»é”</li>
<li>å­ç±»åœ¨è¿›å…¥doSomethingæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè·å¾—Wightçš„é”ã€‚ä½†æ˜¯åœ¨å…¶ä¸­ï¼Œå¦‚æœåœ¨è°ƒç”¨superçš„æ—¶å€™ï¼Œæ²¡æœ‰å¯é‡å…¥çš„é”ï¼Œåˆ™ä¼šé™·å…¥æ­»é”(å› ä¸ºè°ƒç”¨superæ—¶å€™ä¹Ÿè·å–çš„æ˜¯Wightçš„é”).</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1">public class  LoggingWidget extends Widget{
</span><span id="__span-8-2">    @Override
</span><span id="__span-8-3">    public synchronized void doSomething(){
</span><span id="__span-8-4">        System.out.println(&quot;calling to doSomething&quot;);
</span><span id="__span-8-5">        super.doSomething();
</span><span id="__span-8-6">    }
</span><span id="__span-8-7">}
</span><span id="__span-8-8">
</span><span id="__span-8-9">class Widget{
</span><span id="__span-8-10">    public synchronized void doSomething(){
</span><span id="__span-8-11">
</span><span id="__span-8-12">    }
</span><span id="__span-8-13">}
</span></code></pre></div></td></tr></table></div>
<h3 id="24">2.4 ä½¿ç”¨é”æ¥ä¿æŠ¤çŠ¶æ€<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>å¯¹è±¡çš„å†…ç½®é”å’ŒçŠ¶æ€å˜é‡çš„å…³ç³»ï¼š</p>
</li>
<li>
<p>å¯¹è±¡çš„å†…ç½®é”ç”±å¯¹è±¡å†³å®šã€‚</p>
</li>
<li>å¯¹è±¡çš„æˆå‘˜å±æ€§å¹¶ä¸æ˜¯åªèƒ½é å¯¹è±¡çš„å†…ç½®é”æ¥é™åˆ¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–é”æ¥é™åˆ¶</li>
<li>çº¿ç¨‹åœ¨è·å¾—æŸä¸ªé”çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½é˜»æ­¢å…¶ä»–çº¿ç¨‹è·å–å…¶ä»–çš„é”ã€‚</li>
<li>å»ºè®®ï¼šæ¯ä¸ªå…±äº«ä¸å¯å˜å˜é‡åªé€šè¿‡ä¸€ä¸ªé”æ¥ä¿æŠ¤ã€‚</li>
<li>å¸¸è§çº¦å®šï¼š</li>
<li>å°†æ‰€æœ‰å¯å˜çŠ¶æ€å°è£…åœ¨å¯¹è±¡å†…éƒ¨ï¼Œé€šè¿‡å¯¹è±¡çš„å†…ç½®é”æ¥å¯¹æ‰€æœ‰è®¿é—®å¯å˜çŠ¶æ€çš„è·¯å¾„è¿›è¡ŒåŒæ­¥ã€‚</li>
<li>å¤šä¸ªåŒæ­¥æ–¹æ³•çš„ç»„åˆå¹¶ä¸ä¸€å®šæ˜¯åŸå­çš„</li>
<li>å°½å¯èƒ½å¯¹è¾ƒçŸ­çš„ä»£ç å—è¿›è¡ŒåŠ é”ï¼Œé™ä½æ€§èƒ½å½±å“ã€‚</li>
<li>å½“è¿›è¡Œè¾ƒé•¿æ—¶é—´è®¡ç®—ï¼Œæˆ–è€…è¿›è¡ŒIOçš„æ—¶å€™ï¼Œä¸è¦æŒæœ‰é”ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1">public class CachedFactorizer extends GenericServlet implements Servlet {
</span><span id="__span-9-2">     private BigInteger lastNumber;
</span><span id="__span-9-3">     private BigInteger[] lastFactors;
</span><span id="__span-9-4">     private long hits;
</span><span id="__span-9-5">     private long cacheHits;
</span><span id="__span-9-6">
</span><span id="__span-9-7">    public synchronized long getHits() {
</span><span id="__span-9-8">        return hits;
</span><span id="__span-9-9">    }
</span><span id="__span-9-10">
</span><span id="__span-9-11">    public synchronized double getCacheHitRatio() {
</span><span id="__span-9-12">        return (double) cacheHits / (double) hits;
</span><span id="__span-9-13">    }
</span><span id="__span-9-14">
</span><span id="__span-9-15">    public void service(ServletRequest req, ServletResponse resp) {
</span><span id="__span-9-16">        BigInteger i = extractFromRequest(req);
</span><span id="__span-9-17">        BigInteger[] factors = null;
</span><span id="__span-9-18">        synchronized (this) {
</span><span id="__span-9-19">            ++hits;
</span><span id="__span-9-20">            if (i.equals(lastNumber)) {
</span><span id="__span-9-21">                ++cacheHits;
</span><span id="__span-9-22">                factors = lastFactors.clone();
</span><span id="__span-9-23">            }
</span><span id="__span-9-24">        }
</span><span id="__span-9-25">        if (factors == null) {
</span><span id="__span-9-26">            factors = factor(i);
</span><span id="__span-9-27">            synchronized (this) {
</span><span id="__span-9-28">                lastNumber = i;
</span><span id="__span-9-29">                lastFactors = factors.clone();
</span><span id="__span-9-30">            }
</span><span id="__span-9-31">        }
</span><span id="__span-9-32">        encodeIntoResponse(resp, factors);
</span><span id="__span-9-33">    }
</span><span id="__span-9-34">
</span><span id="__span-9-35">    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
</span><span id="__span-9-36">    }
</span><span id="__span-9-37">
</span><span id="__span-9-38">    BigInteger extractFromRequest(ServletRequest req) {
</span><span id="__span-9-39">        return new BigInteger(&quot;7&quot;);
</span><span id="__span-9-40">    }
</span><span id="__span-9-41">
</span><span id="__span-9-42">    BigInteger[] factor(BigInteger i) {
</span><span id="__span-9-43">        // Doesn&#39;t really factor
</span><span id="__span-9-44">        return new BigInteger[]{i};
</span><span id="__span-9-45">    }
</span><span id="__span-9-46">}
</span></code></pre></div></td></tr></table></div>
<h2 id="3">3 .å¯¹è±¡çš„å…±äº«<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 å¯è§æ€§<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<ol>
<li>èƒŒæ™¯ï¼šå¹¶å‘ç¼–ç¨‹çš„å®ç°ï¼Œä¸ä»…åœ¨äºå¯¹äºå…±äº«å˜é‡çš„å¯å˜çŠ¶æ€è¿›è¡Œæ­£å¸¸ç®¡ç†ï¼ŒåŒæ—¶ï¼Œä¹Ÿéœ€è¦å¯¹å†…å­˜å¯è§æ€§è¿›è¡Œç®¡ç†ï¼Œé˜²æ­¢æ›´æ–°ä½†æ˜¯æ²¡æœ‰åŒæ­¥æ‰€å¯¼è‡´çš„é”™è¯¯</li>
<li>ä¾‹å­ï¼š</li>
<li>ä¸‹é¢çš„ä»£ç è¯´æ˜äº†å½“å¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å…±äº«æ•°æ®æ—¶å€™å‡ºç°çš„é”™è¯¯ã€‚</li>
<li>åœ¨ä»£ç ä¸­ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹éƒ½ä¼šè¯»å–å…±äº«å˜é‡numberå’Œreadyã€‚</li>
<li>ä¸»çº¿ç¨‹å¯åŠ¨readerçº¿ç¨‹ä¹‹åï¼Œå°†number=42,ready=trueã€‚æ­£å¸¸æƒ…å†µä¸‹readerçº¿ç¨‹ä¼šç­‰åˆ°readyçº¿ç¨‹ä¸ºtrueä¹‹åï¼Œè¾“å‡ºnumberçš„å€¼ï¼Œæ­£å¸¸æ˜¯è¾“å‡º42</li>
<li>ä»£ç å¯èƒ½ä¼šä¸€å€¼æŒç»­å¾ªç¯ä¸‹å»ï¼Œå› ä¸ºreaderçº¿ç¨‹å¯èƒ½æ°¸è¿œéƒ½çœ‹ä¸åˆ°readyå€¼ã€‚ä¸€ç§æ›´å¥‡æ€ªçš„ç°è±¡æ˜¯ï¼Œä»£ç è¾“å‡ºä¸º0ã€‚å› ä¸ºreaderçº¿ç¨‹å¯èƒ½ä¼šçœ‹åˆ°å†™å…¥çš„readyå€¼ï¼Œä½†æ˜¯æ²¡æœ‰çœ‹åˆ°å†™å…¥çš„numberçš„å€¼ï¼Œç§°ä¸ºé‡æ’åº(reordering)ã€‚å½“ä¸»çº¿ç¨‹é¦–å…ˆå†™å…¥numberï¼Œåœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å†™å…¥readyï¼Œé‚£ä¹ˆreadyçº¿ç¨‹çœ‹åˆ°çš„æ•°æ®å¯èƒ½ä¸å†™å…¥çš„æ•°æ®å®Œå…¨ç›¸åã€‚</li>
</ol>
<p><strong>ğŸ‘‹</strong></p>
<p>ç»“è®ºï¼šåªè¦çº¿ç¨‹ä¹‹é—´æœ‰æ•°æ®äº¤æ¢ï¼Œå°±è¿›è¡ŒåŒæ­¥</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1">public class NoVisibility {
</span><span id="__span-10-2">    private static boolean ready;
</span><span id="__span-10-3">    private static int number;
</span><span id="__span-10-4">
</span><span id="__span-10-5">    private static class ReaderThread extends Thread {
</span><span id="__span-10-6">        public void run() {
</span><span id="__span-10-7">            while (!ready)
</span><span id="__span-10-8">                Thread.yield();
</span><span id="__span-10-9">            System.out.println(number);
</span><span id="__span-10-10">        }
</span><span id="__span-10-11">    }
</span><span id="__span-10-12">
</span><span id="__span-10-13">    public static void main(String[] args) {
</span><span id="__span-10-14">        new ReaderThread().start();
</span><span id="__span-10-15">        number = 42;
</span><span id="__span-10-16">        ready = true;
</span><span id="__span-10-17">    }
</span><span id="__span-10-18">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¤±æ•ˆçš„æ•°æ®ï¼š</li>
<li>ä¾‹å­ï¼š<ol>
<li>å¯¹äºå¦‚ä¸‹è¿™ä¸ªå…±äº«å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†setï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†getï¼Œåˆ™è¯¥çº¿ç¨‹çš„getä¸ä¸€å®šä¼šçœ‹åˆ°è¢«æ›´æ–°çš„valueå€¼ã€‚</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1">public class MutableInteger {
</span><span id="__span-11-2">    private int value;
</span><span id="__span-11-3">
</span><span id="__span-11-4">    public int get(){
</span><span id="__span-11-5">        return value;
</span><span id="__span-11-6">    }
</span><span id="__span-11-7">
</span><span id="__span-11-8">    public void set(int value){
</span><span id="__span-11-9">        this.value=value;
</span><span id="__span-11-10">    }
</span><span id="__span-11-11">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ä¿®æ”¹ä¹‹åçš„çº¿ç¨‹å®‰å…¨ç±»ï¼š</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1">public class SynchronizedInteger {
</span><span id="__span-12-2">
</span><span id="__span-12-3">    private int value;
</span><span id="__span-12-4">
</span><span id="__span-12-5">    public synchronized int get() {
</span><span id="__span-12-6">        return value;
</span><span id="__span-12-7">    }
</span><span id="__span-12-8">
</span><span id="__span-12-9">    public synchronized void set(int value) {
</span><span id="__span-12-10">        this.value = value;
</span><span id="__span-12-11">    }
</span><span id="__span-12-12">
</span><span id="__span-12-13">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>éåŸå­æ“ä½œçš„64ä½æ“ä½œ</p>
</li>
<li>
<p>æœ€ä½å®‰å…¨æ€§ï¼šå½“çº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªå¤±æ•ˆå€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼è‚¯å®šæ˜¯ç”±æŸä¸ªçº¿ç¨‹è®¾ç½®çš„å€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªéšæœºå€¼ã€‚</p>
</li>
<li>évolatileç±»å‹çš„64ä½æ•°å€¼å˜é‡(double,long)ã€‚JVMå¯¹äºè¿™ä¸ªç±»å‹å˜é‡çš„è¯»å†™ï¼Œå…è®¸ä¸¤ä¸ª32ä½æ“ä½œã€‚å½“è¯»å–ä¸€ä¸ªévolatileç±»å‹çš„longå˜é‡çš„æ—¶å€™ï¼Œå¦‚æœå¯¹è¯¥å˜é‡çš„è¯»å†™æ“ä½œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½è¯»å–åˆ°ä¸€ä¸ªå€¼çš„é«˜32ä½å’Œä¸€ä¸ªå€¼çš„ä½32ä½ã€‚å› æ­¤ï¼Œlongå’Œdoubleç±»å‹çš„å˜é‡éœ€è¦ä½¿ç”¨volatileå˜é‡æ¥å£°æ˜ä»–ä»¬ï¼Œæˆ–è€…ç”¨é”ä¿æŠ¤ã€‚</li>
<li>åŠ é”å’Œå¯è§æ€§</li>
<li>å¦‚æœçº¿ç¨‹Aå…ˆlock Mï¼Œå†æ‰§è¡Œä»£ç å—ï¼Œå†unlock M,ã€‚è€ŒBçº¿ç¨‹ç´§æ¥ç€lock Mï¼Œæ­¤æ—¶Bçº¿ç¨‹æ‰§è¡Œçš„ä»£ç å—ä¸€å®šå¯ä»¥çœ‹è§Aåœ¨å…¶ä»£ç å—çš„æ‰€æœ‰æ“ä½œç»“æœã€‚å¦‚æœæ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œåˆ™æ— æ³•ä¿è¯</li>
<li>åŠ é”å¯ä»¥ä¿è¯äº’æ–¥æ€§ï¼ŒåŒæ—¶å¯ä»¥ä¿è¯å†…å­˜å¯è§æ€§ã€‚</li>
<li>volatileå˜é‡ï¼š</li>
<li>ä½œç”¨ï¼šæ¥ç¡®ä¿å°†å˜é‡çš„æ›´æ–°æ“ä½œé€šçŸ¥åˆ°å…¶ä»–çº¿ç¨‹ã€‚volatileç±»å‹çš„å˜é‡ç¼–è¯‘å™¨åœ¨è¿è¡Œçš„æ—¶å€™ä¼šæ³¨æ„åˆ°è¯¥å˜é‡æ˜¯å…±äº«çš„ã€‚å°±ä¸ä¼šå°†å…¶å’Œå…¶ä»–æ“ä½œè¿›è¡Œé‡æ’åºã€‚åœ¨è¯»å–volatileå˜é‡çš„æ—¶å€™ï¼Œè¿”å›çš„æ€»æ˜¯æœ€æ–°å†™å…¥çš„å€¼ã€‚</li>
<li>å¯ä»¥å°†volatileçœ‹åšSynchronizedInteger,ä½†æ˜¯æ›´è½»é‡çº§(ä¸ä¼šåŠ é”)</li>
<li>volatileå˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§</li>
<li>ä½¿ç”¨èŒƒå›´ï¼š</li>
<li>ç¡®ä¿å˜é‡è‡ªèº«çš„å¯è§æ€§</li>
<li>ç¡®ä¿æ‰€å¼•ç”¨å¯¹è±¡çš„å¯è§æ€§</li>
<li>æ ‡è¯†é‡è¦çš„ç¨‹åºç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å‘ç”Ÿï¼Œå¸¸ç”¨æ¥åšflag</li>
<li>ä½¿ç”¨æ¡ä»¶ï¼š</li>
<li>å¯¹å˜é‡çš„å†™å…¥æ“ä½œä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼</li>
<li>è¯¥å˜é‡ä¸ä¼šå’Œå…¶ä»–çŠ¶æ€å˜é‡ä¸€èµ·çº³å…¥ä¸å˜æ€§æ¡ä»¶ä¸­</li>
<li>åœ¨è®¿é—®å¯¹è±¡çš„æ—¶å€™ä¸éœ€è¦åŠ é”</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1">//å…¸å‹ä¾‹å­
</span><span id="__span-13-2">//æ£€æŸ¥æŸä¸ªçŠ¶æ€æ ‡è®°ä»¥åˆ¤æ–­æ˜¯å¦é€€å‡ºå¾ªç¯(ç”¨é”ä¹Ÿå¯ä»¥)
</span><span id="__span-13-3">//å¦‚æœä¸æ˜¯volatileç±»å‹ï¼Œåˆ™å¦‚æœasleepè¢«ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½çœ‹ä¸åˆ°
</span><span id="__span-13-4">volatile boolean asleep;
</span><span id="__span-13-5">
</span><span id="__span-13-6">    while(!asleep){
</span><span id="__span-13-7">        countSomeSleep();
</span><span id="__span-13-8">    }
</span></code></pre></div></td></tr></table></div>
<h3 id="32">3.2 å‘å¸ƒå’Œé€¸å‡º<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>å‘å¸ƒ(publish)ï¼š</p>
</li>
<li>
<p>å®šä¹‰ï¼šå‘å¸ƒä¸€ä¸ªå¯¹è±¡æ˜¯æŒ‡ä½¿å¾—å¯¹è±¡åœ¨å½“å‰ä½œç”¨åŸŸä¹‹å¤–çš„ä»£ç ä¸­ä½¿ç”¨ã€‚</p>
</li>
<li>ä¾‹å­ï¼š<ol>
<li>å°†ä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°å…¶ä»–ä»£ç å¯ä»¥è®¿é—®çš„åœ°æ–¹ã€‚</li>
<li>æˆ–è€…æ˜¯æŸä¸€ä¸ªç§æœ‰æ–¹æ³•ä¸­è¿”å›è¯¥å¼•ç”¨ã€‚</li>
<li>æˆ–è€…æ˜¯å°†å¼•ç”¨ä¼ é€’åˆ°å…¶ä»–ç±»çš„æ–¹æ³•ä¸­ã€‚</li>
</ol>
</li>
<li>é€¸å‡º(escape)ï¼š</li>
<li>å®šä¹‰ï¼šæŸäº›ä¸è¯¥è¢«publishçš„å¯¹è±¡è¢«å‘å¸ƒ</li>
<li>ä¾‹å­ï¼š</li>
<li>ç ´åå°è£…æ€§ï¼špublishå†…éƒ¨çŠ¶æ€</li>
<li>ç ´åçº¿ç¨‹å®‰å…¨æ€§ï¼šåœ¨å¯¹è±¡åˆ›å»ºä¹‹å‰å°±è¿”å›å¼•ç”¨</li>
<li>å‘å¸ƒä¸€ä¸ªå¯¹è±¡ï¼š</li>
<li>æœ€å¸¸è§çš„æ–¹æ³•ï¼šå°†å¯¹è±¡çš„å¼•ç”¨å®šä¹‰ä¸ºpublic staticã€‚åˆ™ä»»ä½•ç±»å’Œçº¿ç¨‹éƒ½å¯ä»¥çœ‹è§è¯¥å¯¹è±¡å¼•ç”¨ã€‚</li>
<li>å½“å‘å¸ƒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¯èƒ½ä¼šé—´æ¥å‘å¸ƒå…¶ä»–å¯¹è±¡(æ¯”å¦‚é›†åˆä¸­åŒ…å«çš„å…¶ä»–å¯¹è±¡)ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1">public static Set&lt;Secret&gt; knownSecrets;
</span><span id="__span-14-2">
</span><span id="__span-14-3">public void init(){
</span><span id="__span-14-4">    knownSecrets = new HashSet&lt;Secret&gt;();
</span><span id="__span-14-5">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>é€¸å‡ºï¼š</li>
<li>å¦‚ä¸‹ä»£ç å°†å†…éƒ¨çŠ¶æ€(ç§æœ‰å˜é‡)çš„å¼•ç”¨é€¸å‡ºã€‚</li>
<li>åˆ™stateså·²ç»é€¸å‡ºå…¶ä½œç”¨åŸŸ</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1">public class UnsafeStates {
</span><span id="__span-15-2">    private String[] states = new String[]{&quot;hello&quot;};
</span><span id="__span-15-3">
</span><span id="__span-15-4">    public String[] getStates(){
</span><span id="__span-15-5">        return states;
</span><span id="__span-15-6">    }
</span><span id="__span-15-7">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¦‚ä¸‹ï¼šå½“ThisEscapeåœ¨è¿›è¡Œå‘å¸ƒå†…éƒ¨ç±»EventListenerçš„æ—¶å€™ï¼Œä¹Ÿéšå«åœ°å‘å¸ƒäº†ThisEscapeå®ä¾‹æœ¬èº«ã€‚è¿™æ ·ä¼šä½¿å¾—thiså¼•ç”¨é€¸å‡ºã€‚è¿™æ˜¯å› ä¸ºä»å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­å°±è¿”å›å¯¹è±¡çš„å¼•ç”¨(this),è¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚</li>
<li>å¸¸è§é”™è¯¯æƒ…å†µï¼šåœ¨æ„é€ å‡½æ•°ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚åˆ™æ­¤æ—¶thiså¼•ç”¨éƒ½ä¼šè¢«æ–°åˆ›å»ºçš„çº¿ç¨‹å…±äº«ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1">public class ThisEscape {
</span><span id="__span-16-2">    public ThisEscape(EventSource source) {
</span><span id="__span-16-3">        //å‘å¸ƒå†…éƒ¨ç±»ï¼Œå°†å…¶ä¼ å…¥åˆ°sourceå®ä¾‹çš„æ–¹æ³•ä¸­
</span><span id="__span-16-4">        source.registerListener(new EventListener() {
</span><span id="__span-16-5">            public void onEvent(Event e) {
</span><span id="__span-16-6">                doSomething(e);
</span><span id="__span-16-7">            }
</span><span id="__span-16-8">        });
</span><span id="__span-16-9">    }
</span><span id="__span-16-10">
</span><span id="__span-16-11">    void doSomething(Event e) {
</span><span id="__span-16-12">    }
</span><span id="__span-16-13">
</span><span id="__span-16-14">
</span><span id="__span-16-15">    interface EventSource {
</span><span id="__span-16-16">        void registerListener(EventListener e);
</span><span id="__span-16-17">    }
</span><span id="__span-16-18">
</span><span id="__span-16-19">    interface EventListener {
</span><span id="__span-16-20">        void onEvent(Event e);
</span><span id="__span-16-21">    }
</span><span id="__span-16-22">
</span><span id="__span-16-23">    interface Event {
</span><span id="__span-16-24">    }
</span><span id="__span-16-25">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¯ä»¥é€šè¿‡ä½¿ç”¨ç§æœ‰æ„é€ å™¨+å…¬å…±å·¥å‚æ–¹æ³•æ¥é˜²æ­¢thiså¼•ç”¨åœ¨æ„é€ è¿‡ç¨‹ä¸­é€¸å‡º</li>
<li>åŸç†ï¼šåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»ï¼Œå¹¶å°†å†…éƒ¨ç±»å‘å¸ƒå‡ºå»ï¼Œè¿™ä¸¤è€…ä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚</li>
<li>åŠæ³•ï¼š<ol>
<li>é¦–å…ˆç§æœ‰æ„é€ å™¨ï¼Œåœ¨å…¶ä¸­åˆ›å»ºå†…éƒ¨ç±»</li>
<li>ç„¶åé€šè¿‡å…¬å…±çš„å·¥å‚æ–¹æ³•æ¥å‘å¸ƒ å†…éƒ¨ç±»</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1">public class SafeListener {
</span><span id="__span-17-2">    private final EventListener listener;
</span><span id="__span-17-3">
</span><span id="__span-17-4">    //ç§æœ‰æ„é€ å™¨
</span><span id="__span-17-5">    private SafeListener() {
</span><span id="__span-17-6">        listener = new EventListener() {
</span><span id="__span-17-7">            public void onEvent(Event e) {
</span><span id="__span-17-8">                doSomething(e);
</span><span id="__span-17-9">            }
</span><span id="__span-17-10">        };
</span><span id="__span-17-11">    }
</span><span id="__span-17-12">    //å…¬å…±çš„å·¥å‚æ–¹æ³•
</span><span id="__span-17-13">    public static SafeListener newInstance(EventSource source) {
</span><span id="__span-17-14">        SafeListener safe = new SafeListener();
</span><span id="__span-17-15">        //å‘å¸ƒå†…éƒ¨ç±»
</span><span id="__span-17-16">        source.registerListener(safe.listener);
</span><span id="__span-17-17">        return safe;
</span><span id="__span-17-18">    }
</span><span id="__span-17-19">
</span><span id="__span-17-20">    void doSomething(Event e) {
</span><span id="__span-17-21">    }
</span><span id="__span-17-22">
</span><span id="__span-17-23">
</span><span id="__span-17-24">    interface EventSource {
</span><span id="__span-17-25">        void registerListener(EventListener e);
</span><span id="__span-17-26">    }
</span><span id="__span-17-27">
</span><span id="__span-17-28">    interface EventListener {
</span><span id="__span-17-29">        void onEvent(Event e);
</span><span id="__span-17-30">    }
</span><span id="__span-17-31">
</span><span id="__span-17-32">    interface Event {
</span><span id="__span-17-33">    }
</span><span id="__span-17-34">}
</span></code></pre></div></td></tr></table></div>
<h3 id="33">3.3 çº¿ç¨‹å°é—­<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<ol>
<li>å®šä¹‰ï¼šä¸€ç§é¿å…åŒæ­¥çš„æ–¹æ³•å°±æ˜¯ä¸å…±äº«æ•°æ®ï¼Œåªåœ¨å•çº¿ç¨‹ä¸­è®¿é—®æ•°æ®ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å°é—­ã€‚å®ƒæ˜¯å®ç°çº¿ç¨‹å®‰å…¨æ€§çš„æœ€ç®€å•çš„ä¸€ç§æ–¹å¼ã€‚</li>
<li>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
</li>
<li>
<p>Swingï¼šSwingä¸­çš„å¯è§†åŒ–ç»„ä»¶å’Œæ•°æ®æ¨¡å‹å¯¹è±¡éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚Swingå°†ä»–ä»¬å°é—­åœ¨Swingçš„äº‹ä»¶åˆ†å‘çº¿ç¨‹ä¸­è®¿é—®ï¼Œæ¥å®ç°çº¿ç¨‹å®‰å…¨æ€§ã€‚åœ¨é™¤äº†äº‹ä»¶çº¿ç¨‹ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹å°±ä¸èƒ½è®¿é—®è¿™äº›å¯¹è±¡ï¼Œå¦åˆ™å¯èƒ½å‡ºé”™</p>
</li>
<li>JDBCï¼šJDBCä¸­çš„Connectionå¯¹è±¡ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤§å¤šæ•°è¯·æ±‚éƒ½æ˜¯ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”åœ¨Connectionå¯¹è±¡è¿”å›ä¹‹å‰ï¼Œä¸ä¼šå°†å®ƒåˆ†é…ç»™å…¶ä»–çº¿ç¨‹ã€‚</li>
<li>Javaè‡ªå¸¦çš„çº¿ç¨‹å°é—­ï¼š</li>
<li>å±€éƒ¨å˜é‡ï¼šå› ä¸ºå±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹ç§æœ‰æ ˆä¸­ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯çº¿ç¨‹å°é—­çš„ã€‚</li>
<li>ThreadLocalç±»</li>
<li>å…·ä½“åˆ†ç±»ï¼š</li>
<li>ad-hocçº¿ç¨‹å°é—­ï¼š</li>
<li>å®šä¹‰ï¼šç»´æŠ¤çº¿ç¨‹å°é—­æ€§çš„èŒè´£å®Œå…¨ç”±ç¨‹åºæ¥æ‰¿æ‹…ï¼Œä¸ä½¿ç”¨ä»»ä½•çš„è¯­è¨€ç‰¹æ€§ã€‚</li>
<li>å¦‚æœå¯ä»¥ç¡®ä¿åªæœ‰å•ä¸ªçº¿ç¨‹å¯¹å…±äº«çš„volatileå˜é‡æ‰§è¡Œå†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå°†volatileå˜é‡è¿›è¡Œäº†çº¿ç¨‹å°é—­ã€‚è€Œä¸”è¿˜èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–è¯¥å˜é‡çš„å€¼ã€‚</li>
<li>æ ˆå°é—­ï¼š</li>
<li>å®šä¹‰ï¼šåœ¨æ ˆå°é—­ä¸­ï¼Œåªæœ‰é€šè¿‡å±€éƒ¨å˜é‡æ‰å¯è®¿é—®å¯¹è±¡ã€‚å› ä¸ºä¿å­˜åœ¨çº¿ç¨‹ç§æœ‰çš„æ ˆä¸­ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚</li>
<li>ä¾‹å­ï¼š</li>
<li>ä¸‹é¢çš„æ–¹æ³•ä¸­ï¼Œå¯¹äºTreeSetå¯¹è±¡çš„å¼•ç”¨ï¼Œåªæœ‰ä¸€ä¸ªanimalså±€éƒ¨å˜é‡ã€‚è¿™å°±ä¿è¯äº†å®ƒä¸ä¼šè¢«å‘å¸ƒã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1">   public int loadTheArk(Collection&lt;Animal&gt; candidates) {
</span><span id="__span-18-2">        SortedSet&lt;Animal&gt; animals;
</span><span id="__span-18-3">        int numPairs = 0;
</span><span id="__span-18-4">        Animal candidate = null;
</span><span id="__span-18-5">
</span><span id="__span-18-6">        // animals confined to method, don&#39;t let them escape!
</span><span id="__span-18-7">        animals = new TreeSet&lt;Animal&gt;(new SpeciesGenderComparator());
</span><span id="__span-18-8">        animals.addAll(candidates);
</span><span id="__span-18-9">        for (Animal a : animals) {
</span><span id="__span-18-10">            if (candidate == null || !candidate.isPotentialMate(a))
</span><span id="__span-18-11">                candidate = a;
</span><span id="__span-18-12">            else {
</span><span id="__span-18-13">                ark.load(new AnimalPair(candidate, a));
</span><span id="__span-18-14">                ++numPairs;
</span><span id="__span-18-15">                candidate = null;
</span><span id="__span-18-16">            }
</span><span id="__span-18-17">        }
</span><span id="__span-18-18">        return numPairs;
</span><span id="__span-18-19">    }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ThreadLocalç±»ï¼š</li>
<li>ä½œç”¨ï¼šThreadLocalå¯¹è±¡é€šå¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹å¯¹è±¡æˆ–è€…å…¨å±€å˜é‡è¿›è¡Œå…±äº«æ“ä½œã€‚</li>
<li>æ–¹æ³•ï¼šgetå’Œsetæ–¹æ³•æ€»æ˜¯ä¸ºæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„å€¼éƒ½ä¿å­˜ä¸€ä»½ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå› æ­¤getæ–¹æ³•æ€»æ˜¯è¿”å›ç”±å½“å‰æ‰§è¡Œçº¿ç¨‹åœ¨è°ƒç”¨setçš„æ—¶å€™è®¾ç½®çš„å€¼</li>
<li>ä¾‹å­ï¼šä¸‹é¢ä¸­åœ¨å•çº¿ç¨‹ç¨‹åºä¸­åˆ›å»ºäº†å…¨å±€çš„æ•°æ®åº“è¿æ¥(DriverManager.getConnection).ç”±äºJDBCçš„Connectionå¯¹è±¡ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¦‚æœæœ‰å¤šçº¿ç¨‹ï¼Œå°±éœ€è¦å°†JDBCçš„è¿æ¥æ“ä½œä¿å­˜åˆ°ThreadLocalå¯¹è±¡ä¸­ã€‚åˆ™åœ¨è°ƒç”¨getæ–¹æ³•çš„æ—¶å€™ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè·å¾—å±äºè‡ªå·±çš„è¿æ¥ã€‚</li>
<li>ä¾‹å­ï¼šå½“æŸä¸ªé¢‘ç¹çš„æ“ä½œéœ€è¦ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œæ¯”å¦‚ç¼“å†²åŒºçš„æ—¶å€™ï¼Œè€Œåˆå¸Œæœ›é¿å…æ¯æ¬¡éƒ½é‡æ–°åˆ†é…è¯¥ä¸´æ—¶å¯¹è±¡ï¼Œåˆ™å°±å¯ä»¥ä½¿ç”¨ThreadLocalã€‚æ¯”å¦‚Integer.toString()ä¼šä½¿ç”¨ThreadLocalçš„ç¼“å†²åŒºã€‚</li>
<li>å½“æŸä¸ªçº¿ç¨‹åˆæ¬¡è°ƒç”¨ThreadLocal.getæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨initialValueæ–¹æ³•æ¥è·å–åˆå§‹å€¼ã€‚å¯ä»¥å°†ThreadLocal<Connection>çœ‹åšMap<Thread,Connection>ã€‚</li>
<li>å°†å•çº¿ç¨‹ç¨‹åºå˜æ¢ä¸ºå¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œé€šè¿‡å°†å…±äº«çš„å…¨å±€å˜é‡æ”¹ä¸ºThreadLocalï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1">public class ConnectionDispenser {
</span><span id="__span-19-2">    static String DB_URL = &quot;jdbc:mysql://localhost/javalab&quot;;
</span><span id="__span-19-3">
</span><span id="__span-19-4">    private ThreadLocal&lt;Connection&gt; connectionHolder
</span><span id="__span-19-5">            = new ThreadLocal&lt;Connection&gt;() {
</span><span id="__span-19-6">        public Connection initialValue() {
</span><span id="__span-19-7">            try {
</span><span id="__span-19-8">                //å…¨å±€çš„æ•°æ®åº“è¿æ¥
</span><span id="__span-19-9">                return DriverManager.getConnection(DB_URL);
</span><span id="__span-19-10">            } catch (SQLException e) {
</span><span id="__span-19-11">                throw new RuntimeException(&quot;Unable to acquire Connection, e&quot;);
</span><span id="__span-19-12">            }
</span><span id="__span-19-13">        };
</span><span id="__span-19-14">    };
</span><span id="__span-19-15">
</span><span id="__span-19-16">    public Connection getConnection() {
</span><span id="__span-19-17">        return connectionHolder.get();
</span><span id="__span-19-18">    }
</span><span id="__span-19-19">}
</span></code></pre></div></td></tr></table></div>
<h3 id="34">3.4 ä¸å¯å˜å¯¹è±¡<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<ol>
<li>å®šä¹‰ï¼šæŸä¸ªå¯¹è±¡åœ¨åˆ›å»ºä¹‹åå°±ä¸èƒ½æ”¹å˜</li>
<li>çº¿ç¨‹å®‰å…¨ï¼šä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒä»¬çš„çŠ¶æ€åªèƒ½é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¹å˜ã€‚</li>
</ol>
<p><strong>ğŸ””</strong></p>
<p>ä¸å¯å˜å¯¹è±¡ä¸ç­‰äºæŠŠæ‰€æœ‰fieldéƒ½åŠ ä¸Šfinalã€‚å› ä¸ºfinalçš„å˜é‡å¯èƒ½ä¿å­˜çš„æ˜¯å¯å˜å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<ol>
<li>
<p>æ¡ä»¶ï¼š</p>
</li>
<li>
<p>å¯¹è±¡åˆ›å»ºä¹‹åå°±ä¸èƒ½ä¿®æ”¹</p>
</li>
<li>å¯¹è±¡çš„æ‰€æœ‰fieldéƒ½æ˜¯finalç±»å‹</li>
<li>å¯¹è±¡çš„åˆ›å»º(æ„é€ å‡½æ•°)æ²¡æœ‰thisé€¸å‡ºã€‚</li>
<li>final</li>
<li>å®šä¹‰ï¼šfinalå¯ä»¥è§†ä¸ºC++ä¸­çš„constæœºåˆ¶çš„å—é™åˆ¶ç‰ˆæœ¬ï¼Œç”¨äºæ„å»ºä¸å¯å˜å¯¹è±¡</li>
<li>æ€§è´¨ï¼š</li>
<li>finalç±»å‹çš„fieldæ˜¯ä¸å¯ä»¥è¢«ä¿®æ”¹çš„</li>
<li>finalå¯ä»¥ä¿è¯åˆå§‹åŒ–è¿‡ç¨‹çš„å®‰å…¨æ€§ï¼Œä»è€Œå¯ä»¥ä¸å—é™åˆ¶çš„è®¿é—®ä¸å¯å˜å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å…±äº«è¿™äº›å¯¹è±¡çš„æ—¶å€™æ— é¡»åŒæ­¥</li>
<li>é™¤ééœ€è¦æ›´é«˜å¯è§æ€§ï¼Œå¦åˆ™ä¸€èˆ¬å°†fieldå£°æ˜ä¸ºprivate. åŒæ ·ï¼Œå¦‚æœä¸éœ€è¦æ”¹å˜ï¼Œåˆ™ä¸€èˆ¬å°†fieldå£°æ˜ä¸ºfinal</li>
<li>ä½¿ç”¨Volatileæ¥å‘å¸ƒä¸å¯å˜å¯¹è±¡</li>
<li>æ­¥éª¤ï¼š</li>
<li>æ›´æ–°ç¼“å­˜çš„ç»“æœ</li>
<li>åˆ¤æ–­éœ€æ±‚æ˜¯å¦åœ¨ç¼“å­˜ä¸­</li>
<li>æ€§è´¨ï¼š</li>
<li>å½“è®¿é—®å’Œæ›´æ–°å¤šä¸ªå˜é‡çš„æ—¶å€™å‡ºç°äº†ç«äº‰æ¡ä»¶é—®é¢˜ï¼Œå°±å¯ä»¥é€šè¿‡å°†è¿™äº›å˜é‡å…¨éƒ¨ä¿å­˜åœ¨ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ä¸­æ¥æ¶ˆé™¤ï¼Œè€Œä¸æ˜¯åƒå¯å˜å¯¹è±¡ä¸€æ ·ä½¿ç”¨é”ã€‚</li>
<li>åˆ™è¯¥å˜é‡åœ¨èµ‹å€¼è¿‡åå°±ä¸èƒ½æ”¹å˜ã€‚</li>
<li>å½“ä½¿ç”¨volatileçš„æ—¶å€™ï¼Œåˆ™å¦‚æœä¸€ä¸ªçº¿ç¨‹æ”¹å˜ç¼“å­˜ï¼Œåˆ™è¯¥æ”¹å˜å¯¹äºæ‰€æœ‰çº¿ç¨‹å¯è§ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1">public class OneValueCache {
</span><span id="__span-20-2">    private final BigInteger lastNumber;
</span><span id="__span-20-3">    private final BigInteger[] lastFactors;
</span><span id="__span-20-4">
</span><span id="__span-20-5">    public OneValueCache(BigInteger i,
</span><span id="__span-20-6">                         BigInteger[] factors) {
</span><span id="__span-20-7">        lastNumber = i;
</span><span id="__span-20-8">        lastFactors = Arrays.copyOf(factors, factors.length);
</span><span id="__span-20-9">    }
</span><span id="__span-20-10">
</span><span id="__span-20-11">    public BigInteger[] getFactors(BigInteger i) {
</span><span id="__span-20-12">        if (lastNumber == null || !lastNumber.equals(i))
</span><span id="__span-20-13">            return null;
</span><span id="__span-20-14">        else
</span><span id="__span-20-15">            return Arrays.copyOf(lastFactors, lastFactors.length);
</span><span id="__span-20-16">    }
</span><span id="__span-20-17">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®‰å…¨å‘å¸ƒï¼š</li>
<li>æ¦‚å¿µï¼šæŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ›åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«å¯¹è±¡ï¼Œæ­¤æ—¶å¿…é¡»ç¡®ä¿å®‰å…¨è¿›è¡Œå…±äº«ã€‚</li>
<li>ä¸æ­£ç¡®çš„æƒ…å†µï¼š<ol>
<li>å®Œå…¨ä½¿ç”¨publicæ¥è¿›è¡Œå‘å¸ƒ</li>
<li>å¦‚ä¸‹ï¼Œå¦‚æœè¯¥Holderç±»ä½¿ç”¨publicæ–¹å¼è¿›è¡Œå‘å¸ƒï¼Œåˆ™å¯èƒ½å…¶ä»–çº¿ç¨‹é€šè¿‡StuffIntoPublicæ¥çœ‹è§Holderçš„ä¸åŒçŠ¶æ€</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1">//å‘å¸ƒ
</span><span id="__span-21-2">public class StuffIntoPublic {
</span><span id="__span-21-3">    public Holder holder;
</span><span id="__span-21-4">
</span><span id="__span-21-5">    public  void init(){
</span><span id="__span-21-6">        holder = new Holder(42);
</span><span id="__span-21-7">    }
</span><span id="__span-21-8">}
</span><span id="__span-21-9">
</span><span id="__span-21-10">//Holderå®šä¹‰
</span><span id="__span-21-11">class Holder {
</span><span id="__span-21-12">    private int n;
</span><span id="__span-21-13">
</span><span id="__span-21-14">    //åˆå§‹åŒ–æ„é€ å™¨
</span><span id="__span-21-15">    public Holder(int n) {
</span><span id="__span-21-16">        this.n = n;
</span><span id="__span-21-17">    }
</span><span id="__span-21-18">
</span><span id="__span-21-19">    public void assertSanity() {
</span><span id="__span-21-20">        if (n != n)
</span><span id="__span-21-21">            throw new AssertionError(&quot;This statement is false.&quot;);
</span><span id="__span-21-22">    }
</span><span id="__span-21-23">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>
<p>å®‰å…¨å‘å¸ƒçš„å¸¸ç”¨æ¨¡å¼ï¼š</p>
</li>
<li>
<p>æ–¹æ³•ï¼š</p>
<ol>
<li>åœ¨é™æ€åˆå§‹åŒ–å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡å¼•ç”¨</li>
<li>å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°volatileç±»å‹çš„field</li>
<li>å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°æŸä¸ªæ­£ç¡®æ„é€ çš„å¯¹è±¡çš„finalç±»å‹fieldä¸­</li>
<li>å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°ä¸€ä¸ªç”±é”ä¿æŠ¤çš„åŸŸä¸­</li>
</ol>
</li>
<li>å¸¸è§æƒ…å†µï¼š</li>
<li>å°†å¯¹è±¡æ”¾å…¥æŸä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ä¸­</li>
<li>ä½¿ç”¨é™æ€çš„åˆå§‹åŒ–å™¨</li>
<li>äº‹å®ä¸å¯å˜å¯¹è±¡ï¼š</li>
<li>å®šä¹‰ï¼šå®šä¹‰ä¸ºå¯å˜å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šä¸€ç›´æ²¡æœ‰æ”¹å˜ï¼Œç¨‹åºåªéœ€è¦æŠŠå®ƒä»¬è§†ä¸ºä¸å¯å˜å¯¹è±¡å°±å¯ä»¥ã€‚</li>
<li>å¯å˜å¯¹è±¡ï¼š</li>
<li>å®‰å…¨å‘å¸ƒåªèƒ½ä¿è¯å¯¹è±¡æ„å»ºçš„æ—¶å€™çš„å®‰å…¨æ€§ã€‚</li>
<li>å¯å˜å¯¹è±¡å¿…é¡»æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ–è¦é€šè¿‡é”ç­‰æ¥ä¿è¯æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
</ol>
<h2 id="4">4 .å¯¹è±¡çš„ç»„åˆ<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 è®¾è®¡çº¿ç¨‹å®‰å…¨çš„ç±»<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<ol>
<li>åŸºæœ¬è¦ç´ ï¼š</li>
<li>æ‰¾å‡ºæ„æˆå¯¹è±¡çŠ¶æ€çš„æ‰€æœ‰å˜é‡</li>
<li>æ‰¾å‡ºçº¦æŸçŠ¶æ€å˜é‡çš„ä¸å˜æ€§æ¡ä»¶</li>
<li>å»ºç«‹å¯¹è±¡çŠ¶æ€çš„å¹¶å‘è®¿é—®ç®¡ç†ç­–ç•¥</li>
<li>ä¾‹å­ï¼š</li>
<li>ä¸€ä¸ªç±»çš„æ‰€æœ‰åŸºæœ¬ç±»å‹çš„æˆå‘˜å˜é‡æ„æˆäº†è¯¥ç±»çš„çŠ¶æ€ï¼Œæ¯”å¦‚ä¸‹é¢çš„åŸŸå°±åªæœ‰ä¸€ä¸ªvalueæˆå‘˜å˜é‡</li>
<li>ä¸€ä¸ªåŒ…å«äº†å¼•ç”¨ç±»å‹çš„ç±»ï¼Œå…¶çŠ¶æ€ä¹ŸåŒ…å«å…¶å¼•ç”¨å¯¹è±¡çš„çŠ¶æ€ã€‚æ¯”å¦‚é“¾è¡¨çš„çŠ¶æ€å°±åŒ…æ‹¬å…¶ä¸­æ‰€æœ‰ç»“ç‚¹çš„çŠ¶æ€ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1">public final class Counter {
</span><span id="__span-22-2">    @GuardedBy(&quot;this&quot;) private long value = 0;
</span><span id="__span-22-3">
</span><span id="__span-22-4">    public synchronized long getValue() {
</span><span id="__span-22-5">        return value;
</span><span id="__span-22-6">    }
</span><span id="__span-22-7">
</span><span id="__span-22-8">    public synchronized long increment() {
</span><span id="__span-22-9">        if (value == Long.MAX_VALUE)
</span><span id="__span-22-10">            throw new IllegalStateException(&quot;counter overflow&quot;);
</span><span id="__span-22-11">        return ++value;
</span><span id="__span-22-12">    }
</span><span id="__span-22-13">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>åŒæ­¥ç­–ç•¥ï¼šå®šä¹‰äº†å¦‚ä½•åœ¨ä¸è¿èƒŒå¯¹è±¡ä¸å˜æ¡ä»¶æˆ–è€…åéªŒæ¡ä»¶ä¸‹å¯¹äºå…¶çŠ¶æ€çš„è®¿é—®æ“ä½œè¿›è¡ŒååŒã€‚</li>
<li>
<p>æ”¶é›†åŒæ­¥éœ€æ±‚ï¼š</p>
</li>
<li>
<p>çŠ¶æ€ç©ºé—´ï¼šå¯¹è±¡å’Œå˜é‡æ‰€æœ‰å–å€¼çš„ç»„åˆã€‚æ‰€ä»¥final çš„fieldè¶Šå¤šï¼Œåˆ™çŠ¶æ€ç©ºé—´è¶Šå°ï¼Œè¶Šå¯ä»¥ç®€åŒ–åˆ†æè¿‡ç¨‹ã€‚</p>
</li>
<li>
<p>ä¸å¯å˜æ¡ä»¶ï¼š</p>
<ol>
<li>å®šä¹‰ï¼šåœ¨ç±»ä¸­ä½“ç°ï¼Œç”¨äºåˆ¤æ–­çŠ¶æ€æ˜¯æœ‰æ•ˆè¿˜æ˜¯æ— æ•ˆã€‚</li>
<li>ä¾‹å­ï¼šCounterä¸­çš„ValueåŸŸ</li>
<li>ValueåŸŸæ˜¯Long.MIN_VALUEåˆ°Long.MAX_VALUEç±»å‹ã€‚ä½†æ˜¯Valueéšå«ç€&gt;=0</li>
<li>åéªŒæ¡ä»¶ï¼šæ¯”å¦‚å¦‚æœCounterçš„çŠ¶æ€ç›®å‰æ˜¯17,é‚£ä¹ˆä¸‹ä¸€ä¸ªæœ‰æ•ˆçŠ¶æ€åªèƒ½æ˜¯18ã€‚åˆ™è¯¥æ“ä½œæ˜¯å¤åˆæ“ä½œã€‚</li>
<li>å¿…é¡»äº†è§£å¯¹è±¡çš„ä¸å˜æ€§æ¡ä»¶å’ŒåéªŒæ¡ä»¶ï¼Œæ‰èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ã€‚è¦æ»¡è¶³åœ¨çŠ¶æ€å˜é‡çš„æœ‰æ•ˆå€¼æˆ–è€…çŠ¶æ€è½¬æ¢ä¸Šçš„å„ç§çº¦æŸæ¡ä»¶ï¼Œå°±å¿…é¡»å€ŸåŠ©åŸå­æ€§å’Œå°è£…æ€§ã€‚</li>
<li>ä¾èµ–çŠ¶æ€çš„æ“ä½œï¼š</li>
<li>å®šä¹‰ï¼šå¦‚æœæŸä¸ªæ“ä½œåŒ…å«æœ‰åŸºäºçŠ¶æ€çš„å…ˆéªŒæ€§æ¡ä»¶ï¼Œåˆ™è¯¥æ“ä½œè¢«ç§°ä¸ºä¾èµ–çŠ¶æ€çš„æ“ä½œã€‚</li>
<li>ä¾‹å­ï¼šæ¯”å¦‚ä¸èƒ½ä»ç©ºé˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªå…ƒç´ </li>
<li>å•çº¿ç¨‹æƒ…å†µï¼šå¦‚æœå…ˆéªŒæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™å¿…ç„¶å¤±è´¥</li>
<li>å¤šçº¿ç¨‹æƒ…å†µï¼šå…ˆéªŒæ¡ä»¶å¯èƒ½ä¼šå—å…¶ä»–çº¿ç¨‹çš„å½±å“ï¼Œéœ€è¦ç­‰åˆ°å…ˆéªŒæ¡ä»¶ä¸ºçœŸå†æ‰§è¡Œã€‚æ¯”å¦‚ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¯ä»¥åœ¨ç”Ÿäº§è€…ç”Ÿäº§ä¹‹åï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚å¯ä»¥é€šè¿‡é˜»å¡é˜Ÿåˆ—æˆ–è€…ä¿¡å·é‡æ¥å®ç°ã€‚</li>
<li>çŠ¶æ€çš„æ‰€æœ‰æƒï¼š</li>
<li>Javaä¸­ç”±äºGCçš„å­˜åœ¨ï¼Œåˆ™ä½¿å¾—æ‰€æœ‰æƒçš„è€ƒè™‘è¾ƒå°‘ã€‚</li>
<li>å¯¹è±¡å¯¹å®ƒæ‰€å°è£…çš„çŠ¶æ€æ‹¥æœ‰æ‰€æœ‰æƒã€‚</li>
<li>å¦‚æœå‘å¸ƒäº†æŸä¸ªå¯å˜å¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™ä¸åœ¨ç‹¬äº«è¯¥å¯¹è±¡çš„æ§åˆ¶æƒã€‚</li>
</ol>
</li>
</ol>
<h3 id="42">4.2 å®ä¾‹å°é—­ï¼š<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<ol>
<li>å®ä¾‹å°é—­</li>
<li>å®šä¹‰ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«å°é—­åˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè®¿é—®è¢«å°è£…å¯¹è±¡çš„æ‰€æœ‰ä»£ç è·¯å¾„éƒ½æ˜¯å·²çŸ¥çš„ã€‚ä¸å¯¹è±¡è¢«æ”¾åˆ°æ•´ä¸ªç¨‹åºä¸­çš„è®¿é—®æƒ…å†µç›¸æ¯”ï¼Œå¯ä»¥ç¡®ä¿ä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼è¿›è¡Œä½¿ç”¨è¯¥å¯¹è±¡ã€‚</li>
<li>
<p>èŒƒå›´ï¼š</p>
<ol>
<li>å¯¹è±¡å¯ä»¥è¢«å°é—­åˆ°ä¸€ä¸ªç±»çš„å®ä¾‹ä¸­</li>
<li>å¯ä»¥è¢«å°é—­åˆ°ä¸€ä¸ªä½œç”¨åŸŸå†…(æ¯”å¦‚ä½œä¸ºä¸€ä¸ªå±€éƒ¨å˜é‡)</li>
<li>å¯ä»¥è¢«å°è£…åˆ°çº¿ç¨‹å†…</li>
<li>ä¾‹å­ï¼š</li>
<li>ä¸‹é¢çš„PersonSetçš„çŠ¶æ€åŒ…å«HashSetçš„çŠ¶æ€ï¼Œè€ŒHashSetå¹¶éçº¿ç¨‹å®‰å…¨ã€‚</li>
<li>å°†HashSetå°é—­åˆ°PersonSetä¸­ï¼Œé€šè¿‡ç§æœ‰å˜é‡å®ç°ã€‚</li>
<li>å”¯ä¸€èƒ½è®¿é—®mySetå°±æ˜¯addPersonå’ŒcontainsPersonï¼Œåœ¨æ‰§è¡Œä»–ä»¬çš„æ—¶å€™éƒ½è·å¾—äº†PersonSetçš„é”ã€‚</li>
<li>å› æ­¤PersonSetçš„çŠ¶æ€å®Œå…¨ç”±å†…ç½®é”æ¥ä¿æŠ¤ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ã€‚</li>
<li>æ›´å¤šä¾‹å­ï¼šæ¯”å¦‚Javaçš„å®¹å™¨ç±»ä¸­ArrayListå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯é€šè¿‡åŒ…è£…å™¨å·¥å‚æ–¹æ³•ï¼Œä½¿ç”¨è£…é¥°å™¨æŠŠéçº¿ç¨‹å®‰å…¨çš„ç±»å°é—­åœ¨ä¸€ä¸ªåŒæ­¥çš„å¯¹è±¡ä¸­ã€‚æ‰€æœ‰å¯¹åº•å±‚å¯¹è±¡çš„è®¿é—®éƒ½é€šè¿‡åŒ…è£…å™¨æ¥è¿›è¡Œã€‚</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1">public class PersonSet {
</span><span id="__span-23-2">    @GuardedBy(&quot;this&quot;) private final Set&lt;Person&gt; mySet = new HashSet&lt;Person&gt;();
</span><span id="__span-23-3">
</span><span id="__span-23-4">    public synchronized void addPerson(Person p) {
</span><span id="__span-23-5">        mySet.add(p);
</span><span id="__span-23-6">    }
</span><span id="__span-23-7">
</span><span id="__span-23-8">    public synchronized boolean containsPerson(Person p) {
</span><span id="__span-23-9">        return mySet.contains(p);
</span><span id="__span-23-10">    }
</span><span id="__span-23-11">
</span><span id="__span-23-12">    interface Person {
</span><span id="__span-23-13">    }
</span><span id="__span-23-14">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>Javaç›‘è§†å™¨æ¨¡å¼ï¼š</li>
<li>å®šä¹‰ï¼šéµå¾ªJavaç›‘è§†å™¨æ¨¡å¼çš„å¯¹è±¡ä¼šæŠŠå¯¹è±¡çš„æ‰€æœ‰å¯å˜çŠ¶æ€éƒ½ç»™å°è£…èµ·æ¥ï¼Œå¹¶ç”±è‡ªå·±çš„å†…ç½®é”æ¥ä¿æŠ¤ã€‚</li>
<li>ä¾‹å­ï¼š<ol>
<li>å¦‚ä¸‹çš„ç±»é€šè¿‡ç§æœ‰é”æ¥ä¿æŠ¤çŠ¶æ€ï¼Œè€Œä¸æ˜¯å†…ç½®é”ã€‚</li>
<li>ä¼˜ç‚¹ï¼šå¯ä»¥å°†é”å˜ä¸ºç§æœ‰ï¼Œä½¿å¾—å®¢æˆ·ä»£ç æ— æ³•å¾—åˆ°é”ï¼Œåªèƒ½é€šè¿‡å…¬æœ‰æ–¹æ³•è·å¾—é”ã€‚</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1">public class PrivateLock {
</span><span id="__span-24-2">    private final Object myLock = new Object();
</span><span id="__span-24-3">    @GuardedBy(&quot;myLock&quot;) Widget widget;
</span><span id="__span-24-4">
</span><span id="__span-24-5">    void someMethod() {
</span><span id="__span-24-6">        synchronized (myLock) {
</span><span id="__span-24-7">            // Access or modify the state of widget
</span><span id="__span-24-8">        }
</span><span id="__span-24-9">    }
</span><span id="__span-24-10">}
</span></code></pre></div></td></tr></table></div>
<h1 id="suc">SUC<a class="headerlink" href="#suc" title="Permanent link">&para;</a></h1>
<h2 id="1">1.æ¦‚è¿°<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="_2">ç»ƒä¹ é¢˜æ€»ç»“ï¼š<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ol>
<li>å®ç°ä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç±»å‹å£°æ˜çš„composeæ–¹æ³•ã€‚æ­¤æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå‡½æ•°hï¼Œå®ƒæ˜¯è¾“å…¥å‡½æ•°få’Œgçš„ç»„åˆã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1">  def compose[A, B, C](f: B =&gt; C, g: A =&gt; B): A =&gt; C = {
</span><span id="__span-25-2">    // A =&gt; C
</span><span id="__span-25-3">    a =&gt; f(g(a))
</span><span id="__span-25-4">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®ç°ä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç±»å‹å£°æ˜çš„fuseæ–¹æ³•ï¼Œè‹¥aå’Œbéƒ½éç©ºï¼Œåˆ™è¿”å›çš„Optionå¯¹è±¡åº”è¯¥åŒ…å«Optionå¯¹è±¡aå’Œbä¸­çš„å€¼çš„äºŒå…ƒç»„ï¼ˆä½¿ç”¨foræ¨å¯¼å¼ï¼‰ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1">  def fuse[A, B](a: Option[A], b: Option[B]): Option[(A, B)] = {
</span><span id="__span-26-2">    val ans = for {
</span><span id="__span-26-3">      x &lt;- a
</span><span id="__span-26-4">      y &lt;- b
</span><span id="__span-26-5">    } yield {
</span><span id="__span-26-6">      (x, y)
</span><span id="__span-26-7">    }
</span><span id="__span-26-8">    ans
</span><span id="__span-26-9">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®ç°ä¸€ä¸ªcheckæ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ç±»å‹ä¸ºTçš„å€¼çš„åºåˆ—å’Œç±»å‹ä¸ºT =&gt; Booleançš„å‡½æ•°ï¼Œå½“ä¸”ä»…å½“ pred å‡½æ•°å¯¹ xs ä¸­æ‰€æœ‰çš„å€¼éƒ½ä¸ºçœŸï¼Œå¹¶ä¸”ä¸ä¼šæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œcheckæ‰è¿”å›çœŸ</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1">  def check[T](xs: List[T])(p: T =&gt; Boolean): Boolean = {
</span><span id="__span-27-2">    import scala.util.{Try, Success, Failure}
</span><span id="__span-27-3">    var flag = false
</span><span id="__span-27-4">    xs.foreach(
</span><span id="__span-27-5">      item =&gt; {
</span><span id="__span-27-6">        flag = Try(p(item)) match {
</span><span id="__span-27-7">          case Success(value) =&gt; value
</span><span id="__span-27-8">          case Failure(exception) =&gt; false
</span><span id="__span-27-9">        }
</span><span id="__span-27-10">      }
</span><span id="__span-27-11">    )
</span><span id="__span-27-12">    flag
</span><span id="__span-27-13">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®ç°ä¸€ä¸ªcombinationså‡½æ•°ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªå…ƒç´ åºåˆ—ï¼Œè¾“å‡ºæ˜¯é•¿åº¦ä¸ºnçš„æ‰€æœ‰å¯èƒ½ç»„åˆçš„éå†å™¨ã€‚ç»„åˆæŒ‡çš„æ˜¯ä»ä¸€ä¸ªå…ƒç´ é›†åˆä¸­é€‰å‡ºä¸€ä¸ªå­é›†çš„æ–¹å¼ï¼Œæ¯ä¸ªå…ƒç´ åªè¢«é€‰æ‹©ä¸€æ¬¡ï¼Œåªä¸è¿‡ä¸å…³å¿ƒå…ƒç´ å­é›†ä¸­çš„æ¬¡åºã€‚æ¯”å¦‚ï¼Œç»™å®šåºåˆ— Seq(1, 4, 9, 16)ï¼Œé•¿åº¦ä¸º2çš„ç»„åˆåŒ…æ‹¬Seq(1, 4)ã€Seq(1, 9)ã€Seq(1,16)ã€Seq(4, 9)ã€Seq(4, 16)å’Œ Seq(9, 16)ã€‚combinationså‡½æ•°çš„å®šä¹‰å£°æ˜å¦‚ä¸‹ï¼ˆå‚è§æ ‡å‡†åº“æ–‡æ¡£ä¸­Iteratorçš„APIï¼‰ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1">  def myCombinations(i: Int, ints: List[Int]): List[List[Int]] = {
</span><span id="__span-28-2">    if (i == 0) {
</span><span id="__span-28-3">      List(List())
</span><span id="__span-28-4">    } else {
</span><span id="__span-28-5">      ints.flatMap(
</span><span id="__span-28-6">        item =&gt; {
</span><span id="__span-28-7">          val ans = myCombinations(i - 1, ints.filter(_ != item))
</span><span id="__span-28-8">          ans.map(
</span><span id="__span-28-9">            list =&gt; {
</span><span id="__span-28-10">              if(list.nonEmpty &amp;&amp; list.head &lt; item) list :+ item
</span><span id="__span-28-11">              else if(list.isEmpty) list :+ item
</span><span id="__span-28-12">              else List()
</span><span id="__span-28-13">            }
</span><span id="__span-28-14">          )
</span><span id="__span-28-15">        }
</span><span id="__span-28-16">      ).filter(_.nonEmpty)
</span><span id="__span-28-17">    }
</span><span id="__span-28-18">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å‡è®¾è¯»è€…å’ŒåŒäº‹ä»¬åŒå¤„ä¸€ä¸ªåŠå…¬å®¤ï¼Œå„è‡ªæœ‰ä¸€ä¸ªéš”é—´ï¼Œå¤§å®¶äº’ç›¸çœ‹ä¸è§å¯¹æ–¹ï¼Œä¸”ä¸èƒ½è¯´è¯ï¼ˆä¼šåµåˆ°åˆ«äººï¼‰ã€‚å› ä¸ºéƒ½è¢«é™åˆ¶åœ¨éš”é—´ä¸­ï¼Œæ‰€ä»¥æ¯ä¸ªäººéƒ½æ— æ³•ç¡®è®¤ä¼ é€’èšä¼šæ¶ˆæ¯çš„çº¸æ¡æ˜¯å¦å·²ç»åˆ°è¾¾ç›®çš„åœ°ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œå…¶ä¸­ä¸€äººè¢«å«åˆ°è€æ¿åŠå…¬å®¤ï¼Œè¢«æ°¸ä¹…â€œæ‰£ç•™â€åœ¨é‚£é‡Œã€‚è¯·è®¾è®¡ä¸€ä¸ªç®—æ³•ï¼Œä½¿å¤§å®¶èƒ½å¤Ÿç¡®å®šä½•æ—¶èƒ½å¤Ÿèšä¼šã€‚é™¤è¢«è€æ¿å«èµ°çš„é‚£ä½ä¹‹å¤–ï¼Œæ‰€æœ‰äººéƒ½éœ€è¦åŒæ—¶åšå‡ºå†³å®šã€‚å¦‚æœæœ‰äº›çº¸æ¡è¢«é€’åˆ°ç›®çš„åœ°æ—¶å‘ç”Ÿéšæœºæ€§å¤±è¯¯ï¼Œåˆ™è¯¥å¦‚ä½•æ”¹è¿›ç®—æ³•ï¼Ÿ</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1">import SUC.chapter01.Person.peopleMap
</span><span id="__span-29-2">
</span><span id="__span-29-3">import scala.collection.mutable.Queue
</span><span id="__span-29-4">import scala.collection.concurrent.TrieMap
</span><span id="__span-29-5">import scala.util.Random
</span><span id="__span-29-6">
</span><span id="__span-29-7">sealed trait PartyStatus
</span><span id="__span-29-8">case object NotDecided extends PartyStatus
</span><span id="__span-29-9">case object CanParty extends PartyStatus
</span><span id="__span-29-10">case object CannotParty extends PartyStatus
</span><span id="__span-29-11">
</span><span id="__span-29-12">object Person{
</span><span id="__span-29-13">  def apply(name: String, status: PartyStatus = NotDecided): Person = {
</span><span id="__span-29-14">    new Person(name, status)
</span><span id="__span-29-15">  }
</span><span id="__span-29-16">  // å‡è®¾æœ‰ä¸€ä¸ªå…¨å±€çš„çº¿ç¨‹å®‰å…¨çš„peopleæ˜ å°„ï¼Œç”¨äºæ ¹æ®åå­—å¿«é€ŸæŸ¥æ‰¾Personå®ä¾‹
</span><span id="__span-29-17">  private val peopleMap: TrieMap[String, Person] = TrieMap[String, Person]()
</span><span id="__span-29-18">}
</span><span id="__span-29-19">class Person(val name: String, var status: PartyStatus = NotDecided) {
</span><span id="__span-29-20">  // ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
</span><span id="__span-29-21">  private val queue = Queue[(String, PartyStatus)]()
</span><span id="__span-29-22">
</span><span id="__span-29-23">  def this(name: String, status: PartyStatus, peopleMap: TrieMap[String, Person]) = {
</span><span id="__span-29-24">    this(name, status)
</span><span id="__span-29-25">    peopleMap += (this.name -&gt; this)
</span><span id="__span-29-26">  }
</span><span id="__span-29-27">
</span><span id="__span-29-28">  def sendNote(to: String, note: PartyStatus): Unit = {
</span><span id="__span-29-29">    queue.enqueue((to, note))
</span><span id="__span-29-30">  }
</span><span id="__span-29-31">
</span><span id="__span-29-32">  // ä¼˜åŒ–æŸ¥æ‰¾äººçš„é€»è¾‘
</span><span id="__span-29-33">  def receiveNote(from: String, note: PartyStatus): Unit = {
</span><span id="__span-29-34">    peopleMap.get(from) match {
</span><span id="__span-29-35">      case Some(person) =&gt;
</span><span id="__span-29-36">        if (note == CannotParty) status = CannotParty
</span><span id="__span-29-37">        else if (status == NotDecided) status = note
</span><span id="__span-29-38">      case None =&gt; // å¦‚æœæ‰¾ä¸åˆ°äººï¼Œå¯ä»¥åœ¨è¿™é‡Œè®°å½•é”™è¯¯æˆ–è€…é‡‡å–å…¶ä»–æªæ–½
</span><span id="__span-29-39">    }
</span><span id="__span-29-40">  }
</span><span id="__span-29-41">
</span><span id="__span-29-42">  def updateStatus(): Unit = {
</span><span id="__span-29-43">    while (queue.nonEmpty) {
</span><span id="__span-29-44">      val (to, note) = queue.dequeue()
</span><span id="__span-29-45">      peopleMap.get(to) match {
</span><span id="__span-29-46">        case Some(person) =&gt; person.receiveNote(name, note)
</span><span id="__span-29-47">        case None =&gt; // åŒæ ·çš„ï¼Œè¿™é‡Œå¯ä»¥å¤„ç†æ¥æ”¶åˆ°ä¸å­˜åœ¨çš„äººçš„noteçš„æƒ…å†µ
</span><span id="__span-29-48">      }
</span><span id="__span-29-49">    }
</span><span id="__span-29-50">  }
</span><span id="__span-29-51">}
</span><span id="__span-29-52">
</span><span id="__span-29-53">object PartyAlgorithm {
</span><span id="__span-29-54">  def main(args: Array[String]): Unit = {
</span><span id="__span-29-55">    // åˆå§‹åŒ–peopleMap
</span><span id="__span-29-56">    val peopleMap = TrieMap[String, Person]()
</span><span id="__span-29-57">    List(&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;).foreach(name =&gt; new Person(name, CanParty, peopleMap))
</span><span id="__span-29-58">    new Person(&quot;David&quot;, CannotParty, peopleMap) // David is detained
</span><span id="__span-29-59">
</span><span id="__span-29-60">    val maxRounds = 5
</span><span id="__span-29-61">    for (round &lt;- 1 to maxRounds) {
</span><span id="__span-29-62">      peopleMap.values.foreach(_.updateStatus())
</span><span id="__span-29-63">      if (peopleMap.values.forall(_.status == CannotParty)) {
</span><span id="__span-29-64">        println(&quot;Everyone knows that someone is detained.&quot;)
</span><span id="__span-29-65">        return
</span><span id="__span-29-66">      } else if (peopleMap.values.forall(_.status == CanParty)) {
</span><span id="__span-29-67">        println(&quot;Everyone can party!&quot;)
</span><span id="__span-29-68">        return
</span><span id="__span-29-69">      }
</span><span id="__span-29-70">      if (round == maxRounds) {
</span><span id="__span-29-71">        println(&quot;No consensus reached after &quot; + maxRounds + &quot; rounds.&quot;)
</span><span id="__span-29-72">        return
</span><span id="__span-29-73">      }
</span><span id="__span-29-74">    }
</span><span id="__span-29-75">    println(&quot;Reached maximum rounds without consensus.&quot;)
</span><span id="__span-29-76">  }
</span><span id="__span-29-77">}
</span></code></pre></div></td></tr></table></div>
<h2 id="2jvmjvm">2.JVMä¸JVMçš„å¹¶å‘æ€§<a class="headerlink" href="#2jvmjvm" title="Permanent link">&para;</a></h2>
<h3 id="21_1">2.1 çº¿ç¨‹å’Œè¿›ç¨‹<a class="headerlink" href="#21_1" title="Permanent link">&para;</a></h3>
<p>åˆ›å»ºä¸€ä¸ªJVMå®ä¾‹ï¼Œæ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„JVMè¿›ç¨‹ã€‚åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­è¿è¡Œç€å¾ˆå¤šçº¿ç¨‹ã€‚JVMè¿›ç¨‹å°†è¿™äº›çº¿ç¨‹è¡¨ç°ä¸ºjava.lang.Threadç±»ã€‚æ¯ä¸€ä¸ªJVMçº¿ç¨‹éƒ½è¢«ç›´æ¥æ˜ å°„ä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚Scalaé‡ç”¨äº†Javaä¸­çš„çº¿ç¨‹ä¸­çš„APIï¼Œæ˜¯å‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ã€‚</p>
<h4 id="_3">çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œ<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>æ¯æ¬¡åˆ›å»ºJVMçš„è¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šé»˜è®¤åˆ›å»ºå‡ ä¸ªçº¿ç¨‹</p>
<ol>
<li>mainçº¿ç¨‹</li>
<li>ä¸‹é¢çš„ä»£ç è¾“å‡ºç»“æœæ˜¯main</li>
<li>é™æ€çš„currentThreadæ–¹æ³•æ¥è·å¾—å½“å‰çº¿ç¨‹å¯¹è±¡çš„å¼•ç”¨</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1">object ThreadsMain extends App {
</span><span id="__span-30-2">  val t: Thread = Thread.currentThread
</span><span id="__span-30-3">  val name = t.getName
</span><span id="__span-30-4">  println(s&quot;I am the thread $name&quot;)
</span><span id="__span-30-5">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹</li>
<li>åˆ›å»ºThreadå¯¹è±¡</li>
<li>è°ƒç”¨è¯¥å¯¹è±¡çš„startæ–¹æ³•ï¼Œstartä¼šè¿›ä¸€æ­¥è°ƒç”¨è¯¥çº¿ç¨‹å¯¹è±¡çš„runæ–¹æ³•</li>
<li>joinæ–¹æ³•ï¼šä¼šè®©æœ¬çº¿ç¨‹è¿›å…¥waitingçŠ¶æ€ï¼Œç›´åˆ°forkå‡ºçš„çº¿ç¨‹æ‰§è¡Œç»“æŸ</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1">object ThreadsCreation extends App {
</span><span id="__span-31-2">  class MyThread extends Thread {
</span><span id="__span-31-3">    override def run():Unit = {
</span><span id="__span-31-4">      val name = Thread.currentThread.getName
</span><span id="__span-31-5">      println(s&quot;i am the thread ${name}&quot;)
</span><span id="__span-31-6">    }
</span><span id="__span-31-7">  }
</span><span id="__span-31-8">  val name = Thread.currentThread.getName
</span><span id="__span-31-9">  println(s&quot;i am the thread ${name}&quot;)
</span><span id="__span-31-10">  val t = new MyThread
</span><span id="__span-31-11">  t.start()
</span><span id="__span-31-12">  t.join()
</span><span id="__span-31-13">  println(&quot;New thread joined.&quot;)
</span><span id="__span-31-14">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>è®¾è®¡çº¿ç¨‹åˆ›å»ºå…¬ç”¨å‡½æ•°ä»¥åŠå…¬ç”¨æ—¥å¿—æ‰“å°å‡½æ•°</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1">//çº¿ç¨‹åˆ›å»ºå‡½æ•°  
</span><span id="__span-32-2">def thread(body: =&gt; Unit): Thread = {
</span><span id="__span-32-3">    val t = new Thread{
</span><span id="__span-32-4">      override def run(): Unit = body
</span><span id="__span-32-5">    }
</span><span id="__span-32-6">    t.start()
</span><span id="__span-32-7">    t
</span><span id="__span-32-8">  }
</span><span id="__span-32-9">//æ—¥å¿—æ‰“å°å‡½æ•°
</span><span id="__span-32-10">package object SUC {
</span><span id="__span-32-11">  def log(msg: String): Unit = {
</span><span id="__span-32-12">    println(s&quot;${Thread.currentThread.getName}: $msg&quot;)
</span><span id="__span-32-13">  }
</span><span id="__span-32-14">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_4">åŸå­æ‰§è¡Œ<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<ol>
<li>join</li>
<li>è°ƒç”¨çš„ç‰¹ç‚¹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¢«è°ƒç”¨joinæ–¹æ³•æ—¶ï¼Œå®ƒæ‰€æœ‰çš„å†…å­˜å†™æ“ä½œéƒ½ä¼šåœ¨joinè¿”å›ä¹‹å‰å‘ç”Ÿï¼Œè€Œä¸”è¿™äº›å†™æ“ä½œå¯¹è°ƒç”¨joinçš„é‚£ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„</li>
<li>ç¼ºç‚¹ï¼šåªèƒ½å•å‘é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨çº¿ç¨‹ç»“æœè¿›è¡Œé€šä¿¡çš„æ¨¡å¼</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1">object ThreadsCommunicate extends App {
</span><span id="__span-33-2">  var result: String = null
</span><span id="__span-33-3">  val t = thread { result = &quot;\nTitle\n&quot; + &quot;=&quot; * 5 }
</span><span id="__span-33-4">  t.join()
</span><span id="__span-33-5">  //resultä¸ä¼šä¸ºç©ºï¼Œå› ä¸ºthreadä¸­å†…å­˜å†™æ“ä½œæ€»æ˜¯ä¼šåœ¨joinä¹‹å‰å®Œæˆ
</span><span id="__span-33-6">  log(result)
</span><span id="__span-33-7">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>synchronized</li>
<li>JVMä¸­åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡éƒ½æœ‰å†…ç½®é”(ç›‘æ§å™¨)ï¼Œå…¶ä½œç”¨æ˜¯ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯¥å¯¹è±¡ä¸Šæ‰§è¡ŒæŸä¸ªsynchronizedä»£ç å—ã€‚å½“ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œsynchronizedä»£ç å—æ—¶ï¼Œæˆ‘ä»¬ç§°è¯¥çº¿ç¨‹è·å¾—äº†xçš„ç›‘æ§å™¨çš„æ‰€æœ‰æƒï¼Œæ¢å¥è¯è¯´ï¼Œè·å¾—äº†xçš„ç›‘æ§æƒã€‚</li>
<li>JVMä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹åœ¨æŸä¸ªå¯¹è±¡xä¸Šæ‰§è¡Œsynchronizedè¯­å¥æ—¶ï¼Œè¯¥çº¿ç¨‹æ˜¯xå¯¹è±¡ä¸Šå”¯ä¸€åœ¨æ‰§è¡Œsynchronizedè¯­å¥çš„çº¿ç¨‹ã€‚å¦‚æœçº¿ç¨‹Tè¦åœ¨xä¸Šè°ƒç”¨synchronizedè¯­å¥ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Sæ­£åœ¨xä¸Šè°ƒç”¨å…¶ä»–synchronizedè¯­å¥ï¼Œé‚£ä¹ˆçº¿ç¨‹Tä¼šè¿›å…¥é˜»å¡ï¼ˆblockedï¼‰çŠ¶æ€ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1">object ThreadsUnprotectedUid extends App {
</span><span id="__span-34-2">  var uidCount = 0L
</span><span id="__span-34-3">  //this.synchronizedæ˜¯ç”¨ThreadsUnprotectedUidä½œä¸ºé”
</span><span id="__span-34-4">  def getUniqueId(): Long = this.synchronized {
</span><span id="__span-34-5">    val freshUid = uidCount + 1
</span><span id="__span-34-6">    uidCount = freshUid
</span><span id="__span-34-7">    freshUid
</span><span id="__span-34-8">  }
</span><span id="__span-34-9">
</span><span id="__span-34-10">  def printUniqueIds(n: Int): Unit = {
</span><span id="__span-34-11">
</span><span id="__span-34-12">    val uids = for (i &lt;- 0 until n) yield getUniqueId()
</span><span id="__span-34-13">    log(s&quot;Generated uids: ${uids}&quot;)
</span><span id="__span-34-14">  }
</span><span id="__span-34-15">
</span><span id="__span-34-16">  val t = thread {
</span><span id="__span-34-17">    printUniqueIds(5)
</span><span id="__span-34-18">  }
</span><span id="__span-34-19">  Thread.sleep(10)
</span><span id="__span-34-20">  printUniqueIds(5)
</span><span id="__span-34-21">  t.join()
</span><span id="__span-34-22">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_5">é‡æ’åº<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<ol>
<li>åŸå› ï¼š JMM è§„èŒƒä¸Šï¼Œå¦‚æœåœ¨æŸä¸ªç‰¹å®šçš„çº¿ç¨‹å†…ä»£ç è¯­å¥çš„é¡ºåºä¸å½±å“ç¨‹åºçš„ä¸²è¡Œè¯­ä¹‰ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹ä¸­JVMæ˜¯å…è®¸è¿™ç±»é‡æ’åºçš„ã€‚è¿™æ—¶å€™å¯è§æ€§å°±ä¼šå‘ç”Ÿå˜åŒ–</li>
<li>ä¾‹å­ï¼š</li>
<li>å¦‚ä¸‹ä»£ç ï¼Œæ‰§è¡Œå¤šæ¬¡ä¼šå‡ºç°xå’Œyéƒ½ä¸º1çš„æƒ…å†µ</li>
<li>ä½†æ˜¯å› ä¸ºa,bçš„èµ‹å€¼ç†è®ºä¸Šå¿…æœ‰ä¸€ä¸ªåœ¨ifä¹‹å‰å‘ç”Ÿï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯JVMä¸Šå‘ç”Ÿäº†é‡æ’åºã€‚æ­¤å¤–ï¼Œç¨‹åºå¹¶ä¸éœ€è¦å°†æ‰€æœ‰çš„æ›´æ–°ç«‹å³å†™åˆ°ä¸»å­˜ä¸­ï¼Œè€Œæ˜¯ä¼šå°†å®ƒä»¬ä¸´æ—¶ä¿å­˜åœ¨å¤„ç†å™¨çš„å¯„å­˜å™¨ä¸­ã€‚</li>
<li>è§£å†³åŠæ³•ï¼šåˆšæ‰çŠ¯çš„é”™æ¥è‡ªä¸€ä¸ªå‡è®¾ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œä¼šç«‹åˆ»åæ˜ åˆ°å†…å­˜ä¸­å¹¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œä½†è¿™ç§åŒæ­¥å¹¶ä¸ä¼šè‡ªç„¶è€Œç„¶å‘ç”Ÿ(å¯èƒ½æš‚æ—¶åœ¨å¯„å­˜å™¨ä¸­)ã€‚synchronizedè¯­å¥å°±æ˜¯å®ç°æ­£ç¡®çš„åŒæ­¥çš„åŸºæœ¬æ–¹å¼ã€‚åœ¨å¯¹è±¡xä¸Šæ‰§è¡Œ synchronized è¯­å¥äº§ç”Ÿçš„å†™æ“ä½œä¸ä»…æ˜¯åŸå­æ€§çš„ï¼Œè€Œä¸”å¯¹æ‰€æœ‰åœ¨ x ä¸Šæ‰§è¡Œsynchronizedè¯­å¥çš„çº¿ç¨‹è€Œè¨€éƒ½æ˜¯å¯è§çš„ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1">object ThreadSharedStateAccessReordering extends App {
</span><span id="__span-35-2">  for (i &lt;- 0 until 100000) {
</span><span id="__span-35-3">    var a = false
</span><span id="__span-35-4">    var b = false
</span><span id="__span-35-5">    var x = -1
</span><span id="__span-35-6">    var y = -1
</span><span id="__span-35-7">    val t1 = thread {
</span><span id="__span-35-8">      this.synchronized{
</span><span id="__span-35-9">        a = true
</span><span id="__span-35-10">        y = if (b) 0 else 1
</span><span id="__span-35-11">      }
</span><span id="__span-35-12">    }
</span><span id="__span-35-13">    val t2 = thread {
</span><span id="__span-35-14">      this.synchronized{
</span><span id="__span-35-15">        b = true
</span><span id="__span-35-16">        x = if (a) 0 else 1
</span><span id="__span-35-17">      }
</span><span id="__span-35-18">    }
</span><span id="__span-35-19">    t1.join()
</span><span id="__span-35-20">    t2.join()
</span><span id="__span-35-21">
</span><span id="__span-35-22">    assert(!(x == 1 &amp;&amp; y == 1), s&quot;x = $x, y = $y&quot;)
</span><span id="__span-35-23">  }
</span><span id="__span-35-24">}
</span></code></pre></div></td></tr></table></div>
<h3 id="22_1">2.2ç›‘æ§å™¨å’ŒåŒæ­¥<a class="headerlink" href="#22_1" title="Permanent link">&para;</a></h3>
<h4 id="_6">ç›‘è§†å™¨<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<ol>
<li>ç›‘æ§å™¨ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡xä¸Šçš„synchronizedè¯­å¥æ—¶ï¼Œè‹¥æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ‹¥æœ‰xä¸Šçš„ç›‘æ§å™¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè·å¾—æ­¤ç›‘æ§å™¨ã€‚å¦åˆ™ï¼Œè¯¥çº¿ç¨‹ä¼šç­‰å¾…ç›‘æ§å™¨è¢«é‡Šæ”¾ã€‚åœ¨è·å¾—ç›‘æ§å™¨çš„åŒæ—¶ï¼Œè¯¥çº¿ç¨‹ä¹Ÿèƒ½çœ‹åˆ°é‡Šæ”¾è¯¥ç›‘æ§å™¨çš„å‰ä¸€çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œã€‚</li>
<li>ç›‘è§†å™¨æ˜¯åŸºäºå¯¹è±¡çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰å±äºä¸åŒå¯¹è±¡çš„å¤šä¸ªç›‘è§†å™¨ã€‚</li>
<li>ä¾‹å­ï¼šé“¶è¡Œç³»ç»Ÿï¼š</li>
<li>æœ‰ä¸€ä¸ªå­˜å–æ—¥å¿—è®°å½•æ–¹æ³•ï¼Œä½¿ç”¨ArrayBufferå¯¹è±¡å­˜å‚¨ã€‚ä½¿ç”¨å†…ç½®é”ï¼Œé˜²æ­¢å¯¹è±¡æ›´æ–°å‡ºé”™</li>
<li>æœ‰ä¸€ä¸ªAccountç±»ï¼Œç”¨äºåˆ›å»ºç”¨æˆ·è´¦æˆ·ã€‚ä½¿ç”¨å†…ç½®é”ï¼Œé˜²æ­¢t1,t3çº¿ç¨‹åŒæ—¶æ›´æ–°è´¦æˆ·</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1">object SynchronizedNesting extends App {
</span><span id="__span-36-2">  import scala.collection._
</span><span id="__span-36-3">  private val transfers = mutable.ArrayBuffer[String]()
</span><span id="__span-36-4">  def logTransfer(name: String, n: Int) = transfers.synchronized {
</span><span id="__span-36-5">    transfers += s&quot;transfer to account &#39;$name&#39; = $n&quot;
</span><span id="__span-36-6">  }
</span><span id="__span-36-7">  class Account(val name: String, var money: Int){
</span><span id="__span-36-8">    def add(account: Account, n: Int):Unit = account.synchronized {
</span><span id="__span-36-9">      account.money += n
</span><span id="__span-36-10">      if (n &gt; 10) logTransfer(account.name, n)
</span><span id="__span-36-11">    }
</span><span id="__span-36-12">  }
</span><span id="__span-36-13">  // é“¶è¡Œç³»ç»Ÿç¤ºä¾‹ä»£ç ï¼ˆç»­ï¼‰
</span><span id="__span-36-14">  val jane = new Account(&quot;Jane&quot;, 100)
</span><span id="__span-36-15">  val john = new Account(&quot;John&quot;, 200)
</span><span id="__span-36-16">  val t1 = thread { jane.add(jane, 5) }
</span><span id="__span-36-17">  val t2 = thread { john.add(john, 50) }
</span><span id="__span-36-18">  val t3 = thread { jane.add(jane, 70) }
</span><span id="__span-36-19">  t1.join(); t2.join(); t3.join()
</span><span id="__span-36-20">  log(s&quot;--- accounts ---\n${jane.money}\n${john.money}&quot;)
</span><span id="__span-36-21">  log(s&quot;--- transfers ---\n$transfers&quot;)
</span><span id="__span-36-22">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_7">æ­»é”<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<ol>
<li>å®šä¹‰ï¼šåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å¾—ä¸¤ä¸ªä¸åŒçš„ç›‘æ§å™¨ï¼Œç„¶åå°è¯•è·å¾—å¯¹æ–¹çš„ç›‘æ§å™¨æ—¶ï¼Œæ­»é”å°±å‘ç”Ÿäº†ã€‚åŒæ–¹éƒ½ä¸é‡Šæ”¾è‡ªå·±çš„ç›‘æ§å™¨ï¼Œäºæ˜¯è¿™ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªç›‘æ§å™¨è¢«é‡Šæ”¾ã€‚</li>
<li>æ‰“ç ´æ­»é”çš„å¿…è¦æ¡ä»¶ï¼šè§„å®šèµ„æºè®¿é—®é¡ºåºï¼Œæ‰“ç ´æ½œåœ¨çš„æ­»å¾ªç¯</li>
<li>ä¾‹å­ï¼š</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1">object SynchronizedDeadlock extends App {
</span><span id="__span-37-2">  import SynchronizedNesting.Account
</span><span id="__span-37-3">  def send(a: Account, b: Account, n: Int) = a.synchronized {
</span><span id="__span-37-4">    Thread.sleep(10)
</span><span id="__span-37-5">    b.synchronized {
</span><span id="__span-37-6">      a.money -= n
</span><span id="__span-37-7">      b.money += n
</span><span id="__span-37-8">    }
</span><span id="__span-37-9">  }
</span><span id="__span-37-10">  val a = new Account(&quot;Jack&quot;, 1000)
</span><span id="__span-37-11">  val b = new Account(&quot;Jill&quot;, 2000)
</span><span id="__span-37-12">  val t1 = thread { for (i&lt;- 0 until 100) send(a, b, 1) }
</span><span id="__span-37-13">  val t2 = thread { for (i&lt;- 0 until 100) send(b, a, 1) }
</span><span id="__span-37-14">  t1.join(); t2.join()
</span><span id="__span-37-15">  log(s&quot;a = ${a.money}, b = ${b.money}&quot;)
</span><span id="__span-37-16">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ä¿®æ”¹ï¼š</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1">object SynchronizedDeadlock extends App {
</span><span id="__span-38-2">  import ThreadsUnprotectedUid.getUniqueId
</span><span id="__span-38-3">  class Account(val name: String, var money: Int) {
</span><span id="__span-38-4">    val uid = getUniqueId()
</span><span id="__span-38-5">  }
</span><span id="__span-38-6">  def send(a1: Account, a2: Account, n: Int) {
</span><span id="__span-38-7">    def adjust() {
</span><span id="__span-38-8">      log(s&quot;money is ${n}&quot;)
</span><span id="__span-38-9">      a1.money -= n
</span><span id="__span-38-10">      a2.money += n
</span><span id="__span-38-11">    }
</span><span id="__span-38-12">    if (a1.uid &lt; a2.uid)
</span><span id="__span-38-13">      a1.synchronized { a2.synchronized { adjust() } }
</span><span id="__span-38-14">    else a2.synchronized { a1.synchronized { adjust() } }
</span><span id="__span-38-15">  }
</span><span id="__span-38-16">  val a = new Account(&quot;Jack&quot;, 1000)
</span><span id="__span-38-17">  val b = new Account(&quot;Jill&quot;, 2000)
</span><span id="__span-38-18">  log(s&quot;a.uid = ${a.uid}, b.uid = ${b.uid}&quot;)
</span><span id="__span-38-19">  //a,bçš„uidå…¨å±€æœ‰åºï¼Œåˆ™è·å¾—çš„é”æ˜¯æœ‰åºçš„ï¼Œæ²¡æœ‰æŠ¢åˆ°çš„å°±é˜»å¡ï¼Œè€Œä¸æ˜¯ä¹±å»è·å¾—å…¶ä»–é”
</span><span id="__span-38-20">  val t1 = thread { for (i&lt;- 0 until 100) send(a, b, 10) }
</span><span id="__span-38-21">  val t2 = thread { for (i&lt;- 0 until 100) send(b, a, 1) }
</span><span id="__span-38-22">  t1.join(); t2.join()
</span><span id="__span-38-23">  log(s&quot;a = ${a.money}, b = ${b.money}&quot;)
</span><span id="__span-38-24">}  
</span></code></pre></div></td></tr></table></div>
<h4 id="_8">ä¿æŠ¤å—<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<ol>
<li>çº¿ç¨‹æ± ï¼šåˆ›å»ºæ–°çº¿ç¨‹çš„ä»£ä»·æ¯”åˆ›å»º Account ä¹‹ç±»çš„è½»é‡çº§å¯¹è±¡è¦å¤§å¾—å¤šã€‚åŒä¸€çº¿ç¨‹åº”è¯¥èƒ½å¤Ÿè¢«å¤šä¸ªè¯·æ±‚é‡ç”¨ï¼Œè¿™ç§å¯é‡ç”¨çš„çº¿ç¨‹çš„é›†åˆé€šå¸¸ç§°ä¸ºçº¿ç¨‹æ± </li>
</ol>
<p>å¿™ç­‰å¾…ï¼šworkerçº¿ç¨‹åœ¨å¯åŠ¨ä¹‹å‰è¢«è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒJVMè¿›ç¨‹å¹¶ä¸ä¼šåœ¨ä¸»çº¿ç¨‹ç»ˆæ­¢æ—¶ç»“æŸï¼Œè€Œæ˜¯ä¼šç­‰æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹å…¨éƒ¨ç»“æŸã€‚ç­‰åˆ°workerçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Œå®ƒä¼šç»§ç»­æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ã€‚æˆ‘ä»¬ç§°workerçº¿ç¨‹è¿™æ ·çš„çŠ¶æ€ä¸ºå¿™ç­‰å¾…ã€‚è¿™æ˜¯ä¸€ç§æµªè´¹èµ„æºçš„è¡Œä¸ºï¼Œå¤§éƒ¨åˆ†æƒ…å†µéœ€è¦é¿å…å¿™ç­‰å¾…</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1">import scala.collection._
</span><span id="__span-39-2">object SynchronizedBadPool extends App {
</span><span id="__span-39-3">  private val tasks = mutable.Queue[() =&gt; Unit]()
</span><span id="__span-39-4">  val worker = new Thread {
</span><span id="__span-39-5">    def poll(): Option[() =&gt; Unit] = tasks.synchronized {
</span><span id="__span-39-6">      if (tasks.nonEmpty) Some(tasks.dequeue()) else None
</span><span id="__span-39-7">    }
</span><span id="__span-39-8">    override def run() = while (true) poll() match {
</span><span id="__span-39-9">      case Some(task) =&gt; task()
</span><span id="__span-39-10">      case None =&gt;
</span><span id="__span-39-11">    }
</span><span id="__span-39-12">  }
</span><span id="__span-39-13">  worker.setName(&quot;Worker&quot;)
</span><span id="__span-39-14">  //è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
</span><span id="__span-39-15">  worker.setDaemon(true)
</span><span id="__span-39-16">  worker.start()
</span><span id="__span-39-17">
</span><span id="__span-39-18">  def asynchronous(body: =&gt; Unit) = tasks.synchronized {
</span><span id="__span-39-19">    tasks.enqueue(() =&gt; body)
</span><span id="__span-39-20">  }
</span><span id="__span-39-21">  asynchronous { log(&quot;Hello&quot;) }
</span><span id="__span-39-22">  asynchronous { log(&quot; world!&quot;)}
</span><span id="__span-39-23">  Thread.sleep(5000)
</span><span id="__span-39-24">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¿™ç­‰å¾…çš„ä¼˜åŒ–ï¼šè®©workerçº¿ç¨‹ä¼‘çœ ï¼Œåªæœ‰åœ¨taské˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå†è¢«å”¤é†’</li>
<li>waitä¸notify:ä¹Ÿæ˜¯åŸºäºé”å¯¹è±¡çš„æ“ä½œã€‚å½“çº¿ç¨‹Tè°ƒç”¨æŸå¯¹è±¡çš„waitæ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾xçš„ç›‘æ§å™¨ï¼Œç„¶åè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å¦ä¸€çº¿ç¨‹Sè°ƒç”¨åŒä¸€å¯¹è±¡çš„notifyæ–¹æ³•ã€‚</li>
<li>ä¾‹å­ï¼šæ— è®ºå“ªä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œsychronizedæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè¾“å‡ºhelloä¿¡æ¯</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1">object SynchronizedGuardedBlocks extends App {
</span><span id="__span-40-2">  //AnyRef &lt;=&gt; java.lang.Object
</span><span id="__span-40-3">  val lock = new AnyRef
</span><span id="__span-40-4">  var message: Option[String] = None
</span><span id="__span-40-5">  val greeter = thread {
</span><span id="__span-40-6">    //1.greeterçº¿ç¨‹è¿›å…¥ï¼Œå‘ç°ä¸ºNoneï¼Œè¢«é˜»å¡ï¼Œé‡Šæ”¾é”
</span><span id="__span-40-7">    lock.synchronized {
</span><span id="__span-40-8">      //å¿…é¡»ä½¿ç”¨whileï¼Œä½¿ç”¨ifå¯èƒ½ä¼šå¼•èµ·è™šå‡å”¤é†’ã€‚
</span><span id="__span-40-9">      while (message == None) lock.wait()
</span><span id="__span-40-10">      //3.åœ¨åŒä¸€ä¸ªé”ä¸­ï¼Œå¹¶ä¸”mainç»™messageåœ¨logä¹‹å‰ï¼Œæ‰€ä»¥ä¿è¯å¯è§æ€§
</span><span id="__span-40-11">      log(message.get)
</span><span id="__span-40-12">    }
</span><span id="__span-40-13">  }
</span><span id="__span-40-14">  //2.mainçº¿ç¨‹è¿›å…¥ï¼Œå‘ç°ä¸ä¸ºNoneï¼Œè®¾ç½®message,é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’greeterçº¿ç¨‹
</span><span id="__span-40-15">  lock.synchronized {
</span><span id="__span-40-16">    message = Some(&quot;Hello!&quot;)
</span><span id="__span-40-17">    lock.notify()
</span><span id="__span-40-18">  }
</span><span id="__span-40-19">  greeter.join()
</span><span id="__span-40-20">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>waitçš„ä¸€ä¸ªé‡è¦æ€§è´¨æ˜¯å®ƒä¼šå¼•èµ·è™šå‡å”¤é†’ã€‚æœ‰æ—¶å€™ï¼ŒJVMå…è®¸åœ¨æ²¡æœ‰è°ƒç”¨notifyçš„æƒ…å†µä¸‹å”¤é†’ä¸€ä¸ªæ‰§è¡Œäº†waitçš„ä¼‘çœ çº¿ç¨‹ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ç§æƒ…å†µï¼Œéœ€è¦ç”¨ä¸€ä¸ªwhileå¾ªç¯åå¤æ£€æŸ¥çŠ¶æ€ï¼Œç„¶åç»“åˆ waitä½¿ç”¨ï¼Œå¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºã€‚ä½¿ç”¨ä¸€ä¸ª if è¯­å¥æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå³ä½¿messageçš„å€¼ä¸ºNoneï¼Œä¸€ä¸ªè™šå‡å”¤é†’ä¹Ÿå°†å…è®¸çº¿ç¨‹æ‰§è¡Œmessage.getã€‚ä¿è¯æ˜¯ç”±å…¶ä»–çº¿ç¨‹å°†å…¶notifyå”¤é†’ã€‚</li>
<li>ä¿æŠ¤å—ï¼šè‹¥synchronizedè¯­å¥åœ¨è°ƒç”¨waitä¹‹å‰åå¤æ£€æŸ¥æ¡ä»¶ï¼Œé‚£è¿™ä¸ªsynchronizedè¯­å¥ç§°ä¸ºä¿æŠ¤å—ã€‚é€šå¸¸ä»¥while loopçš„å½¢å¼å‡ºç°ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1">object SynchronizedPool extends App {
</span><span id="__span-41-2">  import scala.collection._
</span><span id="__span-41-3">  private val tasks = mutable.Queue[() =&gt; Unit]()
</span><span id="__span-41-4">  object Worker extends Thread {
</span><span id="__span-41-5">    setDaemon(true)
</span><span id="__span-41-6">    def poll() = tasks.synchronized {
</span><span id="__span-41-7">      //ä¿æŠ¤å—ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šé‡Šæ”¾é”å¹¶è¢«é˜»å¡ç­‰å¾…è¢«å”¤é†’
</span><span id="__span-41-8">      while (tasks.isEmpty) tasks.wait()
</span><span id="__span-41-9">      tasks.dequeue()
</span><span id="__span-41-10">    }
</span><span id="__span-41-11">    override def run() = while (true) {
</span><span id="__span-41-12">      val task = poll()
</span><span id="__span-41-13">      task()
</span><span id="__span-41-14">    }
</span><span id="__span-41-15">  }
</span><span id="__span-41-16">  Worker.start()
</span><span id="__span-41-17">  def asynchronous(body: =&gt;Unit) = tasks.synchronized {
</span><span id="__span-41-18">    tasks.enqueue(() =&gt; body)
</span><span id="__span-41-19">    tasks.notify()
</span><span id="__span-41-20">  }
</span><span id="__span-41-21">  asynchronous { log(&quot;Hello &quot;) }
</span><span id="__span-41-22">  asynchronous { log(&quot;World!&quot;) }
</span><span id="__span-41-23">  Thread.sleep(500)
</span><span id="__span-41-24">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_9">çº¿ç¨‹ä¸­æ–­ä¸å¹³æ»‘å…³é—­<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<p>workerçº¿ç¨‹ä¼˜åŒ–ï¼šå³ä½¿æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå‡ºäºä¼‘çœ çŠ¶æ€ï¼Œä½†æ˜¯æ‰€å æ®çš„æ ˆç©ºé—´ä¸€ç›´éƒ½åœ¨ã€‚å¦‚æœä¼‘çœ çº¿ç¨‹å¤ªå¤šï¼Œå†…å­˜å°±ä¼šè¢«ç”¨å®Œã€‚</p>
<p>ç»“æŸä¼‘çœ çº¿ç¨‹çš„æ–¹æ³•ï¼š</p>
<ol>
<li>ä¸­æ–­çº¿ç¨‹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æˆ–è®¡æ—¶ç­‰å¾…æ—¶ï¼Œè°ƒç”¨å…¶ interrupt æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExptionå¼‚å¸¸ã€‚æ­¤å¼‚å¸¸å¯ä»¥è¢«æ•è·å’Œå¤„ç†ï¼Œä½†åœ¨è¿™é‡Œï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»ˆæ­¢çº¿ç¨‹Workerã€‚ä¸è¿‡ï¼Œå¦‚æœå¯¹è¿è¡Œä¸­çš„çº¿ç¨‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå¼‚å¸¸å°±ä¸ä¼šäº§ç”Ÿï¼Œè€Œæ˜¯è®¾ç½®çº¿ç¨‹çš„interrupt æ ‡å¿—ã€‚å¯¹äºä¸é˜»å¡çš„çº¿ç¨‹å¿…é¡»å‘¨æœŸæ€§åœ°ç”¨isInterrupted æ–¹æ³•æŸ¥è¯¢interruptæ ‡å¿—ã€‚</li>
<li>å¹³æ»‘å…³é—­ï¼šåœ¨å¹³æ»‘å…³é—­ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹è®¾ç½®ç»ˆæ­¢æ¡ä»¶ï¼Œç„¶åè°ƒç”¨notifyæ¥å”¤é†’å·¥ä½œçº¿ç¨‹ã€‚ç„¶åï¼Œå·¥ä½œçº¿ç¨‹ä¼šé‡Šæ”¾å®ƒæ‰€æœ‰çš„èµ„æºï¼Œå¹¶é¡ºåˆ©åœ°ç»“æŸã€‚</li>
<li>ä¸¤è€…çš„é€‰æ‹©ï¼šå¦‚æœnotifyä¸èƒ½å†æ¬¡å”¤é†’çº¿ç¨‹ï¼Œå°±è¦ä½¿ç”¨ä¸»åŠ¨ä¸­æ–­çš„æ–¹å¼ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1">object SynchronizedPool extends App {
</span><span id="__span-42-2">
</span><span id="__span-42-3">  import scala.collection._
</span><span id="__span-42-4">
</span><span id="__span-42-5">  private val tasks = mutable.Queue[() =&gt; Unit]()
</span><span id="__span-42-6">
</span><span id="__span-42-7">  object Worker extends Thread {
</span><span id="__span-42-8">    var terminated = false
</span><span id="__span-42-9">    def poll(): Option[() =&gt; Unit] = tasks.synchronized {
</span><span id="__span-42-10">      while (tasks.isEmpty &amp;&amp; !terminated) tasks.wait()
</span><span id="__span-42-11">      if (!terminated) Some(tasks.dequeue()) else None
</span><span id="__span-42-12">    }
</span><span id="__span-42-13">    import scala.annotation.tailrec
</span><span id="__span-42-14">    @tailrec override def run() = poll() match {
</span><span id="__span-42-15">      //åœ¨pollè¿”å›Someæ—¶ï¼Œä¼šç»§ç»­æ‰§è¡Œrunï¼Œç›´åˆ°è¿”å›None
</span><span id="__span-42-16">      //ä½¿ç”¨äº†å°¾é€’å½’ä¼˜åŒ–
</span><span id="__span-42-17">      case Some(task) =&gt; task(); run()
</span><span id="__span-42-18">      case None =&gt;
</span><span id="__span-42-19">    }
</span><span id="__span-42-20">    def shutdown() = tasks.synchronized {
</span><span id="__span-42-21">      terminated = true
</span><span id="__span-42-22">      tasks.notify()
</span><span id="__span-42-23">    }
</span><span id="__span-42-24">  }
</span><span id="__span-42-25">
</span><span id="__span-42-26">  Worker.start()
</span><span id="__span-42-27">
</span><span id="__span-42-28">  def asynchronous(body: =&gt; Unit) = tasks.synchronized {
</span><span id="__span-42-29">    tasks.enqueue(() =&gt; body)
</span><span id="__span-42-30">    tasks.notify()
</span><span id="__span-42-31">  }
</span><span id="__span-42-32">
</span><span id="__span-42-33">  asynchronous {
</span><span id="__span-42-34">    log(&quot;Hello &quot;)
</span><span id="__span-42-35">  }
</span><span id="__span-42-36">  asynchronous {
</span><span id="__span-42-37">    log(&quot;World!&quot;)
</span><span id="__span-42-38">  }
</span><span id="__span-42-39">  Thread.sleep(500)
</span><span id="__span-42-40">  Worker.shutdown()
</span><span id="__span-42-41">}
</span></code></pre></div></td></tr></table></div>
<h3 id="23volatile">2.3æ˜“å¤±(volatile)å˜é‡<a class="headerlink" href="#23volatile" title="Permanent link">&para;</a></h3>
<ol>
<li>å®šä¹‰ï¼šJVMè¿˜æä¾›äº†ä¸€ç§æ¯”synchronizedä»£ç å—æ›´è½»é‡çº§çš„åŒæ­¥å½¢å¼ï¼Œç§°ä¸ºæ˜“å¤±å˜é‡ã€‚æ˜“å¤±å˜é‡å¯ä¾›äºåŸå­æ€§è¯»å†™ï¼Œå¸¸ç”¨äºè¡¨ç¤ºçŠ¶æ€æ ‡å¿—ã€‚æ¯”å¦‚ï¼Œæ ‡è®°æŸä¸ªè®¡ç®—æ˜¯å¦å®Œæˆã€æ˜¯å¦å–æ¶ˆã€‚è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œç¬¬ä¸€æ˜¯å•ä¸ªçº¿ç¨‹ä¸­æ˜“å¤±å˜é‡çš„è¯»æ“ä½œå’Œå†™æ“ä½œä¸ä¼šé‡æ’åºï¼Œç¬¬äºŒæ˜¯æ˜“å¤±å˜é‡çš„å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹æ˜¯ç«‹å³å¯è§çš„ã€‚å¦‚æœå¯¹ä¸€ä¸ªæ˜“å¤±å˜é‡vè¿›è¡Œå†™æ“ä½œWï¼Œè¿™è¢«å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å¯¹å˜é‡vçš„è¯»æ“ä½œRè§‚å¯Ÿï¼Œé‚£ä¹ˆåœ¨Wä¹‹å‰è¯¥å˜é‡çš„æ‰€æœ‰å†™æ“ä½œéƒ½å¯ä»¥åœ¨Rä¹‹åè§‚å¯Ÿåˆ°ã€‚</li>
<li>Scalaçš„volatileå˜é‡æ€§è´¨</li>
</ol>
<p>å’ŒJavaä¸ä¸€æ ·ï¼ŒScalaæ”¯æŒå£°æ˜å±€éƒ¨ï¼ˆæœ¬ç¤ºä¾‹æŒ‡çš„æ˜¯forå¾ªç¯çš„é—­åŒ…ï¼‰æ˜“å¤±å˜é‡ã€‚å¯¹äºé—­åŒ…æˆ–åµŒå¥—ç±»ä¸­çš„æ¯ä¸ªå±€éƒ¨æ˜“å¤±å˜é‡ï¼ŒScalaéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æ˜“å¤±å­—æ®µçš„å †å¯¹è±¡ã€‚äºæ˜¯ï¼Œå¯ä»¥ç§°è¿™äº›å±€éƒ¨æ˜“å¤±å˜é‡è¢«æå‡ä¸ºå¯¹è±¡ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1">class Page(val txt: String, var position: Int)
</span><span id="__span-43-2">object Volatile extends App {
</span><span id="__span-43-3">  val pages = for (i&lt;- 1 to 5) yield
</span><span id="__span-43-4">    new Page(&quot;Na&quot; * (100 - 20 * i) + &quot; Batman!&quot;, -1)
</span><span id="__span-43-5">  @volatile var found = false
</span><span id="__span-43-6">  for (p &lt;- pages) yield thread {
</span><span id="__span-43-7">    var i = 0
</span><span id="__span-43-8">    while (i &lt; p.txt.length &amp;&amp; !found)
</span><span id="__span-43-9">      if (p.txt(i) == &#39;!&#39;) {
</span><span id="__span-43-10">        p.position = i
</span><span id="__span-43-11">        found = true
</span><span id="__span-43-12">      } else i += 1
</span><span id="__span-43-13">  }
</span><span id="__span-43-14">  while (!found) {}
</span><span id="__span-43-15">  log(s&quot;results: ${pages.map(_.position)}&quot;)
</span><span id="__span-43-16">}
</span></code></pre></div></td></tr></table></div>
<h3 id="24-jmm">2.4 JMM<a class="headerlink" href="#24-jmm" title="Permanent link">&para;</a></h3>
<ol>
<li>å®šä¹‰ï¼šä¸€ä¸ªè¯­è¨€çš„å†…å­˜æ¨¡å‹æŒ‡çš„æ˜¯ä¸€ç§è§„èŒƒï¼Œå®ƒæè¿°äº†å˜é‡çš„å†™æ“ä½œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚Scala ç»§æ‰¿äº† JVM çš„å†…å­˜æ¨¡å‹ï¼Œè¯¥å†…å­˜æ¨¡å‹å®šä¹‰äº†ä¸€ç³»åˆ—ç¨‹åºä¸­å„ç§è¡Œä¸ºçš„å‰å‘ç”Ÿï¼ˆhappens-beforeï¼‰å…³ç³»ã€‚åœ¨JVMä¸Šã€‚è¿™äº›è¡Œä¸ºä¸­å¦‚æœä¸€ä¸ªè¡Œä¸ºAå‘ç”Ÿäºè¡Œä¸ºBä¹‹å‰ï¼Œåˆ™è¡Œä¸ºBå¯ä»¥å‘ç°è¡Œä¸ºAçš„å†…å­˜å†™æ“ä½œã€‚ç¨‹åºå‘˜éœ€è¦è‡ªå·±ä¿è¯ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œä¸æ‰€æœ‰æ­¤å˜é‡çš„æ–°å€¼çš„è¯»æ“ä½œæ„æˆå‰å‘ç”Ÿå…³ç³»ã€‚</li>
<li>è¡Œä¸ºç§ç±»ï¼š</li>
<li>ç¨‹åºæŒ‡ä»¤é¡ºåºï¼šçº¿ç¨‹ä¸­çš„ç¨‹åºæŒ‡ä»¤é¡ºåºå†³å®šäº†å„ä¸ªè¡Œä¸ºçš„å…ˆåå‘ç”Ÿé¡ºåº</li>
<li>ç›‘æ§å™¨é”å®šï¼šå¯¹ä¸€ä¸ªç›‘æ§å™¨çš„è§£é”å‘ç”Ÿåœ¨è¢«æ­¤ç›‘æ§å™¨åç»­è¢«é”å®šä¹‹å‰</li>
<li>volatileå­—æ®µï¼šè¯¥å­—æ®µçš„å†™æ“ä½œå‘ç”Ÿåœ¨è¯»æ“ä½œä¹‹å</li>
<li>çº¿ç¨‹å¯åŠ¨ï¼šçº¿ç¨‹çš„startæ–¹æ³•å‘ç”Ÿåœ¨è¯¥çº¿ç¨‹æ‰€æœ‰è¡Œä¸ºä¹‹å‰</li>
<li>çº¿ç¨‹ç»ˆæ­¢ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»»æ„è¡Œä¸ºå‘ç”Ÿåœ¨å¦ä¸€ä¸ªçº¿ç¨‹å®Œæˆå…¶joinæ–¹æ³•ä¹‹å‰</li>
<li>ä¼ é€’æ€§ï¼šå¦‚æœè¡Œä¸ºAå‘ç”Ÿåœ¨è¡Œä¸ºBä¹‹å‰ï¼Œè€Œè¡Œä¸ºBå‘ç”Ÿåœ¨è¡Œä¸ºCä¹‹å‰ï¼Œåˆ™è¡Œä¸ºAå‘ç”Ÿåœ¨è¡Œä¸ºCä¹‹å‰ã€‚</li>
<li>å‰å‘ç”Ÿå…³ç³»çš„å…¶ä»–æ€§è´¨ï¼š</li>
</ol>
<p>â— éæ˜“å¤±è¯»æ“ä½œä¸èƒ½é€šè¿‡é‡æ’åºå‡ºç°åœ¨ç¨‹åºæŒ‡ä»¤é¡ºåºæ›´é å‰çš„ç¨‹åºæ˜“å¤±è¯»æ“ä½œï¼ˆæˆ–ç›‘æ§å™¨é”å®šï¼‰ä¹‹å‰ã€‚</p>
<p>â— éæ˜“å¤±å†™æ“ä½œä¸èƒ½é€šè¿‡é‡æ’åºå‡ºç°åœ¨ç¨‹åºæŒ‡ä»¤é¡ºåºæ›´é åçš„æ˜“å¤±å†™æ“ä½œï¼ˆæˆ–ç›‘æ§å™¨è§£é”ï¼‰ä¹‹åã€‚</p>
<p>ä¹Ÿå°±æ˜¯æœ€å…ˆvolatileè¯»ï¼Œæœ€åvolatileå†™</p>
<h3 id="_10">ç»ƒä¹ é¢˜ï¼š<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<ol>
<li>å®ç°ä¸€ä¸ªparallelæ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸¤ä¸ªè®¡ç®—ä»£ç å—aå’Œbï¼Œæ­¤æ–¹æ³•ç”¨ä¸¤ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸¤ä¸ªä»£ç å—ï¼Œå¹¶ç”¨ä¸€ä¸ªäºŒå…ƒç»„è¿”å›ä¸¤è€…çš„è®¡ç®—ç»“æœï¼Œå…¶å£°æ˜å¦‚ä¸‹ã€‚</li>
</ol>
<p>def parallel<a href="a: =&gt;A, b: =&gt;B">A, B</a>: (A, B)</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1">class Test02 {
</span><span id="__span-44-2">  def parallel[A, B](a: =&gt;A, b: =&gt;B): (A, B) = {
</span><span id="__span-44-3">    val t1 = new Thread{
</span><span id="__span-44-4">      var flag = false
</span><span id="__span-44-5">      override def run(): Unit = {
</span><span id="__span-44-6">        while(!flag){
</span><span id="__span-44-7">          log(&quot;waiting to get&quot;)
</span><span id="__span-44-8">          getResult()
</span><span id="__span-44-9">
</span><span id="__span-44-10">        }
</span><span id="__span-44-11">      }
</span><span id="__span-44-12">      //æŠŠbodyæ”¾åœ¨è¯¥å‡½æ•°è°ƒç”¨ä¸­ï¼Œå¹¶ä¸”æ§åˆ¶runæ–¹æ³•çš„ç»“æŸæ—¶æœº
</span><span id="__span-44-13">      def getResult(): A = {
</span><span id="__span-44-14">        flag = true
</span><span id="__span-44-15">        a
</span><span id="__span-44-16">      }
</span><span id="__span-44-17">
</span><span id="__span-44-18">    }
</span><span id="__span-44-19">    val t2 = new Thread{
</span><span id="__span-44-20">      var flag = false
</span><span id="__span-44-21">      override def run(): Unit = {
</span><span id="__span-44-22">        while(!flag){
</span><span id="__span-44-23">          log(&quot;waiting to get&quot;)
</span><span id="__span-44-24">          getResult()
</span><span id="__span-44-25">        }
</span><span id="__span-44-26">      }
</span><span id="__span-44-27">      def getResult():B= {
</span><span id="__span-44-28">        flag = true
</span><span id="__span-44-29">        b
</span><span id="__span-44-30">      }
</span><span id="__span-44-31">    }
</span><span id="__span-44-32">    t1.start()
</span><span id="__span-44-33">    t2.start()
</span><span id="__span-44-34">    //mainçº¿ç¨‹å¼€å§‹ç­‰å¾…å­çº¿ç¨‹çš„ç»“æœ
</span><span id="__span-44-35">    t1.join()
</span><span id="__span-44-36">    t2.join()
</span><span id="__span-44-37">    //è°ƒç”¨getResultä¹‹åï¼Œä¸¤ä¸ªçº¿ç¨‹æ‰ä¼šç»“æŸæ‰§è¡Œï¼Œè¿”å›åˆ°Mainçº¿ç¨‹
</span><span id="__span-44-38">    (t1.getResult(),t2.getResult())
</span><span id="__span-44-39">  }
</span><span id="__span-44-40">  @Test
</span><span id="__span-44-41">  def test01(): Unit = {
</span><span id="__span-44-42">    def fun1(): String = {
</span><span id="__span-44-43">      &quot;hello&quot;
</span><span id="__span-44-44">    }
</span><span id="__span-44-45">
</span><span id="__span-44-46">    def fun2(): Int = {
</span><span id="__span-44-47">      1
</span><span id="__span-44-48">    }
</span><span id="__span-44-49">    val (r1, r2) = parallel[String,Int](fun1 , fun2)
</span><span id="__span-44-50">    println(r1)
</span><span id="__span-44-51">    println(r2)
</span><span id="__span-44-52">  }
</span><span id="__span-44-53">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å®ç°ä¸€ä¸ª periodically æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªä»¥ms ä¸ºå•ä½çš„æ—¶é—´å‚æ•°durationï¼Œä»¥åŠä¸€ä¸ªè®¡ç®—ä»£ç å—bã€‚æ­¤æ–¹æ³•æ¯éš”duration msç”¨çº¿ç¨‹æ‰§è¡Œbã€‚æ­¤æ–¹æ³•çš„å£°æ˜å¦‚ä¸‹ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1">  def periodically(duration: Long)(b: =&gt;Unit): Unit  ={
</span><span id="__span-45-2">    val t = new Thread{
</span><span id="__span-45-3">      override def run(): Unit = {
</span><span id="__span-45-4">        while(true){
</span><span id="__span-45-5">          b
</span><span id="__span-45-6">          Thread.sleep(duration)
</span><span id="__span-45-7">        }
</span><span id="__span-45-8">      }
</span><span id="__span-45-9">    }
</span><span id="__span-45-10">    t.start()
</span><span id="__span-45-11">  }
</span></code></pre></div></td></tr></table></div>
<p>3ï¼Œ4 å®ç°å•å˜é‡çš„æ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1">class SyncVar[T] {
</span><span id="__span-46-2">  import scala.collection._
</span><span id="__span-46-3">  private var value = mutable.Queue[T]()
</span><span id="__span-46-4">  def get(): T = {
</span><span id="__span-46-5">    value.synchronized{
</span><span id="__span-46-6">      while(value.isEmpty) value.wait()
</span><span id="__span-46-7">      val res = value.dequeue()
</span><span id="__span-46-8">      value.notify()
</span><span id="__span-46-9">      res
</span><span id="__span-46-10">    }
</span><span id="__span-46-11">  }
</span><span id="__span-46-12">  def put(x: T): Unit = {
</span><span id="__span-46-13">    value.synchronized{
</span><span id="__span-46-14">      while(value.nonEmpty) value.wait()
</span><span id="__span-46-15">      value.enqueue(x)
</span><span id="__span-46-16">      value.notify()
</span><span id="__span-46-17">    }
</span><span id="__span-46-18">  }
</span><span id="__span-46-19">  def isEmpty():Boolean = value.isEmpty
</span><span id="__span-46-20">  def nonEmpty():Boolean = value.nonEmpty
</span><span id="__span-46-21">}
</span><span id="__span-46-22">
</span><span id="__span-46-23">object Test02 {
</span><span id="__span-46-24">  def main(args: Array[String]): Unit = {
</span><span id="__span-46-25">    val sv = new SyncVar[Int]
</span><span id="__span-46-26">    val producer = thread{
</span><span id="__span-46-27">      for(i &lt;- 0 until 15){
</span><span id="__span-46-28">        sv.put(i)
</span><span id="__span-46-29">      }
</span><span id="__span-46-30">    }
</span><span id="__span-46-31">    val consumer = thread{
</span><span id="__span-46-32">      var cnt = 0
</span><span id="__span-46-33">      while(cnt &lt; 15){
</span><span id="__span-46-34">        val x = sv.get()
</span><span id="__span-46-35">        println(x)
</span><span id="__span-46-36">        cnt += 1
</span><span id="__span-46-37">      }
</span><span id="__span-46-38">    }
</span><span id="__span-46-39">    producer.join()
</span><span id="__span-46-40">    consumer.join()
</span><span id="__span-46-41">    log(&quot;end&quot;)
</span><span id="__span-46-42">  }
</span><span id="__span-46-43">}
</span></code></pre></div></td></tr></table></div>
<h2 id="3_1">3.å¹¶å‘ç¼–ç¨‹çš„ä¼ ç»Ÿæ„é€ æ¨¡å—<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h2>
<h3 id="31executorexecutioncontext">3.1Executorå’ŒExecutionContextå¯¹è±¡<a class="headerlink" href="#31executorexecutioncontext" title="Permanent link">&para;</a></h3>
<ol>
<li>çº¿ç¨‹æ± ï¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éœ€è¦ä¸ºå®ƒçš„è°ƒç”¨æ ˆåˆ†é…ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡ç”¨äºçº¿ç¨‹åˆ‡æ¢ï¼Œåˆ‡æ¢ç”šè‡³è¦æ¯”æ‰§è¡Œå¹¶å‘ä»»åŠ¡æœ¬èº«æ›´è€—æ—¶ã€‚å‡ºäºè¿™ä¸ªè€ƒè™‘ï¼Œå¤§å¤šæ•°å¹¶å‘æ€§æ¡†æ¶ä¼šæä¾›å·¥å…·æ¥ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹é›†åˆï¼Œè®©è¿™äº›çº¿ç¨‹å¤„äºå¾…å‘½çŠ¶æ€ï¼Œä»¥éšæ—¶å¤„ç†æ–°å‡ºç°çš„å¹¶å‘æ€§ä»»åŠ¡ã€‚è¿™ç§å·¥å…·ä¸€èˆ¬ç§°ä¸ºçº¿ç¨‹æ± ã€‚</li>
<li>
<p>ExecutoræŠ½è±¡æ¥å£ï¼š</p>
</li>
<li>
<p>å®ƒåªæœ‰ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œåœ¨executeæ–¹æ³•é‡Œå¯ä»¥è°ƒç”¨è¿™ä¸ªRunnableå¯¹è±¡çš„runæ–¹æ³•ã€‚å®ƒä¼šä»çº¿ç¨‹æ± ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡ŒRunnableå¯¹è±¡ï¼Œè¯¥çº¿ç¨‹ä¸å½“å‰è°ƒç”¨executeæ–¹æ³•çš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚</p>
</li>
<li>ä½œç”¨ï¼šExecutor å¯¹è±¡çš„ä½œç”¨æ˜¯å°†å¹¶å‘è®¡ç®—å®šä¹‰å’Œå®ƒçš„æ‰§è¡Œæ–¹å¼è§£è€¦åˆï¼Œä»è€Œï¼Œç¨‹åºå‘˜å¯ä»¥é›†ä¸­ç²¾åŠ›ç¡®å®šå“ªäº›ä»£ç æ˜¯å¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¹¶å°†å®ƒä»¬ä¸è°ƒç”¨æ–¹å¼ï¼ˆä½•æ—¶ä½•åœ°ï¼‰åˆ†ç¦»å¼€</li>
<li>åœ¨Javaä¸­çš„å®ç°æ˜¯ForkJoinPoolï¼Œä½äºjava,util.concurrentåŒ…ä¸­ã€‚åœ¨Scalaä¸­ä½äºscala.concurrent.forkjoin</li>
<li>ä¾‹å­ï¼š</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1">import scala.concurrent._
</span><span id="__span-47-2">import java.util.concurrent.ForkJoinPool
</span><span id="__span-47-3">object ExecutorsCreate extends App {
</span><span id="__span-47-4">  //1.åˆ›å»ºçº¿ç¨‹æ± 
</span><span id="__span-47-5">  val executor = new ForkJoinPool
</span><span id="__span-47-6">  //2.ä¼ å…¥runnableæ¥å£çš„å®ç°ç±»
</span><span id="__span-47-7">  executor.execute(new Runnable {
</span><span id="__span-47-8">    def run() = log(&quot;This task is run asynchronously.&quot;)
</span><span id="__span-47-9">  })
</span><span id="__span-47-10">  Thread.sleep(500)
</span><span id="__span-47-11">  executor.shutdown()
</span><span id="__span-47-12">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ExecutorContextç‰¹è´¨</li>
</ol>
<p>scala.concurrentåŒ…å®šä¹‰äº†ExecutionContextç‰¹è´¨ï¼Œå’ŒExecutorå¯¹è±¡çš„åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒåªé’ˆå¯¹ Scalaç¨‹åºã€‚</p>
<p>ExecutionContext å®ç°äº†æŠ½è±¡çš„ execute æ–¹æ³•ï¼Œå¯¹åº”äº† Executor æ¥å£çš„executeæ–¹æ³•ï¼Œå®ƒè¿˜å®ç°äº†reportFailureæ–¹æ³•ï¼Œå‚æ•°ä¸ºä¸€ä¸ªThrowableå¯¹è±¡ï¼Œæ­¤ æ–¹æ³•åœ¨æŸä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šè¢«è°ƒç”¨ã€‚ExecutionContext ä¸­è¿˜å¸¦äº†ä¸€ä¸ªé»˜è®¤çš„æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç§°ä¸ºglobalï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†ForkJoinPoolå®ä¾‹ã€‚</p>
<p>åœ¨å…·æœ‰è¶…çº¿ç¨‹çš„å››æ ¸CPUä¸Šï¼Œå…¨å±€ExecutionContextå¯¹è±¡åœ¨çº¿ç¨‹æ± ä¸­æœ‰8ä¸ªçº¿ç¨‹ã€‚è€Œåœ¨æœ¬ç”µè„‘ä¸Šï¼Œçº¿ç¨‹æ± æœ‰16ä¸ªçº¿ç¨‹ã€‚</p>
<p>é¿å…å¯¹ExecutionContextå’ŒExecutorå¯¹è±¡æ‰§è¡Œå¯èƒ½æ— é™æœŸé˜»å¡çš„æ“ä½œï¼Œè€Œå¯¼è‡´çº¿ç¨‹é¥¥é¥¿</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1">object ExecutionContextGlobal extends App {
</span><span id="__span-48-2">  val ectx = ExecutionContext.global
</span><span id="__span-48-3">  ectx.execute(new Runnable {
</span><span id="__span-48-4">    def run() = log(&quot;Running on the execution context.&quot;)
</span><span id="__span-48-5">  })
</span><span id="__span-48-6">  Thread.sleep(500)
</span><span id="__span-48-7">}
</span></code></pre></div></td></tr></table></div>
<h3 id="32_1">3.2 åŸå­æ€§åŸè¯­<a class="headerlink" href="#32_1" title="Permanent link">&para;</a></h3>
<p>å†…å­˜å†™æ“ä½œçš„å¯è§æ€§æ˜¯ç”±å‰å‘ç”Ÿå…³ç³»æ¥ä¿è¯çš„ã€‚ç¬¬äºŒç« ä¸­ä½¿ç”¨çš„æ˜¯sychronizedæ¥å®ç°çš„å‰å‘ç”Ÿå…³ç³»ã€‚</p>
<p>åŸå­æ€§å˜é‡ï¼Œå®ƒæ”¯æŒä¸€æ¬¡æ€§æ‰§è¡Œå¤šæ¬¡å†…å­˜è¯»å†™æ“ä½œã€‚åŸå­æ€§å˜é‡æ˜¯æ˜“å¤±å˜é‡çš„è¿‘äº²ï¼Œä½†å…¶è¡¨è¾¾èƒ½åŠ›æ›´å¼ºï¼Œå¸¸ç”¨äºåœ¨æ— é¡»ä½¿ç”¨synchronized è¯­å¥çš„æƒ…å†µä¸‹æ„é€ å¤æ‚çš„å¹¶å‘æ“ä½œ</p>
<h4 id="_11">åŸå­æ€§å˜é‡<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p>å¯çº¿æ€§åŒ–æ“ä½œï¼š</p>
</li>
<li>
<p>å¯çº¿æ€§åŒ–æ“ä½œæŒ‡çš„æ˜¯å¯¹ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†è€Œè¨€å¯ç¬é—´å‘ç”Ÿçš„æ“ä½œ</p>
</li>
<li>ä¸€æ¬¡volatileè¯»æˆ–å†™å°±æ˜¯å¯çº¿æ€§åŒ–æ“ä½œ</li>
<li>å¤æ‚å¯çº¿æ€§åŒ–æ“ä½œï¼šè‡³å°‘åŒ…å«ä¸¤æ¬¡è¯»/å†™æ“ä½œ</li>
<li>java.util.concurrent.atomic</li>
<li>AtomicBoolean</li>
<li>AtomicInteger</li>
<li>AtomicLong</li>
<li>AtomicReference</li>
<li>ä¾‹å­ï¼š</li>
</ol>
<p>mainçº¿ç¨‹ä»¥åŠå…¶ä»–çº¿ç¨‹å‡è·å¾—å…¨å±€å”¯ä¸€uid</p>
<p>incrementAndGet()æ˜¯ä¸€ä¸ªå¤æ‚å¯çº¿æ€§åŒ–æ“ä½œï¼Œå®ƒåŒæ—¶å®ç°äº†è¯»å–uidçš„å½“å‰å€¼xï¼Œè®¡ç®—x+1ï¼Œç„¶åå°†x+1å†™å›åˆ°uidè¿™3ä¸ªæ“ä½œã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1">import java.util.concurrent.atomic._
</span><span id="__span-49-2">object AtomicUid extends App {
</span><span id="__span-49-3">  private val uid = new AtomicLong(0L)
</span><span id="__span-49-4">  def getUniqueId(): Long = uid.incrementAndGet()
</span><span id="__span-49-5">  for(i&lt;- 0 until 16){
</span><span id="__span-49-6">    execute { log(s&quot;Uid asynchronously: ${getUniqueId()}&quot;) }
</span><span id="__span-49-7">  }
</span><span id="__span-49-8">  log(s&quot;Got a unique id: ${getUniqueId()}&quot;)
</span><span id="__span-49-9">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>å¤æ‚å¯çº¿æ€§æ“ä½œçš„å®ç°åŸºç¡€ï¼š</li>
<li>compareAndSetæ“ä½œ(CAS)ã€‚ä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„testAndSetæŒ‡ä»¤</li>
<li>CASæ“ä½œä¼šè¯»å–åŸå­å˜é‡ä¹‹å‰çš„é¢„æœŸå€¼ä»¥åŠæ–°å€¼ï¼Œåªæœ‰å½“å‰å€¼ç­‰äºé¢„æœŸå€¼çš„æ—¶å€™ï¼Œæ‰åŸå­æ€§çš„å°†å½“å‰å€¼æ¢ä¸ºæ–°å€¼ã€‚å®ƒæ˜¯æ— é”ç¼–ç¨‹çš„åŸºç¡€æ€§æ„é€ </li>
<li>å’Œå…¶é€»è¾‘ç­‰ä»·çš„synchronizedä»£ç ï¼šä½†æ˜¯CASæŒ‡ä»¤æ›´é«˜æ•ˆä¸”åœ¨å¤§å¤šæ•°JVMä¸Šä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œå› ä¸ºå®ƒæ˜¯åŸºäºå¤„ç†å™¨æŒ‡ä»¤å®ç°çš„</li>
<li>åŸºæœ¬é€»è¾‘æ˜¯åŸºäºè¯»å–çš„å€¼ï¼Œè®¡ç®—å‡ºæ–°å€¼ï¼Œå¦‚æœç°åœ¨å˜é‡è¿˜æ˜¯åˆšæ‰è¯»å–æ—¶åˆ»çš„å€¼ï¼Œè¯æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜è¯¥å˜é‡ã€‚æ‰€ä»¥å¯ä»¥å°†æ–°å€¼å†™å…¥å†…å­˜ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1">def compareAndSet(ov: Long, nv: Long): Boolean =
</span><span id="__span-50-2">  this.synchronized {
</span><span id="__span-50-3">    if (this.get != ov) false else {
</span><span id="__span-50-4">      this.set(nv)
</span><span id="__span-50-5">      true
</span><span id="__span-50-6">    }
</span><span id="__span-50-7">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>ä½¿ç”¨CASæ“ä½œé‡æ–°å®ç°UID</li>
<li>å¦‚æœä¸æ»¡è¶³CASçš„compareæ¡ä»¶ï¼Œå°±ä¼šé€’å½’è°ƒç”¨è¿›è¡Œé‡è¯•ã€‚å¯ä»¥ä½¿ç”¨å°¾é€’å½’ä¼˜åŒ–é˜²æ­¢æ ˆçˆ†ç‚¸ã€‚</li>
<li>å…³äºæ— é™é€’å½’ï¼šä¸å¿…æ‹…å¿ƒï¼Œå› ä¸ºé€’å½’çš„æ¡ä»¶æ˜¯å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†æ“ä½œï¼Œè¿™ä¹Ÿå°±è¯æ˜ç³»ç»Ÿçš„æ•´ä½“æ˜¯å‘å‰è¿›è¡Œçš„ï¼Œå¿…ç„¶ä¸ä¼šæ— é™é€’å½’ã€‚</li>
<li>å¤§éƒ¨åˆ†JDKå®ç°incrementAndGetçš„æ–¹å¼ä¸è¿™é‡ŒåŸºäºCASçš„getUniqueIdçš„å®ç°æ–¹å¼ç±»ä¼¼ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1">object AtomicVar2 extends App {
</span><span id="__span-51-2">  private var uid = new AtomicLong(0L)
</span><span id="__span-51-3">  @tailrec def getUniqueId(): Long = {
</span><span id="__span-51-4">    val oldUid = uid.get
</span><span id="__span-51-5">    val newUid = oldUid + 1
</span><span id="__span-51-6">    if (uid.compareAndSet(oldUid, newUid)) newUid
</span><span id="__span-51-7">    else getUniqueId()
</span><span id="__span-51-8">  }
</span><span id="__span-51-9">  for(i&lt;- 0 until 16){
</span><span id="__span-51-10">    execute { log(s&quot;Uid asynchronously: ${getUniqueId()}&quot;) }
</span><span id="__span-51-11">  }
</span><span id="__span-51-12">  Thread.sleep(5000)
</span><span id="__span-51-13">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_12">æ— é”ç¼–ç¨‹<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<ol>
<li>ä¼˜ç‚¹</li>
</ol>
<p>åœ¨æ— é”çš„ç¨‹åºä¸­ï¼Œèµ„æºäº‰ç”¨ä¸å¤ªä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚æ‰§è¡Œæ— é”æ“ä½œçš„çº¿ç¨‹ä¸ä¼šå°è¯•è·å¾—ä»»ä½•é”ã€‚å› è€Œï¼Œå¾ˆå¤šæ— é”ç®—æ³•éƒ½æœ‰æ›´é«˜çš„ååé‡ã€‚æ‰§è¡Œæ— é”ç®—æ³•çš„çº¿ç¨‹å³ä½¿ä»æ“ä½œç³»ç»Ÿå¤„è·å¾—æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿä¸ä¼šå ç”¨ä»»ä½•é”ï¼Œå› è€Œä¸ä¼šé€ æˆå…¶ä»–çº¿ç¨‹çš„ä¸´æ—¶é˜»å¡ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹ä¼šç«‹åˆ»å»é‡è¯•ã€‚</p>
<p>æ— é”ç¼–ç¨‹å’Œæ­»é”æ— ç¼˜</p>
<ol>
<li>å®šä¹‰:å¯¹äºæ‰§è¡Œä¸€ä¸ªæ“ä½œçš„å¤šä¸ªçº¿ç¨‹ï¼Œä¸ç®¡å„çº¿ç¨‹æ‰§è¡Œé€Ÿåº¦å¦‚ä½•ï¼Œå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹æ€»èƒ½åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆæ­¤æ“ä½œï¼Œé‚£ä¹ˆè¯¥æ“ä½œæ˜¯æ— é”çš„ã€‚è€Œä¸æ˜¯å‡ºç°æ…¢çº¿ç¨‹é˜»å¡å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µã€‚</li>
</ol>
<h4 id="api">é”çš„å®ç°ä¸å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI<a class="headerlink" href="#api" title="Permanent link">&para;</a></h4>
<p>å°†ä½¿ç”¨åŸå­å˜é‡æ¥å®ç°é”ï¼Œå¹¶ä¸”ä¸éœ€è¦é˜»å¡è°ƒç”¨è€…ï¼Œä»è€Œå¯ä»¥è®©çº¿ç¨‹åœ¨æ— æ³•è·å¾—é”çš„æƒ…å†µä¸‹ä¸ç”¨è¢«é˜»å¡ã€‚</p>
<p>å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI</p>
<ol>
<li>éœ€æ±‚ï¼š</li>
<li>å¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆ›å»ºæ–°æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«å¤åˆ¶æˆ–è€…åˆ é™¤</li>
<li>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¤åˆ¶æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«åˆ é™¤</li>
<li>å¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆ é™¤ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«å¤åˆ¶</li>
<li>æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åˆ é™¤åŒä¸€ä¸ªæ–‡ä»¶</li>
</ol>
<p>æ€»ç»“ä¸º:å¢åŠ ï¼Œå¤åˆ¶ï¼Œåˆ é™¤</p>
<ol>
<li>è®¾è®¡å†…å®¹ï¼š</li>
<li>æ–‡ä»¶å’Œç›®å½•å»ºæ¨¡ï¼š<ol>
<li>Entryç±»çš„isDirå­—æ®µç”¨äºè¡¨ç¤ºå½“å‰å¯¹è±¡æ˜¯å¦ä¸ºç›®å½•æˆ–æ–‡ä»¶ã€‚</li>
<li>stateå­—æ®µæè¿°äº†æ–‡ä»¶çŠ¶æ€ï¼šæ–‡ä»¶æ˜¯å¦ç©ºé—²(idle)ã€åœ¨åˆ›å»ºä¸­()ã€åœ¨å¤åˆ¶ä¸­æˆ–å°†è¢«åˆ é™¤ã€‚è¿™äº›çŠ¶æ€ç”¨sealedç‰¹è´¨å»ºæ¨¡ï¼Œå‘½åä¸ºState(ä½¿ç”¨å¯†å°ç±»æ–¹ä¾¿æ¨¡å¼åŒ¹é…åˆ°æ‰€æœ‰æƒ…å†µ)</li>
<li>CpoyingçŠ¶æ€ä¸‹çš„å­—æ®µnç”¨æ¥è®°å½•ç›®å‰æœ‰å¤šå°‘ä¸ªå¤åˆ¶æ“ä½œ</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1">sealed trait State
</span><span id="__span-52-2">class Idle extends State
</span><span id="__span-52-3">class Creating extends State
</span><span id="__span-52-4">class Copying(val n:Int) extends State
</span><span id="__span-52-5">class Deleting extends State
</span><span id="__span-52-6">//å¯¹å•ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œå»ºæ¨¡
</span><span id="__span-52-7">class Entry(val isDir:Boolean){
</span><span id="__span-52-8">  val state = new AtomicReference[State]()
</span><span id="__span-52-9">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>çŠ¶æ€è½¬ç§»å›¾ï¼š</li>
</ol>
<p><img alt="image.png" src="../assets/%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB%E7%A4%BA%E6%84%8F%E5%9B%BE.png" /></p>
<ol>
<li>ä»£ç å®ç°ï¼š</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1">  private def prepareForDelete(entry: Entry):Boolean = {
</span><span id="__span-53-2">    /*
</span><span id="__span-53-3">    1.å¦‚æœstateæ˜¯Idleï¼Œåˆ™compareAndSetæˆåŠŸï¼Œè¿”å›true
</span><span id="__span-53-4">    2.è¯¥æ–¹æ³•è¿”å›çš„true,åˆ™è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹å¯ä»¥è¿›è¡Œæ–‡ä»¶çš„åˆ é™¤
</span><span id="__span-53-5">     */
</span><span id="__span-53-6">    val s0 = entry.state.get
</span><span id="__span-53-7">    s0 match {
</span><span id="__span-53-8">      case i:Idle =&gt; if(entry.state.compareAndSet(i,new Deleting)) true else prepareForDelete(entry)
</span><span id="__span-53-9">      case c:Creating =&gt; log(&quot;Cannot delete while creating&quot;);false
</span><span id="__span-53-10">      case c:Copying =&gt; log(&quot;Cannot delete while copying&quot;);false
</span><span id="__span-53-11">      case d:Deleting =&gt; false
</span><span id="__span-53-12">    }
</span><span id="__span-53-13">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>åœ¨åŸå­æ€§å¼•ç”¨å˜é‡ä¸Šçš„CASæŒ‡ä»¤æ€»æ˜¯ä½¿ç”¨å¼•ç”¨çš„ç­‰ä»·æ€§ï¼Œè€Œä¸ä¼šè°ƒç”¨equalsæ–¹æ³•ï¼Œå³ä½¿equalsæ–¹æ³•é‡è½½äº†ä¹Ÿä¸è¡Œã€‚</li>
<li>
<p>ABAé—®é¢˜ï¼š</p>
</li>
<li>
<p>å®šä¹‰ï¼šABAé—®é¢˜æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°çš„ä¸€ç§å†…å­˜è¯»å†™é€»è¾‘é—®é¢˜ã€‚å½“å¯¹åŒä¸€å†…å­˜åŒºåŸŸè¿›è¡Œä¸¤æ¬¡è¯»æ“ä½œæ—¶ï¼Œè‹¥å¾—åˆ°ç›¸åŒçš„Aå€¼ï¼Œä¸€èˆ¬ä¼šå‡è®¾ä¸¤æ¬¡è¯»æ“ä½œä¹‹é—´æ­¤å†…å­˜åŒºåŸŸæ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚ä½†è¿™ä¸€ç»“è®ºä¸ä¸€å®šå¯é ï¼Œå› ä¸ºåœ¨ä¸¤æ¬¡è¯»æ“ä½œä¹‹é—´æœ‰å¯èƒ½å‘ç”Ÿäº†å…ˆå†™å…¥Bå€¼ååˆæ¢å¤ä¸ºAå€¼çš„æƒ…å†µï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ABAé—®é¢˜ï¼Œ</p>
<ol>
<li>è®¾ç½®æ–‡ä»¶çš„copyçŠ¶æ€çš„è½¬æ¢çš„æ—¶å€™ï¼Œå¦‚æœæ¯æ¬¡å‡å°ä¸€ä¸ªcopyçº¿ç¨‹çš„æ—¶å€™ï¼Œä¿ç•™åŸæ¥çš„copyå¯¹è±¡ã€‚ç”¨æ¥åœ¨å¢åŠ copyçš„æ—¶å€™å¤ç”¨ï¼Œè¿™æ ·åšçš„æœ¬æ„æ˜¯é€šè¿‡å‡å°‘ç”Ÿæˆæ–°çš„ Copying å¯¹è±¡æ¥å‡å°åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œç„¶è€Œï¼Œè¿™ç§åšæ³•ä¼šäº§ç”Ÿä¹‹å‰æåˆ°çš„ABAé—®é¢˜ã€‚</li>
</ol>
</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"> def releaseCopy(e: Entry): Copying = e.state.get match {
</span><span id="__span-54-2">    case c: Copying =&gt;
</span><span id="__span-54-3">      val nstate = if (c.n == 1) new Idle else new Copying(c.n - 1)
</span><span id="__span-54-4">      if (e.state.compareAndSet(c, nstate)) c
</span><span id="__span-54-5">      else releaseCopy(e)
</span><span id="__span-54-6">  }
</span><span id="__span-54-7">  def acquireCopy(e: Entry, c: Copying) = e.state.get match {
</span><span id="__span-54-8">    case i: Idle =&gt; {
</span><span id="__span-54-9">      c.n = 1
</span><span id="__span-54-10">      if (!e.state.compareAndSet(i, c)) acquire(e, c)
</span><span id="__span-54-11">     }
</span><span id="__span-54-12">    case oc: Copying =&gt; {
</span><span id="__span-54-13">      c.n = oc.n + 1
</span><span id="__span-54-14">      if (!e.state.compareAndSet(oc, c)) acquire(e, c)
</span><span id="__span-54-15">    }
</span><span id="__span-54-16">  }
</span></code></pre></div></td></tr></table></div>
<p><img alt="image.png" src="../assets/cas%E7%A4%BA%E6%84%8F%E5%9B%BE.png" /></p>
<ol>
<li>è§£å†³åŠæ³•ï¼š</li>
<li>åªèƒ½å…·ä½“é—®é¢˜ï¼Œå…·ä½“åˆ†æã€‚æ­¤å¤„æ˜¯Atomicå¯¹è±¡ä¸­ä¿å­˜çš„æ˜¯copyä½œä¸ºäº†å¯å˜å¯¹è±¡(æœ¬æ¥nåº”è¯¥è®¾ç½®ä¸ºvalç±»å‹)ã€‚</li>
<li>JVMä¸Šçš„å¸¸è§„åšæ³•ï¼š<ol>
<li>ç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†å®ƒä»¬èµ‹å€¼ç»™AtomicReferenceå¯¹è±¡</li>
<li>åœ¨AtomicReferenceå¯¹è±¡å†…ä¿å­˜ä¸å¯å˜å¯¹è±¡</li>
<li>é¿å…å°†ä¹‹å‰å·²ç»èµ‹å€¼ç»™åŸå­æ€§å˜é‡çš„å€¼è¢«é‡æ–°èµ‹å€¼ã€‚</li>
<li>åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå•è°ƒé€’å¢æ•°å€¼å‹åŸå­æ€§å˜é‡ï¼Œå³è¦ä¹ˆä¸¥æ ¼é€’å‡ï¼Œè¦ä¹ˆä¸¥æ ¼é€’å¢</li>
</ol>
</li>
</ol>
<h3 id="33_1">3.3æ‡’å€¼<a class="headerlink" href="#33_1" title="Permanent link">&para;</a></h3>
<p>å¹¶å‘ç¨‹åºä¸­çš„æ‡’å€¼ä¼šäº§ç”Ÿæ„æ–™å¤–çš„è¡Œä¸ºï¼Œå¤šçº¿ç¨‹ç¨‹åºä¸­çš„æ‡’å€¼å¿…é¡»ä¿æŒç›¸åŒçš„è¯­ä¹‰ï¼›æ‡’å€¼åªæœ‰åœ¨è¢«æŸä¸ªçº¿ç¨‹è®¿é—®æ—¶æ‰ä¼šåˆå§‹åŒ–ï¼Œè€Œä¸”è‡³å¤šåˆå§‹åŒ–ä¸€æ¬¡ã€‚</p>
<p>scalaä½¿ç”¨åŒæ£€æŸ¥é”æœºåˆ¶ï¼Œä¿è¯æ‡’å€¼åœ¨è¢«çº¿ç¨‹è®¿é—®æ—¶æœ€å¤šè¢«åˆå§‹åŒ–ä¸€æ¬¡</p>
<p>ç»å¯¹ä¸è¦åœ¨å…¬å…±å¯¹è±¡ä¸Šä½¿ç”¨synchronizedè¯­å¥ï¼›åšæŒåœ¨ç‹¬ç«‹ä¸”ç§æœ‰çš„ç®€å•å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1">object LazyValsCreate extends App {
</span><span id="__span-55-2">  lazy val obj = new AnyRef
</span><span id="__span-55-3">  lazy val non = s&quot;made by ${Thread.currentThread.getName}&quot;
</span><span id="__span-55-4">  execute {
</span><span id="__span-55-5">    log(s&quot;EC sees obj = $obj&quot;)
</span><span id="__span-55-6">    log(s&quot;EC sees non = $non&quot;)
</span><span id="__span-55-7">  }
</span><span id="__span-55-8">  log(s&quot;Main sees obj = $obj&quot;)
</span><span id="__span-55-9">  log(s&quot;Main sees non = $non&quot;)
</span><span id="__span-55-10">  Thread.sleep(500)
</span><span id="__span-55-11">}
</span></code></pre></div></td></tr></table></div>
<h3 id="34_1">3.4 å¹¶å‘å®¹å™¨<a class="headerlink" href="#34_1" title="Permanent link">&para;</a></h3>
<p>scalaçš„æ ‡å‡†å®¹å™¨çš„å®ç°æ²¡æœ‰ä½¿ç”¨çº¿ç¨‹é”ï¼ŒåŒæ—¶å¯å˜å®¹å™¨èƒŒåçš„æ•°æ®ç»“æ„å¯èƒ½éå¸¸å¤æ‚</p>
<h4 id="_13">å¹¶å‘æ–¹æ¡ˆ<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1">//é”™è¯¯ç¤ºä¾‹ï¼šç›´æ¥å¤šçº¿ç¨‹è®¿é—®å¯å˜å®¹å™¨ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨åŒæ­¥æœºåˆ¶
</span><span id="__span-56-2">import scala.collection._
</span><span id="__span-56-3">object CollectionsBad extends App {
</span><span id="__span-56-4">  val buffer = mutable.ArrayBuffer[Int]()
</span><span id="__span-56-5">  def asyncAdd(numbers: Seq[Int]) = execute {
</span><span id="__span-56-6">    buffer ++= numbers
</span><span id="__span-56-7">    log(s&quot;buffer = $buffer&quot;)
</span><span id="__span-56-8">  }
</span><span id="__span-56-9">  asyncAdd(0 until 10)
</span><span id="__span-56-10">  asyncAdd(10 until 20)
</span><span id="__span-56-11">  Thread.sleep(500)
</span><span id="__span-56-12">}
</span></code></pre></div></td></tr></table></div>
<ul>
<li>æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸å¯å˜å®¹å™¨</li>
<li>æ€è·¯ï¼šå°†ä¸å¯å˜å®¹å™¨ä¸åŸå­å˜é‡çš„CASæ“ä½œç›¸ç»“åˆã€‚ä½†æ˜¯å¦‚æœå¤ªå¤šçº¿ç¨‹è®¿é—®åŸå­å˜é‡ï¼Œå¯èƒ½æœ‰å¯æ‰©å±•æ€§é—®é¢˜ã€‚</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1">class AtomicBuffer[T] {
</span><span id="__span-57-2">  private val buffer = new AtomicReference[List[T]](Nil)
</span><span id="__span-57-3">  def preappend(x: T): Unit = {
</span><span id="__span-57-4">    val xs = buffer.get
</span><span id="__span-57-5">    val nxs = x::xs
</span><span id="__span-57-6">    if(!buffer.compareAndSet(xs,nxs)) preappend(x) // tail-recursive
</span><span id="__span-57-7">  }
</span><span id="__span-57-8">}
</span></code></pre></div></td></tr></table></div>
<ul>
<li>æ–¹æ¡ˆ2ï¼šä½¿ç”¨å¯å˜å®¹å™¨</li>
<li>æ€è·¯ï¼šå¿…é¡»å°†ç›¸å…³æ“ä½œæ”¾å…¥synchronizedè¯­å¥ä¸­</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1">def asyncAdd(numbers: Seq[Int]) = execute {
</span><span id="__span-58-2">  buffer.synchronized {
</span><span id="__span-58-3">    buffer ++= numbers
</span><span id="__span-58-4">    log(s&quot;buffer = $buffer&quot;)
</span><span id="__span-58-5">  }
</span><span id="__span-58-6">}
</span></code></pre></div></td></tr></table></div>
<h4 id="api_1">å¹¶å‘é˜Ÿåˆ—å’Œå¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI<a class="headerlink" href="#api_1" title="Permanent link">&para;</a></h4>
<ol>
<li>æ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼</li>
</ol>
<p>å¹¶å‘ç¼–ç¨‹ä¸­é‡‡ç”¨çš„ä¸€ç§å¸¸è§æ¨¡å¼æ˜¯ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…æ¨¡å¼ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œä¸åŒéƒ¨åˆ†çš„è®¡ç®—ä»»åŠ¡çš„è´£ä»»è¢«åˆ’åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ã€‚æ¯”å¦‚ï¼Œåœ¨FTPæœåŠ¡å™¨ä¸­ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è´Ÿè´£ä»ç£ç›˜ä¸Šè¯»å–å¤§æ–‡ä»¶çš„æ•°æ®å—ã€‚è¿™äº›çº¿ç¨‹è¢«ç§°ä¸ºç”Ÿäº§è€…ã€‚å¦å¤–ä¸€äº›çº¿ç¨‹åˆ™è´Ÿè´£å°†æ•°æ®å—å‘é€åˆ°ç½‘ç»œä¸­ï¼Œè¿™ç±»çº¿ç¨‹ç§°ä¸ºæ¶ˆè´¹è€…ã€‚</p>
<ol>
<li>å¹¶å‘é˜Ÿåˆ—çš„ä¸‰ç§æ“ä½œï¼š</li>
<li>ç”Ÿäº§è€…å‘é˜Ÿåˆ—åŠ å…¥å·¥ä½œè¦ç´ çš„enqueueæ“ä½œ</li>
<li>æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·¥ä½œè¦ç´ çš„dequeueæ“ä½œ</li>
<li>inspectæ“ä½œï¼šç”¨äºæ¢æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¹¶æ£€æŸ¥ä¸‹ä¸€ä¸ªå…ƒç´ çš„å€¼</li>
<li>å¹¶å‘é˜Ÿåˆ—å¯ä»¥æœ‰ç•Œï¼Œå¯ä»¥æ— ç•Œã€‚ä¸åŒçš„å¹¶å‘é˜Ÿåˆ—çš„ä¸»è¦åŒºåˆ«æ˜¯å¯¹äºé˜Ÿåˆ—æ»¡ä»¥åŠé˜Ÿåˆ—ç©ºçš„æ“ä½œä¸åŒï¼Œå¯ä»¥ä½¿ç”¨é˜»å¡å¼ï¼Œæ¯”å¦‚JDKåœ¨java.util.concurrentåŒ…ä¸­æä¾›äº†BlockingQueueã€‚scalaçš„é˜»å¡å¼å¹¶å‘é˜Ÿåˆ—åœ¨scala.concurrentåŒ…ä¸‹ã€‚</li>
</ol>
<p><img alt="image.png" src="../assets/queue-api.png" /></p>
<ol>
<li>å…·ä½“å®ç°ç±»ï¼š</li>
<li>ArrayBlockingQueue ç±»æ˜¯ä¸€ç§æœ‰ç•Œé˜»å¡é˜Ÿåˆ—çš„å…·ä½“å®ç°ã€‚åœ¨åˆ›å»ºçš„æ—¶å€™éœ€è¦æŒ‡å®šå¤§å°ã€‚å¦‚æœç”Ÿäº§è€…æ½œåœ¨çš„ç”Ÿäº§é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ï¼Œåˆ™éœ€è¦ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚å¦åˆ™ï¼Œé˜Ÿåˆ—ä¼šä¸æ–­å¢å¤§ï¼Œä»¥è‡³äºè€—å°½æ‰€æœ‰ç³»ç»Ÿå†…å­˜ã€‚</li>
<li>LinkedBlockingQueueæ˜¯æ— ç•Œçš„ã€‚å…¶åº”ç”¨äºæ¶ˆè´¹è€…æ€»æ˜¯æ¯”ç”Ÿäº§è€…æ•ˆç‡æ›´é«˜çš„æƒ…å†µã€‚</li>
<li>å¹¶å‘å®¹å™¨çš„è¿­ä»£å™¨éƒ½åªæ˜¯è®°å½•æŸä¸€æ—¶åˆ»çš„çŠ¶æ€ã€‚</li>
<li>å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPIçš„è¿›ä¸€æ­¥å®ç°</li>
<li>å¯¹äºå¹¶å‘FS çš„APIå‘å‡ºçš„å„ç§æ¶ˆæ¯ï¼Œä½¿ç”¨LInkedBlockingQueueè¿›è¡Œç¼“å­˜ã€‚è¯¥å¹¶å‘é˜Ÿåˆ—æ˜¯é˜»å¡æ–¹å¼çš„ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1">//ç¼“å­˜é˜Ÿåˆ—
</span><span id="__span-59-2">private val messages = new LinkedBlockingQueue[String]
</span><span id="__span-59-3">//ç‹¬ç«‹çš„å®ˆæŠ¤è¿›ç¨‹
</span><span id="__span-59-4">val logger = new Thread {
</span><span id="__span-59-5">  setDaemon(true)
</span><span id="__span-59-6">  override def run() = while (true) log(messages.take())
</span><span id="__span-59-7">}
</span><span id="__span-59-8">logger.start()
</span><span id="__span-59-9">def logMessage(msg: String): Unit = messages.offer(msg)
</span></code></pre></div></td></tr></table></div>
<h4 id="api_2">å¹¶å‘æ˜ å°„ ä»¥åŠå¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI<a class="headerlink" href="#api_2" title="Permanent link">&para;</a></h4>
<p>ä¸å¹¶å‘é˜Ÿåˆ—ä¸åŒï¼Œå› ä¸ºå¹¶å‘é˜Ÿåˆ—ä¸»è¦ç”¨äºæ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼ï¼Œä½†æ˜¯å¹¶å‘é›†åˆä¸æ˜ å°„ä¸»è¦ç”¨äºç¨‹åºçš„çŠ¶æ€ç¼–ç ã€‚æ‰€ä»¥å¹¶å‘é›†åˆä»¥åŠæ˜ å°„å¹¶æ²¡æœ‰é˜»å¡çš„ç‰ˆæœ¬ã€‚</p>
<p>å¹¶å‘æ–‡ä»¶ç³»ç»Ÿè¿›ä¸€æ­¥è®¾è®¡</p>
<ul>
<li>å°†java.util.concurrentåŒ…ä¸‹çš„å¹¶å‘æ˜ å°„é€šè¿‡asScalaæ–¹æ³•è½¬æ¢ä¸ºscalaé›†åˆæ¡†æ¶</li>
<li>é€šè¿‡ä½¿ç”¨Mapç»“æ„å°†æ–‡ä»¶è·¯å¾„ä¸æ–‡ä»¶å¯¹è±¡å¯¹åº”</li>
<li>ä½¿ç”¨org.apache.commons.io.FileUtilså·¥å…·ç±»æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¿­ä»£ï¼Œæ–¹å¼æ˜¯éé€’å½’</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1">import scala.collection.convert.decorateAsScala._
</span><span id="__span-60-2">import java.io.File
</span><span id="__span-60-3">import org.apache.commons.io.FileUtils
</span><span id="__span-60-4">class FileSystem(val root: String) {
</span><span id="__span-60-5">  val rootDir = new File(root)
</span><span id="__span-60-6">  val files: concurrent.Map[String, Entry] =
</span><span id="__span-60-7">    new ConcurrentHashMap().asScala
</span><span id="__span-60-8">  for (f &lt;- FileUtils.iterateFiles(rootDir, null, false).asScala)
</span><span id="__span-60-9">  files.put(f.getName, new Entry(false))
</span><span id="__span-60-10">}
</span></code></pre></div></td></tr></table></div>
<p>å¹¶å‘æ˜ å°„çš„API</p>
<p><img alt="image.png" src="../assets/con-map-api.png" /></p>
<p>å¹¶å‘æ–‡ä»¶ç³»ç»Ÿçš„copyçŠ¶æ€å˜åŒ–ä»¥åŠæ“ä½œ</p>
<p>å‰ç½®æ“ä½œï¼š</p>
<ul>
<li>copyæ“ä½œä»…ä»…å‘ç”Ÿåœ¨æ–‡ä»¶å¤„äº Idle æˆ– CopyingçŠ¶æ€æ—¶ï¼Œç„¶åè¿˜éœ€è¦åŸå­æ€§åœ°å°†æ–‡ä»¶çŠ¶æ€ä»Idleå˜æˆCopyingï¼Œæˆ–å°†Copyingå˜æˆå¦ä¸€ç§CopyingçŠ¶æ€ï¼Œå¹¶å°†né€’å¢ã€‚</li>
<li>releaseæ“ä½œï¼Œå®ƒå°†é€’å‡CopyingçŠ¶æ€çš„è®¡æ•°ï¼Œæˆ–å°†CopyingçŠ¶æ€ä¿®æ”¹ä¸ºIdleçŠ¶æ€ã€‚æ³¨æ„ï¼Œæ­¤æ–¹æ³•å¿…é¡»åœ¨æ–‡ä»¶åˆ›å»ºä¹‹åè°ƒç”¨ï¼Œä»¥ä¾¿å°†CreatingçŠ¶æ€åˆ‡æ¢è‡³IdleçŠ¶æ€ã€‚</li>
</ul>
<p>copyFileæ–¹æ³•å®ç°ï¼š</p>
<ul>
<li>æç«¯æ­¤æ–¹æ³•ä¼šå…ˆæ£€æŸ¥filesæ˜ å°„ä¸­æ˜¯å¦å­˜åœ¨srcé¡¹ï¼Œå¦‚æœå­˜åœ¨ï¼ŒcopyFileä¼šå¯åŠ¨ä¸€ä¸ªå¹¶å‘ä»»åŠ¡æ¥å¤åˆ¶æ–‡ä»¶ã€‚</li>
<li>æ­¤å¹¶å‘ä»»åŠ¡å°è¯•è·å¾—æ­¤æ–‡ä»¶çš„æ§åˆ¶æƒï¼Œå¤åˆ¶æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå¤„äº Creating çŠ¶æ€çš„æ–°çš„destEntryæ–‡ä»¶é¡¹ã€‚</li>
<li>ç„¶åè°ƒç”¨putIfAbsentæ–¹æ³•ï¼Œå®ƒä¼šåŸå­æ€§åœ°æ£€æŸ¥ç›®æ ‡æ–‡ä»¶è·¯å¾„æ˜¯å¦ä½äºæ˜ å°„ä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ·»åŠ (dest,destEntry)ã€‚</li>
<li>æ­¤æ—¶ï¼ŒsrcEntry å’ŒdestEntryè¿™ä¸¤é¡¹éƒ½å¤„äºé”å®šçŠ¶æ€ï¼Œæ‰€ä»¥CommonsIOåº“ä¸­çš„FileUtils.copyFileå¯ç”¨äºè¿›è¡Œç£ç›˜ä¸Šçš„å¤åˆ¶æ“ä½œã€‚ä¸€æ—¦å¤åˆ¶å®Œæˆï¼ŒsrcEntryå’ŒdestEntryéƒ½ä¼šè¢«é‡Šæ”¾ã€‚</li>
</ul>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1">  //copyFileçš„å‡†å¤‡1
</span><span id="__span-61-2">  @tailrec private def acquire(entry: Entry): Boolean = {
</span><span id="__span-61-3">    val s0 = entry.state.get
</span><span id="__span-61-4">    s0 match {
</span><span id="__span-61-5">      case _: Creating | _: Deleting =&gt; {
</span><span id="__span-61-6">        logMessage(&quot;File inaccessible, cannot copy.&quot;)
</span><span id="__span-61-7">        false
</span><span id="__span-61-8">      }
</span><span id="__span-61-9">      case i: Idle =&gt; {
</span><span id="__span-61-10">        if (entry.state.compareAndSet(s0, new Copying(1))) true else acquire(entry)
</span><span id="__span-61-11">      }
</span><span id="__span-61-12">      case c: Copying =&gt; {
</span><span id="__span-61-13">        if (entry.state.compareAndSet(s0, new Copying(c.n + 1))) true else acquire(entry)
</span><span id="__span-61-14">      }
</span><span id="__span-61-15">    }
</span><span id="__span-61-16">  }
</span><span id="__span-61-17">
</span><span id="__span-61-18">  //copyFileçš„å‡†å¤‡2
</span><span id="__span-61-19">  @tailrec private def release(entry: Entry): Unit = {
</span><span id="__span-61-20">    val s0 = entry.state.get
</span><span id="__span-61-21">    s0 match {
</span><span id="__span-61-22">      case _: Creating =&gt; {
</span><span id="__span-61-23">        if (!entry.state.compareAndSet(s0, new Idle)) release(entry)
</span><span id="__span-61-24">      }
</span><span id="__span-61-25">      case c: Copying =&gt; {
</span><span id="__span-61-26">        val nstate = if (c.n == 1) new Idle else new Copying(c.n - 1)
</span><span id="__span-61-27">        if (!entry.state.compareAndSet(s0, nstate)) release(entry)
</span><span id="__span-61-28">      }
</span><span id="__span-61-29">    }
</span><span id="__span-61-30">  }
</span><span id="__span-61-31">
</span><span id="__span-61-32">  //copyFile
</span><span id="__span-61-33">  def copyFile(src: String, dest: String): Unit = {
</span><span id="__span-61-34">    files.get(src) match {
</span><span id="__span-61-35">      case None =&gt; logMessage(s&quot;Path &#39;$src&#39; does not exist!&quot;)
</span><span id="__span-61-36">      case Some(srcEntry) =&gt; {
</span><span id="__span-61-37">        if (!srcEntry.isDir) {
</span><span id="__span-61-38">          //åˆ›å»ºæ–°çš„å¤åˆ¶æ–‡ä»¶çº¿ç¨‹
</span><span id="__span-61-39">          execute {
</span><span id="__span-61-40">            if (acquire(srcEntry)) try {
</span><span id="__span-61-41">              val destEntry = new Entry(isDir = false)
</span><span id="__span-61-42">              //çŠ¶æ€æ˜¯æ­£åœ¨è¢«å¤åˆ¶ç”Ÿæˆ
</span><span id="__span-61-43">              destEntry.state.set(new Creating)
</span><span id="__span-61-44">              //è¿™é‡Œä½¿ç”¨çš„æ˜¯åŸå­æ“ä½œputIfAbsentï¼Œæ˜¯å°‘æœ‰çš„å¤æ‚çº¿æ€§åŒ–æ“ä½œ
</span><span id="__span-61-45">              files.putIfAbsent(dest, destEntry) match {
</span><span id="__span-61-46">                case None =&gt; {
</span><span id="__span-61-47">                  try {
</span><span id="__span-61-48">                    FileUtils.copyFile(new File(src), new File(dest))
</span><span id="__span-61-49">                  } finally release(destEntry)
</span><span id="__span-61-50">                }
</span><span id="__span-61-51">                case _ =&gt; logMessage(&quot;File already exists!&quot;)
</span><span id="__span-61-52">              }
</span><span id="__span-61-53">            } finally release(srcEntry)
</span><span id="__span-61-54">          }
</span><span id="__span-61-55">        }
</span><span id="__span-61-56">      }
</span><span id="__span-61-57">    }
</span><span id="__span-61-58">  }
</span></code></pre></div></td></tr></table></div>
<h4 id="_14">å¹¶å‘é›†åˆ<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>Set[T]ç±»å‹çš„å¹¶å‘é›†åˆå¯ç”¨ConcurrentMap[T,Unit]ç±»å‹æ¥æ¨¡æ‹Ÿï¼Œä¿ç•™é”®è€Œå¿½ç•¥å€¼å³å¯ã€‚è¿™ä¹Ÿæ˜¯å¹¶å‘æ¡†æ¶ä¸­è¾ƒå°‘å‡ºç°å¹¶å‘é›†åˆçš„å®ç°çš„åŸå› ã€‚</p>
<p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»å¯¹ä¸è¦ä½¿ç”¨nullä½œä¸ºå¹¶å‘æ˜ å°„/é›†åˆä¸­çš„é”®æˆ–å€¼ã€‚å¾ˆå¤šJVMä¸Šå®ç°çš„å¹¶å‘æ•°æ®ç»“æ„å°†nullè§†ä¸ºä¸€ç§ç‰¹æ®Šæ ‡è¯†ç¬¦ï¼Œç”¨æ¥è¡¨ç¤ºå…ƒç´ ä¸å­˜åœ¨ã€‚</p>
<h4 id="api_3">å¹¶å‘éå†(é›†åˆ) ä¸å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI<a class="headerlink" href="#api_3" title="Permanent link">&para;</a></h4>
<ol>
<li>Scala åœ¨å¹¶å‘å®¹å™¨çš„è®¿é—®ä¸Šæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚scala.collection. concurrentåŒ…ä¸­çš„TrieMapå®¹å™¨åŸºäºå¹¶å‘çš„Trieæ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ç§å¹¶å‘çš„æ˜ å°„æ•°æ®ç»“æ„ï¼Œå¯ä»¥äº§ç”Ÿå…·æœ‰ä¸€è‡´æ€§çš„éå†å™¨ã€‚</li>
</ol>
<p>å½“å…¶iteratoræ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒTrieMapå®¹å™¨ä¼šåŸå­æ€§åœ°å¯¹æ‰€æœ‰å…ƒç´ å®ç°ä¸€ä¸ªå¿«ç…§ã€‚å¿«ç…§æŒ‡çš„æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„çš„çŠ¶æ€çš„å®Œæ•´ä¿¡æ¯ã€‚ç„¶åï¼Œéå†å™¨ä½¿ç”¨è¿™ä¸ªå¿«ç…§æ¥éå†å…ƒç´ ã€‚å¦‚æœ TrieMap å®¹å™¨ä¹‹åè¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ­¤æ”¹åŠ¨åœ¨ä¹‹å‰çš„å¿«ç…§ä¸­æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤å¿«ç…§å’Œéå†å™¨å¹¶æ²¡æœ‰å‘ç°è¿™ä¸ªæ”¹åŠ¨</p>
<p>å®ƒå¯ç¡®ä¿åªå¤åˆ¶é‚£äº›è¢«ä¿®æ”¹çš„éƒ¨åˆ†ã€‚å¦‚æœæ²¡æœ‰å†å‘ç”Ÿå¹¶å‘çš„ä¿®æ”¹ï¼Œåˆ™TrieMapå®¹å™¨ä¹Ÿä¸å†éœ€è¦è¿›è¡Œå¤åˆ¶ã€‚</p>
<ol>
<li>ä½œç”¨ï¼š</li>
<li>æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éœ€è¦è·å¾—ä¸€ä¸ªä¸€è‡´æ€§çš„å¿«ç…§ï¼ŒåŒ…å«æŸä¸€æ—¶åˆ»æ–‡ä»¶ç®¡ç†å™¨æˆ– FTP æœåŠ¡å™¨çœ‹åˆ°çš„æ‰€æœ‰æ–‡ä»¶ã€‚</li>
<li>TrieMap å®¹å™¨å¯ä¿è¯åˆ é™¤æˆ–å¤åˆ¶æ–‡ä»¶çš„çº¿ç¨‹ä¸ä¼šå¹²æ¶‰æå–æ–‡ä»¶çš„çº¿ç¨‹</li>
<li>å¯ç”¨TrieMapå®¹å™¨å­˜å‚¨æ–‡ä»¶ï¼Œç„¶åï¼Œå®šä¹‰ä¸€ä¸ªç®€å•çš„allFilesæ–¹æ³•ï¼Œç”¨äºè¿”å›æ‰€æœ‰æ–‡ä»¶ã€‚åœ¨foræ¨å¯¼å¼ä¸­çš„filesæ˜ å°„ä¼šäº§ç”Ÿä¸€ä¸ªå¿«ç…§ï¼Œé‡Œé¢åŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚</li>
</ol>
<p>å¦‚æœåº”ç”¨ç¨‹åºéœ€è¦ä¸€è‡´æ€§éå†å™¨ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ TrieMap å®¹å™¨ã€‚</p>
<p>ä½†å¦‚æœä¸€è‡´æ€§éå†å™¨ä¸æ˜¯å¿…éœ€çš„ï¼Œå¹¶ä¸”å®¹å™¨æå°‘å‘ç”Ÿä¿®æ”¹ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ConcurrentHashMapå®¹å™¨ï¼Œå› ä¸ºå®ƒçš„æŸ¥è¯¢æ“ä½œé€Ÿåº¦è¦ç¨å¾®å¿«ä¸€äº›ã€‚</p>
<h3 id="35">3.5 å®šåˆ¶å¹¶å‘æ•°æ®ç»“æ„<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<h4 id="_15">å®ç°ä¸€ä¸ªæ— é”çš„å¹¶å‘æ± <a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<ol>
<li>åŠŸèƒ½ï¼šæ± æ˜¯ä¸€ç§ç®€å•çš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œå®ƒåªæœ‰ä¸¤ä¸ªæ“ä½œï¼Œå³addå’Œremoveæ“ä½œã€‚å…¶ä¸­addå°±æ˜¯æ± ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚æ± ä¸Šçš„removeæ“ä½œé™åˆ¶æ›´å¤šã€‚removeå¹¶ä¸æ˜¯ä»æ± ä¸­åˆ é™¤ä¸€ä¸ªå…·ä½“çš„å…ƒç´ ï¼Œè€Œæ˜¯åœ¨æ± éç©ºæ—¶åˆ é™¤ä»»æ„å…ƒç´ ã€‚é¡¾åæ€ä¹‰ï¼Œæ— é”çš„æ± æŒ‡çš„æ˜¯æ“ä½œä¸ç”¨ä¸Šé”çš„æ± ã€‚</li>
<li>ä½¿ç”¨åœºæ™¯ï¼šå› ä¸ºå®ƒå¯ç”¨äºä¸´æ—¶å­˜å‚¨ä¸€äº›é‡æ–°åˆ›å»ºä»£ä»·å¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚å·¥ä½œçº¿ç¨‹æˆ–æ•°æ®åº“è¿æ¥ã€‚å¯¹äºè¿™äº›åº”ç”¨åœºæ™¯ï¼Œç”¨æˆ·å¹¶ä¸å…³å¿ƒremoveåˆ é™¤çš„æ˜¯å“ªä¸ªå…ƒç´ ï¼Œåªè¦è¿”å›æŸä¸ªå…ƒç´ å³å¯ã€‚</li>
<li>
<p>æ•°æ®ç»“æ„çš„è¡¨è¾¾æ–¹å¼ï¼š</p>
</li>
<li>
<p>ä½¿ç”¨ä¸€ä¸ªä¸å¯å˜é“¾è¡¨è¿›è¡Œç»´æŠ¤</p>
<ul>
<li>å› ä¸ºè¦æ±‚æ¯ä¸ªæ“ä½œéƒ½æ˜¯æ— é”çš„ï¼Œæ‰€ä»¥ä½¿ç”¨CASè¿›è¡Œè®¾è®¡ã€‚å°†çŠ¶æ€ç¼–ç ä¸ºä¸€ä¸ªAtomicReferenceå¯¹è±¡ï¼Œç”¨å®ƒæ¥ä¿å­˜ä¸€ä¸ªä¸å¯å˜é“¾è¡¨çš„æŒ‡é’ˆã€‚</li>
<li>ä½¿ç”¨addæ–¹æ³•ï¼Œå°±æ˜¯å…ˆè¯»å–æ—§é“¾è¡¨ï¼Œåœ¨é“¾è¡¨å¤´éƒ¨æ·»åŠ å…ƒç´ ï¼Œè§¦å‘CASæ“ä½œï¼ŒåŒäºæ›¿æ¢æ—§é“¾è¡¨ï¼Œå¤±è´¥åˆ™è¿›è¡Œé‡è¯•ã€‚</li>
<li>removeæ–¹æ³•è¿‡ç¨‹ä¸addç±»ä¼¼ã€‚</li>
<li>ç¼ºç‚¹ï¼šè¿™ç§å®ç°æ–¹å¼çš„å¯æ‰©å±•æ€§å¹¶ä¸å¥½ã€‚å¤šä¸ªå¤„ç†å™¨éœ€è¦è®¿é—®åŒä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œä»è€Œä¼šå¯¼è‡´é‡è¯•è¿‡äºé¢‘ç¹ã€‚é¢„æœŸçš„æ“ä½œæ—¶é—´æ˜¯O(P)ï¼Œå…¶ä¸­ Pä¸ºå¹¶å‘æ‰§è¡Œaddå’Œremoveæ“ä½œçš„å¤„ç†å™¨æ•°ç›®</li>
</ul>
</li>
<li>
<p>ä½¿ç”¨å¤šä¸ªä¸å¯å˜é“¾è¡¨è¿›è¡Œç»´æŠ¤</p>
</li>
<li>
<p>éœ€è¦ä¸åŒçš„å¤„ç†å™¨æ›´æ–°æ•°æ®çš„æ—¶å€™è®¿é—®ä¸åŒçš„å†…å­˜ä½ç½®ã€‚</p>
</li>
<li>removeæ“ä½œå¹¶ä¸éœ€è¦æœç´¢å“ªä¸ªå…·ä½“çš„å…ƒç´ ï¼Œå®ƒåªè¦èƒ½è¿”å›ä»»æ„ä¸€ä¸ªå…ƒç´ å³å¯ã€‚è€Œadd æ“ä½œå¯ä»¥å°†å…ƒç´ æ·»åŠ åˆ°æ­¤æ•°æ®ç»“æ„ä¸­çš„ä»»æ„ä½ç½®</li>
<li>å†…éƒ¨æ•°æ®è¡¨ç¤ºå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŸå­æ€§å¼•ç”¨çš„æ•°ç»„ï¼Œæ¯ä¸ªå¼•ç”¨æŒ‡å‘ä¸€ä¸ªä¸å¯å˜é“¾è¡¨ã€‚å› æ­¤ï¼Œä¸åŒçš„å¤„ç†å™¨å¯ä»¥åœ¨å¤šä¸ªåŸå­æ€§å¼•ç”¨ä¸­ä»»é€‰ä¸€ä¸ªè¿›è¡Œæ›´æ–°ã€‚</li>
<li>ä»£ç å®ç°</li>
<li>å­˜å‚¨éƒ¨åˆ†</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1">  val parallelism = Runtime.getRuntime.availableProcessors * 32
</span><span id="__span-62-2">  val buckets = new Array[AtomicReference[(List[T],Long)]](parallelism)
</span><span id="__span-62-3">  for(i&lt;-buckets.indices){
</span><span id="__span-62-4">    //æ¯ä¸ªåŸå­å¼•ç”¨ä¸ä»…ä¿å­˜äº†ä¸€ä¸ªé“¾è¡¨ï¼Œè¿˜ä¿å­˜äº†ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æˆ³ï¼Œæ¯æ¬¡æ›´æ–°çš„æ—¶å€™ä¼šé€’å¢
</span><span id="__span-62-5">    buckets(i) = new AtomicReference((Nil,0L))
</span><span id="__span-62-6">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>addæ–¹æ³•</li>
</ol>
<p>addæ“ä½œå¿…é¡»åœ¨æ•°ç»„ä¸­é€‰ä¸€ä¸ªåŸå­æ€§å¼•ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é“¾è¡¨ï¼Œç”¨äºåŒ…å«æ–°å…ƒç´ ï¼Œç„¶åè§¦å‘CASæŒ‡ä»¤ï¼Œç›´åˆ°ç›¸åº”çš„åŸå­æ€§å¼•ç”¨è¢«æ›´æ–°ã€‚é€‰æ‹©æ•°ç»„ä¸­çš„æŸä¸€é¡¹æ—¶ï¼Œå½“å‰å¤„ç†å™¨å¿…é¡»ç¡®ä¿æ²¡æœ‰å…¶ä»–å¤„ç†å™¨åœ¨å ç”¨å®ƒï¼Œä»¥é¿å…ç«äº‰å’Œé‡è¯•ã€‚</p>
<p>ä½¿ç”¨IDå’Œå…ƒç´ çš„hashcodeå€¼è¿›è¡Œå¼‚æˆ–ï¼Œè®¡ç®—å‡ºæ•°ç»„ç´¢å¼•ã€‚å¯ä»¥è¾ƒå¤§ç¨‹åº¦ä¿è¯åˆ†å¸ƒåˆ†æ•£ï¼Œå‡å°‘å“ˆå¸Œå†²çªã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1">  def add(x:T):Unit = {
</span><span id="__span-63-2">    //éšæœºå¢åŠ ä¸€ä¸ªä½ç½®ï¼ŒCASé‡è¯•çš„æ¦‚ç‡æ¯”è¾ƒå°
</span><span id="__span-63-3">    val i = ((Thread.currentThread.getId ^ x.##) % buckets.length).toInt
</span><span id="__span-63-4">    @tailrec def retry():Unit = {
</span><span id="__span-63-5">      val bucket = buckets(i)
</span><span id="__span-63-6">      val v  = bucket.get
</span><span id="__span-63-7">      val nv = (x::v._1,v._2+1)
</span><span id="__span-63-8">      if(!bucket.compareAndSet(v,nv)) retry()
</span><span id="__span-63-9">    }
</span><span id="__span-63-10">    retry()
</span><span id="__span-63-11">  }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>removeæ–¹æ³•</li>
</ol>
<p>ä¸èƒ½ä½¿ç”¨ä¸€æ¬¡æ‰«æçš„æ–¹å¼ï¼Œå› ä¸ºå¹¶å‘æƒ…å†µä¸‹å¯èƒ½åˆšæ‰ä¸ºç©ºçš„é¡¹ä¸‹ä¸€æ—¶åˆ»å°±æœ‰å…ƒç´ ã€‚æç«¯æƒ…å†µä¸‹é€ æˆçš„æ˜¯æ‰«æä¸€éï¼Œè®¤ä¸ºä¸ºç©ºï¼Œä½†æ˜¯å®é™…ä¸Šå…¨éƒ¨éƒ½æœ‰å…ƒç´ ã€‚</p>
<p>å¯ä»¥ä½¿ç”¨æ—¶é—´æˆ³ï¼Œæ—¶é—´æˆ³ä¸å˜å°±è¯æ˜æ²¡æœ‰è¢«æ“ä½œã€‚æ‰«æä¸¤è¾¹æ£€æŸ¥æ—¶é—´æˆ³ä¹‹å’Œï¼Œæ¥ç¡®å®šç»ˆæ­¢ä¿¡æ¯ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1">    def remove(): Option[T] = {
</span><span id="__span-64-2">      val start =
</span><span id="__span-64-3">        (Thread.currentThread.getId % buckets.length).toInt
</span><span id="__span-64-4">      @tailrec def scan(witness: Long): Option[T] = {
</span><span id="__span-64-5">        var i = (start + 1) % buckets.length
</span><span id="__span-64-6">        var sum = 0L
</span><span id="__span-64-7">        while (i != start) {
</span><span id="__span-64-8">          val bucket = buckets(i)
</span><span id="__span-64-9">          @tailrec def retry(): Option[T] = {
</span><span id="__span-64-10">            bucket.get match {
</span><span id="__span-64-11">              case (Nil, stamp) =&gt;
</span><span id="__span-64-12">                sum += stamp
</span><span id="__span-64-13">                None
</span><span id="__span-64-14">              case v @ (lst, stamp) =&gt;
</span><span id="__span-64-15">                val nv = (lst.tail, stamp + 1)
</span><span id="__span-64-16">                if (bucket.compareAndSet(v, nv)) Some(lst.head)
</span><span id="__span-64-17">                else retry()
</span><span id="__span-64-18">            }
</span><span id="__span-64-19">          }
</span><span id="__span-64-20">          retry() match {
</span><span id="__span-64-21">            case Some(v) =&gt; return Some(v)
</span><span id="__span-64-22">            case None =&gt;
</span><span id="__span-64-23">          }
</span><span id="__span-64-24">          i = (i + 1) % buckets.length
</span><span id="__span-64-25">        }
</span><span id="__span-64-26">        if (sum == witness) None
</span><span id="__span-64-27">        else scan(sum)
</span><span id="__span-64-28">      }
</span><span id="__span-64-29">      scan(-1L)
</span><span id="__span-64-30">    }
</span></code></pre></div></td></tr></table></div>
<h4 id="_16">è¿›ç¨‹çš„åˆ›å»ºå’Œå¤„ç†<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h4>
<p>åªè¦æœºå™¨å†…å­˜è¶³å¤Ÿå¤šï¼Œç‹¬ç«‹è¿›ç¨‹ä¸­çš„åƒåœ¾å›æ”¶æˆ–å³æ—¶ç¼–è¯‘ï¼ˆjust-in-time compilationï¼‰å°±åº”è¯¥ä¸ä¼šå½±å“è¿›ç¨‹çš„è¿è¡Œã€‚</p>
<p>scala.sys.processåŒ…ä¸­åŒ…å«å¤„ç†å…¶ä»–è¿›ç¨‹çš„ä¸€å¥—ç²¾ç®€APIã€‚ç”¨æˆ·å¯ä»¥åŒæ­¥è¿è¡Œå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ä¸­è¿è¡Œå­è¿›ç¨‹çš„é‚£ä¸ªçº¿ç¨‹ä¼šç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚ä¹Ÿå¯ä»¥å¼‚æ­¥ï¼Œå³å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹ä¸­çš„è°ƒç”¨çº¿ç¨‹å¹¶å‘è¿è¡Œã€‚</p>
<h2 id="4futurepromise">4.åŸºäºFutureå’ŒPromiseçš„å¼‚æ­¥ç¼–ç¨‹<a class="headerlink" href="#4futurepromise" title="Permanent link">&para;</a></h2>
<h3 id="41-future">4.1 Future<a class="headerlink" href="#41-future" title="Permanent link">&para;</a></h3>
<h4 id="_17">åŸºæœ¬æ¦‚å¿µ<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h4>
<ol>
<li>é˜»å¡çº¿ç¨‹çš„åŸå› ï¼š</li>
<li>èµ„æºæ˜¯æœ‰é™çš„ã€‚</li>
<li>è®¡ç®—æ‰€éœ€è¦çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæ¯”å¦‚çº¿ç¨‹é€šè¿‡ç½‘ç»œè¯·æ±‚èµ„æº</li>
<li>Futureæ˜¯ä¸€ç§å ä½ç¬¦ï¼Œå³æŸä¸ªå€¼çš„å†…å­˜ä½ç½®ã€‚å½“åˆ›å»ºFutureæ—¶ï¼Œç›¸åº”çš„å ä½ç¬¦ä¸­ä¸éœ€è¦æœ‰å€¼ï¼›å¯ä»¥éšç€getWebpageæ–¹æ³•çš„æ‰§è¡Œï¼Œåœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´å°†å€¼æ”¾è¿›å»ã€‚Future[]ç±»å‹éšå«äº†ç¨‹åºçš„å»¶æ—¶è¿‡ç¨‹ï¼Œå…¶ç¨‹åºè¯­ä¹‰æ˜¯ï¼Œèµ„æºè¿‡ä¸€ä¼šå„¿æ‰å¯ç”¨ã€‚å½“Futureå¯¹è±¡è·å¾—æŸä¸ªå€¼ä¹‹åï¼Œå®ƒå°±ä¸å†å˜åŒ–äº†ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1">//è¿”å›å€¼è¡¨ç¤ºFutureå¯¹è±¡æœ€ç»ˆä¼šåŒ…å«ä¸€ä¸ªStringç±»å‹çš„å€¼
</span><span id="__span-65-2">def getWebpage(url: String): Future[String]
</span></code></pre></div></td></tr></table></div>
<ol>
<li>Futureå€¼çš„æå–æ–¹å¼ï¼šåœ¨å½“å‰çš„è°ƒç”¨çº¿ç¨‹ä¸­ï¼Œè¿›è¡Œè½®è¯¢(polling)ï¼Œè®©çº¿ç¨‹åœ¨å€¼å¯ç”¨ä¹‹å‰å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å°†é˜»å¡è½¬ç§»åˆ°äº†è°ƒç”¨çº¿ç¨‹ä¸­ã€‚Future[T]è¡¨ç¤ºä¸€ä¸ªå½“å‰å¯èƒ½ä¸å¯ç”¨ï¼Œä½†æ˜¯è¿‡ä¸€æ®µæ—¶é—´å¯ç”¨çš„ç±»å‹ä¸ºTçš„å€¼ã€‚è€ŒFutureè®¡ç®—è¡¨ç¤ºèƒ½äº§ç”ŸFutureå€¼çš„å¼‚æ­¥è®¡ç®—ã€‚</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1">//åœ¨å¤–å›´ä½œç”¨åŸŸæœç´¢ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„å€¼ï¼Œç¡®å®šçº¿ç¨‹ä½•æ—¶ä½•åœ°æ‰§è¡Œ(çº¿ç¨‹æ± )
</span><span id="__span-66-2">def apply[T](b: =&gt;T)(implicit e: ExecutionContext): Future[T]
</span></code></pre></div></td></tr></table></div>
<h4 id="future">å¯åŠ¨Futureè®¡ç®—<a class="headerlink" href="#future" title="Permanent link">&para;</a></h4>
<p>åœ¨æ­¤ä¾‹ä¸­ï¼Œä¸»çº¿ç¨‹ä½¿ç”¨äº†è½®è¯¢æ³•æ¥è·å¾—Futureçš„å€¼ã€‚Futureå•ä¾‹å¯¹è±¡çš„pollingæ–¹æ³•æ˜¯éé˜»å¡å¼çš„ï¼Œä½†å®ƒä»¬ä¹Ÿæ˜¯éç¡®å®šæ€§çš„ã€‚isCompleted ä¼šè¿”å›falseï¼Œç›´åˆ°Future è®¡ç®—å®Œæˆã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒFuture è®¡ç®—çš„å®Œæˆå¯¹äºè½®è¯¢è°ƒç”¨æ¥è¯´æ˜¯ä¸€ç§å‰å‘ç”Ÿå…³ç³»ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1">object FutureDataType extends App {
</span><span id="__span-67-2">  import scala.concurrent._
</span><span id="__span-67-3">  import ExecutionContext.Implicits.global
</span><span id="__span-67-4">  val buildFile = Future{
</span><span id="__span-67-5">    val f: BufferedSource = Source.fromFile(&quot;pom.xml&quot;)
</span><span id="__span-67-6">    try{
</span><span id="__span-67-7">      f.getLines().mkString(&quot;\n&quot;)
</span><span id="__span-67-8">    } finally f.close()
</span><span id="__span-67-9">  }
</span><span id="__span-67-10">  log(s&quot;start read the file&quot;)
</span><span id="__span-67-11">  log(s&quot;status:  ${buildFile.isCompleted}&quot;)
</span><span id="__span-67-12">  Thread.sleep(250)
</span><span id="__span-67-13">  log(s&quot;status:  ${buildFile.isCompleted}&quot;)
</span><span id="__span-67-14">  log(s&quot;value: \n ${buildFile.value}&quot;)
</span><span id="__span-67-15">}
</span></code></pre></div></td></tr></table></div>
<h4 id="future_1">Futureå›è°ƒ<a class="headerlink" href="#future_1" title="Permanent link">&para;</a></h4>
<p>æ¦‚å¿µï¼šå›è°ƒæ˜¯æŒ‡ä¸€æ—¦å‚æ•°å¯ç”¨å°±ç«‹å³æ‰§è¡Œçš„å‡½æ•°ã€‚å½“å‘scalaçš„Futureè¾“å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæ­¤å›è°ƒæ€»æ˜¯ä¼šæ‰§è¡Œï¼Œä½†æ˜¯æ˜¯åœ¨Futureçš„å€¼å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1">object FuturesCallbacks extends App {
</span><span id="__span-68-2">  def getUrlSpec(): Future[List[String]] = Future {
</span><span id="__span-68-3">    val url = &quot;http://www.w3.org/Addressing/URL/url-spec.txt&quot;
</span><span id="__span-68-4">    val f = Source.fromURL(url)
</span><span id="__span-68-5">    try f.getLines.toList finally f.close()
</span><span id="__span-68-6">  }
</span><span id="__span-68-7">  val urlSpec: Future[List[String]] = getUrlSpec()
</span><span id="__span-68-8">  def find(lines: List[String], keyword: String): String =
</span><span id="__span-68-9">    lines.zipWithIndex collect {
</span><span id="__span-68-10">      case (line, n) if line.contains(keyword) =&gt; (n, line)
</span><span id="__span-68-11">  } mkString(&quot;\n&quot;)
</span><span id="__span-68-12">
</span><span id="__span-68-13">  urlSpec foreach  {
</span><span id="__span-68-14">    lines =&gt; log(find(lines, &quot;URL&quot;))
</span><span id="__span-68-15">  }
</span><span id="__span-68-16">  log(&quot;callback registered, continuing with other work&quot;)
</span><span id="__span-68-17">  Thread.sleep(20000)
</span><span id="__span-68-18">}
</span></code></pre></div></td></tr></table></div>
<p>å›è°ƒå‡½æ•°çš„ä½¿ç”¨ï¼š</p>
<p>åªèƒ½ç”¨foreachæ–¹æ³•åœ¨Futureå¯¹è±¡ä¸­è£…å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚æ³¨æ„ï¼Œforeachæ–¹æ³•ä¸onSuccessæ–¹æ³•æ˜¯ç­‰ä»·çš„ã€‚foreachæ–¹æ³•çš„å‚æ•°æ˜¯éƒ¨åˆ†å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªFutureå€¼ï¼Œç„¶åä¼šæ‰§è¡ŒæŸä¸ªæ“ä½œ</p>
<p>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ³¨å†Œå›è°ƒçš„è¿‡ç¨‹æ˜¯éé˜»å¡çš„ã€‚ä¸»çº¿ç¨‹ä¸­çš„logè¯­å¥ä¼šåœ¨å›è°ƒæ³¨å†Œå®Œæ¯•åç«‹åˆ»æ‰§è¡Œï¼Œè€Œå›è°ƒé‡Œé¢çš„logè¯­å¥åˆ™ä¼šåœ¨å¾ˆä¹…ä¹‹åæ‰æ‰§è¡Œ</p>
<p>æ³¨æ„ï¼Œå›è°ƒå‡½æ•°ä¸ä¸€å®šä¼šåœ¨Futureå®Œæˆä¹‹åç«‹åˆ»æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ‰§è¡Œä¸Šä¸‹æ–‡ä¼šå®‰æ’ä¸€ä¸ªä»»åŠ¡ä¸“é—¨å¤„ç†å›è°ƒã€‚å½“Futureå®Œæˆåï¼Œå›è°ƒå‡½æ•°æ€»ä¼šæ‰§è¡Œï¼Œä¸è¿‡åŒä¸€ä¸ªFutureä¸Šçš„ä¸åŒå›è°ƒä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚æ‰§è¡Œä¸Šä¸‹æ–‡å†³å®šäº†ç”±å“ªä¸ªçº¿ç¨‹åœ¨ä½•æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å®ŒæˆFutureå’Œæ‰§è¡Œå›è°ƒä¹‹é—´å­˜åœ¨å‰å‘ç”Ÿå…³ç³»ã€‚</p>
<p>å›è°ƒå‡½æ•°çš„æ€§è´¨ï¼š</p>
<p>å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ï¼Œæ¯”å¦‚æ²¡æœ‰å˜é‡èµ‹å€¼ã€ä¿®æ”¹å¯å˜é›†åˆæˆ–æ‰§è¡Œæ ‡å‡†è¾“å‡ºå†™æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±è¢«ç§°ä¸ºæ˜¯å‚è€ƒé€æ˜çš„ã€‚</p>
<p>Future å¯¹è±¡ä¸Šçš„å›è°ƒå‡½æ•°æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ€§è´¨ï¼Œå³åªä½¿ç”¨Future.applyå’Œforeachè°ƒç”¨å‚è€ƒé€æ˜çš„å›è°ƒå‡½æ•°çš„ç¨‹åºæ˜¯ç¡®å®šçš„ã€‚</p>
<h4 id="future_2">Futureå’Œå¼‚å¸¸<a class="headerlink" href="#future_2" title="Permanent link">&para;</a></h4>
<p>é¦–å…ˆï¼Œåˆ›å»ºäº†ä¸€ä¸ªFutureï¼Œæ²¡æœ‰æ³¨å†Œä»»ä½•å›è°ƒå‡½æ•°ã€‚ç„¶ååœ¨è¯¥åŸºç¡€ä¹‹ä¸Šæ³¨å†Œå¾ˆå¤šçš„å›è°ƒå‡½æ•°.</p>
<p><img alt="image.png" src="../assets/call-back-api.png" /></p>
<p>foreachæ–¹æ³•æ¥æ”¶çš„å›è°ƒå‡½æ•°åªè¢«ç”¨æ¥å¤„ç†æˆåŠŸçš„Futureçš„å€¼ã€‚é¢å¯¹å¤±è´¥çš„Futureçš„å€¼ï¼Œéœ€è¦ä½¿ç”¨failedæ–¹æ³•è¿›è¡Œå¤„ç†</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-69-1">object FuturesFailure extends App {
</span><span id="__span-69-2">  val urlSpec: Future[String] = Future {
</span><span id="__span-69-3">    val invalidUrl = &quot;http://www.w3.org/non-existent-url-spec.txt&quot;
</span><span id="__span-69-4">    Source.fromURL(invalidUrl).mkString
</span><span id="__span-69-5">  }
</span><span id="__span-69-6">  urlSpec.failed foreach {
</span><span id="__span-69-7">    case t =&gt; log(s&quot;exception occurred - $t&quot;)
</span><span id="__span-69-8">  }
</span><span id="__span-69-9">  Thread.sleep(1000)
</span><span id="__span-69-10">}
</span></code></pre></div></td></tr></table></div>
<h4 id="try">ä½¿ç”¨Tryç±»å‹<a class="headerlink" href="#try" title="Permanent link">&para;</a></h4>
<p>å’ŒOptionç±»ä¸åŒçš„æ˜¯ï¼ŒOptionåªæŠŠNoneä½œä¸ºä¸åŒ¹é…çš„æ ‡å¿—ï¼Œè€Œä¸èƒ½å­˜å‚¨å¤±è´¥çš„ä¿¡æ¯ã€‚</p>
<p>Tryç±»å‹æœ‰ä¸¤ç§æ ·ä¾‹ç±»å®ç°ï¼šä¸€ç§æ˜¯Success[T]ç±»å‹ï¼Œå®ƒä¿å­˜äº†è®¡ç®—æˆåŠŸåçš„ç»“æœï¼›å¦ä¸€ç§æ˜¯Failure[T]ç±»å‹ï¼Œå®ƒä¿å­˜äº†è®¡ç®—å¤±è´¥æ—¶æŠ›å‡ºçš„Throwableå¯¹è±¡ã€‚</p>
<p>Try[T]å¯¹è±¡æ˜¯åœ¨åŒæ­¥åœºåˆä¸‹ä½¿ç”¨çš„ä¸å¯å˜å¯¹è±¡ï¼Œåœ¨åˆ›å»ºæ—¶å°±å°†å€¼æˆ–å¼‚å¸¸ä¿å­˜ä¸‹æ¥äº†ï¼Œè¿™å’ŒFutureå¯¹è±¡ä¸ä¸€æ ·ã€‚ä¹Ÿå°±æ˜¯è¯´Tryå¯¹è±¡çš„ä½¿ç”¨æ€»æ˜¯åœ¨è°ƒç”¨çº¿ç¨‹ä¸­å®Œæˆã€‚</p>
<p>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ¨¡å¼åŒ¹é…ä½¿ç”¨çš„æ˜¯Tryå€¼ã€‚å½“è°ƒç”¨onCompleteå›è°ƒå‡½æ•°æ—¶ï¼Œä¼šä¸ºå®ƒæä¾›åŒ¹é…Successå€¼æˆ–Failureå€¼çš„éƒ¨åˆ†å‡½æ•°ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-70-1">urlSpec onComplete {
</span><span id="__span-70-2">  case Success(txt) =&gt; log(find(txt))
</span><span id="__span-70-3">  case Failure(err) =&gt; log(s&quot;exception occurred - $err&quot;)
</span><span id="__span-70-4">}
</span></code></pre></div></td></tr></table></div>
<h4 id="future_3">Futureä¸Šçš„å‡½æ•°å¼ç»„åˆ<a class="headerlink" href="#future_3" title="Permanent link">&para;</a></h4>
<p>ä½œç”¨ï¼š</p>
<p>å‡½æ•°å¼ç»„åˆæ˜¯ç”¨æ¥è¡¥å……å›è°ƒå‡½æ•°çš„ä¸è¶³ã€‚å›è°ƒå‡½æ•°å¾ˆæœ‰ç”¨ï¼Œä½†åœ¨å¤§å‹ç¨‹åºä¸­ä¸åˆ©äºåˆ†ææ§åˆ¶æµã€‚è€Œä¸”ï¼Œå›è°ƒå‡½æ•°ä¸èƒ½å®ç°å¼‚æ­¥ç¼–ç¨‹ä¸­çš„æŸäº›æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯ç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ç›‘å¬å¤šä¸ªFutureå¯¹è±¡æ˜¯æ¯”è¾ƒçƒ¦ççš„ã€‚è¿˜å¥½Scalaæä¾›äº†Futureçš„è§£å†³æ–¹æ¡ˆï¼Œç§°ä¸ºå‡½æ•°å¼ç»„åˆã€‚å‡½æ•°å¼ç»„åˆæ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œå…¶æ€æƒ³æ˜¯ç”¨é«˜é˜¶å‡½æ•°ï¼ˆç§°ä¸ºç»„åˆå­ï¼‰å°†ç®€å•å€¼ç»„åˆæˆå¤æ‚å€¼ã€‚</p>
<p>å¯ä»¥å°†Futureç†è§£ä¸ºä¸€ç§ç‰¹æ®Šå½¢å¼çš„å®¹å™¨ï¼Œåªä¸è¿‡å®ƒæœ€å¤šåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå¯ä»¥å¯¹å…¶åº”ç”¨å‡½æ•°å¼ç»„åˆã€‚</p>
<p>ä½¿ç”¨æ—¶æœº:</p>
<p>å¯¹äºä¾èµ–äºå•ä¸ªFutureçš„æœ‰å‰¯ä½œç”¨çš„è¡Œä¸ºï¼Œä½¿ç”¨å›è°ƒã€‚å…¶ä»–æƒ…å†µä½¿ç”¨å‡½æ•°å¼ç»„åˆã€‚è€Œå‡½æ•°å¼ç»„åˆä¸­å¦‚æœæœ‰flatmapï¼Œä¸€èˆ¬ä¼šä½¿ç”¨foræ¨å¯¼å¼è¿›è¡Œæ›¿ä»£ã€‚åŒæ—¶ï¼Œforæ¨å¯¼å¼ä¸­çš„è¡¨è¾¾å¼æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå¯èƒ½åœ¨å¹¶å‘å¹¶å‘ç¼–ç¨‹ä¸­éœ€è¦æ³¨æ„é¡ºåºï¼Œå¦‚æœè¾¹è®¡ç®—è¾¹ä½¿ç”¨å¯èƒ½ä¼šå‡ºé—®é¢˜ã€‚</p>
<h3 id="42-promise">4.2 Promise<a class="headerlink" href="#42-promise" title="Permanent link">&para;</a></h3>
<h4 id="_18">åŸºæœ¬æ¦‚å¿µ<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<ol>
<li>æ¦‚å¿µ</li>
</ol>
<p>Promiseæ˜¯æŒ‡åªèƒ½ä¸€æ¬¡æ€§èµ‹å€¼æˆ–æŠ›å‡ºå¼‚å¸¸çš„ä¸€ç§å¯¹è±¡ã€‚è¿™ä¹Ÿæ˜¯Promiseæœ‰æ—¶å€™åˆè¢«ç§°ä¸ºå•èµ‹å€¼å˜é‡çš„åŸå› ã€‚ä¸»è¦ä½œç”¨æ˜¯æ¢ä¸€ç§æ›´çµæ´»çš„æ–¹å¼ï¼Œå°†ç»“æœèµ‹å€¼ç»™Futureï¼Œè€Œä¸æ˜¯å•ä¸€çš„çº¿ç¨‹è¿”å›å€¼</p>
<ol>
<li>åˆ›å»º</li>
</ol>
<p>ä¸ºåˆ›å»ºä¸€ä¸ªPromiseå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨Promiseä¼´éšå¯¹è±¡ä¸Šçš„Promise.applyæ–¹æ³•ã€‚ä¸è¿‡ï¼ŒPromise.apply æ–¹æ³•å¹¶ä¸ä¼šå¯åŠ¨å¼‚æ­¥è®¡ç®—ï¼Œå®ƒåªæ˜¯åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„Promiseå¯¹è±¡ã€‚å½“Promiseå¯¹è±¡åˆ›å»ºåï¼Œå®ƒå¹¶ä¸åŒ…å«å€¼æˆ–å¼‚å¸¸ã€‚ä¸ºäº†å°†å€¼æˆ–å¼‚å¸¸èµ‹å€¼ç»™ä¸€ä¸ªPromiseï¼Œéœ€è¦åˆ†åˆ«ä½¿ç”¨successæˆ–failureæ–¹æ³•</p>
<ol>
<li>ä¸Futureçš„è”ç³»</li>
</ol>
<p>æ¯ä¸ªPromiseå¯¹åº”ä¸€ä¸ªFutureï¼Œä¸ºäº†è·å¾—Promiseå¯¹åº”çš„Futureï¼Œå¯ä»¥è°ƒç”¨Promiseå¯¹è±¡çš„Futureæ–¹æ³•ã€‚è¯¥æ–¹æ³•å¤šæ¬¡è°ƒç”¨ä¹Ÿåªä¼šè¿”å›å¯¹åº”çš„åŒä¸€ä¸ªFutureæ–¹æ³•ã€‚Promiseå’ŒFutureå¯¹åº”ä¸€ä¸ªå•èµ‹å€¼å˜é‡çš„ä¸¤ä¸ªæ–¹é¢ï¼ŒPromiseå¯¹è±¡ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªFutureå¯¹è±¡ã€‚ç”¨æˆ·å¯ä»¥å°†Futureçš„å€¼è¯»å‡ºæ¥ã€‚</p>
<p><strong>ğŸ””</strong></p>
<p>å¸¸è§çš„ä½¿ç”¨æ¨¡å¼ï¼šFuture-å›è°ƒæ¡¥</p>
<ol>
<li>åˆ›å»ºPromiseå¯¹è±¡</li>
<li>å…¶ä¸­å…¶ä»–è®¡ç®—ä»»åŠ¡(çº¿ç¨‹)å®ŒæˆPromise(ä½¿ç”¨å€¼æˆ–è€…å¼‚å¸¸å€¼æ¥å®Œæˆ)</li>
<li>è¿”å›Promiseå¯¹åº”çš„Futureå¯¹è±¡</li>
<li>API</li>
</ol>
<p>promiseçš„successæ–¹æ³•æ˜¯å°†promiseç”¨ä¸€ä¸ªæˆåŠŸçš„ç»“æœå€¼å®Œæˆï¼Œè‡³æ­¤promiseå°±å®Œæˆäº†èµ‹å€¼ï¼Œå…¶å¯¹åº”çš„Futureä¹Ÿå°±ç¡®å®šäº†ã€‚</p>
<p>ç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨ trySuccessã€tryFailure å’ŒtryComplete æ–¹æ³•ï¼Œå…¶åˆ†åˆ«å¯¹åº”äº successã€failureå’Œcompleteï¼Œä¸åŒä¹‹å¤„åœ¨äºä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œæ ‡è¯†èµ‹å€¼æ˜¯å¦æˆåŠŸã€‚</p>
<ol>
<li>ä¾‹å­ï¼šå®šåˆ¶Future.applyæ–¹æ³•</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-71-1">import scala.util.control.NonFatal
</span><span id="__span-71-2">object PromisesCustomAsync extends App {
</span><span id="__span-71-3">  def myFuture[T](b: =&gt;T): Future[T] = {
</span><span id="__span-71-4">    val p = Promise[T]
</span><span id="__span-71-5">    global.execute(new Runnable {
</span><span id="__span-71-6">      def run() = try {
</span><span id="__span-71-7">        p.success(b)
</span><span id="__span-71-8">      } catch {
</span><span id="__span-71-9">        case NonFatal(e) =&gt; {
</span><span id="__span-71-10">          log(&quot;here&quot;)
</span><span id="__span-71-11">          p.failure(e)
</span><span id="__span-71-12">        }
</span><span id="__span-71-13">      }
</span><span id="__span-71-14">    })
</span><span id="__span-71-15">    p.future
</span><span id="__span-71-16">  }
</span><span id="__span-71-17">  val f = myFuture { &quot;naa&quot; + &quot;na&quot; * 8 + &quot; Katamari Damacy!&quot; }
</span><span id="__span-71-18">  f foreach { case text:String =&gt; log(text) }
</span><span id="__span-71-19">  Thread.sleep(1000)
</span><span id="__span-71-20">}
</span></code></pre></div></td></tr></table></div>
<h4 id="api_4">åŒ…è£…åŸºäºå›è°ƒçš„API<a class="headerlink" href="#api_4" title="Permanent link">&para;</a></h4>
<ol>
<li>å¿…è¦æ€§ï¼š</li>
</ol>
<p>è°ƒç”¨çº¿ç¨‹çš„é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨Futureæˆ–è€…å›è°ƒå‡½æ•°è¿›è¡Œé¿å…ã€‚</p>
<p>æ—§ç‰ˆæœ¬çš„æ¡†æ¶å¸¸ä½¿ç”¨åŸå§‹çš„å›è°ƒå‡½æ•°æ¥å¤„ç†ç¨‹åºä¸­çš„å»¶è¿Ÿé—®é¢˜ã€‚æ‰§è¡Œæ—¶é—´å¾…å®šçš„æ–¹æ³•å¹¶ä¸ä¼šè¿”å›ç»“æœï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå®ƒä»¬æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œæ­¤å›è°ƒå‡½æ•°ç”¨äºè¯»å–å°†æ¥çš„ç»“æœã€‚</p>
<p>å¤§é‡çš„å›è°ƒå‡½æ•°ä½¿ç”¨ä¼šä½¿å¾—ç»“æ„å˜å¾—å¼‚å¸¸å¤æ‚ï¼Œå¯ä»¥é€šè¿‡Promiseä½œä¸ºå›è°ƒå‡½æ•°APIå’ŒFutureä¹‹é—´çš„æ¡¥æ¢ã€‚æ­¤æ¨¡å¼ç§°ä¸ºFuture-å›è°ƒæ¡¥ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-72-1">  //æ£€æµ‹ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–°åˆ›å»ºçš„æ–‡ä»¶
</span><span id="__span-72-2">  def fileCreated(dir:String):Future[String] = {
</span><span id="__span-72-3">    val p = Promise[String]
</span><span id="__span-72-4">    //æ¯1000msæ¥è¿›è¡Œæ£€æµ‹
</span><span id="__span-72-5">    val fileMonitor = new FileAlterationMonitor(1000)
</span><span id="__span-72-6">    //æ£€æµ‹çš„æ˜¯dirç›®å½•ä¸‹æ–‡ä»¶
</span><span id="__span-72-7">    val fileObserver = new FileAlterationObserver(dir)
</span><span id="__span-72-8">    //ä¸‹é¢æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç›®å½•ä¸‹æ–‡ä»¶è¢«åˆ›å»ºï¼Œè¯¥å¯¹è±¡çš„onFileCreateæ–¹æ³•ä¼šè¢«è°ƒç”¨
</span><span id="__span-72-9">    val listener = new FileAlterationListenerAdaptor {
</span><span id="__span-72-10">      override def onFileCreate(file: File): Unit = {
</span><span id="__span-72-11">        log(&quot;File created: &quot; + file.getName)
</span><span id="__span-72-12">        //æ£€æµ‹åˆ°æ–‡ä»¶åˆ›å»ºï¼Œå°±å°†æˆåŠŸç»“æœä¼ é€’ç»™promise
</span><span id="__span-72-13">        try{
</span><span id="__span-72-14">          p.success(file.getName)
</span><span id="__span-72-15">        }finally fileMonitor.stop()
</span><span id="__span-72-16">      }
</span><span id="__span-72-17">    }
</span><span id="__span-72-18">    fileObserver.addListener(listener)
</span><span id="__span-72-19">    fileMonitor.addObserver(fileObserver)
</span><span id="__span-72-20">    fileMonitor.start()
</span><span id="__span-72-21">    p.future
</span><span id="__span-72-22">  }
</span></code></pre></div></td></tr></table></div>
<p>å®ç°timeoutæ–¹æ³•ï¼Œè°ƒç”¨timeoutæ–¹æ³•ï¼Œä¼ å…¥t msçš„å‚æ•°ï¼Œç„¶åè®©å®ƒè¿”å›ä¸€ä¸ªè‡³å°‘t msä¹‹åæ‰èƒ½å®Œæˆçš„Futureã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-73-1">def timeout(t: Long): Future[Unit] = {
</span><span id="__span-73-2">    val p = Promise[Unit]
</span><span id="__span-73-3">    //
</span><span id="__span-73-4">    timer.schedule(new TimerTask {
</span><span id="__span-73-5">      override def run() = {
</span><span id="__span-73-6">        p.success()
</span><span id="__span-73-7">        //ä¸€æ—¦è°ƒç”¨cancelæ–¹æ³•ï¼ŒTimerTaskå°±ä¸ä¼šå†è¢«æ‰§è¡Œäº†
</span><span id="__span-73-8">        timer.cancel()
</span><span id="__span-73-9">      }
</span><span id="__span-73-10">    }, t)
</span><span id="__span-73-11">    p.future
</span><span id="__span-73-12"> }
</span></code></pre></div></td></tr></table></div>
<h3 id="43-future">4.3 Futureå’Œé˜»å¡<a class="headerlink" href="#43-future" title="Permanent link">&para;</a></h3>
<p>é˜»å¡å’ŒFutureï¼Œä¹Ÿå°±æ˜¯é˜»å¡Futureçš„æ–¹å¼æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ç­‰å¾…Futureå®Œæˆï¼Œç¬¬äºŒç§æ˜¯å¼‚æ­¥è®¡ç®—å†…éƒ¨é˜»å¡ã€‚</p>
<ol>
<li>ç­‰å¾…Futureå®Œæˆ</li>
</ol>
<p>å¯ä½¿ç”¨ scala.concurrent åŒ…ä¸­çš„Await å¯¹è±¡ä¸Šçš„ ready å’Œresultæ–¹æ³•ã€‚</p>
<p>readyæ–¹æ³•é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æŒ‡å®šçš„Futureå®Œæˆä¸ºæ­¢ã€‚</p>
<p>resultæ–¹æ³•ä¹Ÿå¯é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œå¦‚æœFutureæˆåŠŸå®Œæˆï¼Œåˆ™è¿”å›Futureçš„å€¼ï¼›å¦‚æœFutureå¤±è´¥ï¼Œåˆ™æŠ›å‡ºå…¶å¼‚å¸¸ã€‚</p>
<p>è¿™ä¸¤ç§æ–¹æ³•éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªtimeoutå‚æ•°ï¼Œå³è°ƒç”¨çº¿ç¨‹éœ€è¦ç­‰å¾…Futureè®¡ç®—çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶åä¼šæŠ›å‡ºä¸€ä¸ª TimeoutException å¼‚å¸¸ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-74-1">import scala.concurrent.{Await, Future}
</span><span id="__span-74-2">import scala.concurrent.duration._
</span><span id="__span-74-3">import scala.concurrent.ExecutionContext.Implicits.global
</span><span id="__span-74-4">import scala.io.Source
</span><span id="__span-74-5">object BlockingAwait  extends App {
</span><span id="__span-74-6">  val specUrlSizeFuture = Future{
</span><span id="__span-74-7">    val specUrl = &quot;http://baidu.com/search?q=helloworld&quot;
</span><span id="__span-74-8">    Source.fromURL(specUrl).size
</span><span id="__span-74-9">  }
</span><span id="__span-74-10">  val urlSize = Await.result(specUrlSizeFuture, 10 seconds)
</span><span id="__span-74-11">  println(urlSize)
</span><span id="__span-74-12">}
</span></code></pre></div></td></tr></table></div>
<ol>
<li>åœ¨å¼‚æ­¥è®¡ç®—å†…é˜»å¡</li>
</ol>
<p>æœ‰çš„æ—§ç‰ˆæœ¬çš„APIä¸ä½¿ç”¨å›è°ƒæ¥è¿”å›ä¸€æ­¥çš„ç»“æœï¼Œè€Œæ˜¯ä½¿ç”¨é˜»å¡æ–¹æ³•ã€‚å½“è°ƒç”¨ä¸€ä¸ªé˜»å¡æ–¹æ³•çš„æ—¶å€™ï¼Œç”¨æˆ·å®Œå…¨å¤±å»å¯¹çº¿ç¨‹çš„æ§åˆ¶æƒï¼Œå®Œå…¨ç”±è¿™ä¸ªé˜»å¡æ–¹æ³•æ¥å†³å®šä½•æ—¶å°†çº¿ç¨‹è§£é”å¹¶äº¤è¿˜æ§åˆ¶æƒã€‚</p>
<p>æ‰§è¡Œä¸Šä¸‹æ–‡é€šå¸¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± å®ç°çš„ï¼Œé˜»å¡å·¥ä½œçº¿ç¨‹å¯èƒ½è€—å°½çº¿ç¨‹æ± èµ„æºï¼Œå¯¼è‡´çº¿ç¨‹é¥¥é¥¿ã€‚</p>
<p>å¦‚æœä¸€å®šè¦é˜»å¡ï¼Œåˆ™é˜»å¡çš„é‚£éƒ¨åˆ†ä»£ç åº”è¯¥ç½®äºblockingè°ƒç”¨ä¸­ã€‚è¿™ç›¸å½“äºå‘Šè¯‰æ‰§è¡Œä¸Šä¸‹æ–‡å·¥ä½œçº¿ç¨‹è¢«é˜»å¡äº†ï¼Œå¿…è¦æ—¶å¯ä»¥ä¸´æ—¶å¯åŠ¨å¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-75-1">val futures = for (_ &lt;- 0 until 16) yield Future {
</span><span id="__span-75-2">  blocking {
</span><span id="__span-75-3">    Thread.sleep(1000)
</span><span id="__span-75-4">  }
</span><span id="__span-75-5">}
</span></code></pre></div></td></tr></table></div>
<h3 id="44-scalaasync">4.4 Scalaçš„Asyncåº“<a class="headerlink" href="#44-scalaasync" title="Permanent link">&para;</a></h3>
<p>Scala Async åº“å¼•å…¥äº†ä¸¤ä¸ªæ–°æ–¹æ³•ï¼šasync å’Œ awaitã€‚</p>
<p>async åœ¨æ¦‚å¿µä¸Šç­‰ä»·äºFuture.applyï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥è®¡ç®—ï¼Œå¹¶è¿”å›ä¸€ä¸ªFutureå¯¹è±¡ã€‚</p>
<p>è€Œå¯¹äºawaitæ–¹æ³•åˆ™ä¸èƒ½å°†å…¶å’Œ Await å¯¹è±¡å¼„æ··äº†ï¼Œåè€…ç”¨äºé˜»å¡Future,await æ–¹æ³•åˆ™ç”¨äºæ¥æ”¶ä¸€ä¸ªFutureå¯¹è±¡å¹¶è¿”å›å®ƒçš„å€¼ã€‚è€Œä¸”å’ŒAwaitå¯¹è±¡ä¸Šçš„æ–¹æ³•ä¸åŒï¼Œawaitæ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œ</p>
<h3 id="45">4.5 å¤šçº¿ç¨‹æ–¹æ¡ˆé€‰æ‹©æ€»ç»“<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<ol>
<li>Java</li>
<li>ä¸²è¡Œæ¨¡å¼</li>
</ol>
<p>é€»è¾‘æœ€ç®€å•ï¼Œæ€§èƒ½æœ€ä½</p>
<ol>
<li>çº¿ç¨‹æ±  + Future å¼‚æ­¥è°ƒç”¨</li>
</ol>
<p>å¯ä»¥å¹¶è¡Œè®¡ç®—ï¼Œä½†æ˜¯é‡åˆ°Futureä¹‹é—´æœ‰å‰åä¾èµ–å…³ç³»ï¼Œè¿˜æ˜¯éœ€è¦å¤§é‡æ—¶é—´é˜»å¡/è½®è¯¢</p>
<ol>
<li>çº¿ç¨‹æ±  + CompletableFutureå¼‚æ­¥è°ƒç”¨</li>
</ol>
<p>è¿™ä¸ªFutureæ›´åŠ ç±»ä¼¼äºscalaçš„Futureï¼Œå¯ä»¥å®‰è£…å›è°ƒï¼Œå¯ä»¥è¿›è¡Œä¾èµ–å…³ç³»çš„ç»„åˆ</p>
<ol>
<li>è™šæ‹Ÿçº¿ç¨‹</li>
<li>
<p>Scala</p>
</li>
<li>
<p>ä¸²è¡Œæ¨¡å¼</p>
</li>
</ol>
<p>é€»è¾‘æœ€ç®€å•ï¼Œæ€§èƒ½æœ€ä½</p>
<ol>
<li>çº¿ç¨‹æ±  + Future + Promise</li>
</ol>
<p>æ¯”Javaæ›´çµæ´»</p>
<ol>
<li>async/await</li>
<li>è™šæ‹Ÿçº¿ç¨‹</li>
<li>æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿçº¿ç¨‹</li>
</ol>
<p><a href="https://zhuanlan.zhihu.com/p/670651709">å¾—ç‰©è™šæ‹Ÿçº¿ç¨‹å®è·µ</a></p>
<p><a href="https://juejin.cn/post/7280746515526058038">æ€§èƒ½æµ‹è¯•</a></p>
<h2 id="5">5. å¹¶è¡Œå®¹å™¨<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 åŸºæœ¬æ¦‚å¿µ<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<ol>
<li>é€šç”¨è€—æ—¶æµ‹é‡å‡½æ•°</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-76-1">@volatile var dummy: Any = _
</span><span id="__span-76-2">def timed[T](body: =&gt;T): Double = {
</span><span id="__span-76-3">  val start = System.nanoTime
</span><span id="__span-76-4">  dummy = body
</span><span id="__span-76-5">  val end = System.nanoTime
</span><span id="__span-76-6">  ((end - start) / 1000) / 1000.0
</span><span id="__span-76-7">}
</span></code></pre></div></td></tr></table></div>
<p>ç¤ºä¾‹ï¼š</p>
<p>ä¸‹é¢æµ‹é‡çš„æ˜¯å¹¶è¡Œç‰ˆå®¹å™¨å’Œä¸²è¡Œç‰ˆå®¹å™¨çš„è€—æ—¶å¯¹æ¯”ï¼Œå…·æœ‰10%çš„æ€§èƒ½æå‡ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-77-1">    import scala.collection._
</span><span id="__span-77-2">    import scala.util.Random
</span><span id="__span-77-3">    object ParBasic extends App {
</span><span id="__span-77-4">      val numbers = Random.shuffle(Vector.tabulate(5000000)(i =&gt; i))
</span><span id="__span-77-5">      val seqtime = timed { numbers.max }
</span><span id="__span-77-6">      log(s&quot;Sequential time $seqtime ms&quot;)
</span><span id="__span-77-7">      val partime = timed { numbers.par.max }
</span><span id="__span-77-8">      log(s&quot;Parallel time $partime ms&quot;)
</span><span id="__span-77-9">    }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>é€šå¸¸çš„æ•°æ®å¹¶è¡Œæ“ä½œæ¶‰åŠæ›´å¤šå¤„ç†å™¨ä¹‹é—´çš„é€šä¿¡ã€‚</li>
</ol>
<p>æ­¤å¤„ä¸æ˜¯é€šè¿‡å¤šçº¿ç¨‹æ¡†æ¶ï¼Œè€Œæ˜¯é€šè¿‡å¹¶è¡Œå®¹å™¨æ¥å®è¡Œçš„ã€‚</p>
<p>å½“è°ƒç”¨ä¸€ä¸ªå¹¶è¡Œå®¹å™¨çš„ foreach æ–¹æ³•æ—¶ï¼Œå®¹å™¨ä¸­çš„å…ƒç´ å°†å¹¶å‘åœ°å¤„ç†ã€‚å³ä¸åŒçš„å·¥ä½œçº¿ç¨‹åŒæ—¶è§¦å‘æŒ‡å®šçš„å‡½æ•°ï¼Œæ‰€ä»¥è¿˜éœ€è¦æœ‰æ°å½“çš„åŒæ­¥æªæ–½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒåŒæ­¥æ€§æ˜¯ç”±åŸå­æ€§å˜é‡ä¿è¯çš„ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-78-1">import java.util.concurrent.atomic._
</span><span id="__span-78-2">object ParUid extends App {
</span><span id="__span-78-3">  private val uid = new AtomicLong(0L)
</span><span id="__span-78-4">  val seqtime = timed {
</span><span id="__span-78-5">    for (i &lt;- 0 until 10000000) uid.incrementAndGet()
</span><span id="__span-78-6">  }
</span><span id="__span-78-7">  log(s&quot;Sequential time $seqtime ms&quot;)
</span><span id="__span-78-8">  val partime = timed {
</span><span id="__span-78-9">    for (i &lt;- (0 until 10000000).par) uid.incrementAndGet()
</span><span id="__span-78-10">  }
</span><span id="__span-78-11">  log(s&quot;Parallel time $partime ms&quot;)
</span><span id="__span-78-12">}
</span></code></pre></div></td></tr></table></div>
<p>æœ¬ä¾‹ä¸­å¯èƒ½ä¼šæ…¢æˆ–è€…æ²¡æœ‰æ˜æ˜¾æ”¹è¿›çš„åŸå› ï¼šæ˜¯å› ä¸ºå·¥ä½œçº¿ç¨‹åŒæ—¶è°ƒç”¨äº†åŸå­æ€§å˜é‡uidä¸Šçš„incrementAndGetæ–¹æ³•ï¼Œå¹¶ä¸”å°†ç»“æœç«‹åˆ»å†™å…¥ç›¸åŒçš„å†…å­˜åŒºåŸŸã€‚</p>
<p><strong>ğŸ””</strong></p>
<p>åœ¨ç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼Œå†…å­˜å†™å…¥å¹¶ä¸æ˜¯ç›´æ¥æ“ä½œéšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRandom AccessMemory,RAMï¼‰ï¼Œå› ä¸ºè¿™å¤ªæ…¢äº†ã€‚</p>
<p>ç›¸åï¼Œç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼ŒCPUå’Œå†…å­˜ä¹‹é—´è¿˜æœ‰å¥½å‡ å±‚ç¼“å­˜ï¼š å®¹é‡å°çš„ç¼“å­˜å¾€å¾€é€Ÿåº¦æ›´å¿«ä¹Ÿæ›´è´µï¼Œå®ƒé‡Œé¢å­˜çš„æ˜¯å¤„ç†å™¨å½“å‰å¤„ç†çš„æ•°æ®å¤åˆ¶ã€‚ç¦» CPU æœ€è¿‘çš„ç¼“å­˜å±‚ç§°ä¸º L1ç¼“å­˜ï¼ŒL1ç¼“å­˜åˆè¢«åˆ’åˆ†ä¸ºå¤šä¸ªç§°ä¸ºç¼“å­˜è¡Œï¼ˆcache lineï¼‰çš„è¿ç»­ç©ºé—´ï¼Œå…¶å…¸å‹å¤§å°ä¸º64Bã€‚</p>
<p>åœ¨æ ‡å‡†çš„å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œå¤šä¸ªå†…æ ¸å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œä½†å†™æ“ä½œæ˜¯äº’æ–¥çš„ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå†…æ ¸æ‹¥æœ‰æŸä¸ªç¼“å­˜è¡Œã€‚å¦‚æœåŒæ—¶æœ‰å¦ä¸€ä¸ªå†…æ ¸è¯·æ±‚å†™å…¥åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œé‚£ä¹ˆæ­¤ç¼“å­˜è¡Œçš„å†…å®¹å°†ä¼šè¢«å¤åˆ¶åˆ°é‚£ä¸ªå†…æ ¸çš„L1ç¼“å­˜ä¸­ã€‚ç»´æŠ¤è¿™ç§ç¼“å­˜ä¸€è‡´æ€§çš„åè®®ç§°ä¸ºä¿®æ”¹ã€äº’æ–¥ã€å…±äº«ã€éæ³•ï¼ˆModified Exclusive Shared Invalid,MESIï¼‰ã€‚äº¤æ¢ç¼“å­˜è¡Œçš„æ‰€æœ‰æƒçš„ä»£ä»·æ˜¯æ¯”è¾ƒå¤§çš„</p>
<p>å› ä¸ºå˜é‡uidæ˜¯åŸå­æ€§çš„ï¼ŒJVMéœ€è¦ç¡®ä¿uidçš„å†™æ“ä½œå’Œè¯»æ“ä½œä¹‹é—´å…·æœ‰å‰å‘ç”Ÿå…³ç³»ï¼ˆè§ç¬¬2ç« ï¼‰ã€‚ä¸ºä¿è¯å®ç°å‰å‘ç”Ÿå…³ç³»ï¼Œå†…å­˜å†™æ“ä½œå¿…é¡»å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ã€‚</p>
<p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå”¯ä¸€çš„åŠæ³•æ˜¯åœ¨å†™ä¹‹å‰è®©ç¼“å­˜è¡Œæ˜¯ç‹¬å çš„ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸åŒçš„å¤„ç†å™¨å†…æ ¸åå¤äº¤æ¢ç¼“å­˜è¡Œçš„æ‰€æœ‰æƒï¼Œä»¥å®ç°uidçš„åˆ†é…ï¼Œäºæ˜¯é€ æˆäº†å¹¶è¡Œç‰ˆæœ¬çš„é€Ÿåº¦æ¯”ä¸²è¡Œç‰ˆæœ¬çš„è¿˜æ…¢ã€‚</p>
<p><strong>ğŸ””</strong></p>
<p>å¤šä¸ªçº¿ç¨‹å¾€åŒä¸€å†…å­˜åŒºåŸŸå†™å…¥æ•°æ®éœ€è¦æ°å½“çš„åŒæ­¥æªæ–½ï¼Œè¿™ä¼šé€ æˆç«äº‰å’Œæ€§èƒ½ç“¶é¢ˆï¼Œå› æ­¤ï¼Œåœ¨æ•°æ®å¹¶è¡Œæ“ä½œä¸­è¦å°½é‡é¿å…è¿™ç§æƒ…å†µã€‚ç±»ä¼¼çš„æ€§èƒ½ç“¶é¢ˆè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¤šçº¿ç¨‹å¹¶å‘è§¦å‘åŒä¸€å¯¹è±¡çš„synchronizedè¯­å¥ï¼Œé‡å¤ä¿®æ”¹å¹¶å‘æ˜ å°„ä¸­çš„åŒä¸€ä¸ªé”®ï¼Œæˆ–åŒæ—¶å¾€å¹¶å‘é˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ã€‚è¿™äº›è¡Œä¸ºéƒ½æ¶‰åŠå¾€åŒä¸€å†…å­˜åŒºåŸŸå†™å…¥æ•°æ®</p>
<h3 id="52">5.2  å¹¶è¡Œå®¹å™¨çš„ä½¿ç”¨<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<h4 id="_19">ç±»ç»§æ‰¿å…³ç³»<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h4>
<ol>
<li>å®šä¹‰</li>
</ol>
<p>å¹¶è¡Œå®¹å™¨ä¸å¯ä»¥æ˜¯ä¸²è¡Œå®¹å™¨çš„å­ç±»å‹ã€‚è®©å¹¶è¡Œå®¹å™¨ç»§æ‰¿æŸä¸ªä¸²è¡Œå®¹å™¨ï¼Œä¼šè¿åLiskovæ›¿æ¢åŸåˆ™ã€‚Liskovæ›¿æ¢åŸåˆ™æŒ‡çš„æ˜¯å¦‚æœç±»å‹Sæ˜¯ç±»å‹Tçš„å­ç±»å‹ï¼Œåˆ™ç±»å‹ä¸ºTçš„å¯¹è±¡å¯ä»¥æ›¿æ¢ä¸ºç±»å‹ä¸ºSçš„å¯¹è±¡ï¼Œè€Œä¸ä¼šå½±å“ç¨‹åºçš„æ­£ç¡®æ€§ã€‚å› ä¸ºå¯¹ä¸²è¡Œå®¹å™¨é€‚åˆçš„è®¡ç®—ï¼Œä½¿ç”¨å¹¶è¡Œå®¹å™¨å¯èƒ½é€ æˆæ•°æ®ç«äº‰ã€‚</p>
<p><img alt="image.png" src="../assets/collection-extends.png" /></p>
<p><img alt="" src="" /></p>
<ol>
<li>è½¬æ¢</li>
</ol>
<p>ä½¿ç”¨ä¸²è¡Œå®¹å™¨çš„paræ–¹æ³•å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ªå¹¶è¡Œå®¹å™¨ã€‚</p>
<p>å¦‚æœéœ€è¦ç¼–å†™ä¸å®¹å™¨ç±»å‹æ— å…³çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨æ³›å‹å®¹å™¨ç±»å‹ï¼Œä»–ä»¬æ¯ä¸ªéƒ½æ˜¯ä¸²è¡Œå®¹å™¨å’Œå¹¶è¡Œå®¹å™¨çš„çˆ¶ç±»ã€‚å¦‚æœç¼–å†™æ³›å‹å®¹å™¨çš„ä»£ç ï¼Œéœ€è¦å‡è®¾å®¹å™¨æ˜¯å¹¶è¡Œçš„ï¼Œå¯ä»¥é˜²æ­¢å¼‚å¸¸æƒ…å†µå‡ºç°ã€‚</p>
<h4 id="_20">é…ç½®å¹¶è¡Œå±‚æ¬¡<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h4>
<p>å¹¶è¡Œå®¹å™¨é»˜è®¤çº¿ç¨‹æ•°å’Œå¤„ç†å™¨æ•°ç›®ä¸€æ ·å¤šï¼Œå³ç¨‹åºæ‰§è¡Œæ—¶ä½¿ç”¨çš„å·¥ä½œçº¿ç¨‹æ•°ç›®ã€‚</p>
<p>è¿™ä¸ªé»˜è®¤è¡Œä¸ºæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä¿®æ”¹å¹¶è¡Œå®¹å™¨çš„TaskSupportå¯¹è±¡å³å¯ã€‚è¿™é‡Œç”¨åˆ°çš„ä¸€ä¸ªç®€å•çš„ TaskSupport å®ç°æ˜¯ ForkJoinTaskSupport ç±»ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªForkJoinPoolå®¹å™¨ï¼Œç”¨æ¥è°ƒåº¦å¹¶è¡Œæ“ä½œã€‚</p>
<p>ä¸€ä¸ª TaskSupport å®ä¾‹å¯ä»¥ç”¨äºä¸åŒçš„å¹¶è¡Œå®¹å™¨ï¼Œå°†å…¶èµ‹å€¼ç»™æ¯ä¸ªå¹¶è¡Œå®¹å™¨çš„tasksupportå­—æ®µå³å¯ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-79-1">import SUC.{log, timed}
</span><span id="__span-79-2">
</span><span id="__span-79-3">import scala.collection.parallel
</span><span id="__span-79-4">import scala.concurrent.forkjoin.ForkJoinPool
</span><span id="__span-79-5">import scala.util.Random
</span><span id="__span-79-6">object ParConfig extends App {
</span><span id="__span-79-7">  val fjpool = new ForkJoinPool(2)
</span><span id="__span-79-8">  val customTaskSupport = new parallel.ForkJoinTaskSupport(fjpool)
</span><span id="__span-79-9">  val numbers = Random.shuffle(Vector.tabulate(5000000)(i =&gt; i))
</span><span id="__span-79-10">  val partime = timed {
</span><span id="__span-79-11">    val parnumbers = numbers.par
</span><span id="__span-79-12">    parnumbers.tasksupport = customTaskSupport
</span><span id="__span-79-13">    val n = parnumbers.max
</span><span id="__span-79-14">    println(s&quot;largest number $n&quot;)
</span><span id="__span-79-15">  }
</span><span id="__span-79-16">  log(s&quot;Parallel time $partime ms&quot;)
</span><span id="__span-79-17">}
</span></code></pre></div></td></tr></table></div>
<h3 id="53">5.3 å¹¶è¡Œå®¹å™¨çš„ç¼ºç‚¹<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<h4 id="_21">ä¸å¯å¹¶è¡Œå®¹å™¨<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h4>
<ol>
<li>å¯å¹¶è¡Œçš„å®¹å™¨ï¼šæœ‰äº› Scala å®¹å™¨ä¸Šçš„æ“ä½œæ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œæ¯”å¦‚Arrayã€ArrayBufferã€å¯å˜HashMapã€å¯å˜HashSetã€Rangeã€Vectorã€ä¸å¯å˜HashMapã€ä¸å¯å˜HashSetä»¥åŠå¹¶å‘TrieMapã€‚åœ¨è¿™ç±»å®¹å™¨ä¸Šè°ƒç”¨paræ–¹æ³•å¯ä»¥ç”Ÿæˆä¸€ä¸ªå¹¶è¡Œå®¹å™¨ï¼Œä¸”ä¸åŸä¸²è¡Œå®¹å™¨å…±äº«åŒä¸€ä»½æ•°æ®ï¼Œå› ä¸ºä¸éœ€è¦å¤åˆ¶æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªè½¬æ¢è¿‡ç¨‹å¾ˆå¿«ã€‚</li>
<li>ä¸å¯å¹¶è¡Œçš„å®¹å™¨ï¼šå…¶ä»–Scalaå®¹å™¨åœ¨è°ƒç”¨paræ—¶éœ€è¦è½¬æ¢æ•°æ®ï¼Œè¢«ç§°ä¸ºä¸å¯å¹¶è¡Œå®¹å™¨ã€‚åœ¨ä¸å¯å¹¶è¡Œå®¹å™¨ä¸Šè°ƒç”¨ par æ–¹æ³•éœ€è¦å°†æ•°æ®å…ƒç´ å¤åˆ¶åˆ°æ–°å®¹å™¨ä¸­ã€‚æ¯”å¦‚ï¼Œåœ¨ List å®¹å™¨ä¸Šè°ƒç”¨ paræ–¹æ³•éœ€è¦å°†æ•°æ®å…ƒç´ å¤åˆ¶åˆ°Vectorå®¹å™¨ä¸­</li>
</ol>
<h4 id="_22">ä¸å¯å¹¶è¡Œçš„æ“ä½œ<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>scalaçš„APi foldLeftå°±æ˜¯åŒä¸€ä¸ªä¸å¯å¹¶è¡Œçš„æ“ä½œ.æ¯”å¦‚æ­¤æ–¹æ³•ä»å·¦è‡³å³è®¿é—®å®¹å™¨ä¸­çš„å…ƒç´ ï¼Œå°†å®ƒä»¬åŠ åˆ°ç±»å‹ä¸ºSçš„ç´¯åŠ å™¨ä¸Šï¼Œç´¯åŠ å™¨åˆå§‹å€¼ä¸ºzï¼Œç„¶åå‡½æ•°få°†å½“å‰ç´¯åŠ å™¨å’Œç±»å‹ä¸ºTçš„å…ƒç´ ç›¸åŠ ï¼Œå¾—åˆ°æ–°çš„ç´¯åŠ å™¨ï¼Œå¹¶å‚ä¸ä¸‹ä¸€æ¬¡è®¡ç®—ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-80-1">//scalaçš„APi foldLeft
</span><span id="__span-80-2">def foldLeft[S](z: S)(f: (S, T) =&gt; S): S
</span><span id="__span-80-3">
</span><span id="__span-80-4">List(1, 2, 3).foldLeft(0)((acc, x) =&gt; acc + x)
</span></code></pre></div></td></tr></table></div>
<p>foldLeftçš„ä¸€ä¸ªå…³é”®æ€§è´¨æ˜¯å®ƒä»å·¦è‡³å³è®¿é—®é“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè¿™ä¸€ç‚¹åæ˜ åœ¨å‡½æ•°fçš„å‚æ•°ä¸Šï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸ºSçš„ç´¯åŠ å™¨å’Œä¸€ä¸ªç±»å‹ä¸ºTçš„é“¾è¡¨å…ƒç´ ã€‚å‡½æ•°fä¸èƒ½å°†ä¸¤ä¸ªç´¯åŠ å™¨åˆå¹¶ä¸ºä¸€ä¸ªç´¯åŠ å™¨ã€‚</p>
<p>è§£å†³åŠæ³•ï¼š</p>
<p>ä¸ºäº†èƒ½å¤Ÿå°†ä¸åŒå¤„ç†å™¨äº§ç”Ÿçš„ç´¯åŠ å™¨åˆå¹¶èµ·æ¥ï¼Œéœ€è¦ç”¨åˆ° aggregate æ–¹æ³•ã€‚aggregate æ–¹æ³•ç±»ä¼¼äºfoldLeftï¼Œåªä¸è¿‡å®ƒæ²¡æœ‰æŒ‰ä»å·¦è‡³å³çš„æ–¹å¼æŒ‡å®šæ•´ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ ï¼Œè€Œæ˜¯æŒ‡å®šä¸€ä¸ªå­é›†ï¼ˆè®¿é—®é¡ºåºä»ç„¶æ˜¯ä»å·¦è‡³å³ï¼‰ã€‚æ¯ä¸ªå­é›†å¯ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ç´¯åŠ å™¨ã€‚</p>
<h4 id="_23">å¹¶è¡Œå®¹å™¨çš„å‰¯ä½œç”¨<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>ä¸ºé¿å…ä½¿ç”¨åŒæ­¥ï¼Œå¹¶è·å¾—æ›´å¥½çš„å¯æ‰©å±•æ€§ï¼Œåº”å°½é‡ä½¿ç”¨å£°æ˜å¼çš„å¹¶è¡Œæ“ä½œï¼Œè€Œéåœ¨å¾ªç¯ä¸­ä½¿ç”¨å¹¶è¡Œæ“ä½œï¼ˆæœ‰å‰¯ä½œç”¨ï¼‰</p>
<p>ç±»ä¼¼åœ°ï¼Œç”¨æˆ·éœ€ç¡®ä¿å¹¶è¡Œæ“ä½œè¯»å–çš„å†…å­˜ä½ç½®ä¸Šä¸èƒ½æœ‰å¹¶å‘çš„å†™æ“ä½œã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“å‰å¹¶å‘æ“ä½œæ­£åœ¨æ‰§è¡Œæ—¶ï¼Œå­é›†bä¸åº”è¯¥è¢«å…¶ä»–çº¿ç¨‹å¹¶å‘åœ°ä¿®æ”¹ï¼Œå¦åˆ™ä¼šå¯¼è‡´å’Œå¯å˜å˜é‡ä¸€æ ·çš„é”™è¯¯ç»“æœã€‚</p>
<h4 id="_24">éç¡®å®šæ€§å¹¶è¡Œæ“ä½œï¼Œå¯äº¤æ¢çš„æ“ä½œ<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>åªè¦ç”¨äºæ§åˆ¶å¹¶è¡Œçš„çŠ¶æ€æ˜¯å¯ç¡®å®šçš„ã€‚</p>
<h2 id="8">8. è§’è‰²æ¨¡å‹<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<p>åœ¨è§’è‰²æ¨¡å‹ä¸­ï¼Œç¨‹åºç”±å¤§é‡å®ä½“æ„æˆï¼Œå®ƒä»¬å„è‡ªç‹¬ç«‹è¿è¡Œï¼Œç›¸äº’ä¹‹é—´é€šè¿‡æ¶ˆæ¯ä¼ é€’æ¥é€šä¿¡ã€‚è¿™ç§ç‹¬ç«‹çš„å®ä½“ç§°ä¸ºè§’è‰²ã€‚</p>
<p>è§’è‰²æ¨¡å‹ä¸»è¦ç”¨äºè§£å†³å…±äº«å†…å­˜å¸¦æ¥çš„é—®é¢˜ï¼Œæ¯”å¦‚æ•°æ®äº‰ç”¨æˆ–åŒæ­¥ï¼Œå› ä¸ºå®ƒå¹²è„†å°±å®Œå…¨ä¸ç”¨å…±äº«å†…å­˜ã€‚å¯å˜çŠ¶æ€è¢«é™åˆ¶åœ¨è§’è‰²å†…éƒ¨ï¼Œå½“è§’è‰²æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¹‹åï¼Œè¿™äº›çŠ¶æ€ä¼šè¢«æ½œåœ¨åœ°ä¿®æ”¹ã€‚è§’è‰²æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯è¢«ä¸²è¡Œä¾æ¬¡å¤„ç†çš„ã€‚è¿™ä¿è¯äº†è§’è‰²ä¸­çš„å¯å˜çŠ¶æ€ç»ä¸ä¼šè¢«å¹¶å‘è®¿é—®ã€‚</p>
<p>è§’è‰²çš„åˆ›å»ºå’Œæ¶ˆæ¯çš„å‘é€ä¸å…³å¿ƒè§’è‰²çš„ä½ç½®ã€‚åœ¨åˆ†å¸ƒå¼ç¼–ç¨‹ä¸­ï¼Œè¿™è¢«ç§°ä¸ºä½ç½®é€æ˜ï¼ˆlocation transparencyï¼‰ã€‚</p>
<h3 id="81">8.1 ä½¿ç”¨è§’è‰²æ¨¡å‹<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<p>å°†è§’è‰²ç³»ç»Ÿç±»æ¯”ä¸ºä¸€ä¸ªå…¬å¸</p>
<ol>
<li>
<p>è§’è‰²ç³»ç»Ÿ</p>
</li>
<li>
<p>å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªè§’è‰²çš„åˆ†å±‚ç»“æ„ï¼Œä¸”è¿™äº›è§’è‰²ä¹‹é—´å…±äº«ä¸€äº›é…ç½®é€‰é¡¹ã€‚</p>
</li>
<li>ä½œç”¨ï¼šè§’è‰²ç³»ç»Ÿè´Ÿè´£åˆ›å»ºæ–°çš„è§’è‰²ã€æŸ¥æ‰¾è§’è‰²ã€è®°å½•é‡è¦äº‹ä»¶ç­‰ã€‚è§’è‰²ç³»ç»Ÿç±»ä¼¼äºè½¯ä»¶å…¬å¸ã€‚</li>
<li>è§’è‰²ç±»</li>
<li>å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªæè¿°è§’è‰²å†…éƒ¨çŠ¶æ€å’ŒæŒ‡å¯¼è§’è‰²å¤„ç†æ¶ˆæ¯çš„æ¨¡æ¿ã€‚</li>
<li>ä½œç”¨ï¼šåŒä¸€ä¸ªè§’è‰²ç±»å¯ä»¥åˆ›å»ºå‡ºå¤šä¸ªè§’è‰²ï¼Œè§’è‰²ç±»ç±»ä¼¼äºå…¬å¸å†…çš„ç‰¹å®šèŒä½ï¼Œæ¯”å¦‚è½¯ä»¶å·¥ç¨‹å¸ˆã€è¥é”€ç»ç†æˆ–äººäº‹ç»ç†ã€‚</li>
<li>è§’è‰²å®ä¾‹</li>
<li>å®šä¹‰ï¼šè§’è‰²å®ä¾‹æ˜¯ä¸€ä¸ªå­˜åœ¨äºè¿è¡Œæ—¶å¹¶è´Ÿè´£æ¥æ”¶æ¶ˆæ¯çš„å®ä½“ã€‚è§’è‰²å®ä¾‹ä¸­å¯èƒ½åŒ…å«å¯å˜çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥å‘å…¶ä»–è§’è‰²å®ä¾‹å‘é€æ¶ˆæ¯ã€‚</li>
<li>ä½œç”¨ï¼šç±»æ¯”ä¸ºå…·ä½“çš„å‘˜å·¥ã€‚</li>
<li>æ¶ˆæ¯</li>
<li>å®šä¹‰ï¼šæ¶ˆæ¯æ˜¯è§’è‰²ä¹‹é—´é€šä¿¡çš„åŸºæœ¬å•å…ƒã€‚åœ¨ Akka ä¸­ï¼Œæ¶ˆæ¯å¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚æ¶ˆæ¯ç±»ä¼¼äºå…¬å¸å†…çš„ç”µå­é‚®ä»¶ã€‚</li>
<li>é‚®ç®±ï¼šé‚®ç®±æ˜¯ç”¨æ¥ç¼“å†²æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å†…å­˜ï¼Œåªä¸è¿‡å®ƒå±äºæ¯ä¸ªç‰¹å®šçš„è§’è‰²å®ä¾‹ã€‚è¿™ä¸ªç¼“å†²åŒºæ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå…¶ä»–è§’è‰²å®ä¾‹åªèƒ½ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ¶ˆæ¯ã€‚é‚®ç®±å¯¹åº”äºé›‡å‘˜çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ã€‚</li>
<li>è§’è‰²å¼•ç”¨</li>
<li>å®šä¹‰ï¼šè§’è‰²å¼•ç”¨æ˜¯ä¸€ç§æ”¯æŒè§’è‰²å‘ä¸€ä¸ªå…·ä½“è§’è‰²å‘é€æ¶ˆæ¯çš„å¯¹è±¡ã€‚</li>
<li>ä½œç”¨ï¼šæ­¤å¯¹è±¡å‘ç¨‹åºå‘˜éšè—äº†è§’è‰²çš„å…·ä½“ä½ç½®ä¿¡æ¯ã€‚è§’è‰²å¯èƒ½è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨ä¸åŒçš„è®¡ç®—æœºä¸Š</li>
<li>ä»è½¯ä»¶å…¬å¸çš„è§’åº¦çœ‹ï¼Œè§’è‰²å¼•ç”¨å¯¹åº”äºé›‡å‘˜çš„ç”µå­é‚®ä»¶åœ°å€ã€‚é€šè¿‡ç”µå­é‚®ä»¶åœ°å€ï¼Œé›‡å‘˜ä¹‹é—´å°±å¯ä»¥å‘é€ç”µå­é‚®ä»¶äº†ã€‚</li>
<li>è°ƒåº¦å™¨</li>
<li>å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªç”¨æ¥è°ƒåº¦è§’è‰²çš„ç»„ä»¶ï¼Œå®ƒå†³å®šäº†è§’è‰²ä½•æ—¶å¯ä»¥å¤„ç†æ¶ˆæ¯å¹¶ä¸ºä¹‹åˆ†é…è®¡ç®—èµ„æºã€‚</li>
<li>åœ¨Akka ä¸­ï¼Œè°ƒåº¦å™¨åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚è°ƒåº¦å™¨ç¡®ä¿äº†é‚£äº›é‚®ç®±éç©ºçš„è§’è‰²æ€»èƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è¿è¡Œèµ·æ¥ï¼Œå¹¶çº¿æ€§åœ°å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</li>
</ol>
<p><strong>ğŸ””</strong></p>
<p>æ‰§è¡Œä¸Šä¸‹æ–‡ï¼šæ‰§è¡Œä¸Šä¸‹æ–‡å¯ä»¥å†³å®šä»»åŠ¡æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œä»¥åŠå¦‚ä½•ç®¡ç†è¿™äº›çº¿ç¨‹ã€‚</p>
<p>åœ¨ Scala ä¸­ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡é€šå¸¸ä½œä¸ºéšå¼å‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œè¿™æ ·å‡½æ•°å¯ä»¥åœ¨ä¸éœ€è¦æ˜¾å¼ä¼ å…¥æ‰§è¡Œä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚</p>
<ol>
<li>ç±»æ¯”ï¼šè°ƒåº¦å™¨çš„ç±»æ¯”å¯¹è±¡ä¹‹ä¸€æ˜¯è½¯ä»¶å…¬å¸å†…çš„ç”µå­é‚®ä»¶å›å¤æ”¿ç­–ï¼Œä¹Ÿå°±æ˜¯è§„å®šä¸åŒèŒå‘˜çš„é‚®ä»¶ç›¸åº”æ—¶æœºã€‚</li>
</ol>
<h4 id="_25">åˆ›å»ºè§’è‰²ç³»ç»Ÿå’Œè§’è‰²å®ä¾‹<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>Akkaä¸­çš„è§’è‰²å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹å’Œå¯¹è±¡å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹å¤§è‡´ç±»ä¼¼ã€‚é¦–å…ˆä¹Ÿè¦å®šä¹‰ä¸€ä¸ªè§’è‰²ç±»ï¼Œå®ƒå®šä¹‰äº†è§’è‰²çš„è¡Œä¸ºã€‚ç„¶åï¼Œè¿˜éœ€è¦æŒ‡å®šç‰¹å®šè§’è‰²å®ä¾‹çš„é…ç½®ã€‚æœ€åï¼Œè¿˜è¦å‘Šè¯‰è§’è‰²ç³»ç»Ÿç”¨æŒ‡å®šçš„é…ç½®å®ä¾‹åŒ–è§’è‰²ï¼Œè§’è‰²ç³»ç»Ÿæ‰ä¼šåˆ›å»ºä¸€ä¸ªè§’è‰²å®ä¾‹ï¼Œå¹¶è¿”å›æ­¤å®ä¾‹çš„è§’è‰²å¼•ç”¨ã€‚</p>
<ol>
<li>
<p>è§’è‰²ç±»çš„å£°æ˜</p>
</li>
<li>
<p>è§’è‰²ç±»ç”¨äºæŒ‡å®šè§’è‰²çš„è¡Œä¸ºã€‚</p>
</li>
</ol>
<p>å®ƒæè¿°äº†è§’è‰²å¦‚ä½•å“åº”æ¶ˆæ¯å’Œä¸å…¶ä»–è§’è‰²é€šä¿¡ã€‚å£°æ˜ä¸€ä¸ªæ–°çš„è§’è‰²ç±»éœ€è¦æ‰©å±•akka.actoråŒ…ä¸­çš„Actorç‰¹è´¨ã€‚å¹¶å®ç°receiveæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å‡¡è¿”å›ä¸€ä¸ªåå‡½æ•°å¯¹è±¡ã€‚å½“è§’è‰²æ”¶é›†åˆ°Anyç±»å‹çš„ä¿¡æ¯çš„æ—¶å€™ï¼Œè¯¥éƒ¨åˆ†å‡½æ•°å¯¹è±¡å°±ä¼šè¢«è°ƒç”¨ã€‚å¦åˆ™è¯¥æ¶ˆæ¯ä¼šè¢«å¿½ç•¥ã€‚</p>
<ul>
<li>è§’è‰²ç±»è¿˜å°è£…äº†è¿™ä¸ªè§’è‰²ä¼šç”¨åˆ°çš„å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™äº›å¯¹è±¡è¡¨ç¤ºäº†è§’è‰²çš„çŠ¶æ€ã€‚</li>
</ul>
<p><strong>ğŸ“Œ</strong></p>
<p>å®šä¹‰: PartialFunction åå‡½æ•° å…è®¸ä½ å®šä¹‰ä¸€ä¸ªåªå¯¹æŸäº›è¾“å…¥æœ‰å®šä¹‰çš„å‡½æ•°ã€‚</p>
<p>åº”ç”¨: å¸¸ç”¨äºå¤„ç†é‚£äº›ä¸éœ€è¦ä¸ºæ‰€æœ‰å¯èƒ½çš„è¾“å…¥éƒ½æä¾›æœ‰æ„ä¹‰è¾“å‡ºçš„æƒ…å†µã€‚</p>
<p>å®ç°: é€šè¿‡ case è¯­å¥æˆ–è€… if æ¡ä»¶æ¥å®ç°æ¨¡å¼åŒ¹é…ã€‚</p>
<p>ä½¿ç”¨: å¯ä»¥ç›´æ¥åº”ç”¨äº foreach æˆ–è€… collect ç­‰é›†åˆæ“ä½œä¸Šã€‚</p>
<p>PartialFunction åœ¨å¤„ç†å¦‚é”™è¯¯å¤„ç†ã€æ•°æ®è½¬æ¢ç­‰åœºæ™¯æ—¶éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä¼˜é›…åœ°å¤„ç†æ— æ•ˆè¾“å…¥çš„æƒ…å†µä¸‹ã€‚</p>
<p>ä¾‹å­ï¼šä¸‹é¢çš„Actorç±»å¯ä»¥ç›¸åº”æ¶ˆæ¯helloã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-81-1">    import akka.actor._
</span><span id="__span-81-2">    import akka.event.Logging
</span><span id="__span-81-3">    class HelloActor(val hello: String) extends Actor {
</span><span id="__span-81-4">      //è¯¥loggingå¯¹è±¡å¼•ç”¨äº†å½“å‰è§’è‰²ç³»ç»Ÿä»¥åŠå½“å‰è§’è‰²
</span><span id="__span-81-5">      val log = Logging(context.system, this)
</span><span id="__span-81-6">      //éƒ¨åˆ†å‡½æ•°
</span><span id="__span-81-7">      def receive = {
</span><span id="__span-81-8">        //å¯ä»¥ç›¸åº”æ¶ˆæ¯hello
</span><span id="__span-81-9">        case `hello` =&gt;
</span><span id="__span-81-10">          log.info(s&quot;Received a &#39;$hello&#39;... $hello!&quot;)
</span><span id="__span-81-11">        case msgã€€ã€€ =&gt;
</span><span id="__span-81-12">          log.info(s&quot;Unexpected message &#39;$msg&#39;&quot;)
</span><span id="__span-81-13">          //åœæ­¢å½“å‰è§’è‰²
</span><span id="__span-81-14">          context.stop(self)
</span><span id="__span-81-15">      }
</span><span id="__span-81-16">    }
</span></code></pre></div></td></tr></table></div>
<ol>
<li>è§’è‰²é…ç½®</li>
<li>ä¸€ä¸ªè§’è‰²é…ç½®ä¸­çš„ä¿¡æ¯åŒ…æ‹¬è§’è‰²ç±»ã€å…¶æ„é€ å‡½æ•°å‚æ•°ã€é‚®ç®±ã€è°ƒåº¦å™¨çš„å®ä¾‹ã€‚</li>
<li>åœ¨Akkaä¸­ï¼Œè§’è‰²é…ç½®ç”±Propsç±»è¡¨ç¤ºã€‚Propså¯¹è±¡å°è£…äº†åˆ›å»ºè§’è‰²å®ä¾‹ æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åºåˆ—åŒ–ä¹‹åé€šè¿‡ç½‘ç»œå‘é€ã€‚</li>
<li>ä½¿ç”¨æ–¹æ³•ï¼šä¸ºäº†åˆ›å»ºPropså¯¹è±¡ï¼Œæ¨èçš„åšæ³•æ˜¯åœ¨è§’è‰²ç±»çš„ä¼´ç”Ÿå¯¹è±¡ä¸­å£°æ˜ä¸€äº›å·¥å‚æ–¹æ³•</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-82-1">object HelloActor {
</span><span id="__span-82-2">//props æ–¹æ³•ç”¨åˆ° Props.apply å·¥å‚æ–¹æ³•çš„ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œ
</span><span id="__span-82-3">//å®ƒé€šè¿‡åˆ›å»ºHelloActorç±»æ¥æ¥æ”¶ä¸€ä¸ªä»£ç å—ã€‚
</span><span id="__span-82-4">  def props(hello: String): Props = Props(new HelloActor(hello))
</span><span id="__span-82-5">//propsAltæ–¹æ³•ç”¨åˆ°äº†Props.applyçš„å¦å¤–ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œ
</span><span id="__span-82-6">//å®ƒç”±è§’è‰²ç±»çš„Classå¯¹è±¡å’Œæ„é€ å‡½æ•°å‚æ•°é“¾è¡¨åˆ›å»ºå‡ºä¸€ä¸ªè§’è‰²å®ä¾‹ã€‚è¿™ä¸¤ä¸ªé‡è½½æ–¹æ³•åœ¨è¯­ä¹‰ä¸Šæ˜¯ç­‰ä»·çš„
</span><span id="__span-82-7">  def propsAlt(hello: String): Props = Props(classOf[HelloActor], hello)
</span><span id="__span-82-8">}
</span></code></pre></div></td></tr></table></div>
<p><strong>ğŸ“Œ</strong></p>
<p>ç¬¬ä¸€ä¸ªProps.applyæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨è§’è‰²ç±»æ„é€ å‡½æ•°çš„é—­åŒ…ã€‚å¦‚æœç”¨æˆ·ä¸å¤Ÿä»”ç»†ï¼Œè¿™ä¸ªé—­åŒ…å¾ˆå®¹æ˜“æ•æ‰åˆ°å¤–å±‚çš„å¼•ç”¨ï¼Œè¿™æ—¶ï¼Œè¿™äº›å¼•ç”¨ä¼šå˜æˆPropså¯¹è±¡çš„ä¸€éƒ¨åˆ†ã€‚ä¼šå¯¼è‡´ç½‘ç»œä¼ è¾“çš„æ—¶å€™ä¸€åŒå‘é€ï¼Œå¯¼è‡´é¢å¤–çš„ç½‘ç»œå¼€é”€</p>
<ol>
<li>è§’è‰²ç³»ç»Ÿä¸è§’è‰²åˆ›å»º</li>
</ol>
<p>åœ¨å®ä¾‹åŒ–è§’è‰²æ—¶ï¼Œéœ€è¦å°†å…¶è§’è‰²é…ç½®å‘é€ç»™è§’è‰²ç³»ç»Ÿçš„ actorOf æ–¹æ³•ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-83-1">//åŒ…å¯¹è±¡ï¼šlazy val ourSystem = ActorSystem(&quot;OurExampleSystem&quot;)  
</span><span id="__span-83-2">object ActorCreate extends App{
</span><span id="__span-83-3">  private val hiActor: ActorRef = ourSystem.actorOf(HelloActor.props(&quot;hi&quot;), name = &quot;greeter&quot;)
</span><span id="__span-83-4">  //å‘hiActorå‘é€æ¶ˆæ¯&quot;hi&quot;
</span><span id="__span-83-5">  hiActor ! &quot;hi&quot;
</span><span id="__span-83-6">  Thread.sleep(1000)
</span><span id="__span-83-7">  hiActor ! &quot;hola&quot;
</span><span id="__span-83-8">  Thread.sleep(1000)
</span><span id="__span-83-9">  //å…³é—­hiActor
</span><span id="__span-83-10">  ourSystem.terminate()
</span><span id="__span-83-11">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_26">æœªå¤„ç†æ¶ˆæ¯çš„ç®¡ç†<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p>è§’è‰²å®ä¾‹ä¼šåœ¨é»˜è®¤æƒ…å†µä¸‹å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸äºˆå¤„ç†ï¼Œreceive æ–¹æ³•æœªå¤„ç†çš„æ¶ˆæ¯ä¼šè¢«å°è£…æˆUnhandledMessageå¯¹è±¡ï¼Œç„¶åè½¬å‘ç»™è§’è‰²ç³»ç»Ÿçš„äº‹ä»¶æµï¼Œè¿™å¸¸ç”¨äºæ—¥å¿—è®°å½•ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-84-1">import akka.actor._
</span><span id="__span-84-2">import akka.event.{Logging, LoggingAdapter}
</span><span id="__span-84-3">
</span><span id="__span-84-4">// å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥æ¼”ç¤ºæœªå¤„ç†æ¶ˆæ¯çš„å¤„ç†
</span><span id="__span-84-5">object ActorsUnhandled extends App{
</span><span id="__span-84-6">  // åˆ›å»ºä¸€ä¸ªä¸ä¼šå¤„ç†ä»»ä½•æ¶ˆæ¯çš„æ¼”å‘˜
</span><span id="__span-84-7">  private val deafActor: ActorRef = ourSystem.actorOf(Props[DeafActor], name = &quot;deafy&quot;)
</span><span id="__span-84-8">
</span><span id="__span-84-9">  // å‘æ¼”å‘˜å‘é€ä¸€ä¸ªå­—ç¬¦ä¸²æ¶ˆæ¯
</span><span id="__span-84-10">  deafActor ! &quot;hi&quot;
</span><span id="__span-84-11">  // ç­‰å¾…1ç§’
</span><span id="__span-84-12">  Thread.sleep(1000)
</span><span id="__span-84-13">
</span><span id="__span-84-14">  // å‘æ¼”å‘˜å‘é€ä¸€ä¸ªæ•´æ•°æ¶ˆæ¯
</span><span id="__span-84-15">  deafActor ! 12010
</span><span id="__span-84-16">  // å†æ¬¡ç­‰å¾…1ç§’
</span><span id="__span-84-17">  Thread.sleep(1000)
</span><span id="__span-84-18">
</span><span id="__span-84-19">  // ç»ˆæ­¢ç³»ç»Ÿ
</span><span id="__span-84-20">  ourSystem.terminate()
</span><span id="__span-84-21">}
</span><span id="__span-84-22">
</span><span id="__span-84-23">// å®šä¹‰ä¸€ä¸ªæ¼”å‘˜ç±»ï¼Œè¯¥ç±»ä¸ä¼šå¤„ç†ä»»ä½•æ¶ˆæ¯
</span><span id="__span-84-24">class DeafActor extends Actor{
</span><span id="__span-84-25">  // åˆå§‹åŒ–æ—¥å¿—é€‚é…å™¨
</span><span id="__span-84-26">  private val log: LoggingAdapter = Logging(context.system, this)
</span><span id="__span-84-27">
</span><span id="__span-84-28">  // å®šä¹‰æ¥æ”¶æ¶ˆæ¯çš„è¡Œä¸ºï¼Œæ­¤å¤„ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯
</span><span id="__span-84-29">  override def receive: Receive = PartialFunction.empty
</span><span id="__span-84-30">
</span><span id="__span-84-31">  // é‡å†™unhandledæ–¹æ³•æ¥å¤„ç†æœªå¤„ç†çš„æ¶ˆæ¯
</span><span id="__span-84-32">  override def unhandled(message: Any) = {
</span><span id="__span-84-33">    // æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†
</span><span id="__span-84-34">    message match{
</span><span id="__span-84-35">      case msg:String =&gt; log.info(s&quot;unhandled msg : $msg&quot;)
</span><span id="__span-84-36">      case other =&gt; super.unhandled(other)
</span><span id="__span-84-37">    }
</span><span id="__span-84-38">  }
</span><span id="__span-84-39">}
</span></code></pre></div></td></tr></table></div>
<h4 id="_27">è§’è‰²è¡Œä¸ºå’ŒçŠ¶æ€åˆ‡æ¢<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>Actorç±»çš„receiveæ–¹æ³•å¿…é¡»è¿”å›åå‡½æ•°ï¼Œä½†æ˜¯ä¸å®œæ ¹æ®è§’è‰²çš„çŠ¶æ€è¿”å›ä¸åŒçš„åå‡½æ•°ã€‚</p>
<p>å¦‚ä¸‹è¡Œä¸ºæ˜¯ä¸è¢«å…è®¸çš„</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-85-1">class CountdownActor extends Actor {
</span><span id="__span-85-2">  var n = 10
</span><span id="__span-85-3">  def receive = if (n &gt; 0) { // ä¸è¦è¿™æ ·åš
</span><span id="__span-85-4">    case &quot;count&quot; =&gt;
</span><span id="__span-85-5">      log(s&quot;n = $n&quot;)
</span><span id="__span-85-6">      n -= 1
</span><span id="__span-85-7">  } else PartialFunction.empty
</span><span id="__span-85-8">}
</span></code></pre></div></td></tr></table></div>
<p>æ­£ç¡®æ–¹å¼:</p>
<p>å½“ä¸€ä¸ªçŠ¶æ€åŒ–çš„è§’è‰²éœ€è¦ä¿®æ”¹è¡Œä¸ºæ—¶ï¼Œä¸ºæ¯ä¸€ç§è¡Œä¸ºå£°æ˜ä¸€ä¸ªç‹¬ç«‹çš„åå‡½æ•°ï¼Œç„¶ååœ¨receiveæ–¹æ³•ä¸­è¿”å›åˆå§‹è¡Œä¸ºå¯¹åº”çš„åå‡½æ•°ã€‚</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-86-1">class CountdownActor extends Actor {
</span><span id="__span-86-2">  val log = Logging(context.system, this)
</span><span id="__span-86-3">  var n = 10
</span><span id="__span-86-4">//æ³¨æ„ï¼Œè¿™é‡Œç”¨åˆ°ä¼´ç”Ÿå¯¹è±¡Actorä¸­çš„ç±»å‹åˆ«åReceiveï¼Œ
</span><span id="__span-86-5">//å®ƒåªä¸è¿‡æ˜¯PartialFunction[Any,Unit]ç±»å‹çš„ç¼©å†™ã€‚
</span><span id="__span-86-6">
</span><span id="__span-86-7">  def counting: Actor.Receive = {
</span><span id="__span-86-8">    case &quot;count&quot; =&gt;
</span><span id="__span-86-9">      n -= 1
</span><span id="__span-86-10">      log.info(s&quot;n = $n&quot;)
</span><span id="__span-86-11">      if (n == 0) context.become(done)
</span><span id="__span-86-12">  }
</span><span id="__span-86-13">  def done = PartialFunction.empty
</span><span id="__span-86-14">  def receive = counting
</span><span id="__span-86-15">}
</span></code></pre></div></td></tr></table></div>
<p>å½“ä¸ºå¤æ‚è§’è‰²å»ºæ¨¡æ—¶ï¼Œå°†å®ƒä»¬è§†ä¸ºçŠ¶æ€æœºï¼ˆstatemachineï¼‰æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  å›åˆ°é¡µé¢é¡¶éƒ¨
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      lx CC-BY-4.0
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.indexes", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.action.edit"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../javascripts/katex.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>