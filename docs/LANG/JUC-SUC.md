# JUC-SUC

> éƒ¨åˆ†ç›®å½•ç¼ºå¤±

## å¹¶å‘ç®€ä»‹

### 1.1 çº¿ç¨‹çš„åˆ›å»º

1. åˆ›å»ºæ–¹æ³•ï¼š
   1. ç»§æ‰¿Threadç±»ï¼š
      1. ç»§æ‰¿Threadç±»ï¼Œå¹¶é‡å†™run()æ–¹æ³•ï¼Œrunå°±æ˜¯æ–°çº¿ç¨‹è¦æ‰§è¡Œçš„äº‹æƒ…ã€‚
      2. åˆ›å»ºThreadå­ç±»çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶è°ƒç”¨start()æ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚

```
package com.atguigu.thread;

//è‡ªå®šä¹‰çº¿ç¨‹ç±»
public class MyThread extends Thread {
     //å®šä¹‰æŒ‡å®šçº¿ç¨‹åç§°çš„æ„é€ æ–¹æ³•
     public MyThread(String name) {
         //è°ƒç”¨çˆ¶ç±»çš„ String å‚æ•°çš„æ„é€ æ–¹æ³•ï¼ŒæŒ‡å®šçº¿ç¨‹çš„åç§°
         super(name);
     }
     /**
     * é‡å†™ run æ–¹æ³•ï¼Œå®Œæˆè¯¥çº¿ç¨‹æ‰§è¡Œçš„é€»è¾‘
     */
     @Override
     public void run() {
         for (int i = 0; i < 10; i++) {
         System.out.println(getName()+"ï¼šæ­£åœ¨æ‰§è¡Œï¼"+i);
         }
     }
}

//æµ‹è¯•ç±»
package com.atguigu.thread;
public class TestMyThread {
 public static void main(String[] args) {
     //åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹å¯¹è±¡ 1
     MyThread mt1 = new MyThread("å­çº¿ç¨‹ 1");
     //å¼€å¯å­çº¿ç¨‹ 1
     mt1.start();
   
     //åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹å¯¹è±¡ 2
     MyThread mt2 = new MyThread("å­çº¿ç¨‹ 2");
     //å¼€å¯å­çº¿ç¨‹ 2
     mt2.start();
   
     //åœ¨ä¸»æ–¹æ³•ä¸­æ‰§è¡Œ for å¾ªç¯
     for (int i = 0; i < 10; i++) {
         System.out.println("main çº¿ç¨‹ï¼"+i);
     }
 }
}
```

1. å®ç°Runnableæ¥å£ï¼š
   1. èƒŒæ™¯ï¼šJavaæœ‰å•ç»§æ‰¿é™åˆ¶ï¼Œå½“æ— æ³•ç»§æ‰¿Threadç±»çš„æ—¶å€™ï¼Œå¯ä»¥å®ç°Runnableæ¥å£
   2. æ­¥éª¤ï¼š
      1. å®ç°Runnableæ¥å£ï¼Œå¹¶é‡å†™runæ–¹æ³•ï¼Œè¯¥runæ–¹æ³•å°±æ˜¯çº¿ç¨‹çš„æ‰§è¡Œä½“ã€‚
      2. åˆ›å»ºRunnableæ¥å£å®ç°ç±»çš„å®ä¾‹ï¼Œå¹¶ä½œä¸ºtargetå‚æ•°ä¼ äººThreadç±»çš„å®ä¾‹(çº¿ç¨‹å¯¹è±¡)
      3. å¯åŠ¨çº¿ç¨‹å¯¹è±¡çš„startæ–¹æ³•

**ğŸ“Œ**

çº¿ç¨‹å¯¹è±¡ä¸€ç›´éƒ½æ˜¯Threadå¯¹è±¡ã€‚

1. å¦‚æœå¯ä»¥ç›´æ¥ç»§æ‰¿ï¼Œå¹¶é‡å†™runæ–¹æ³•ï¼Œå°±å¯ä»¥ç›´æ¥æä¾›çº¿ç¨‹æ‰§è¡Œä½“
2. å¦‚æœä¸å¯ä»¥ç»§æ‰¿Threadï¼Œå°±éœ€ç”¨ä¸€ä¸ªå®ç°Runnableæ¥å£çš„å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥Threadå¯¹è±¡ä¸­ï¼Œä½œä¸ºçº¿ç¨‹æ‰§è¡Œä½“ã€‚

```
package com.atguigu.thread;
public class MyRunnable implements Runnable {
     @Override
     public void run() {
         for (int i = 0; i < 20; i++) {
             System.out.println(Thread.currentThread().getName() + " "
            + i);
         }
     }
}
æµ‹è¯•ç±»ï¼š
package com.atguigu.thread;
public class TestMyRunnable {
     public static void main(String[] args) {
         //åˆ›å»ºè‡ªå®šä¹‰ç±»å¯¹è±¡ çº¿ç¨‹ä»»åŠ¡å¯¹è±¡
         MyRunnable mr = new MyRunnable();
         //åˆ›å»ºçº¿ç¨‹å¯¹è±¡
         Thread t = new Thread(mr, "é•¿æ±Ÿ");
         t.start();
         for (int i = 0; i < 20; i++) {
             System.out.println("é»„æ²³ " + i);
         }
     }
}
```

### 1.2å¹¶å‘åŸºç¡€

1. æ“ä½œç³»ç»Ÿå¤šè¿›ç¨‹çš„åŸå› ï¼š
   1. èµ„æºåˆ©ç”¨ç‡ï¼šé€šè¿‡è¿›ç¨‹åˆ‡æ¢æ¥é«˜æ•ˆåˆ©ç”¨CPU
   2. å…¬å¹³æ€§ï¼šé€šè¿‡æ—¶é—´åˆ†ç‰‡ç­‰æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å…±äº«CPUï¼Œè€Œä¸æ˜¯ä»å¤´åˆ°å°¾çš„ä¸²è¡Œ
   3. ä¾¿åˆ©æ€§(çº¿ç¨‹)ï¼š
      1. é€šè¿‡åœ¨è¿›ç¨‹ä¸­åŠ å…¥çº¿ç¨‹ï¼Œä½¿å¾—å•ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªç¨‹åºæ§åˆ¶æµã€‚å¤šä¸ªçº¿ç¨‹å…±äº«å †åŒºåŸŸå’Œä»£ç åŒºï¼Œä»¥åŠæ–‡ä»¶å¥æŸ„ç­‰èµ„æºï¼Œ
      2. ä½†æ˜¯åˆæœ‰å„è‡ªçš„ç¨‹åºè®¡æ•°å™¨ï¼Œæ ˆåŒºã€‚åŒä¸€ä¸ªè¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹å®¢å¯ä»¥è¢«åŒæ—¶è°ƒåº¦åˆ°å¤šä¸ªCPUä¸Šæ‰§è¡Œã€‚
      3. çº¿ç¨‹æ˜¯ç¨‹åºè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚
2. å¤šçº¿ç¨‹çš„ä¼˜åŠ¿ï¼š
3. å‘æŒ¥å¤šå¤„ç†å™¨çš„æ€§èƒ½ï¼šç”±äºè°ƒåº¦çš„åŸºæœ¬å•ä½æ˜¯çº¿ç¨‹ï¼Œè€Œå¤šçº¿ç¨‹å°±å¯ä»¥åŒæ—¶è°ƒåº¦åœ¨å¤šä¸ªæ ¸ä¸Šã€‚å°±ç®—åªæœ‰ä¸€ä¸ªå¤„ç†å™¨ï¼Œå¤šçº¿ç¨‹ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒIOçš„æ—¶å€™ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œæé«˜CPUåˆ©ç”¨ç‡ï¼Œè€Œä¸æ˜¯ç­‰å¾…é˜»å¡çš„è¿”å›ã€‚
4. å»ºæ¨¡ç®€å•ï¼šå¯ä»¥ä¸ºæ¨¡å‹ä¸­æ¯æ¯ç§ä»»åŠ¡çš„éƒ½åˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œå½¢æˆä¸²è¡Œæ‰§è¡Œçš„å‡è±¡ã€‚å¤šçº¿ç¨‹å¯ä»¥å°†å¤æ‚ä¸”å¼‚æ­¥çš„å·¥ä½œæµè¿›ä¸€æ­¥åˆ†è§£ä¸ºä¸€ç»„ç®€å•å¹¶ä¸”åŒæ­¥çš„å·¥ä½œæµï¼Œä¸åŒçš„å·¥ä½œæµåœ¨ç‰¹å®šä½ç½®äº¤äº’ã€‚
5. å¼‚æ­¥äº‹ä»¶çš„ç®€åŒ–å¤„ç†ï¼šæœåŠ¡å™¨ç¨‹åºåœ¨æ¥æ”¶å¤šä¸ªå®¢æˆ·ç«¯çš„Socketè¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœä¸ºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½åˆ†é…å•ç‹¬çš„çº¿ç¨‹å¹¶ä¸”ä½¿ç”¨åŒæ­¥IO,å°±ä¼šé™ä½å¼€å‘éš¾åº¦

**ğŸ””**

åŒæ­¥å’Œå¼‚æ­¥(æ˜¯æ¶ˆæ¯çš„é€šçŸ¥æœºåˆ¶)ï¼š

åŒæ­¥IOï¼šåœ¨åŒæ­¥IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œå¿…é¡»ç­‰å¾…IOæ“ä½œå®Œæˆï¼Œæ‰å¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ªæ­¥éª¤ã€‚

å¼‚æ­¥IOï¼šåœ¨å¼‚æ­¥IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘å‡ºIOè¯·æ±‚ä¹‹åï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚å½“IOå®Œæˆä¹‹åï¼Œä¼šé€šè¿‡æŸç§æ–¹å¼é€šçŸ¥(æ¯”å¦‚å›è°ƒå‡½æ•°)é€šçŸ¥è¿›ç¨‹ã€‚

é˜»å¡å’Œéé˜»å¡(æ˜¯ç¨‹åºåœ¨ç­‰å¾…æ¶ˆæ¯(æ— æ‰€è°“åŒæ­¥å¼‚æ­¥)æ—¶å€™çš„çŠ¶æ€)ï¼š

é˜»å¡IOï¼šåœ¨é˜»å¡IOä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å‘èµ·IOæ“ä½œï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ä¸ºæ­¢ã€‚

éé˜»å¡IOï¼šè¿›ç¨‹å‘å‡ºè¯·æ±‚ä¹‹åç«‹å³è¿”å›

å››è€…ä¹‹é—´æ²¡æœ‰ç»å¯¹å…³ç³»ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªé˜»å¡çš„å¼‚æ­¥IOæ¨¡å‹ï¼šè¿›ç¨‹å‘èµ·ä¸€ä¸ªIOæ“ä½œåï¼Œä¸éœ€è¦ç­‰å¾…IOæ“ä½œçš„å®Œæˆï¼Œä½†å¦‚æœæ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¿›ç¨‹å°±ä¼šè¢«æŒ‚èµ·ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ä¸ºæ­¢ã€‚

åŒæ­¥/å¼‚æ­¥ä¸é˜»å¡/éé˜»å¡æ˜¯ä¸¤ç»„ä¸åŒçš„æ¦‚å¿µï¼Œå®ƒä»¬å¯ä»¥å…±å­˜ç»„åˆï¼Œè€Œå¾ˆå¤šäººä¹‹æ‰€ä»¥æŠŠåŒæ­¥å’Œé˜»å¡æ··æ·†ï¼Œæˆ‘æƒ³ä¹Ÿæ˜¯å› ä¸ºæ²¡æœ‰åŒºåˆ†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œæ¯”å¦‚åœ¨è¿›ç¨‹é˜»å¡çš„ read/write æ“ä½œä¸­ï¼Œå…¶å®æ˜¯æŠŠæ¶ˆæ¯é€šçŸ¥å’Œå¤„ç†æ¶ˆæ¯ç»“åˆåœ¨äº†ä¸€èµ·ï¼Œåœ¨è¿™é‡Œæ‰€å…³æ³¨çš„æ¶ˆæ¯å°±æ˜¯ fd æ˜¯å¦å¯è¯»/å†™ï¼Œè€Œå¤„ç†æ¶ˆæ¯åˆ™æ˜¯å¯¹ fd è¯»/å†™ï¼Œå½“æˆ‘ä»¬å°†è¿™ä¸ª fd è®¾ç½®ä¸ºéé˜»å¡çš„æ—¶å€™ï¼Œread/write æ“ä½œå°±ä¸ä¼šåœ¨ç­‰å¾…æ¶ˆæ¯é€šçŸ¥è¿™é‡Œé˜»å¡ï¼Œå¦‚æœ fd ä¸å¯è¯»/å†™åˆ™æ“ä½œç«‹å³è¿”å›ã€‚

1. å¤šçº¿ç¨‹çš„é£é™©ï¼š
   1. å®‰å…¨æ€§é—®é¢˜ï¼š
      1. æ¡ˆä¾‹ï¼šéçº¿ç¨‹å®‰å…¨çš„æ•°å€¼åºåˆ—ç”Ÿæˆå™¨ï¼š
         1. å¦‚ä¸‹é¢çš„æ–¹æ³•getNextï¼Œå…¶ä¸­valueæ˜¯æˆå‘˜å˜é‡è¿›ç¨‹å†…çº¿ç¨‹å…±äº«ã€‚
         2. åœ¨å•çº¿ç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œæ²¡æœ‰é—®é¢˜ã€‚ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œvalue++çš„æ“ä½œå®é™…ä¸Šæ˜¯å†…å­˜->å¯„å­˜å™¨ï¼Œvalue+1ï¼Œå°†valueå†è¿”å›å†…å­˜åŒºåŸŸã€‚æ“ä½œå¹¶ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯æƒ…å†µã€‚
         3. è¯¥æ¡ˆä¾‹è¯´æ˜çš„æ˜¯å¸¸è§çš„ç«æ€æ¡ä»¶(race condition)ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸã€‚
         4. æ”¹æ­£ï¼šä½¿ç”¨synchronizedå…³é”®å­—ï¼Œrace conditionéƒ¨åˆ†å®ç°é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢äº¤æ›¿æ‰§è¡Œçš„æƒ…å†µå‘ç”Ÿã€‚

```
# éçº¿ç¨‹å®‰å…¨
public class unsafeSequence {
    private int value;

    public int getNext() {
        return value++;
    }
}

#ä¿®æ­£ï¼çº¿ç¨‹å®‰å…¨ï¼š
@ThreadSafe
public class Sequence {
    private int value;
    public synchronized int getNext(){
        return value++;
    }
}
```

1. å®‰å…¨æ€§é—®é¢˜ï¼š
   1. æ— é™å¾ªç¯ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚
   2. æ­»é”ï¼Œé¥¥é¥¿ï¼Œæ´»é”
2. æ€§èƒ½é—®é¢˜ï¼š
3. ä¸Šä¸‹æ–‡åˆ‡æ¢å¼•å‘çš„æ¶ˆè€—ï¼Œä¼šä½¿å¾—ç¨‹åºä¸¢å¤±å±€éƒ¨æ€§ï¼Œå¹¶ä¸”CPUèŠ±è´¹è¿‡å¤šæ—¶é—´åœ¨è°ƒåº¦ä¸Šã€‚
4. åŒæ­¥æœºåˆ¶ï¼Œå¯èƒ½ä¼šé˜»æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚

## 2 . çº¿ç¨‹å®‰å…¨

### 2.1 çº¿ç¨‹å®‰å…¨

1. å½“å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯å˜å˜é‡çš„æ—¶å€™ï¼Œå¤„ç†æ–¹æ³•ï¼š
   1. ä¸åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«è¯¥å˜é‡
   2. å°†å˜é‡æ”¹ä¸ºä¸å¯å˜ç±»å‹
   3. åœ¨è®¿é—®çŠ¶æ€å˜é‡çš„æ—¶å€™ä½¿ç”¨åŒæ­¥å˜é‡
2. çº¿ç¨‹å®‰å…¨æ€§ï¼š
3. å®šä¹‰ï¼šæŸä¸ªç±»çš„è¡Œä¸ºä¸å…¶è§„èŒƒå®Œå…¨ä¸€è‡´ã€‚è‰¯å¥½çš„è§„èŒƒåŒ…æ‹¬å„ç§ä¸å˜æ¡ä»¶æ¥çº¦æŸå¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥åŠå®šä¹‰å„ç§åéªŒæ¡ä»¶æ¥æè¿°å¯¹è±¡æ“ä½œçš„ç»“æœã€‚å½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»çš„æ—¶å€™ï¼Œè¯¥ç±»å§‹ç»ˆå¯ä»¥è¡¨ç°æ­£ç¡®çš„è¡Œä¸ºï¼Œè€Œä¸”ä¸»è°ƒå‡½æ•°ä¸ç”¨ä½¿ç”¨é¢å¤–çš„åŒæ­¥æˆ–è€…åè°ƒï¼Œè¯¥ç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨æ€§çš„ã€‚
4. ä¾‹å­ï¼š
5. Servlet:Servletï¼ˆServer Appletï¼‰æ˜¯Java Servletçš„ç®€ç§°ï¼Œç§°ä¸ºå°æœåŠ¡ç¨‹åºæˆ–æœåŠ¡è¿æ¥å™¨ï¼Œæ³›æŒ‡ç”¨ **Javaç¼–å†™çš„æœåŠ¡å™¨ç«¯ç¨‹åº**ã€‚åœ¨ç¼–ç¨‹è¿‡ç¨‹ä¸­ä¹ŸæŒ‡ä¸€åˆ‡ **å®ç°äº†Servletæ¥å£çš„ç±»**ï¼ˆçº¦å®šä»¥Servletç»“å°¾å‘½åï¼‰ã€‚
6. ä¸‹é¢çš„Servletä»è¯·æ±‚ä¸­æå–å‡ºæ•°å€¼ï¼Œè¿›è¡Œå› å¼åˆ†è§£ï¼Œç„¶åå°†æ•°æ®å°è£…è¿›å…¥è¯¥Servletçš„ç›¸åº”ä¸­ã€‚
7. å®‰å…¨æ€§ï¼šç”±äºè¯¥ç±»æ˜¯æ— çŠ¶æ€çš„ï¼Œå®ƒæ—¢ä¸åŒ…å«ä»»ä½•æˆå‘˜å˜é‡ï¼Œä¹Ÿä¸åŒ…å«å¯¹å…¶ä»–ç±»çš„æˆå‘˜å˜é‡çš„å¼•ç”¨ã€‚è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€åªå­˜åœ¨äºçº¿ç¨‹æ ˆä¸Šçš„å±€éƒ¨å˜é‡ä¸­ï¼Œè€Œçº¿ç¨‹æ ˆæ˜¯ç§æœ‰çš„ã€‚ä¸ä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹ä¹‹é—´æœ‰å…±äº«çš„çŠ¶æ€ã€‚æ‰€ä»¥çº¿ç¨‹è®¿é—®æ— çŠ¶æ€å¯¹è±¡å¹¶ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚
8. æ— çŠ¶æ€å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

```
public class StatelessFactorizer extends GenericServlet implements Servlet {

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        encodeIntoResponse(resp, factors);
    }

    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
    }

    BigInteger extractFromRequest(ServletRequest req) {
        return new BigInteger("7");
    }

    BigInteger[] factor(BigInteger i) {
        // Doesn't really factor
        return new BigInteger[] { i };
    }
}
```

### 2.2 åŸå­æ€§

1. å‡è®¾åœ¨æ— çŠ¶æ€å¯¹è±¡ä¸­å¢åŠ ä¸€ä¸ªçŠ¶æ€
2. ä¸‹è¿°ä¾‹å­ä¸­ï¼Œå¢åŠ ä¸€ä¸ªå‘½ä¸­è®¡æ•°å™¨çš„æˆå‘˜å±æ€§æ¥ç»Ÿè®¡è¯·æ±‚æ¬¡æ•°ã€‚
3. ç”±äºæ“ä½œä¸æ˜¯åŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªæ“ä½œåºåˆ—ï¼Œå¹¶ä¸”ä¾èµ–äºä¹‹å‰çš„çŠ¶æ€
4. è¯¥æƒ…å†µç§°ä¸ºç«æ€æ¡ä»¶ã€‚

**ğŸ‘‹**

æœ€å¸¸è§çš„ç«æ€æ¡ä»¶ï¼šå…ˆæ£€æŸ¥åæ‰§è¡Œ

æœ¬è´¨æ˜¯å…ˆè§‚å¯Ÿåˆ°æŸä¸ªæ¡ä»¶ï¼Œç„¶ååŸºäºè§‚å¯Ÿçš„ç»“æœè¿›è¡Œç›¸åº”çš„åŠ¨ä½œã€‚ä½†æ˜¯å®é™…ä¸Šåœ¨è§‚å¯Ÿåˆ°é‡‡å–åŠ¨ä½œä¹‹é—´ï¼Œä¹‹å‰çš„è§‚å¯Ÿç»“æœå¯èƒ½å·²ç»æ— æ•ˆï¼Œä»è€Œä¼šå¯¼è‡´å„ç§é—®é¢˜ã€‚

ç«æ€æ¡ä»¶å¹¶ä¸ç­‰äºæ•°æ®ç«äº‰ï¼

```
public class UnsafeCountingFactorizer extends GenericServlet implements Servlet {
    private long count = 0;

    public long getCount() {
        return count;
    }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        //è¯¥æ“ä½œå¹¶éåŸå­æ“ä½œï¼Œè€Œæ˜¯ä¸€ä¸ªè¯»å–-ä¿®æ”¹-å†™å…¥çš„æ“ä½œåºåˆ—ã€‚
        ++count;
        encodeIntoResponse(resp, factors);
    }

    void encodeIntoResponse(ServletResponse res, BigInteger[] factors) {
    }

    BigInteger extractFromRequest(ServletRequest req) {
        return new BigInteger("7");
    }

    BigInteger[] factor(BigInteger i) {
        // Doesn't really factor
        return new BigInteger[] { i };
    }
}
```

1. å…¸å‹æƒ…å†µï¼šå»¶è¿Ÿåˆå§‹åŒ–
   1. æ“ä½œæœ¬æ„ï¼šå°†å¯¹è±¡çš„åˆå§‹åŒ–å»¶è¿Ÿåˆ°å®é™…è¢«ä½¿ç”¨çš„æ—¶å€™ã€‚
   2. ç«æ€æ¡ä»¶ï¼š
      1. Açœ‹åˆ°instanceä¸ºnullï¼Œå› æ­¤åˆ›å»ºäº†ExpensiveObjectå®ä¾‹ã€‚
      2. å¦‚æœå½“Aæ­£åœ¨è¿›è¡Œåˆ›å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œæ­¤æ—¶Bçº¿ç¨‹è¿›å…¥ï¼Œåˆ¤æ–­instanceä»ç„¶ä¸ºç©ºï¼Œä¹Ÿè¿›è¡Œåˆ›å»ºå¯¹è±¡ã€‚
      3. åˆ™ä¸¤æ¬¡è°ƒç”¨getInstanceæ–¹æ³•è¿”å›çš„å…¶å®æ˜¯ä¸¤æ¬¡newçš„ç¤ºä¾‹ï¼Œè€Œä¸æ˜¯å•ä¾‹æ¨¡å¼ã€‚å¦‚æœè¯¥ç±»è¢«ç”¨äºæ³¨å†Œä¿¡æ¯ç­‰åœºæ™¯ï¼Œå¿…ç„¶ä¼šå¯¼è‡´ä¿¡æ¯ä¸¢å¤±ã€‚
      4.

```
public class LazyInitRace {
    private ExpensiveObject instance = null;

    public ExpensiveObject getInstance() {
        if (instance == null)
            instance = new ExpensiveObject();
        return instance;
    }
}

class ExpensiveObject { }
```

1. ä¸Šè¿°çš„ä¸¤ç§æƒ…å†µéƒ½å±äºå¤åˆæ“ä½œ(éåŸå­)æ“ä½œå¯¼è‡´çš„ç«æ€æ¡ä»¶ã€‚
2. è§£å†³åŠæ³•ï¼š
   1. é€šè¿‡å®‰å…¨ç±»æ¥ç®¡ç†å‘æ— çŠ¶æ€ç±»ä¸­å¼•å…¥çš„çŠ¶æ€ï¼Œæ­¤æ—¶ä»ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

å¼•å…¥çº¿ç¨‹å®‰å…¨ç±»:AtomicLongæ¥ç®¡ç†è®¡æ•°å™¨çš„çŠ¶æ€ã€‚

ä½†æ˜¯å½“çŠ¶æ€å˜é‡çš„æ•°é‡ä¸å†æ˜¯ä¸€ä¸ªçš„æ—¶å€™ï¼Œå°±ä¸å†é€‚ç”¨ï¼Œå› ä¸ºæ— æ³•ä¿è¯å¤šä¸ªå˜é‡ä¹‹é—´çš„çº¦æŸå¯ä»¥åŒæ­¥å‘ç”Ÿå˜åŒ–ã€‚

```
public class CountingFactorizer extends GenericServlet implements Servlet {
    private final AtomicLong count = new AtomicLong(0);

    public long getCount() { return count.get(); }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = factor(i);
        count.incrementAndGet();
        encodeIntoResponse(resp, factors);
    }

    void encodeIntoResponse(ServletResponse res, BigInteger[] factors) {}
    BigInteger extractFromRequest(ServletRequest req) {return null; }
    BigInteger[] factor(BigInteger i) { return null; }
}
```

1. é€šè¿‡åŠ é”æœºåˆ¶ï¼Œæ¥ä¿è¯åŸå­æ€§ã€‚

### 2.3 å†…ç½®é”

1. åŒæ­¥ä»£ç å—ï¼š
   1. ç»„æˆï¼š
      1. é”çš„å¯¹è±¡å¼•ç”¨ï¼šä¸€èˆ¬æ˜¯æ–¹æ³•è°ƒç”¨æ‰€åœ¨çš„å¯¹è±¡ã€‚é™æ€çš„synchronizedæ–¹æ³•ä»¥Classå¯¹è±¡ä½œä¸ºé”ã€‚
      2. ç”±è¯¥é”ä¿æŠ¤çš„ä»£ç å—
   2. Javaçš„å†…ç½®é”ï¼Œæ˜¯ä¸€ç§äº’æ–¥é”ï¼ŒåŒæ—¶æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥é”ã€‚
2. ä¾‹å­ï¼šä¸‹é¢çš„ç±»é€šè¿‡ä½¿ç”¨å†…ç½®é”ï¼Œå®ç°äº†åŒæ­¥æœºåˆ¶ã€‚ä½†æ˜¯åŒæ—¶å¹¶å‘åº¦å¤§å¤§é™ä½ï¼Œä½¿å¾—æ€§èƒ½éš¾ä»¥æ¥å—

```
public class SynchronizedFactorizer extends GenericServlet implements Servlet {
    @GuardedBy("this") private BigInteger lastNumber;
    @GuardedBy("this") private BigInteger[] lastFactors;

    public synchronized void service(ServletRequest req,
                                     ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        if (i.equals(lastNumber))
            encodeIntoResponse(resp, lastFactors);
        else {
            BigInteger[] factors = factor(i);
            lastNumber = i;
            lastFactors = factors;
            encodeIntoResponse(resp, factors);
        }
    }

    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
    }

    BigInteger extractFromRequest(ServletRequest req) {
        return new BigInteger("7");
    }

    BigInteger[] factor(BigInteger i) {
        // Doesn't really factor
        return new BigInteger[] { i };
    }
}
```

1. é‡å…¥ï¼š
   1. èƒŒæ™¯ï¼šå½“æŸä¸ªçº¿ç¨‹è¯·æ±‚ä¸€ä¸ªç”±å…¶ä»–çº¿ç¨‹æŒæœ‰çš„é”çš„æ—¶å€™ï¼Œå‘å‡ºè¯·æ±‚çš„çº¿ç¨‹å°±ä¼šé˜»å¡ã€‚ä½†æ˜¯ç”±äºå†…ç½®é”æ˜¯å¯ä»¥é‡å…¥çš„ï¼Œå¦‚æœæŸä¸ªçº¿ç¨‹è·å–å®ƒè‡ªå·±æŒæœ‰çš„é”ï¼Œåˆ™ä¼šæˆåŠŸã€‚
   2. é‡å…¥çš„æ„ä¹‰ï¼šæ„å‘³ç€è·å–é”çš„æ“ä½œçš„ç²’åº¦æ˜¯çº¿ç¨‹ï¼Œè€Œä¸æ˜¯è°ƒç”¨ã€‚è€Œpthreadé‡Œé¢äº’æ–¥é”çš„è·å–æ“ä½œæ˜¯ä»¥è°ƒç”¨ä¸ºç²’åº¦çš„ã€‚
   3. å®ç°æ–¹æ³•ï¼š
      1. ä¸ºæ¯ä¸ªé”å…³è”ä¸€ä¸ªè·å–è®¡æ•°å€¼ï¼Œä»¥åŠæ‰€æœ‰è€…çº¿ç¨‹ã€‚
      2. å½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œè¯¥é”å°±è¢«è®¤ä¸ºæ˜¯æ²¡æœ‰è¢«ä»»ä½•çº¿ç¨‹æŒæœ‰ã€‚
      3. å½“çº¿ç¨‹è¯·æ±‚ä¸€ä¸ªæœªè¢«æŒæœ‰çš„é”çš„æ—¶å€™ï¼ŒJVMå°±ä¼šå°†è¯¥çº¿ç¨‹æ ‡è®°ä¸ºè¯¥é”çš„æ‰€æœ‰è€…çº¿ç¨‹ï¼Œå¹¶å°†è·å–è®¡æ•°å€¼è®¾ç½®ä¸º1ã€‚å¦‚æœåŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è·å¾—è¯¥é”ï¼Œåˆ™å°†è®¡æ•°å€¼é€’å¢ã€‚å½“çº¿ç¨‹é€€å‡ºåŒæ­¥ä»£ç å—çš„æ—¶å€™ï¼Œè®¡æ•°å™¨ä¼šé€’å‡ï¼Œå½“è®¡æ•°å€¼ä¸º0çš„æ—¶å€™ï¼Œé”è¢«é‡Šæ”¾ã€‚
   4. ä¾‹å­ï¼š
   5. å­ç±»é‡å†™äº†çˆ¶ç±»çš„synchronizedæ–¹æ³•ï¼Œç„¶åè°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•ã€‚

**ğŸ””**

å­ç±»ä¸­çš„superå’Œthiså±…ç„¶æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œè€Œä¸”çˆ¶ç±»çš„thisä¹Ÿæ˜¯ã€‚æ‰€ä»¥æ‰ä¼šè¯´é”ä½çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯superæœ¬èº«ä»ç„¶æ˜¯å­ç±»çš„å¼•ç”¨ï¼Œåªä¸è¿‡å®ƒå¯ä»¥è°ƒç”¨åˆ°çˆ¶ç±»çš„æ–¹æ³•æˆ–å˜é‡ã€‚

1. å¦‚æœæ²¡æœ‰å¯é‡å…¥çš„é”ï¼Œåˆ™è¯¥ä»£ç ä¼šäº§ç”Ÿæ­»é”
2. å­ç±»åœ¨è¿›å…¥doSomethingæ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè·å¾—Wightçš„é”ã€‚ä½†æ˜¯åœ¨å…¶ä¸­ï¼Œå¦‚æœåœ¨è°ƒç”¨superçš„æ—¶å€™ï¼Œæ²¡æœ‰å¯é‡å…¥çš„é”ï¼Œåˆ™ä¼šé™·å…¥æ­»é”(å› ä¸ºè°ƒç”¨superæ—¶å€™ä¹Ÿè·å–çš„æ˜¯Wightçš„é”).

```
public class  LoggingWidget extends Widget{
    @Override
    public synchronized void doSomething(){
        System.out.println("calling to doSomething");
        super.doSomething();
    }
}

class Widget{
    public synchronized void doSomething(){

    }
}
```

### 2.4 ä½¿ç”¨é”æ¥ä¿æŠ¤çŠ¶æ€

1. å¯¹è±¡çš„å†…ç½®é”å’ŒçŠ¶æ€å˜é‡çš„å…³ç³»ï¼š

   1. å¯¹è±¡çš„å†…ç½®é”ç”±å¯¹è±¡å†³å®šã€‚
   2. å¯¹è±¡çš„æˆå‘˜å±æ€§å¹¶ä¸æ˜¯åªèƒ½é å¯¹è±¡çš„å†…ç½®é”æ¥é™åˆ¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–é”æ¥é™åˆ¶
   3. çº¿ç¨‹åœ¨è·å¾—æŸä¸ªé”çš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½é˜»æ­¢å…¶ä»–çº¿ç¨‹è·å–å…¶ä»–çš„é”ã€‚
   4. å»ºè®®ï¼šæ¯ä¸ªå…±äº«ä¸å¯å˜å˜é‡åªé€šè¿‡ä¸€ä¸ªé”æ¥ä¿æŠ¤ã€‚
2. å¸¸è§çº¦å®šï¼š
3. å°†æ‰€æœ‰å¯å˜çŠ¶æ€å°è£…åœ¨å¯¹è±¡å†…éƒ¨ï¼Œé€šè¿‡å¯¹è±¡çš„å†…ç½®é”æ¥å¯¹æ‰€æœ‰è®¿é—®å¯å˜çŠ¶æ€çš„è·¯å¾„è¿›è¡ŒåŒæ­¥ã€‚
4. å¤šä¸ªåŒæ­¥æ–¹æ³•çš„ç»„åˆå¹¶ä¸ä¸€å®šæ˜¯åŸå­çš„
5. å°½å¯èƒ½å¯¹è¾ƒçŸ­çš„ä»£ç å—è¿›è¡ŒåŠ é”ï¼Œé™ä½æ€§èƒ½å½±å“ã€‚
6. å½“è¿›è¡Œè¾ƒé•¿æ—¶é—´è®¡ç®—ï¼Œæˆ–è€…è¿›è¡ŒIOçš„æ—¶å€™ï¼Œä¸è¦æŒæœ‰é”ã€‚

```
public class CachedFactorizer extends GenericServlet implements Servlet {
     private BigInteger lastNumber;
     private BigInteger[] lastFactors;
     private long hits;
     private long cacheHits;

    public synchronized long getHits() {
        return hits;
    }

    public synchronized double getCacheHitRatio() {
        return (double) cacheHits / (double) hits;
    }

    public void service(ServletRequest req, ServletResponse resp) {
        BigInteger i = extractFromRequest(req);
        BigInteger[] factors = null;
        synchronized (this) {
            ++hits;
            if (i.equals(lastNumber)) {
                ++cacheHits;
                factors = lastFactors.clone();
            }
        }
        if (factors == null) {
            factors = factor(i);
            synchronized (this) {
                lastNumber = i;
                lastFactors = factors.clone();
            }
        }
        encodeIntoResponse(resp, factors);
    }

    void encodeIntoResponse(ServletResponse resp, BigInteger[] factors) {
    }

    BigInteger extractFromRequest(ServletRequest req) {
        return new BigInteger("7");
    }

    BigInteger[] factor(BigInteger i) {
        // Doesn't really factor
        return new BigInteger[]{i};
    }
}
```

## 3 .å¯¹è±¡çš„å…±äº«

### 3.1 å¯è§æ€§

1. èƒŒæ™¯ï¼šå¹¶å‘ç¼–ç¨‹çš„å®ç°ï¼Œä¸ä»…åœ¨äºå¯¹äºå…±äº«å˜é‡çš„å¯å˜çŠ¶æ€è¿›è¡Œæ­£å¸¸ç®¡ç†ï¼ŒåŒæ—¶ï¼Œä¹Ÿéœ€è¦å¯¹å†…å­˜å¯è§æ€§è¿›è¡Œç®¡ç†ï¼Œé˜²æ­¢æ›´æ–°ä½†æ˜¯æ²¡æœ‰åŒæ­¥æ‰€å¯¼è‡´çš„é”™è¯¯
2. ä¾‹å­ï¼š
   1. ä¸‹é¢çš„ä»£ç è¯´æ˜äº†å½“å¤šä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å…±äº«æ•°æ®æ—¶å€™å‡ºç°çš„é”™è¯¯ã€‚
   2. åœ¨ä»£ç ä¸­ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹éƒ½ä¼šè¯»å–å…±äº«å˜é‡numberå’Œreadyã€‚
   3. ä¸»çº¿ç¨‹å¯åŠ¨readerçº¿ç¨‹ä¹‹åï¼Œå°†number=42,ready=trueã€‚æ­£å¸¸æƒ…å†µä¸‹readerçº¿ç¨‹ä¼šç­‰åˆ°readyçº¿ç¨‹ä¸ºtrueä¹‹åï¼Œè¾“å‡ºnumberçš„å€¼ï¼Œæ­£å¸¸æ˜¯è¾“å‡º42
   4. ä»£ç å¯èƒ½ä¼šä¸€å€¼æŒç»­å¾ªç¯ä¸‹å»ï¼Œå› ä¸ºreaderçº¿ç¨‹å¯èƒ½æ°¸è¿œéƒ½çœ‹ä¸åˆ°readyå€¼ã€‚ä¸€ç§æ›´å¥‡æ€ªçš„ç°è±¡æ˜¯ï¼Œä»£ç è¾“å‡ºä¸º0ã€‚å› ä¸ºreaderçº¿ç¨‹å¯èƒ½ä¼šçœ‹åˆ°å†™å…¥çš„readyå€¼ï¼Œä½†æ˜¯æ²¡æœ‰çœ‹åˆ°å†™å…¥çš„numberçš„å€¼ï¼Œç§°ä¸ºé‡æ’åº(reordering)ã€‚å½“ä¸»çº¿ç¨‹é¦–å…ˆå†™å…¥numberï¼Œåœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹å†™å…¥readyï¼Œé‚£ä¹ˆreadyçº¿ç¨‹çœ‹åˆ°çš„æ•°æ®å¯èƒ½ä¸å†™å…¥çš„æ•°æ®å®Œå…¨ç›¸åã€‚

**ğŸ‘‹**

ç»“è®ºï¼šåªè¦çº¿ç¨‹ä¹‹é—´æœ‰æ•°æ®äº¤æ¢ï¼Œå°±è¿›è¡ŒåŒæ­¥

```
public class NoVisibility {
    private static boolean ready;
    private static int number;

    private static class ReaderThread extends Thread {
        public void run() {
            while (!ready)
                Thread.yield();
            System.out.println(number);
        }
    }

    public static void main(String[] args) {
        new ReaderThread().start();
        number = 42;
        ready = true;
    }
}
```

1. å¤±æ•ˆçš„æ•°æ®ï¼š
   1. ä¾‹å­ï¼š
      1. å¯¹äºå¦‚ä¸‹è¿™ä¸ªå…±äº«å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†setï¼Œä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†getï¼Œåˆ™è¯¥çº¿ç¨‹çš„getä¸ä¸€å®šä¼šçœ‹åˆ°è¢«æ›´æ–°çš„valueå€¼ã€‚

```
public class MutableInteger {
    private int value;
  
    public int get(){
        return value;
    }
  
    public void set(int value){
        this.value=value;
    }
}
```

1. ä¿®æ”¹ä¹‹åçš„çº¿ç¨‹å®‰å…¨ç±»ï¼š

```
public class SynchronizedInteger {

    private int value;

    public synchronized int get() {
        return value;
    }

    public synchronized void set(int value) {
        this.value = value;
    }

}
```

1. éåŸå­æ“ä½œçš„64ä½æ“ä½œ

   1. æœ€ä½å®‰å…¨æ€§ï¼šå½“çº¿ç¨‹åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªå¤±æ•ˆå€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼è‚¯å®šæ˜¯ç”±æŸä¸ªçº¿ç¨‹è®¾ç½®çš„å€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªéšæœºå€¼ã€‚
   2. évolatileç±»å‹çš„64ä½æ•°å€¼å˜é‡(double,long)ã€‚JVMå¯¹äºè¿™ä¸ªç±»å‹å˜é‡çš„è¯»å†™ï¼Œå…è®¸ä¸¤ä¸ª32ä½æ“ä½œã€‚å½“è¯»å–ä¸€ä¸ªévolatileç±»å‹çš„longå˜é‡çš„æ—¶å€™ï¼Œå¦‚æœå¯¹è¯¥å˜é‡çš„è¯»å†™æ“ä½œåœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½è¯»å–åˆ°ä¸€ä¸ªå€¼çš„é«˜32ä½å’Œä¸€ä¸ªå€¼çš„ä½32ä½ã€‚å› æ­¤ï¼Œlongå’Œdoubleç±»å‹çš„å˜é‡éœ€è¦ä½¿ç”¨volatileå˜é‡æ¥å£°æ˜ä»–ä»¬ï¼Œæˆ–è€…ç”¨é”ä¿æŠ¤ã€‚
2. åŠ é”å’Œå¯è§æ€§
3. å¦‚æœçº¿ç¨‹Aå…ˆlock Mï¼Œå†æ‰§è¡Œä»£ç å—ï¼Œå†unlock M,ã€‚è€ŒBçº¿ç¨‹ç´§æ¥ç€lock Mï¼Œæ­¤æ—¶Bçº¿ç¨‹æ‰§è¡Œçš„ä»£ç å—ä¸€å®šå¯ä»¥çœ‹è§Aåœ¨å…¶ä»£ç å—çš„æ‰€æœ‰æ“ä½œç»“æœã€‚å¦‚æœæ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œåˆ™æ— æ³•ä¿è¯
4. åŠ é”å¯ä»¥ä¿è¯äº’æ–¥æ€§ï¼ŒåŒæ—¶å¯ä»¥ä¿è¯å†…å­˜å¯è§æ€§ã€‚
5. volatileå˜é‡ï¼š
6. ä½œç”¨ï¼šæ¥ç¡®ä¿å°†å˜é‡çš„æ›´æ–°æ“ä½œé€šçŸ¥åˆ°å…¶ä»–çº¿ç¨‹ã€‚volatileç±»å‹çš„å˜é‡ç¼–è¯‘å™¨åœ¨è¿è¡Œçš„æ—¶å€™ä¼šæ³¨æ„åˆ°è¯¥å˜é‡æ˜¯å…±äº«çš„ã€‚å°±ä¸ä¼šå°†å…¶å’Œå…¶ä»–æ“ä½œè¿›è¡Œé‡æ’åºã€‚åœ¨è¯»å–volatileå˜é‡çš„æ—¶å€™ï¼Œè¿”å›çš„æ€»æ˜¯æœ€æ–°å†™å…¥çš„å€¼ã€‚
7. å¯ä»¥å°†volatileçœ‹åšSynchronizedInteger,ä½†æ˜¯æ›´è½»é‡çº§(ä¸ä¼šåŠ é”)
8. volatileå˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§
9. ä½¿ç”¨èŒƒå›´ï¼š
10. ç¡®ä¿å˜é‡è‡ªèº«çš„å¯è§æ€§
11. ç¡®ä¿æ‰€å¼•ç”¨å¯¹è±¡çš„å¯è§æ€§
12. æ ‡è¯†é‡è¦çš„ç¨‹åºç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å‘ç”Ÿï¼Œå¸¸ç”¨æ¥åšflag
13. ä½¿ç”¨æ¡ä»¶ï¼š
14. å¯¹å˜é‡çš„å†™å…¥æ“ä½œä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼
15. è¯¥å˜é‡ä¸ä¼šå’Œå…¶ä»–çŠ¶æ€å˜é‡ä¸€èµ·çº³å…¥ä¸å˜æ€§æ¡ä»¶ä¸­
16. åœ¨è®¿é—®å¯¹è±¡çš„æ—¶å€™ä¸éœ€è¦åŠ é”

```
//å…¸å‹ä¾‹å­
//æ£€æŸ¥æŸä¸ªçŠ¶æ€æ ‡è®°ä»¥åˆ¤æ–­æ˜¯å¦é€€å‡ºå¾ªç¯(ç”¨é”ä¹Ÿå¯ä»¥)
//å¦‚æœä¸æ˜¯volatileç±»å‹ï¼Œåˆ™å¦‚æœasleepè¢«ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½çœ‹ä¸åˆ°
volatile boolean asleep;

    while(!asleep){
        countSomeSleep();
    }
```

### 3.2 å‘å¸ƒå’Œé€¸å‡º

1. å‘å¸ƒ(publish)ï¼š

   1. å®šä¹‰ï¼šå‘å¸ƒä¸€ä¸ªå¯¹è±¡æ˜¯æŒ‡ä½¿å¾—å¯¹è±¡åœ¨å½“å‰ä½œç”¨åŸŸä¹‹å¤–çš„ä»£ç ä¸­ä½¿ç”¨ã€‚
   2. ä¾‹å­ï¼š
      1. å°†ä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°å…¶ä»–ä»£ç å¯ä»¥è®¿é—®çš„åœ°æ–¹ã€‚
      2. æˆ–è€…æ˜¯æŸä¸€ä¸ªç§æœ‰æ–¹æ³•ä¸­è¿”å›è¯¥å¼•ç”¨ã€‚
      3. æˆ–è€…æ˜¯å°†å¼•ç”¨ä¼ é€’åˆ°å…¶ä»–ç±»çš„æ–¹æ³•ä¸­ã€‚
2. é€¸å‡º(escape)ï¼š
3. å®šä¹‰ï¼šæŸäº›ä¸è¯¥è¢«publishçš„å¯¹è±¡è¢«å‘å¸ƒ
4. ä¾‹å­ï¼š
5. ç ´åå°è£…æ€§ï¼špublishå†…éƒ¨çŠ¶æ€
6. ç ´åçº¿ç¨‹å®‰å…¨æ€§ï¼šåœ¨å¯¹è±¡åˆ›å»ºä¹‹å‰å°±è¿”å›å¼•ç”¨
7. å‘å¸ƒä¸€ä¸ªå¯¹è±¡ï¼š
8. æœ€å¸¸è§çš„æ–¹æ³•ï¼šå°†å¯¹è±¡çš„å¼•ç”¨å®šä¹‰ä¸ºpublic staticã€‚åˆ™ä»»ä½•ç±»å’Œçº¿ç¨‹éƒ½å¯ä»¥çœ‹è§è¯¥å¯¹è±¡å¼•ç”¨ã€‚
9. å½“å‘å¸ƒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¯èƒ½ä¼šé—´æ¥å‘å¸ƒå…¶ä»–å¯¹è±¡(æ¯”å¦‚é›†åˆä¸­åŒ…å«çš„å…¶ä»–å¯¹è±¡)ã€‚

```
public static Set<Secret> knownSecrets;

public void init(){
    knownSecrets = new HashSet<Secret>();
}
```

1. é€¸å‡ºï¼š
   1. å¦‚ä¸‹ä»£ç å°†å†…éƒ¨çŠ¶æ€(ç§æœ‰å˜é‡)çš„å¼•ç”¨é€¸å‡ºã€‚
   2. åˆ™stateså·²ç»é€¸å‡ºå…¶ä½œç”¨åŸŸ

```
public class UnsafeStates {
    private String[] states = new String[]{"hello"};
  
    public String[] getStates(){
        return states;
    }
}
```

1. å¦‚ä¸‹ï¼šå½“ThisEscapeåœ¨è¿›è¡Œå‘å¸ƒå†…éƒ¨ç±»EventListenerçš„æ—¶å€™ï¼Œä¹Ÿéšå«åœ°å‘å¸ƒäº†ThisEscapeå®ä¾‹æœ¬èº«ã€‚è¿™æ ·ä¼šä½¿å¾—thiså¼•ç”¨é€¸å‡ºã€‚è¿™æ˜¯å› ä¸ºä»å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­å°±è¿”å›å¯¹è±¡çš„å¼•ç”¨(this),è¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚
2. å¸¸è§é”™è¯¯æƒ…å†µï¼šåœ¨æ„é€ å‡½æ•°ä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ã€‚åˆ™æ­¤æ—¶thiså¼•ç”¨éƒ½ä¼šè¢«æ–°åˆ›å»ºçš„çº¿ç¨‹å…±äº«ã€‚

```
public class ThisEscape {
    public ThisEscape(EventSource source) {
        //å‘å¸ƒå†…éƒ¨ç±»ï¼Œå°†å…¶ä¼ å…¥åˆ°sourceå®ä¾‹çš„æ–¹æ³•ä¸­
        source.registerListener(new EventListener() {
            public void onEvent(Event e) {
                doSomething(e);
            }
        });
    }

    void doSomething(Event e) {
    }


    interface EventSource {
        void registerListener(EventListener e);
    }

    interface EventListener {
        void onEvent(Event e);
    }

    interface Event {
    }
}
```

1. å¯ä»¥é€šè¿‡ä½¿ç”¨ç§æœ‰æ„é€ å™¨+å…¬å…±å·¥å‚æ–¹æ³•æ¥é˜²æ­¢thiså¼•ç”¨åœ¨æ„é€ è¿‡ç¨‹ä¸­é€¸å‡º
   1. åŸç†ï¼šåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºå†…éƒ¨ç±»ï¼Œå¹¶å°†å†…éƒ¨ç±»å‘å¸ƒå‡ºå»ï¼Œè¿™ä¸¤è€…ä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚
   2. åŠæ³•ï¼š
      1. é¦–å…ˆç§æœ‰æ„é€ å™¨ï¼Œåœ¨å…¶ä¸­åˆ›å»ºå†…éƒ¨ç±»
      2. ç„¶åé€šè¿‡å…¬å…±çš„å·¥å‚æ–¹æ³•æ¥å‘å¸ƒ å†…éƒ¨ç±»

```
public class SafeListener {
    private final EventListener listener;
  
    //ç§æœ‰æ„é€ å™¨
    private SafeListener() {
        listener = new EventListener() {
            public void onEvent(Event e) {
                doSomething(e);
            }
        };
    }
    //å…¬å…±çš„å·¥å‚æ–¹æ³•
    public static SafeListener newInstance(EventSource source) {
        SafeListener safe = new SafeListener();
        //å‘å¸ƒå†…éƒ¨ç±»
        source.registerListener(safe.listener);
        return safe;
    }

    void doSomething(Event e) {
    }


    interface EventSource {
        void registerListener(EventListener e);
    }

    interface EventListener {
        void onEvent(Event e);
    }

    interface Event {
    }
}
```

### 3.3 çº¿ç¨‹å°é—­

1. å®šä¹‰ï¼šä¸€ç§é¿å…åŒæ­¥çš„æ–¹æ³•å°±æ˜¯ä¸å…±äº«æ•°æ®ï¼Œåªåœ¨å•çº¿ç¨‹ä¸­è®¿é—®æ•°æ®ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å°é—­ã€‚å®ƒæ˜¯å®ç°çº¿ç¨‹å®‰å…¨æ€§çš„æœ€ç®€å•çš„ä¸€ç§æ–¹å¼ã€‚
2. åº”ç”¨åœºæ™¯ï¼š

   1. Swingï¼šSwingä¸­çš„å¯è§†åŒ–ç»„ä»¶å’Œæ•°æ®æ¨¡å‹å¯¹è±¡éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚Swingå°†ä»–ä»¬å°é—­åœ¨Swingçš„äº‹ä»¶åˆ†å‘çº¿ç¨‹ä¸­è®¿é—®ï¼Œæ¥å®ç°çº¿ç¨‹å®‰å…¨æ€§ã€‚åœ¨é™¤äº†äº‹ä»¶çº¿ç¨‹ä¹‹å¤–çš„å…¶ä»–çº¿ç¨‹å°±ä¸èƒ½è®¿é—®è¿™äº›å¯¹è±¡ï¼Œå¦åˆ™å¯èƒ½å‡ºé”™
   2. JDBCï¼šJDBCä¸­çš„Connectionå¯¹è±¡ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤§å¤šæ•°è¯·æ±‚éƒ½æ˜¯ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¸”åœ¨Connectionå¯¹è±¡è¿”å›ä¹‹å‰ï¼Œä¸ä¼šå°†å®ƒåˆ†é…ç»™å…¶ä»–çº¿ç¨‹ã€‚
3. Javaè‡ªå¸¦çš„çº¿ç¨‹å°é—­ï¼š
4. å±€éƒ¨å˜é‡ï¼šå› ä¸ºå±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹ç§æœ‰æ ˆä¸­ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯çº¿ç¨‹å°é—­çš„ã€‚
5. ThreadLocalç±»
6. å…·ä½“åˆ†ç±»ï¼š
7. ad-hocçº¿ç¨‹å°é—­ï¼š
8. å®šä¹‰ï¼šç»´æŠ¤çº¿ç¨‹å°é—­æ€§çš„èŒè´£å®Œå…¨ç”±ç¨‹åºæ¥æ‰¿æ‹…ï¼Œä¸ä½¿ç”¨ä»»ä½•çš„è¯­è¨€ç‰¹æ€§ã€‚
9. å¦‚æœå¯ä»¥ç¡®ä¿åªæœ‰å•ä¸ªçº¿ç¨‹å¯¹å…±äº«çš„volatileå˜é‡æ‰§è¡Œå†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå°†volatileå˜é‡è¿›è¡Œäº†çº¿ç¨‹å°é—­ã€‚è€Œä¸”è¿˜èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–è¯¥å˜é‡çš„å€¼ã€‚
10. æ ˆå°é—­ï¼š
11. å®šä¹‰ï¼šåœ¨æ ˆå°é—­ä¸­ï¼Œåªæœ‰é€šè¿‡å±€éƒ¨å˜é‡æ‰å¯è®¿é—®å¯¹è±¡ã€‚å› ä¸ºä¿å­˜åœ¨çº¿ç¨‹ç§æœ‰çš„æ ˆä¸­ï¼Œæ‰€ä»¥ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚
12. ä¾‹å­ï¼š
13. ä¸‹é¢çš„æ–¹æ³•ä¸­ï¼Œå¯¹äºTreeSetå¯¹è±¡çš„å¼•ç”¨ï¼Œåªæœ‰ä¸€ä¸ªanimalså±€éƒ¨å˜é‡ã€‚è¿™å°±ä¿è¯äº†å®ƒä¸ä¼šè¢«å‘å¸ƒã€‚

```
   public int loadTheArk(Collection<Animal> candidates) {
        SortedSet<Animal> animals;
        int numPairs = 0;
        Animal candidate = null;

        // animals confined to method, don't let them escape!
        animals = new TreeSet<Animal>(new SpeciesGenderComparator());
        animals.addAll(candidates);
        for (Animal a : animals) {
            if (candidate == null || !candidate.isPotentialMate(a))
                candidate = a;
            else {
                ark.load(new AnimalPair(candidate, a));
                ++numPairs;
                candidate = null;
            }
        }
        return numPairs;
    }
```

1. ThreadLocalç±»ï¼š
   1. ä½œç”¨ï¼šThreadLocalå¯¹è±¡é€šå¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹å¯¹è±¡æˆ–è€…å…¨å±€å˜é‡è¿›è¡Œå…±äº«æ“ä½œã€‚
   2. æ–¹æ³•ï¼šgetå’Œsetæ–¹æ³•æ€»æ˜¯ä¸ºæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„å€¼éƒ½ä¿å­˜ä¸€ä»½ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå› æ­¤getæ–¹æ³•æ€»æ˜¯è¿”å›ç”±å½“å‰æ‰§è¡Œçº¿ç¨‹åœ¨è°ƒç”¨setçš„æ—¶å€™è®¾ç½®çš„å€¼
   3. ä¾‹å­ï¼šä¸‹é¢ä¸­åœ¨å•çº¿ç¨‹ç¨‹åºä¸­åˆ›å»ºäº†å…¨å±€çš„æ•°æ®åº“è¿æ¥(DriverManager.getConnection).ç”±äºJDBCçš„Connectionå¯¹è±¡ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¦‚æœæœ‰å¤šçº¿ç¨‹ï¼Œå°±éœ€è¦å°†JDBCçš„è¿æ¥æ“ä½œä¿å­˜åˆ°ThreadLocalå¯¹è±¡ä¸­ã€‚åˆ™åœ¨è°ƒç”¨getæ–¹æ³•çš„æ—¶å€™ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šè·å¾—å±äºè‡ªå·±çš„è¿æ¥ã€‚
   4. ä¾‹å­ï¼šå½“æŸä¸ªé¢‘ç¹çš„æ“ä½œéœ€è¦ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œæ¯”å¦‚ç¼“å†²åŒºçš„æ—¶å€™ï¼Œè€Œåˆå¸Œæœ›é¿å…æ¯æ¬¡éƒ½é‡æ–°åˆ†é…è¯¥ä¸´æ—¶å¯¹è±¡ï¼Œåˆ™å°±å¯ä»¥ä½¿ç”¨ThreadLocalã€‚æ¯”å¦‚Integer.toString()ä¼šä½¿ç”¨ThreadLocalçš„ç¼“å†²åŒºã€‚
   5. å½“æŸä¸ªçº¿ç¨‹åˆæ¬¡è°ƒç”¨ThreadLocal.getæ–¹æ³•çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨initialValueæ–¹æ³•æ¥è·å–åˆå§‹å€¼ã€‚å¯ä»¥å°†ThreadLocal<Connection>çœ‹åšMap<Thread,Connection>ã€‚
   6. å°†å•çº¿ç¨‹ç¨‹åºå˜æ¢ä¸ºå¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œé€šè¿‡å°†å…±äº«çš„å…¨å±€å˜é‡æ”¹ä¸ºThreadLocalï¼Œå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ã€‚

```
public class ConnectionDispenser {
    static String DB_URL = "jdbc:mysql://localhost/javalab";

    private ThreadLocal<Connection> connectionHolder
            = new ThreadLocal<Connection>() {
        public Connection initialValue() {
            try {
                //å…¨å±€çš„æ•°æ®åº“è¿æ¥
                return DriverManager.getConnection(DB_URL);
            } catch (SQLException e) {
                throw new RuntimeException("Unable to acquire Connection, e");
            }
        };
    };

    public Connection getConnection() {
        return connectionHolder.get();
    }
}
```

### 3.4 ä¸å¯å˜å¯¹è±¡

1. å®šä¹‰ï¼šæŸä¸ªå¯¹è±¡åœ¨åˆ›å»ºä¹‹åå°±ä¸èƒ½æ”¹å˜
2. çº¿ç¨‹å®‰å…¨ï¼šä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒä»¬çš„çŠ¶æ€åªèƒ½é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¹å˜ã€‚

**ğŸ””**

ä¸å¯å˜å¯¹è±¡ä¸ç­‰äºæŠŠæ‰€æœ‰fieldéƒ½åŠ ä¸Šfinalã€‚å› ä¸ºfinalçš„å˜é‡å¯èƒ½ä¿å­˜çš„æ˜¯å¯å˜å¯¹è±¡çš„å¼•ç”¨ã€‚

1. æ¡ä»¶ï¼š

   1. å¯¹è±¡åˆ›å»ºä¹‹åå°±ä¸èƒ½ä¿®æ”¹
   2. å¯¹è±¡çš„æ‰€æœ‰fieldéƒ½æ˜¯finalç±»å‹
   3. å¯¹è±¡çš„åˆ›å»º(æ„é€ å‡½æ•°)æ²¡æœ‰thisé€¸å‡ºã€‚
2. final
3. å®šä¹‰ï¼šfinalå¯ä»¥è§†ä¸ºC++ä¸­çš„constæœºåˆ¶çš„å—é™åˆ¶ç‰ˆæœ¬ï¼Œç”¨äºæ„å»ºä¸å¯å˜å¯¹è±¡
4. æ€§è´¨ï¼š
5. finalç±»å‹çš„fieldæ˜¯ä¸å¯ä»¥è¢«ä¿®æ”¹çš„
6. finalå¯ä»¥ä¿è¯åˆå§‹åŒ–è¿‡ç¨‹çš„å®‰å…¨æ€§ï¼Œä»è€Œå¯ä»¥ä¸å—é™åˆ¶çš„è®¿é—®ä¸å¯å˜å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å…±äº«è¿™äº›å¯¹è±¡çš„æ—¶å€™æ— é¡»åŒæ­¥
7. é™¤ééœ€è¦æ›´é«˜å¯è§æ€§ï¼Œå¦åˆ™ä¸€èˆ¬å°†fieldå£°æ˜ä¸ºprivate. åŒæ ·ï¼Œå¦‚æœä¸éœ€è¦æ”¹å˜ï¼Œåˆ™ä¸€èˆ¬å°†fieldå£°æ˜ä¸ºfinal
8. ä½¿ç”¨Volatileæ¥å‘å¸ƒä¸å¯å˜å¯¹è±¡
9. æ­¥éª¤ï¼š
10. æ›´æ–°ç¼“å­˜çš„ç»“æœ
11. åˆ¤æ–­éœ€æ±‚æ˜¯å¦åœ¨ç¼“å­˜ä¸­
12. æ€§è´¨ï¼š
13. å½“è®¿é—®å’Œæ›´æ–°å¤šä¸ªå˜é‡çš„æ—¶å€™å‡ºç°äº†ç«äº‰æ¡ä»¶é—®é¢˜ï¼Œå°±å¯ä»¥é€šè¿‡å°†è¿™äº›å˜é‡å…¨éƒ¨ä¿å­˜åœ¨ä¸€ä¸ªä¸å¯å˜å¯¹è±¡ä¸­æ¥æ¶ˆé™¤ï¼Œè€Œä¸æ˜¯åƒå¯å˜å¯¹è±¡ä¸€æ ·ä½¿ç”¨é”ã€‚
14. åˆ™è¯¥å˜é‡åœ¨èµ‹å€¼è¿‡åå°±ä¸èƒ½æ”¹å˜ã€‚
15. å½“ä½¿ç”¨volatileçš„æ—¶å€™ï¼Œåˆ™å¦‚æœä¸€ä¸ªçº¿ç¨‹æ”¹å˜ç¼“å­˜ï¼Œåˆ™è¯¥æ”¹å˜å¯¹äºæ‰€æœ‰çº¿ç¨‹å¯è§ã€‚

```
public class OneValueCache {
    private final BigInteger lastNumber;
    private final BigInteger[] lastFactors;

    public OneValueCache(BigInteger i,
                         BigInteger[] factors) {
        lastNumber = i;
        lastFactors = Arrays.copyOf(factors, factors.length);
    }

    public BigInteger[] getFactors(BigInteger i) {
        if (lastNumber == null || !lastNumber.equals(i))
            return null;
        else
            return Arrays.copyOf(lastFactors, lastFactors.length);
    }
}
```

1. å®‰å…¨å‘å¸ƒï¼š
   1. æ¦‚å¿µï¼šæŸäº›æƒ…å†µä¸‹æˆ‘ä»¬å¸Œæœ›åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«å¯¹è±¡ï¼Œæ­¤æ—¶å¿…é¡»ç¡®ä¿å®‰å…¨è¿›è¡Œå…±äº«ã€‚
   2. ä¸æ­£ç¡®çš„æƒ…å†µï¼š
      1. å®Œå…¨ä½¿ç”¨publicæ¥è¿›è¡Œå‘å¸ƒ
      2. å¦‚ä¸‹ï¼Œå¦‚æœè¯¥Holderç±»ä½¿ç”¨publicæ–¹å¼è¿›è¡Œå‘å¸ƒï¼Œåˆ™å¯èƒ½å…¶ä»–çº¿ç¨‹é€šè¿‡StuffIntoPublicæ¥çœ‹è§Holderçš„ä¸åŒçŠ¶æ€

```
//å‘å¸ƒ
public class StuffIntoPublic {
    public Holder holder;

    public  void init(){
        holder = new Holder(42);
    }
}

//Holderå®šä¹‰
class Holder {
    private int n;
  
    //åˆå§‹åŒ–æ„é€ å™¨
    public Holder(int n) {
        this.n = n;
    }

    public void assertSanity() {
        if (n != n)
            throw new AssertionError("This statement is false.");
    }
}
```

1. å®‰å…¨å‘å¸ƒçš„å¸¸ç”¨æ¨¡å¼ï¼š

   1. æ–¹æ³•ï¼š
      1. åœ¨é™æ€åˆå§‹åŒ–å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡å¼•ç”¨
      2. å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°volatileç±»å‹çš„field
      3. å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°æŸä¸ªæ­£ç¡®æ„é€ çš„å¯¹è±¡çš„finalç±»å‹fieldä¸­
      4. å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åˆ°ä¸€ä¸ªç”±é”ä¿æŠ¤çš„åŸŸä¸­
   2. å¸¸è§æƒ…å†µï¼š
   3. å°†å¯¹è±¡æ”¾å…¥æŸä¸ªçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ä¸­
   4. ä½¿ç”¨é™æ€çš„åˆå§‹åŒ–å™¨
2. äº‹å®ä¸å¯å˜å¯¹è±¡ï¼š
3. å®šä¹‰ï¼šå®šä¹‰ä¸ºå¯å˜å¯¹è±¡ï¼Œä½†æ˜¯å®é™…ä¸Šä¸€ç›´æ²¡æœ‰æ”¹å˜ï¼Œç¨‹åºåªéœ€è¦æŠŠå®ƒä»¬è§†ä¸ºä¸å¯å˜å¯¹è±¡å°±å¯ä»¥ã€‚
4. å¯å˜å¯¹è±¡ï¼š
5. å®‰å…¨å‘å¸ƒåªèƒ½ä¿è¯å¯¹è±¡æ„å»ºçš„æ—¶å€™çš„å®‰å…¨æ€§ã€‚
6. å¯å˜å¯¹è±¡å¿…é¡»æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ–è¦é€šè¿‡é”ç­‰æ¥ä¿è¯æ˜¯çº¿ç¨‹å®‰å…¨çš„

## 4 .å¯¹è±¡çš„ç»„åˆ

### 4.1 è®¾è®¡çº¿ç¨‹å®‰å…¨çš„ç±»

1. åŸºæœ¬è¦ç´ ï¼š
   1. æ‰¾å‡ºæ„æˆå¯¹è±¡çŠ¶æ€çš„æ‰€æœ‰å˜é‡
   2. æ‰¾å‡ºçº¦æŸçŠ¶æ€å˜é‡çš„ä¸å˜æ€§æ¡ä»¶
   3. å»ºç«‹å¯¹è±¡çŠ¶æ€çš„å¹¶å‘è®¿é—®ç®¡ç†ç­–ç•¥
2. ä¾‹å­ï¼š
3. ä¸€ä¸ªç±»çš„æ‰€æœ‰åŸºæœ¬ç±»å‹çš„æˆå‘˜å˜é‡æ„æˆäº†è¯¥ç±»çš„çŠ¶æ€ï¼Œæ¯”å¦‚ä¸‹é¢çš„åŸŸå°±åªæœ‰ä¸€ä¸ªvalueæˆå‘˜å˜é‡
4. ä¸€ä¸ªåŒ…å«äº†å¼•ç”¨ç±»å‹çš„ç±»ï¼Œå…¶çŠ¶æ€ä¹ŸåŒ…å«å…¶å¼•ç”¨å¯¹è±¡çš„çŠ¶æ€ã€‚æ¯”å¦‚é“¾è¡¨çš„çŠ¶æ€å°±åŒ…æ‹¬å…¶ä¸­æ‰€æœ‰ç»“ç‚¹çš„çŠ¶æ€ã€‚

```
public final class Counter {
    @GuardedBy("this") private long value = 0;

    public synchronized long getValue() {
        return value;
    }

    public synchronized long increment() {
        if (value == Long.MAX_VALUE)
            throw new IllegalStateException("counter overflow");
        return ++value;
    }
}
```

1. åŒæ­¥ç­–ç•¥ï¼šå®šä¹‰äº†å¦‚ä½•åœ¨ä¸è¿èƒŒå¯¹è±¡ä¸å˜æ¡ä»¶æˆ–è€…åéªŒæ¡ä»¶ä¸‹å¯¹äºå…¶çŠ¶æ€çš„è®¿é—®æ“ä½œè¿›è¡ŒååŒã€‚
2. æ”¶é›†åŒæ­¥éœ€æ±‚ï¼š

   1. çŠ¶æ€ç©ºé—´ï¼šå¯¹è±¡å’Œå˜é‡æ‰€æœ‰å–å€¼çš„ç»„åˆã€‚æ‰€ä»¥final çš„fieldè¶Šå¤šï¼Œåˆ™çŠ¶æ€ç©ºé—´è¶Šå°ï¼Œè¶Šå¯ä»¥ç®€åŒ–åˆ†æè¿‡ç¨‹ã€‚
   2. ä¸å¯å˜æ¡ä»¶ï¼š

      1. å®šä¹‰ï¼šåœ¨ç±»ä¸­ä½“ç°ï¼Œç”¨äºåˆ¤æ–­çŠ¶æ€æ˜¯æœ‰æ•ˆè¿˜æ˜¯æ— æ•ˆã€‚
   3. ä¾‹å­ï¼šCounterä¸­çš„ValueåŸŸ
   4. ValueåŸŸæ˜¯Long.MIN\_VALUEåˆ°Long.MAX\_VALUEç±»å‹ã€‚ä½†æ˜¯Valueéšå«ç€>=0
   5. åéªŒæ¡ä»¶ï¼šæ¯”å¦‚å¦‚æœCounterçš„çŠ¶æ€ç›®å‰æ˜¯17,é‚£ä¹ˆä¸‹ä¸€ä¸ªæœ‰æ•ˆçŠ¶æ€åªèƒ½æ˜¯18ã€‚åˆ™è¯¥æ“ä½œæ˜¯å¤åˆæ“ä½œã€‚
   6. å¿…é¡»äº†è§£å¯¹è±¡çš„ä¸å˜æ€§æ¡ä»¶å’ŒåéªŒæ¡ä»¶ï¼Œæ‰èƒ½ç¡®ä¿çº¿ç¨‹å®‰å…¨æ€§ã€‚è¦æ»¡è¶³åœ¨çŠ¶æ€å˜é‡çš„æœ‰æ•ˆå€¼æˆ–è€…çŠ¶æ€è½¬æ¢ä¸Šçš„å„ç§çº¦æŸæ¡ä»¶ï¼Œå°±å¿…é¡»å€ŸåŠ©åŸå­æ€§å’Œå°è£…æ€§ã€‚
3. ä¾èµ–çŠ¶æ€çš„æ“ä½œï¼š
4. å®šä¹‰ï¼šå¦‚æœæŸä¸ªæ“ä½œåŒ…å«æœ‰åŸºäºçŠ¶æ€çš„å…ˆéªŒæ€§æ¡ä»¶ï¼Œåˆ™è¯¥æ“ä½œè¢«ç§°ä¸ºä¾èµ–çŠ¶æ€çš„æ“ä½œã€‚
5. ä¾‹å­ï¼šæ¯”å¦‚ä¸èƒ½ä»ç©ºé˜Ÿåˆ—ä¸­ç§»é™¤ä¸€ä¸ªå…ƒç´ 
6. å•çº¿ç¨‹æƒ…å†µï¼šå¦‚æœå…ˆéªŒæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™å¿…ç„¶å¤±è´¥
7. å¤šçº¿ç¨‹æƒ…å†µï¼šå…ˆéªŒæ¡ä»¶å¯èƒ½ä¼šå—å…¶ä»–çº¿ç¨‹çš„å½±å“ï¼Œéœ€è¦ç­‰åˆ°å…ˆéªŒæ¡ä»¶ä¸ºçœŸå†æ‰§è¡Œã€‚æ¯”å¦‚ä¸€ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œå¯ä»¥åœ¨ç”Ÿäº§è€…ç”Ÿäº§ä¹‹åï¼Œè¿›è¡Œæ¶ˆè´¹ã€‚å¯ä»¥é€šè¿‡é˜»å¡é˜Ÿåˆ—æˆ–è€…ä¿¡å·é‡æ¥å®ç°ã€‚
8. çŠ¶æ€çš„æ‰€æœ‰æƒï¼š
9. Javaä¸­ç”±äºGCçš„å­˜åœ¨ï¼Œåˆ™ä½¿å¾—æ‰€æœ‰æƒçš„è€ƒè™‘è¾ƒå°‘ã€‚
10. å¯¹è±¡å¯¹å®ƒæ‰€å°è£…çš„çŠ¶æ€æ‹¥æœ‰æ‰€æœ‰æƒã€‚
11. å¦‚æœå‘å¸ƒäº†æŸä¸ªå¯å˜å¯¹è±¡çš„å¼•ç”¨ï¼Œåˆ™ä¸åœ¨ç‹¬äº«è¯¥å¯¹è±¡çš„æ§åˆ¶æƒã€‚

### 4.2 å®ä¾‹å°é—­ï¼š

1. å®ä¾‹å°é—­
   1. å®šä¹‰ï¼šå½“ä¸€ä¸ªå¯¹è±¡è¢«å°é—­åˆ°å¦ä¸€ä¸ªå¯¹è±¡ä¸­çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè®¿é—®è¢«å°è£…å¯¹è±¡çš„æ‰€æœ‰ä»£ç è·¯å¾„éƒ½æ˜¯å·²çŸ¥çš„ã€‚ä¸å¯¹è±¡è¢«æ”¾åˆ°æ•´ä¸ªç¨‹åºä¸­çš„è®¿é—®æƒ…å†µç›¸æ¯”ï¼Œå¯ä»¥ç¡®ä¿ä»¥çº¿ç¨‹å®‰å…¨çš„æ–¹å¼è¿›è¡Œä½¿ç”¨è¯¥å¯¹è±¡ã€‚
   2. èŒƒå›´ï¼š

      1. å¯¹è±¡å¯ä»¥è¢«å°é—­åˆ°ä¸€ä¸ªç±»çš„å®ä¾‹ä¸­
      2. å¯ä»¥è¢«å°é—­åˆ°ä¸€ä¸ªä½œç”¨åŸŸå†…(æ¯”å¦‚ä½œä¸ºä¸€ä¸ªå±€éƒ¨å˜é‡)
      3. å¯ä»¥è¢«å°è£…åˆ°çº¿ç¨‹å†…
   3. ä¾‹å­ï¼š
   4. ä¸‹é¢çš„PersonSetçš„çŠ¶æ€åŒ…å«HashSetçš„çŠ¶æ€ï¼Œè€ŒHashSetå¹¶éçº¿ç¨‹å®‰å…¨ã€‚
   5. å°†HashSetå°é—­åˆ°PersonSetä¸­ï¼Œé€šè¿‡ç§æœ‰å˜é‡å®ç°ã€‚
   6. å”¯ä¸€èƒ½è®¿é—®mySetå°±æ˜¯addPersonå’ŒcontainsPersonï¼Œåœ¨æ‰§è¡Œä»–ä»¬çš„æ—¶å€™éƒ½è·å¾—äº†PersonSetçš„é”ã€‚
   7. å› æ­¤PersonSetçš„çŠ¶æ€å®Œå…¨ç”±å†…ç½®é”æ¥ä¿æŠ¤ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ç±»ã€‚
   8. æ›´å¤šä¾‹å­ï¼šæ¯”å¦‚Javaçš„å®¹å™¨ç±»ä¸­ArrayListå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯é€šè¿‡åŒ…è£…å™¨å·¥å‚æ–¹æ³•ï¼Œä½¿ç”¨è£…é¥°å™¨æŠŠéçº¿ç¨‹å®‰å…¨çš„ç±»å°é—­åœ¨ä¸€ä¸ªåŒæ­¥çš„å¯¹è±¡ä¸­ã€‚æ‰€æœ‰å¯¹åº•å±‚å¯¹è±¡çš„è®¿é—®éƒ½é€šè¿‡åŒ…è£…å™¨æ¥è¿›è¡Œã€‚

```
public class PersonSet {
    @GuardedBy("this") private final Set<Person> mySet = new HashSet<Person>();

    public synchronized void addPerson(Person p) {
        mySet.add(p);
    }

    public synchronized boolean containsPerson(Person p) {
        return mySet.contains(p);
    }

    interface Person {
    }
}
```

1. Javaç›‘è§†å™¨æ¨¡å¼ï¼š
   1. å®šä¹‰ï¼šéµå¾ªJavaç›‘è§†å™¨æ¨¡å¼çš„å¯¹è±¡ä¼šæŠŠå¯¹è±¡çš„æ‰€æœ‰å¯å˜çŠ¶æ€éƒ½ç»™å°è£…èµ·æ¥ï¼Œå¹¶ç”±è‡ªå·±çš„å†…ç½®é”æ¥ä¿æŠ¤ã€‚
   2. ä¾‹å­ï¼š
      1. å¦‚ä¸‹çš„ç±»é€šè¿‡ç§æœ‰é”æ¥ä¿æŠ¤çŠ¶æ€ï¼Œè€Œä¸æ˜¯å†…ç½®é”ã€‚
      2. ä¼˜ç‚¹ï¼šå¯ä»¥å°†é”å˜ä¸ºç§æœ‰ï¼Œä½¿å¾—å®¢æˆ·ä»£ç æ— æ³•å¾—åˆ°é”ï¼Œåªèƒ½é€šè¿‡å…¬æœ‰æ–¹æ³•è·å¾—é”ã€‚

```
public class PrivateLock {
    private final Object myLock = new Object();
    @GuardedBy("myLock") Widget widget;

    void someMethod() {
        synchronized (myLock) {
            // Access or modify the state of widget
        }
    }
}
```

# SUC

## 1.æ¦‚è¿°

### ç»ƒä¹ é¢˜æ€»ç»“ï¼š

1. å®ç°ä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç±»å‹å£°æ˜çš„composeæ–¹æ³•ã€‚æ­¤æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªå‡½æ•°hï¼Œå®ƒæ˜¯è¾“å…¥å‡½æ•°få’Œgçš„ç»„åˆã€‚

```
  def compose[A, B, C](f: B => C, g: A => B): A => C = {
    // A => C
    a => f(g(a))
  }
```

1. å®ç°ä¸€ä¸ªå…·æœ‰å¦‚ä¸‹ç±»å‹å£°æ˜çš„fuseæ–¹æ³•ï¼Œè‹¥aå’Œbéƒ½éç©ºï¼Œåˆ™è¿”å›çš„Optionå¯¹è±¡åº”è¯¥åŒ…å«Optionå¯¹è±¡aå’Œbä¸­çš„å€¼çš„äºŒå…ƒç»„ï¼ˆä½¿ç”¨foræ¨å¯¼å¼ï¼‰ã€‚

```
  def fuse[A, B](a: Option[A], b: Option[B]): Option[(A, B)] = {
    val ans = for {
      x <- a
      y <- b
    } yield {
      (x, y)
    }
    ans
  }
```

1. å®ç°ä¸€ä¸ªcheckæ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ç±»å‹ä¸ºTçš„å€¼çš„åºåˆ—å’Œç±»å‹ä¸ºT => Booleançš„å‡½æ•°ï¼Œå½“ä¸”ä»…å½“ pred å‡½æ•°å¯¹ xs ä¸­æ‰€æœ‰çš„å€¼éƒ½ä¸ºçœŸï¼Œå¹¶ä¸”ä¸ä¼šæŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œcheckæ‰è¿”å›çœŸ

```
  def check[T](xs: List[T])(p: T => Boolean): Boolean = {
    import scala.util.{Try, Success, Failure}
    var flag = false
    xs.foreach(
      item => {
        flag = Try(p(item)) match {
          case Success(value) => value
          case Failure(exception) => false
        }
      }
    )
    flag
  }
```

1. å®ç°ä¸€ä¸ªcombinationså‡½æ•°ï¼Œè¾“å…¥æ˜¯ä¸€ä¸ªå…ƒç´ åºåˆ—ï¼Œè¾“å‡ºæ˜¯é•¿åº¦ä¸ºnçš„æ‰€æœ‰å¯èƒ½ç»„åˆçš„éå†å™¨ã€‚ç»„åˆæŒ‡çš„æ˜¯ä»ä¸€ä¸ªå…ƒç´ é›†åˆä¸­é€‰å‡ºä¸€ä¸ªå­é›†çš„æ–¹å¼ï¼Œæ¯ä¸ªå…ƒç´ åªè¢«é€‰æ‹©ä¸€æ¬¡ï¼Œåªä¸è¿‡ä¸å…³å¿ƒå…ƒç´ å­é›†ä¸­çš„æ¬¡åºã€‚æ¯”å¦‚ï¼Œç»™å®šåºåˆ— Seq(1, 4, 9, 16)ï¼Œé•¿åº¦ä¸º2çš„ç»„åˆåŒ…æ‹¬Seq(1, 4)ã€Seq(1, 9)ã€Seq(1,16)ã€Seq(4, 9)ã€Seq(4, 16)å’Œ Seq(9, 16)ã€‚combinationså‡½æ•°çš„å®šä¹‰å£°æ˜å¦‚ä¸‹ï¼ˆå‚è§æ ‡å‡†åº“æ–‡æ¡£ä¸­Iteratorçš„APIï¼‰ã€‚

```
  def myCombinations(i: Int, ints: List[Int]): List[List[Int]] = {
    if (i == 0) {
      List(List())
    } else {
      ints.flatMap(
        item => {
          val ans = myCombinations(i - 1, ints.filter(_ != item))
          ans.map(
            list => {
              if(list.nonEmpty && list.head < item) list :+ item
              else if(list.isEmpty) list :+ item
              else List()
            }
          )
        }
      ).filter(_.nonEmpty)
    }
  }
```

1. å‡è®¾è¯»è€…å’ŒåŒäº‹ä»¬åŒå¤„ä¸€ä¸ªåŠå…¬å®¤ï¼Œå„è‡ªæœ‰ä¸€ä¸ªéš”é—´ï¼Œå¤§å®¶äº’ç›¸çœ‹ä¸è§å¯¹æ–¹ï¼Œä¸”ä¸èƒ½è¯´è¯ï¼ˆä¼šåµåˆ°åˆ«äººï¼‰ã€‚å› ä¸ºéƒ½è¢«é™åˆ¶åœ¨éš”é—´ä¸­ï¼Œæ‰€ä»¥æ¯ä¸ªäººéƒ½æ— æ³•ç¡®è®¤ä¼ é€’èšä¼šæ¶ˆæ¯çš„çº¸æ¡æ˜¯å¦å·²ç»åˆ°è¾¾ç›®çš„åœ°ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œå…¶ä¸­ä¸€äººè¢«å«åˆ°è€æ¿åŠå…¬å®¤ï¼Œè¢«æ°¸ä¹…â€œæ‰£ç•™â€åœ¨é‚£é‡Œã€‚è¯·è®¾è®¡ä¸€ä¸ªç®—æ³•ï¼Œä½¿å¤§å®¶èƒ½å¤Ÿç¡®å®šä½•æ—¶èƒ½å¤Ÿèšä¼šã€‚é™¤è¢«è€æ¿å«èµ°çš„é‚£ä½ä¹‹å¤–ï¼Œæ‰€æœ‰äººéƒ½éœ€è¦åŒæ—¶åšå‡ºå†³å®šã€‚å¦‚æœæœ‰äº›çº¸æ¡è¢«é€’åˆ°ç›®çš„åœ°æ—¶å‘ç”Ÿéšæœºæ€§å¤±è¯¯ï¼Œåˆ™è¯¥å¦‚ä½•æ”¹è¿›ç®—æ³•ï¼Ÿ

```
import SUC.chapter01.Person.peopleMap

import scala.collection.mutable.Queue
import scala.collection.concurrent.TrieMap
import scala.util.Random

sealed trait PartyStatus
case object NotDecided extends PartyStatus
case object CanParty extends PartyStatus
case object CannotParty extends PartyStatus

object Person{
  def apply(name: String, status: PartyStatus = NotDecided): Person = {
    new Person(name, status)
  }
  // å‡è®¾æœ‰ä¸€ä¸ªå…¨å±€çš„çº¿ç¨‹å®‰å…¨çš„peopleæ˜ å°„ï¼Œç”¨äºæ ¹æ®åå­—å¿«é€ŸæŸ¥æ‰¾Personå®ä¾‹
  private val peopleMap: TrieMap[String, Person] = TrieMap[String, Person]()
}
class Person(val name: String, var status: PartyStatus = NotDecided) {
  // ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—
  private val queue = Queue[(String, PartyStatus)]()

  def this(name: String, status: PartyStatus, peopleMap: TrieMap[String, Person]) = {
    this(name, status)
    peopleMap += (this.name -> this)
  }

  def sendNote(to: String, note: PartyStatus): Unit = {
    queue.enqueue((to, note))
  }

  // ä¼˜åŒ–æŸ¥æ‰¾äººçš„é€»è¾‘
  def receiveNote(from: String, note: PartyStatus): Unit = {
    peopleMap.get(from) match {
      case Some(person) =>
        if (note == CannotParty) status = CannotParty
        else if (status == NotDecided) status = note
      case None => // å¦‚æœæ‰¾ä¸åˆ°äººï¼Œå¯ä»¥åœ¨è¿™é‡Œè®°å½•é”™è¯¯æˆ–è€…é‡‡å–å…¶ä»–æªæ–½
    }
  }

  def updateStatus(): Unit = {
    while (queue.nonEmpty) {
      val (to, note) = queue.dequeue()
      peopleMap.get(to) match {
        case Some(person) => person.receiveNote(name, note)
        case None => // åŒæ ·çš„ï¼Œè¿™é‡Œå¯ä»¥å¤„ç†æ¥æ”¶åˆ°ä¸å­˜åœ¨çš„äººçš„noteçš„æƒ…å†µ
      }
    }
  }
}

object PartyAlgorithm {
  def main(args: Array[String]): Unit = {
    // åˆå§‹åŒ–peopleMap
    val peopleMap = TrieMap[String, Person]()
    List("Alice", "Bob", "Charlie").foreach(name => new Person(name, CanParty, peopleMap))
    new Person("David", CannotParty, peopleMap) // David is detained

    val maxRounds = 5
    for (round <- 1 to maxRounds) {
      peopleMap.values.foreach(_.updateStatus())
      if (peopleMap.values.forall(_.status == CannotParty)) {
        println("Everyone knows that someone is detained.")
        return
      } else if (peopleMap.values.forall(_.status == CanParty)) {
        println("Everyone can party!")
        return
      }
      if (round == maxRounds) {
        println("No consensus reached after " + maxRounds + " rounds.")
        return
      }
    }
    println("Reached maximum rounds without consensus.")
  }
}
```

## 2.JVMä¸JVMçš„å¹¶å‘æ€§

### 2.1 çº¿ç¨‹å’Œè¿›ç¨‹

åˆ›å»ºä¸€ä¸ªJVMå®ä¾‹ï¼Œæ€»æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„JVMè¿›ç¨‹ã€‚åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­è¿è¡Œç€å¾ˆå¤šçº¿ç¨‹ã€‚JVMè¿›ç¨‹å°†è¿™äº›çº¿ç¨‹è¡¨ç°ä¸ºjava.lang.Threadç±»ã€‚æ¯ä¸€ä¸ªJVMçº¿ç¨‹éƒ½è¢«ç›´æ¥æ˜ å°„ä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚Scalaé‡ç”¨äº†Javaä¸­çš„çº¿ç¨‹ä¸­çš„APIï¼Œæ˜¯å‡ºäºå…¼å®¹æ€§çš„è€ƒè™‘ã€‚

#### çº¿ç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œ

æ¯æ¬¡åˆ›å»ºJVMçš„è¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šé»˜è®¤åˆ›å»ºå‡ ä¸ªçº¿ç¨‹

1. mainçº¿ç¨‹
   1. ä¸‹é¢çš„ä»£ç è¾“å‡ºç»“æœæ˜¯main
   2. é™æ€çš„currentThreadæ–¹æ³•æ¥è·å¾—å½“å‰çº¿ç¨‹å¯¹è±¡çš„å¼•ç”¨

```
object ThreadsMain extends App {
  val t: Thread = Thread.currentThread
  val name = t.getName
  println(s"I am the thread $name")
}
```

1. å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹
   1. åˆ›å»ºThreadå¯¹è±¡
   2. è°ƒç”¨è¯¥å¯¹è±¡çš„startæ–¹æ³•ï¼Œstartä¼šè¿›ä¸€æ­¥è°ƒç”¨è¯¥çº¿ç¨‹å¯¹è±¡çš„runæ–¹æ³•
   3. joinæ–¹æ³•ï¼šä¼šè®©æœ¬çº¿ç¨‹è¿›å…¥waitingçŠ¶æ€ï¼Œç›´åˆ°forkå‡ºçš„çº¿ç¨‹æ‰§è¡Œç»“æŸ

```
object ThreadsCreation extends App {
  class MyThread extends Thread {
    override def run():Unit = {
      val name = Thread.currentThread.getName
      println(s"i am the thread ${name}")
    }
  }
  val name = Thread.currentThread.getName
  println(s"i am the thread ${name}")
  val t = new MyThread
  t.start()
  t.join()
  println("New thread joined.")
}
```

1. è®¾è®¡çº¿ç¨‹åˆ›å»ºå…¬ç”¨å‡½æ•°ä»¥åŠå…¬ç”¨æ—¥å¿—æ‰“å°å‡½æ•°

```
//çº¿ç¨‹åˆ›å»ºå‡½æ•°  
def thread(body: => Unit): Thread = {
    val t = new Thread{
      override def run(): Unit = body
    }
    t.start()
    t
  }
//æ—¥å¿—æ‰“å°å‡½æ•°
package object SUC {
  def log(msg: String): Unit = {
    println(s"${Thread.currentThread.getName}: $msg")
  }
}
```

#### åŸå­æ‰§è¡Œ

1. join
   1. è°ƒç”¨çš„ç‰¹ç‚¹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¢«è°ƒç”¨joinæ–¹æ³•æ—¶ï¼Œå®ƒæ‰€æœ‰çš„å†…å­˜å†™æ“ä½œéƒ½ä¼šåœ¨joinè¿”å›ä¹‹å‰å‘ç”Ÿï¼Œè€Œä¸”è¿™äº›å†™æ“ä½œå¯¹è°ƒç”¨joinçš„é‚£ä¸ªçº¿ç¨‹æ˜¯å¯è§çš„
   2. ç¼ºç‚¹ï¼šåªèƒ½å•å‘é€šä¿¡ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨çº¿ç¨‹ç»“æœè¿›è¡Œé€šä¿¡çš„æ¨¡å¼

```
object ThreadsCommunicate extends App {
  var result: String = null
  val t = thread { result = "\nTitle\n" + "=" * 5 }
  t.join()
  //resultä¸ä¼šä¸ºç©ºï¼Œå› ä¸ºthreadä¸­å†…å­˜å†™æ“ä½œæ€»æ˜¯ä¼šåœ¨joinä¹‹å‰å®Œæˆ
  log(result)
}
```

1. synchronized
   1. JVMä¸­åˆ›å»ºçš„æ¯ä¸ªå¯¹è±¡éƒ½æœ‰å†…ç½®é”(ç›‘æ§å™¨)ï¼Œå…¶ä½œç”¨æ˜¯ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯¥å¯¹è±¡ä¸Šæ‰§è¡ŒæŸä¸ªsynchronizedä»£ç å—ã€‚å½“ä¸€ä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œsynchronizedä»£ç å—æ—¶ï¼Œæˆ‘ä»¬ç§°è¯¥çº¿ç¨‹è·å¾—äº†xçš„ç›‘æ§å™¨çš„æ‰€æœ‰æƒï¼Œæ¢å¥è¯è¯´ï¼Œè·å¾—äº†xçš„ç›‘æ§æƒã€‚
   2. JVMä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹åœ¨æŸä¸ªå¯¹è±¡xä¸Šæ‰§è¡Œsynchronizedè¯­å¥æ—¶ï¼Œè¯¥çº¿ç¨‹æ˜¯xå¯¹è±¡ä¸Šå”¯ä¸€åœ¨æ‰§è¡Œsynchronizedè¯­å¥çš„çº¿ç¨‹ã€‚å¦‚æœçº¿ç¨‹Tè¦åœ¨xä¸Šè°ƒç”¨synchronizedè¯­å¥ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹Sæ­£åœ¨xä¸Šè°ƒç”¨å…¶ä»–synchronizedè¯­å¥ï¼Œé‚£ä¹ˆçº¿ç¨‹Tä¼šè¿›å…¥é˜»å¡ï¼ˆblockedï¼‰çŠ¶æ€ã€‚

```
object ThreadsUnprotectedUid extends App {
  var uidCount = 0L
  //this.synchronizedæ˜¯ç”¨ThreadsUnprotectedUidä½œä¸ºé”
  def getUniqueId(): Long = this.synchronized {
    val freshUid = uidCount + 1
    uidCount = freshUid
    freshUid
  }

  def printUniqueIds(n: Int): Unit = {

    val uids = for (i <- 0 until n) yield getUniqueId()
    log(s"Generated uids: ${uids}")
  }

  val t = thread {
    printUniqueIds(5)
  }
  Thread.sleep(10)
  printUniqueIds(5)
  t.join()
}
```

#### é‡æ’åº

1. åŸå› ï¼š JMM è§„èŒƒä¸Šï¼Œå¦‚æœåœ¨æŸä¸ªç‰¹å®šçš„çº¿ç¨‹å†…ä»£ç è¯­å¥çš„é¡ºåºä¸å½±å“ç¨‹åºçš„ä¸²è¡Œè¯­ä¹‰ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹ä¸­JVMæ˜¯å…è®¸è¿™ç±»é‡æ’åºçš„ã€‚è¿™æ—¶å€™å¯è§æ€§å°±ä¼šå‘ç”Ÿå˜åŒ–
2. ä¾‹å­ï¼š
   1. å¦‚ä¸‹ä»£ç ï¼Œæ‰§è¡Œå¤šæ¬¡ä¼šå‡ºç°xå’Œyéƒ½ä¸º1çš„æƒ…å†µ
   2. ä½†æ˜¯å› ä¸ºa,bçš„èµ‹å€¼ç†è®ºä¸Šå¿…æœ‰ä¸€ä¸ªåœ¨ifä¹‹å‰å‘ç”Ÿï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯JVMä¸Šå‘ç”Ÿäº†é‡æ’åºã€‚æ­¤å¤–ï¼Œç¨‹åºå¹¶ä¸éœ€è¦å°†æ‰€æœ‰çš„æ›´æ–°ç«‹å³å†™åˆ°ä¸»å­˜ä¸­ï¼Œè€Œæ˜¯ä¼šå°†å®ƒä»¬ä¸´æ—¶ä¿å­˜åœ¨å¤„ç†å™¨çš„å¯„å­˜å™¨ä¸­ã€‚
   3. è§£å†³åŠæ³•ï¼šåˆšæ‰çŠ¯çš„é”™æ¥è‡ªä¸€ä¸ªå‡è®¾ï¼Œå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œä¼šç«‹åˆ»åæ˜ åˆ°å†…å­˜ä¸­å¹¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œä½†è¿™ç§åŒæ­¥å¹¶ä¸ä¼šè‡ªç„¶è€Œç„¶å‘ç”Ÿ(å¯èƒ½æš‚æ—¶åœ¨å¯„å­˜å™¨ä¸­)ã€‚synchronizedè¯­å¥å°±æ˜¯å®ç°æ­£ç¡®çš„åŒæ­¥çš„åŸºæœ¬æ–¹å¼ã€‚åœ¨å¯¹è±¡xä¸Šæ‰§è¡Œ synchronized è¯­å¥äº§ç”Ÿçš„å†™æ“ä½œä¸ä»…æ˜¯åŸå­æ€§çš„ï¼Œè€Œä¸”å¯¹æ‰€æœ‰åœ¨ x ä¸Šæ‰§è¡Œsynchronizedè¯­å¥çš„çº¿ç¨‹è€Œè¨€éƒ½æ˜¯å¯è§çš„ã€‚

```
object ThreadSharedStateAccessReordering extends App {
  for (i <- 0 until 100000) {
    var a = false
    var b = false
    var x = -1
    var y = -1
    val t1 = thread {
      this.synchronized{
        a = true
        y = if (b) 0 else 1
      }
    }
    val t2 = thread {
      this.synchronized{
        b = true
        x = if (a) 0 else 1
      }
    }
    t1.join()
    t2.join()

    assert(!(x == 1 && y == 1), s"x = $x, y = $y")
  }
}
```

### 2.2ç›‘æ§å™¨å’ŒåŒæ­¥

#### ç›‘è§†å™¨

1. ç›‘æ§å™¨ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¯¹è±¡xä¸Šçš„synchronizedè¯­å¥æ—¶ï¼Œè‹¥æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ‹¥æœ‰xä¸Šçš„ç›‘æ§å™¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè·å¾—æ­¤ç›‘æ§å™¨ã€‚å¦åˆ™ï¼Œè¯¥çº¿ç¨‹ä¼šç­‰å¾…ç›‘æ§å™¨è¢«é‡Šæ”¾ã€‚åœ¨è·å¾—ç›‘æ§å™¨çš„åŒæ—¶ï¼Œè¯¥çº¿ç¨‹ä¹Ÿèƒ½çœ‹åˆ°é‡Šæ”¾è¯¥ç›‘æ§å™¨çš„å‰ä¸€çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜å†™æ“ä½œã€‚
2. ç›‘è§†å™¨æ˜¯åŸºäºå¯¹è±¡çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¥æœ‰å±äºä¸åŒå¯¹è±¡çš„å¤šä¸ªç›‘è§†å™¨ã€‚
3. ä¾‹å­ï¼šé“¶è¡Œç³»ç»Ÿï¼š
   1. æœ‰ä¸€ä¸ªå­˜å–æ—¥å¿—è®°å½•æ–¹æ³•ï¼Œä½¿ç”¨ArrayBufferå¯¹è±¡å­˜å‚¨ã€‚ä½¿ç”¨å†…ç½®é”ï¼Œé˜²æ­¢å¯¹è±¡æ›´æ–°å‡ºé”™
   2. æœ‰ä¸€ä¸ªAccountç±»ï¼Œç”¨äºåˆ›å»ºç”¨æˆ·è´¦æˆ·ã€‚ä½¿ç”¨å†…ç½®é”ï¼Œé˜²æ­¢t1,t3çº¿ç¨‹åŒæ—¶æ›´æ–°è´¦æˆ·

```
object SynchronizedNesting extends App {
  import scala.collection._
  private val transfers = mutable.ArrayBuffer[String]()
  def logTransfer(name: String, n: Int) = transfers.synchronized {
    transfers += s"transfer to account '$name' = $n"
  }
  class Account(val name: String, var money: Int){
    def add(account: Account, n: Int):Unit = account.synchronized {
      account.money += n
      if (n > 10) logTransfer(account.name, n)
    }
  }
  // é“¶è¡Œç³»ç»Ÿç¤ºä¾‹ä»£ç ï¼ˆç»­ï¼‰
  val jane = new Account("Jane", 100)
  val john = new Account("John", 200)
  val t1 = thread { jane.add(jane, 5) }
  val t2 = thread { john.add(john, 50) }
  val t3 = thread { jane.add(jane, 70) }
  t1.join(); t2.join(); t3.join()
  log(s"--- accounts ---\n${jane.money}\n${john.money}")
  log(s"--- transfers ---\n$transfers")
}
```

#### æ­»é”

1. å®šä¹‰ï¼šåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è·å¾—ä¸¤ä¸ªä¸åŒçš„ç›‘æ§å™¨ï¼Œç„¶åå°è¯•è·å¾—å¯¹æ–¹çš„ç›‘æ§å™¨æ—¶ï¼Œæ­»é”å°±å‘ç”Ÿäº†ã€‚åŒæ–¹éƒ½ä¸é‡Šæ”¾è‡ªå·±çš„ç›‘æ§å™¨ï¼Œäºæ˜¯è¿™ä¸¤ä¸ªçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªç›‘æ§å™¨è¢«é‡Šæ”¾ã€‚
2. æ‰“ç ´æ­»é”çš„å¿…è¦æ¡ä»¶ï¼šè§„å®šèµ„æºè®¿é—®é¡ºåºï¼Œæ‰“ç ´æ½œåœ¨çš„æ­»å¾ªç¯
3. ä¾‹å­ï¼š

```
object SynchronizedDeadlock extends App {
  import SynchronizedNesting.Account
  def send(a: Account, b: Account, n: Int) = a.synchronized {
    Thread.sleep(10)
    b.synchronized {
      a.money -= n
      b.money += n
    }
  }
  val a = new Account("Jack", 1000)
  val b = new Account("Jill", 2000)
  val t1 = thread { for (i<- 0 until 100) send(a, b, 1) }
  val t2 = thread { for (i<- 0 until 100) send(b, a, 1) }
  t1.join(); t2.join()
  log(s"a = ${a.money}, b = ${b.money}")
}
```

1. ä¿®æ”¹ï¼š

```
object SynchronizedDeadlock extends App {
  import ThreadsUnprotectedUid.getUniqueId
  class Account(val name: String, var money: Int) {
    val uid = getUniqueId()
  }
  def send(a1: Account, a2: Account, n: Int) {
    def adjust() {
      log(s"money is ${n}")
      a1.money -= n
      a2.money += n
    }
    if (a1.uid < a2.uid)
      a1.synchronized { a2.synchronized { adjust() } }
    else a2.synchronized { a1.synchronized { adjust() } }
  }
  val a = new Account("Jack", 1000)
  val b = new Account("Jill", 2000)
  log(s"a.uid = ${a.uid}, b.uid = ${b.uid}")
  //a,bçš„uidå…¨å±€æœ‰åºï¼Œåˆ™è·å¾—çš„é”æ˜¯æœ‰åºçš„ï¼Œæ²¡æœ‰æŠ¢åˆ°çš„å°±é˜»å¡ï¼Œè€Œä¸æ˜¯ä¹±å»è·å¾—å…¶ä»–é”
  val t1 = thread { for (i<- 0 until 100) send(a, b, 10) }
  val t2 = thread { for (i<- 0 until 100) send(b, a, 1) }
  t1.join(); t2.join()
  log(s"a = ${a.money}, b = ${b.money}")
}  
```

#### ä¿æŠ¤å—

1. çº¿ç¨‹æ± ï¼šåˆ›å»ºæ–°çº¿ç¨‹çš„ä»£ä»·æ¯”åˆ›å»º Account ä¹‹ç±»çš„è½»é‡çº§å¯¹è±¡è¦å¤§å¾—å¤šã€‚åŒä¸€çº¿ç¨‹åº”è¯¥èƒ½å¤Ÿè¢«å¤šä¸ªè¯·æ±‚é‡ç”¨ï¼Œè¿™ç§å¯é‡ç”¨çš„çº¿ç¨‹çš„é›†åˆé€šå¸¸ç§°ä¸ºçº¿ç¨‹æ± 

å¿™ç­‰å¾…ï¼šworkerçº¿ç¨‹åœ¨å¯åŠ¨ä¹‹å‰è¢«è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒJVMè¿›ç¨‹å¹¶ä¸ä¼šåœ¨ä¸»çº¿ç¨‹ç»ˆæ­¢æ—¶ç»“æŸï¼Œè€Œæ˜¯ä¼šç­‰æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹å…¨éƒ¨ç»“æŸã€‚ç­‰åˆ°workerçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Œå®ƒä¼šç»§ç»­æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ä»»åŠ¡ã€‚æˆ‘ä»¬ç§°workerçº¿ç¨‹è¿™æ ·çš„çŠ¶æ€ä¸ºå¿™ç­‰å¾…ã€‚è¿™æ˜¯ä¸€ç§æµªè´¹èµ„æºçš„è¡Œä¸ºï¼Œå¤§éƒ¨åˆ†æƒ…å†µéœ€è¦é¿å…å¿™ç­‰å¾…

```
import scala.collection._
object SynchronizedBadPool extends App {
  private val tasks = mutable.Queue[() => Unit]()
  val worker = new Thread {
    def poll(): Option[() => Unit] = tasks.synchronized {
      if (tasks.nonEmpty) Some(tasks.dequeue()) else None
    }
    override def run() = while (true) poll() match {
      case Some(task) => task()
      case None =>
    }
  }
  worker.setName("Worker")
  //è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
  worker.setDaemon(true)
  worker.start()

  def asynchronous(body: => Unit) = tasks.synchronized {
    tasks.enqueue(() => body)
  }
  asynchronous { log("Hello") }
  asynchronous { log(" world!")}
  Thread.sleep(5000)
}
```

1. å¿™ç­‰å¾…çš„ä¼˜åŒ–ï¼šè®©workerçº¿ç¨‹ä¼‘çœ ï¼Œåªæœ‰åœ¨taské˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå†è¢«å”¤é†’
   1. waitä¸notify:ä¹Ÿæ˜¯åŸºäºé”å¯¹è±¡çš„æ“ä½œã€‚å½“çº¿ç¨‹Tè°ƒç”¨æŸå¯¹è±¡çš„waitæ–¹æ³•æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾xçš„ç›‘æ§å™¨ï¼Œç„¶åè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°å¦ä¸€çº¿ç¨‹Sè°ƒç”¨åŒä¸€å¯¹è±¡çš„notifyæ–¹æ³•ã€‚
   2. ä¾‹å­ï¼šæ— è®ºå“ªä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œsychronizedæ–¹æ³•ï¼Œæœ€ç»ˆéƒ½ä¼šè¾“å‡ºhelloä¿¡æ¯

```
object SynchronizedGuardedBlocks extends App {
  //AnyRef <=> java.lang.Object
  val lock = new AnyRef
  var message: Option[String] = None
  val greeter = thread {
    //1.greeterçº¿ç¨‹è¿›å…¥ï¼Œå‘ç°ä¸ºNoneï¼Œè¢«é˜»å¡ï¼Œé‡Šæ”¾é”
    lock.synchronized {
      //å¿…é¡»ä½¿ç”¨whileï¼Œä½¿ç”¨ifå¯èƒ½ä¼šå¼•èµ·è™šå‡å”¤é†’ã€‚
      while (message == None) lock.wait()
      //3.åœ¨åŒä¸€ä¸ªé”ä¸­ï¼Œå¹¶ä¸”mainç»™messageåœ¨logä¹‹å‰ï¼Œæ‰€ä»¥ä¿è¯å¯è§æ€§
      log(message.get)
    }
  }
  //2.mainçº¿ç¨‹è¿›å…¥ï¼Œå‘ç°ä¸ä¸ºNoneï¼Œè®¾ç½®message,é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’greeterçº¿ç¨‹
  lock.synchronized {
    message = Some("Hello!")
    lock.notify()
  }
  greeter.join()
}
```

1. waitçš„ä¸€ä¸ªé‡è¦æ€§è´¨æ˜¯å®ƒä¼šå¼•èµ·è™šå‡å”¤é†’ã€‚æœ‰æ—¶å€™ï¼ŒJVMå…è®¸åœ¨æ²¡æœ‰è°ƒç”¨notifyçš„æƒ…å†µä¸‹å”¤é†’ä¸€ä¸ªæ‰§è¡Œäº†waitçš„ä¼‘çœ çº¿ç¨‹ã€‚ä¸ºäº†é˜²æ­¢å‡ºç°è¿™ç§æƒ…å†µï¼Œéœ€è¦ç”¨ä¸€ä¸ªwhileå¾ªç¯åå¤æ£€æŸ¥çŠ¶æ€ï¼Œç„¶åç»“åˆ waitä½¿ç”¨ï¼Œå¦‚ä¸Šé¢ä»£ç æ‰€ç¤ºã€‚ä½¿ç”¨ä¸€ä¸ª if è¯­å¥æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå³ä½¿messageçš„å€¼ä¸ºNoneï¼Œä¸€ä¸ªè™šå‡å”¤é†’ä¹Ÿå°†å…è®¸çº¿ç¨‹æ‰§è¡Œmessage.getã€‚ä¿è¯æ˜¯ç”±å…¶ä»–çº¿ç¨‹å°†å…¶notifyå”¤é†’ã€‚
2. ä¿æŠ¤å—ï¼šè‹¥synchronizedè¯­å¥åœ¨è°ƒç”¨waitä¹‹å‰åå¤æ£€æŸ¥æ¡ä»¶ï¼Œé‚£è¿™ä¸ªsynchronizedè¯­å¥ç§°ä¸ºä¿æŠ¤å—ã€‚é€šå¸¸ä»¥while loopçš„å½¢å¼å‡ºç°ã€‚

```
object SynchronizedPool extends App {
  import scala.collection._
  private val tasks = mutable.Queue[() => Unit]()
  object Worker extends Thread {
    setDaemon(true)
    def poll() = tasks.synchronized {
      //ä¿æŠ¤å—ï¼Œå½“é˜Ÿåˆ—ä¸ºç©ºï¼Œä¼šé‡Šæ”¾é”å¹¶è¢«é˜»å¡ç­‰å¾…è¢«å”¤é†’
      while (tasks.isEmpty) tasks.wait()
      tasks.dequeue()
    }
    override def run() = while (true) {
      val task = poll()
      task()
    }
  }
  Worker.start()
  def asynchronous(body: =>Unit) = tasks.synchronized {
    tasks.enqueue(() => body)
    tasks.notify()
  }
  asynchronous { log("Hello ") }
  asynchronous { log("World!") }
  Thread.sleep(500)
}
```

#### çº¿ç¨‹ä¸­æ–­ä¸å¹³æ»‘å…³é—­

workerçº¿ç¨‹ä¼˜åŒ–ï¼šå³ä½¿æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå‡ºäºä¼‘çœ çŠ¶æ€ï¼Œä½†æ˜¯æ‰€å æ®çš„æ ˆç©ºé—´ä¸€ç›´éƒ½åœ¨ã€‚å¦‚æœä¼‘çœ çº¿ç¨‹å¤ªå¤šï¼Œå†…å­˜å°±ä¼šè¢«ç”¨å®Œã€‚

ç»“æŸä¼‘çœ çº¿ç¨‹çš„æ–¹æ³•ï¼š

1. ä¸­æ–­çº¿ç¨‹ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æˆ–è®¡æ—¶ç­‰å¾…æ—¶ï¼Œè°ƒç”¨å…¶ interrupt æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ª InterruptedExptionå¼‚å¸¸ã€‚æ­¤å¼‚å¸¸å¯ä»¥è¢«æ•è·å’Œå¤„ç†ï¼Œä½†åœ¨è¿™é‡Œï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»ˆæ­¢çº¿ç¨‹Workerã€‚ä¸è¿‡ï¼Œå¦‚æœå¯¹è¿è¡Œä¸­çš„çº¿ç¨‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªå¼‚å¸¸å°±ä¸ä¼šäº§ç”Ÿï¼Œè€Œæ˜¯è®¾ç½®çº¿ç¨‹çš„interrupt æ ‡å¿—ã€‚å¯¹äºä¸é˜»å¡çš„çº¿ç¨‹å¿…é¡»å‘¨æœŸæ€§åœ°ç”¨isInterrupted æ–¹æ³•æŸ¥è¯¢interruptæ ‡å¿—ã€‚
2. å¹³æ»‘å…³é—­ï¼šåœ¨å¹³æ»‘å…³é—­ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹è®¾ç½®ç»ˆæ­¢æ¡ä»¶ï¼Œç„¶åè°ƒç”¨notifyæ¥å”¤é†’å·¥ä½œçº¿ç¨‹ã€‚ç„¶åï¼Œå·¥ä½œçº¿ç¨‹ä¼šé‡Šæ”¾å®ƒæ‰€æœ‰çš„èµ„æºï¼Œå¹¶é¡ºåˆ©åœ°ç»“æŸã€‚
3. ä¸¤è€…çš„é€‰æ‹©ï¼šå¦‚æœnotifyä¸èƒ½å†æ¬¡å”¤é†’çº¿ç¨‹ï¼Œå°±è¦ä½¿ç”¨ä¸»åŠ¨ä¸­æ–­çš„æ–¹å¼ã€‚

```
object SynchronizedPool extends App {

  import scala.collection._

  private val tasks = mutable.Queue[() => Unit]()

  object Worker extends Thread {
    var terminated = false
    def poll(): Option[() => Unit] = tasks.synchronized {
      while (tasks.isEmpty && !terminated) tasks.wait()
      if (!terminated) Some(tasks.dequeue()) else None
    }
    import scala.annotation.tailrec
    @tailrec override def run() = poll() match {
      //åœ¨pollè¿”å›Someæ—¶ï¼Œä¼šç»§ç»­æ‰§è¡Œrunï¼Œç›´åˆ°è¿”å›None
      //ä½¿ç”¨äº†å°¾é€’å½’ä¼˜åŒ–
      case Some(task) => task(); run()
      case None =>
    }
    def shutdown() = tasks.synchronized {
      terminated = true
      tasks.notify()
    }
  }

  Worker.start()

  def asynchronous(body: => Unit) = tasks.synchronized {
    tasks.enqueue(() => body)
    tasks.notify()
  }

  asynchronous {
    log("Hello ")
  }
  asynchronous {
    log("World!")
  }
  Thread.sleep(500)
  Worker.shutdown()
}
```

### 2.3æ˜“å¤±(volatile)å˜é‡

1. å®šä¹‰ï¼šJVMè¿˜æä¾›äº†ä¸€ç§æ¯”synchronizedä»£ç å—æ›´è½»é‡çº§çš„åŒæ­¥å½¢å¼ï¼Œç§°ä¸ºæ˜“å¤±å˜é‡ã€‚æ˜“å¤±å˜é‡å¯ä¾›äºåŸå­æ€§è¯»å†™ï¼Œå¸¸ç”¨äºè¡¨ç¤ºçŠ¶æ€æ ‡å¿—ã€‚æ¯”å¦‚ï¼Œæ ‡è®°æŸä¸ªè®¡ç®—æ˜¯å¦å®Œæˆã€æ˜¯å¦å–æ¶ˆã€‚è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªå¥½å¤„ï¼Œç¬¬ä¸€æ˜¯å•ä¸ªçº¿ç¨‹ä¸­æ˜“å¤±å˜é‡çš„è¯»æ“ä½œå’Œå†™æ“ä½œä¸ä¼šé‡æ’åºï¼Œç¬¬äºŒæ˜¯æ˜“å¤±å˜é‡çš„å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹æ˜¯ç«‹å³å¯è§çš„ã€‚å¦‚æœå¯¹ä¸€ä¸ªæ˜“å¤±å˜é‡vè¿›è¡Œå†™æ“ä½œWï¼Œè¿™è¢«å¦ä¸€ä¸ªçº¿ç¨‹é€šè¿‡å¯¹å˜é‡vçš„è¯»æ“ä½œRè§‚å¯Ÿï¼Œé‚£ä¹ˆåœ¨Wä¹‹å‰è¯¥å˜é‡çš„æ‰€æœ‰å†™æ“ä½œéƒ½å¯ä»¥åœ¨Rä¹‹åè§‚å¯Ÿåˆ°ã€‚
2. Scalaçš„volatileå˜é‡æ€§è´¨

å’ŒJavaä¸ä¸€æ ·ï¼ŒScalaæ”¯æŒå£°æ˜å±€éƒ¨ï¼ˆæœ¬ç¤ºä¾‹æŒ‡çš„æ˜¯forå¾ªç¯çš„é—­åŒ…ï¼‰æ˜“å¤±å˜é‡ã€‚å¯¹äºé—­åŒ…æˆ–åµŒå¥—ç±»ä¸­çš„æ¯ä¸ªå±€éƒ¨æ˜“å¤±å˜é‡ï¼ŒScalaéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¸¦æ˜“å¤±å­—æ®µçš„å †å¯¹è±¡ã€‚äºæ˜¯ï¼Œå¯ä»¥ç§°è¿™äº›å±€éƒ¨æ˜“å¤±å˜é‡è¢«æå‡ä¸ºå¯¹è±¡ã€‚

```
class Page(val txt: String, var position: Int)
object Volatile extends App {
  val pages = for (i<- 1 to 5) yield
    new Page("Na" * (100 - 20 * i) + " Batman!", -1)
  @volatile var found = false
  for (p <- pages) yield thread {
    var i = 0
    while (i < p.txt.length && !found)
      if (p.txt(i) == '!') {
        p.position = i
        found = true
      } else i += 1
  }
  while (!found) {}
  log(s"results: ${pages.map(_.position)}")
}
```

### 2.4 JMM

1. å®šä¹‰ï¼šä¸€ä¸ªè¯­è¨€çš„å†…å­˜æ¨¡å‹æŒ‡çš„æ˜¯ä¸€ç§è§„èŒƒï¼Œå®ƒæè¿°äº†å˜é‡çš„å†™æ“ä½œåœ¨ä»€ä¹ˆæƒ…å†µä¸‹å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚Scala ç»§æ‰¿äº† JVM çš„å†…å­˜æ¨¡å‹ï¼Œè¯¥å†…å­˜æ¨¡å‹å®šä¹‰äº†ä¸€ç³»åˆ—ç¨‹åºä¸­å„ç§è¡Œä¸ºçš„å‰å‘ç”Ÿï¼ˆhappens-beforeï¼‰å…³ç³»ã€‚åœ¨JVMä¸Šã€‚è¿™äº›è¡Œä¸ºä¸­å¦‚æœä¸€ä¸ªè¡Œä¸ºAå‘ç”Ÿäºè¡Œä¸ºBä¹‹å‰ï¼Œåˆ™è¡Œä¸ºBå¯ä»¥å‘ç°è¡Œä¸ºAçš„å†…å­˜å†™æ“ä½œã€‚ç¨‹åºå‘˜éœ€è¦è‡ªå·±ä¿è¯ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œä¸æ‰€æœ‰æ­¤å˜é‡çš„æ–°å€¼çš„è¯»æ“ä½œæ„æˆå‰å‘ç”Ÿå…³ç³»ã€‚
2. è¡Œä¸ºç§ç±»ï¼š
   1. ç¨‹åºæŒ‡ä»¤é¡ºåºï¼šçº¿ç¨‹ä¸­çš„ç¨‹åºæŒ‡ä»¤é¡ºåºå†³å®šäº†å„ä¸ªè¡Œä¸ºçš„å…ˆåå‘ç”Ÿé¡ºåº
   2. ç›‘æ§å™¨é”å®šï¼šå¯¹ä¸€ä¸ªç›‘æ§å™¨çš„è§£é”å‘ç”Ÿåœ¨è¢«æ­¤ç›‘æ§å™¨åç»­è¢«é”å®šä¹‹å‰
   3. volatileå­—æ®µï¼šè¯¥å­—æ®µçš„å†™æ“ä½œå‘ç”Ÿåœ¨è¯»æ“ä½œä¹‹å
   4. çº¿ç¨‹å¯åŠ¨ï¼šçº¿ç¨‹çš„startæ–¹æ³•å‘ç”Ÿåœ¨è¯¥çº¿ç¨‹æ‰€æœ‰è¡Œä¸ºä¹‹å‰
   5. çº¿ç¨‹ç»ˆæ­¢ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»»æ„è¡Œä¸ºå‘ç”Ÿåœ¨å¦ä¸€ä¸ªçº¿ç¨‹å®Œæˆå…¶joinæ–¹æ³•ä¹‹å‰
   6. ä¼ é€’æ€§ï¼šå¦‚æœè¡Œä¸ºAå‘ç”Ÿåœ¨è¡Œä¸ºBä¹‹å‰ï¼Œè€Œè¡Œä¸ºBå‘ç”Ÿåœ¨è¡Œä¸ºCä¹‹å‰ï¼Œåˆ™è¡Œä¸ºAå‘ç”Ÿåœ¨è¡Œä¸ºCä¹‹å‰ã€‚
3. å‰å‘ç”Ÿå…³ç³»çš„å…¶ä»–æ€§è´¨ï¼š

â— éæ˜“å¤±è¯»æ“ä½œä¸èƒ½é€šè¿‡é‡æ’åºå‡ºç°åœ¨ç¨‹åºæŒ‡ä»¤é¡ºåºæ›´é å‰çš„ç¨‹åºæ˜“å¤±è¯»æ“ä½œï¼ˆæˆ–ç›‘æ§å™¨é”å®šï¼‰ä¹‹å‰ã€‚

â— éæ˜“å¤±å†™æ“ä½œä¸èƒ½é€šè¿‡é‡æ’åºå‡ºç°åœ¨ç¨‹åºæŒ‡ä»¤é¡ºåºæ›´é åçš„æ˜“å¤±å†™æ“ä½œï¼ˆæˆ–ç›‘æ§å™¨è§£é”ï¼‰ä¹‹åã€‚

ä¹Ÿå°±æ˜¯æœ€å…ˆvolatileè¯»ï¼Œæœ€åvolatileå†™

### ç»ƒä¹ é¢˜ï¼š

1. å®ç°ä¸€ä¸ªparallelæ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸¤ä¸ªè®¡ç®—ä»£ç å—aå’Œbï¼Œæ­¤æ–¹æ³•ç”¨ä¸¤ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸¤ä¸ªä»£ç å—ï¼Œå¹¶ç”¨ä¸€ä¸ªäºŒå…ƒç»„è¿”å›ä¸¤è€…çš„è®¡ç®—ç»“æœï¼Œå…¶å£°æ˜å¦‚ä¸‹ã€‚

def parallel[A, B](a: =>A, b: =>B): (A, B)

```
class Test02 {
  def parallel[A, B](a: =>A, b: =>B): (A, B) = {
    val t1 = new Thread{
      var flag = false
      override def run(): Unit = {
        while(!flag){
          log("waiting to get")
          getResult()

        }
      }
      //æŠŠbodyæ”¾åœ¨è¯¥å‡½æ•°è°ƒç”¨ä¸­ï¼Œå¹¶ä¸”æ§åˆ¶runæ–¹æ³•çš„ç»“æŸæ—¶æœº
      def getResult(): A = {
        flag = true
        a
      }

    }
    val t2 = new Thread{
      var flag = false
      override def run(): Unit = {
        while(!flag){
          log("waiting to get")
          getResult()
        }
      }
      def getResult():B= {
        flag = true
        b
      }
    }
    t1.start()
    t2.start()
    //mainçº¿ç¨‹å¼€å§‹ç­‰å¾…å­çº¿ç¨‹çš„ç»“æœ
    t1.join()
    t2.join()
    //è°ƒç”¨getResultä¹‹åï¼Œä¸¤ä¸ªçº¿ç¨‹æ‰ä¼šç»“æŸæ‰§è¡Œï¼Œè¿”å›åˆ°Mainçº¿ç¨‹
    (t1.getResult(),t2.getResult())
  }
  @Test
  def test01(): Unit = {
    def fun1(): String = {
      "hello"
    }

    def fun2(): Int = {
      1
    }
    val (r1, r2) = parallel[String,Int](fun1 , fun2)
    println(r1)
    println(r2)
  }
}
```

1. å®ç°ä¸€ä¸ª periodically æ–¹æ³•ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªä»¥ms ä¸ºå•ä½çš„æ—¶é—´å‚æ•°durationï¼Œä»¥åŠä¸€ä¸ªè®¡ç®—ä»£ç å—bã€‚æ­¤æ–¹æ³•æ¯éš”duration msç”¨çº¿ç¨‹æ‰§è¡Œbã€‚æ­¤æ–¹æ³•çš„å£°æ˜å¦‚ä¸‹ã€‚

```
  def periodically(duration: Long)(b: =>Unit): Unit  ={
    val t = new Thread{
      override def run(): Unit = {
        while(true){
          b
          Thread.sleep(duration)
        }
      }
    }
    t.start()
  }
```

3ï¼Œ4 å®ç°å•å˜é‡çš„æ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼

```
class SyncVar[T] {
  import scala.collection._
  private var value = mutable.Queue[T]()
  def get(): T = {
    value.synchronized{
      while(value.isEmpty) value.wait()
      val res = value.dequeue()
      value.notify()
      res
    }
  }
  def put(x: T): Unit = {
    value.synchronized{
      while(value.nonEmpty) value.wait()
      value.enqueue(x)
      value.notify()
    }
  }
  def isEmpty():Boolean = value.isEmpty
  def nonEmpty():Boolean = value.nonEmpty
}

object Test02 {
  def main(args: Array[String]): Unit = {
    val sv = new SyncVar[Int]
    val producer = thread{
      for(i <- 0 until 15){
        sv.put(i)
      }
    }
    val consumer = thread{
      var cnt = 0
      while(cnt < 15){
        val x = sv.get()
        println(x)
        cnt += 1
      }
    }
    producer.join()
    consumer.join()
    log("end")
  }
}
```

## 3.å¹¶å‘ç¼–ç¨‹çš„ä¼ ç»Ÿæ„é€ æ¨¡å—

### 3.1Executorå’ŒExecutionContextå¯¹è±¡

1. çº¿ç¨‹æ± ï¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éœ€è¦ä¸ºå®ƒçš„è°ƒç”¨æ ˆåˆ†é…ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ªä¸Šä¸‹æ–‡ç”¨äºçº¿ç¨‹åˆ‡æ¢ï¼Œåˆ‡æ¢ç”šè‡³è¦æ¯”æ‰§è¡Œå¹¶å‘ä»»åŠ¡æœ¬èº«æ›´è€—æ—¶ã€‚å‡ºäºè¿™ä¸ªè€ƒè™‘ï¼Œå¤§å¤šæ•°å¹¶å‘æ€§æ¡†æ¶ä¼šæä¾›å·¥å…·æ¥ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹é›†åˆï¼Œè®©è¿™äº›çº¿ç¨‹å¤„äºå¾…å‘½çŠ¶æ€ï¼Œä»¥éšæ—¶å¤„ç†æ–°å‡ºç°çš„å¹¶å‘æ€§ä»»åŠ¡ã€‚è¿™ç§å·¥å…·ä¸€èˆ¬ç§°ä¸ºçº¿ç¨‹æ± ã€‚
2. ExecutoræŠ½è±¡æ¥å£ï¼š

   1. å®ƒåªæœ‰ä¸€ä¸ªexecuteæ–¹æ³•ï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œåœ¨executeæ–¹æ³•é‡Œå¯ä»¥è°ƒç”¨è¿™ä¸ªRunnableå¯¹è±¡çš„runæ–¹æ³•ã€‚å®ƒä¼šä»çº¿ç¨‹æ± ä¸­å–å‡ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡ŒRunnableå¯¹è±¡ï¼Œè¯¥çº¿ç¨‹ä¸å½“å‰è°ƒç”¨executeæ–¹æ³•çš„çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚
   2. ä½œç”¨ï¼šExecutor å¯¹è±¡çš„ä½œç”¨æ˜¯å°†å¹¶å‘è®¡ç®—å®šä¹‰å’Œå®ƒçš„æ‰§è¡Œæ–¹å¼è§£è€¦åˆï¼Œä»è€Œï¼Œç¨‹åºå‘˜å¯ä»¥é›†ä¸­ç²¾åŠ›ç¡®å®šå“ªäº›ä»£ç æ˜¯å¯å¹¶å‘æ‰§è¡Œçš„ï¼Œå¹¶å°†å®ƒä»¬ä¸è°ƒç”¨æ–¹å¼ï¼ˆä½•æ—¶ä½•åœ°ï¼‰åˆ†ç¦»å¼€
   3. åœ¨Javaä¸­çš„å®ç°æ˜¯ForkJoinPoolï¼Œä½äºjava,util.concurrentåŒ…ä¸­ã€‚åœ¨Scalaä¸­ä½äºscala.concurrent.forkjoin
   4. ä¾‹å­ï¼š

```
import scala.concurrent._
import java.util.concurrent.ForkJoinPool
object ExecutorsCreate extends App {
  //1.åˆ›å»ºçº¿ç¨‹æ± 
  val executor = new ForkJoinPool
  //2.ä¼ å…¥runnableæ¥å£çš„å®ç°ç±»
  executor.execute(new Runnable {
    def run() = log("This task is run asynchronously.")
  })
  Thread.sleep(500)
  executor.shutdown()
}
```

1. ExecutorContextç‰¹è´¨

scala.concurrentåŒ…å®šä¹‰äº†ExecutionContextç‰¹è´¨ï¼Œå’ŒExecutorå¯¹è±¡çš„åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒåªé’ˆå¯¹ Scalaç¨‹åºã€‚

ExecutionContext å®ç°äº†æŠ½è±¡çš„ execute æ–¹æ³•ï¼Œå¯¹åº”äº† Executor æ¥å£çš„executeæ–¹æ³•ï¼Œå®ƒè¿˜å®ç°äº†reportFailureæ–¹æ³•ï¼Œå‚æ•°ä¸ºä¸€ä¸ªThrowableå¯¹è±¡ï¼Œæ­¤ æ–¹æ³•åœ¨æŸä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šè¢«è°ƒç”¨ã€‚ExecutionContext ä¸­è¿˜å¸¦äº†ä¸€ä¸ªé»˜è®¤çš„æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç§°ä¸ºglobalï¼Œå…¶å†…éƒ¨ä½¿ç”¨äº†ForkJoinPoolå®ä¾‹ã€‚

åœ¨å…·æœ‰è¶…çº¿ç¨‹çš„å››æ ¸CPUä¸Šï¼Œå…¨å±€ExecutionContextå¯¹è±¡åœ¨çº¿ç¨‹æ± ä¸­æœ‰8ä¸ªçº¿ç¨‹ã€‚è€Œåœ¨æœ¬ç”µè„‘ä¸Šï¼Œçº¿ç¨‹æ± æœ‰16ä¸ªçº¿ç¨‹ã€‚

é¿å…å¯¹ExecutionContextå’ŒExecutorå¯¹è±¡æ‰§è¡Œå¯èƒ½æ— é™æœŸé˜»å¡çš„æ“ä½œï¼Œè€Œå¯¼è‡´çº¿ç¨‹é¥¥é¥¿

```
object ExecutionContextGlobal extends App {
  val ectx = ExecutionContext.global
  ectx.execute(new Runnable {
    def run() = log("Running on the execution context.")
  })
  Thread.sleep(500)
}
```

### 3.2 åŸå­æ€§åŸè¯­

å†…å­˜å†™æ“ä½œçš„å¯è§æ€§æ˜¯ç”±å‰å‘ç”Ÿå…³ç³»æ¥ä¿è¯çš„ã€‚ç¬¬äºŒç« ä¸­ä½¿ç”¨çš„æ˜¯sychronizedæ¥å®ç°çš„å‰å‘ç”Ÿå…³ç³»ã€‚

åŸå­æ€§å˜é‡ï¼Œå®ƒæ”¯æŒä¸€æ¬¡æ€§æ‰§è¡Œå¤šæ¬¡å†…å­˜è¯»å†™æ“ä½œã€‚åŸå­æ€§å˜é‡æ˜¯æ˜“å¤±å˜é‡çš„è¿‘äº²ï¼Œä½†å…¶è¡¨è¾¾èƒ½åŠ›æ›´å¼ºï¼Œå¸¸ç”¨äºåœ¨æ— é¡»ä½¿ç”¨synchronized è¯­å¥çš„æƒ…å†µä¸‹æ„é€ å¤æ‚çš„å¹¶å‘æ“ä½œ

#### åŸå­æ€§å˜é‡

1. å¯çº¿æ€§åŒ–æ“ä½œï¼š

   1. å¯çº¿æ€§åŒ–æ“ä½œæŒ‡çš„æ˜¯å¯¹ç³»ç»Ÿå…¶ä»–éƒ¨åˆ†è€Œè¨€å¯ç¬é—´å‘ç”Ÿçš„æ“ä½œ
   2. ä¸€æ¬¡volatileè¯»æˆ–å†™å°±æ˜¯å¯çº¿æ€§åŒ–æ“ä½œ
   3. å¤æ‚å¯çº¿æ€§åŒ–æ“ä½œï¼šè‡³å°‘åŒ…å«ä¸¤æ¬¡è¯»/å†™æ“ä½œ
2. java.util.concurrent.atomic
3. AtomicBoolean
4. AtomicInteger
5. AtomicLong
6. AtomicReference
7. ä¾‹å­ï¼š

mainçº¿ç¨‹ä»¥åŠå…¶ä»–çº¿ç¨‹å‡è·å¾—å…¨å±€å”¯ä¸€uid

incrementAndGet()æ˜¯ä¸€ä¸ªå¤æ‚å¯çº¿æ€§åŒ–æ“ä½œï¼Œå®ƒåŒæ—¶å®ç°äº†è¯»å–uidçš„å½“å‰å€¼xï¼Œè®¡ç®—x+1ï¼Œç„¶åå°†x+1å†™å›åˆ°uidè¿™3ä¸ªæ“ä½œã€‚

```
import java.util.concurrent.atomic._
object AtomicUid extends App {
  private val uid = new AtomicLong(0L)
  def getUniqueId(): Long = uid.incrementAndGet()
  for(i<- 0 until 16){
    execute { log(s"Uid asynchronously: ${getUniqueId()}") }
  }
  log(s"Got a unique id: ${getUniqueId()}")
}
```

1. å¤æ‚å¯çº¿æ€§æ“ä½œçš„å®ç°åŸºç¡€ï¼š
   1. compareAndSetæ“ä½œ(CAS)ã€‚ä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„testAndSetæŒ‡ä»¤
   2. CASæ“ä½œä¼šè¯»å–åŸå­å˜é‡ä¹‹å‰çš„é¢„æœŸå€¼ä»¥åŠæ–°å€¼ï¼Œåªæœ‰å½“å‰å€¼ç­‰äºé¢„æœŸå€¼çš„æ—¶å€™ï¼Œæ‰åŸå­æ€§çš„å°†å½“å‰å€¼æ¢ä¸ºæ–°å€¼ã€‚å®ƒæ˜¯æ— é”ç¼–ç¨‹çš„åŸºç¡€æ€§æ„é€ 
   3. å’Œå…¶é€»è¾‘ç­‰ä»·çš„synchronizedä»£ç ï¼šä½†æ˜¯CASæŒ‡ä»¤æ›´é«˜æ•ˆä¸”åœ¨å¤§å¤šæ•°JVMä¸Šä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œå› ä¸ºå®ƒæ˜¯åŸºäºå¤„ç†å™¨æŒ‡ä»¤å®ç°çš„
   4. åŸºæœ¬é€»è¾‘æ˜¯åŸºäºè¯»å–çš„å€¼ï¼Œè®¡ç®—å‡ºæ–°å€¼ï¼Œå¦‚æœç°åœ¨å˜é‡è¿˜æ˜¯åˆšæ‰è¯»å–æ—¶åˆ»çš„å€¼ï¼Œè¯æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ”¹å˜è¯¥å˜é‡ã€‚æ‰€ä»¥å¯ä»¥å°†æ–°å€¼å†™å…¥å†…å­˜ã€‚

```
def compareAndSet(ov: Long, nv: Long): Boolean =
  this.synchronized {
    if (this.get != ov) false else {
      this.set(nv)
      true
    }
  }
```

1. ä½¿ç”¨CASæ“ä½œé‡æ–°å®ç°UID
   1. å¦‚æœä¸æ»¡è¶³CASçš„compareæ¡ä»¶ï¼Œå°±ä¼šé€’å½’è°ƒç”¨è¿›è¡Œé‡è¯•ã€‚å¯ä»¥ä½¿ç”¨å°¾é€’å½’ä¼˜åŒ–é˜²æ­¢æ ˆçˆ†ç‚¸ã€‚
   2. å…³äºæ— é™é€’å½’ï¼šä¸å¿…æ‹…å¿ƒï¼Œå› ä¸ºé€’å½’çš„æ¡ä»¶æ˜¯å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†æ“ä½œï¼Œè¿™ä¹Ÿå°±è¯æ˜ç³»ç»Ÿçš„æ•´ä½“æ˜¯å‘å‰è¿›è¡Œçš„ï¼Œå¿…ç„¶ä¸ä¼šæ— é™é€’å½’ã€‚
   3. å¤§éƒ¨åˆ†JDKå®ç°incrementAndGetçš„æ–¹å¼ä¸è¿™é‡ŒåŸºäºCASçš„getUniqueIdçš„å®ç°æ–¹å¼ç±»ä¼¼ã€‚

```
object AtomicVar2 extends App {
  private var uid = new AtomicLong(0L)
  @tailrec def getUniqueId(): Long = {
    val oldUid = uid.get
    val newUid = oldUid + 1
    if (uid.compareAndSet(oldUid, newUid)) newUid
    else getUniqueId()
  }
  for(i<- 0 until 16){
    execute { log(s"Uid asynchronously: ${getUniqueId()}") }
  }
  Thread.sleep(5000)
}
```

#### æ— é”ç¼–ç¨‹

1. ä¼˜ç‚¹

åœ¨æ— é”çš„ç¨‹åºä¸­ï¼Œèµ„æºäº‰ç”¨ä¸å¤ªä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚æ‰§è¡Œæ— é”æ“ä½œçš„çº¿ç¨‹ä¸ä¼šå°è¯•è·å¾—ä»»ä½•é”ã€‚å› è€Œï¼Œå¾ˆå¤šæ— é”ç®—æ³•éƒ½æœ‰æ›´é«˜çš„ååé‡ã€‚æ‰§è¡Œæ— é”ç®—æ³•çš„çº¿ç¨‹å³ä½¿ä»æ“ä½œç³»ç»Ÿå¤„è·å¾—æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿä¸ä¼šå ç”¨ä»»ä½•é”ï¼Œå› è€Œä¸ä¼šé€ æˆå…¶ä»–çº¿ç¨‹çš„ä¸´æ—¶é˜»å¡ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹ä¼šç«‹åˆ»å»é‡è¯•ã€‚

æ— é”ç¼–ç¨‹å’Œæ­»é”æ— ç¼˜

1. å®šä¹‰:å¯¹äºæ‰§è¡Œä¸€ä¸ªæ“ä½œçš„å¤šä¸ªçº¿ç¨‹ï¼Œä¸ç®¡å„çº¿ç¨‹æ‰§è¡Œé€Ÿåº¦å¦‚ä½•ï¼Œå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹æ€»èƒ½åœ¨æœ‰é™æ­¥éª¤å†…å®Œæˆæ­¤æ“ä½œï¼Œé‚£ä¹ˆè¯¥æ“ä½œæ˜¯æ— é”çš„ã€‚è€Œä¸æ˜¯å‡ºç°æ…¢çº¿ç¨‹é˜»å¡å…¶ä»–çº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µã€‚

#### é”çš„å®ç°ä¸å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI

å°†ä½¿ç”¨åŸå­å˜é‡æ¥å®ç°é”ï¼Œå¹¶ä¸”ä¸éœ€è¦é˜»å¡è°ƒç”¨è€…ï¼Œä»è€Œå¯ä»¥è®©çº¿ç¨‹åœ¨æ— æ³•è·å¾—é”çš„æƒ…å†µä¸‹ä¸ç”¨è¢«é˜»å¡ã€‚

å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI

1. éœ€æ±‚ï¼š
   1. å¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆ›å»ºæ–°æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«å¤åˆ¶æˆ–è€…åˆ é™¤
   2. å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¤åˆ¶æ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«åˆ é™¤
   3. å¦‚æœä¸€ä¸ªçº¿ç¨‹æ­£åœ¨åˆ é™¤ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆæ­¤æ–‡ä»¶ä¸èƒ½è¢«å¤åˆ¶
   4. æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åˆ é™¤åŒä¸€ä¸ªæ–‡ä»¶

æ€»ç»“ä¸º:å¢åŠ ï¼Œå¤åˆ¶ï¼Œåˆ é™¤

1. è®¾è®¡å†…å®¹ï¼š
   1. æ–‡ä»¶å’Œç›®å½•å»ºæ¨¡ï¼š
      1. Entryç±»çš„isDirå­—æ®µç”¨äºè¡¨ç¤ºå½“å‰å¯¹è±¡æ˜¯å¦ä¸ºç›®å½•æˆ–æ–‡ä»¶ã€‚
      2. stateå­—æ®µæè¿°äº†æ–‡ä»¶çŠ¶æ€ï¼šæ–‡ä»¶æ˜¯å¦ç©ºé—²(idle)ã€åœ¨åˆ›å»ºä¸­()ã€åœ¨å¤åˆ¶ä¸­æˆ–å°†è¢«åˆ é™¤ã€‚è¿™äº›çŠ¶æ€ç”¨sealedç‰¹è´¨å»ºæ¨¡ï¼Œå‘½åä¸ºState(ä½¿ç”¨å¯†å°ç±»æ–¹ä¾¿æ¨¡å¼åŒ¹é…åˆ°æ‰€æœ‰æƒ…å†µ)
      3. CpoyingçŠ¶æ€ä¸‹çš„å­—æ®µnç”¨æ¥è®°å½•ç›®å‰æœ‰å¤šå°‘ä¸ªå¤åˆ¶æ“ä½œ

```
sealed trait State
class Idle extends State
class Creating extends State
class Copying(val n:Int) extends State
class Deleting extends State
//å¯¹å•ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œå»ºæ¨¡
class Entry(val isDir:Boolean){
  val state = new AtomicReference[State]()
}
```

1. çŠ¶æ€è½¬ç§»å›¾ï¼š

![image.png](assets/çŠ¶æ€è½¬ç§»ç¤ºæ„å›¾.png)

1. ä»£ç å®ç°ï¼š

```
  private def prepareForDelete(entry: Entry):Boolean = {
    /*
    1.å¦‚æœstateæ˜¯Idleï¼Œåˆ™compareAndSetæˆåŠŸï¼Œè¿”å›true
    2.è¯¥æ–¹æ³•è¿”å›çš„true,åˆ™è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹å¯ä»¥è¿›è¡Œæ–‡ä»¶çš„åˆ é™¤
     */
    val s0 = entry.state.get
    s0 match {
      case i:Idle => if(entry.state.compareAndSet(i,new Deleting)) true else prepareForDelete(entry)
      case c:Creating => log("Cannot delete while creating");false
      case c:Copying => log("Cannot delete while copying");false
      case d:Deleting => false
    }
  }
```

1. åœ¨åŸå­æ€§å¼•ç”¨å˜é‡ä¸Šçš„CASæŒ‡ä»¤æ€»æ˜¯ä½¿ç”¨å¼•ç”¨çš„ç­‰ä»·æ€§ï¼Œè€Œä¸ä¼šè°ƒç”¨equalsæ–¹æ³•ï¼Œå³ä½¿equalsæ–¹æ³•é‡è½½äº†ä¹Ÿä¸è¡Œã€‚
2. ABAé—®é¢˜ï¼š

   1. å®šä¹‰ï¼šABAé—®é¢˜æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°çš„ä¸€ç§å†…å­˜è¯»å†™é€»è¾‘é—®é¢˜ã€‚å½“å¯¹åŒä¸€å†…å­˜åŒºåŸŸè¿›è¡Œä¸¤æ¬¡è¯»æ“ä½œæ—¶ï¼Œè‹¥å¾—åˆ°ç›¸åŒçš„Aå€¼ï¼Œä¸€èˆ¬ä¼šå‡è®¾ä¸¤æ¬¡è¯»æ“ä½œä¹‹é—´æ­¤å†…å­˜åŒºåŸŸæ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚ä½†è¿™ä¸€ç»“è®ºä¸ä¸€å®šå¯é ï¼Œå› ä¸ºåœ¨ä¸¤æ¬¡è¯»æ“ä½œä¹‹é—´æœ‰å¯èƒ½å‘ç”Ÿäº†å…ˆå†™å…¥Bå€¼ååˆæ¢å¤ä¸ºAå€¼çš„æƒ…å†µï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ABAé—®é¢˜ï¼Œ
      1. è®¾ç½®æ–‡ä»¶çš„copyçŠ¶æ€çš„è½¬æ¢çš„æ—¶å€™ï¼Œå¦‚æœæ¯æ¬¡å‡å°ä¸€ä¸ªcopyçº¿ç¨‹çš„æ—¶å€™ï¼Œä¿ç•™åŸæ¥çš„copyå¯¹è±¡ã€‚ç”¨æ¥åœ¨å¢åŠ copyçš„æ—¶å€™å¤ç”¨ï¼Œè¿™æ ·åšçš„æœ¬æ„æ˜¯é€šè¿‡å‡å°‘ç”Ÿæˆæ–°çš„ Copying å¯¹è±¡æ¥å‡å°åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œç„¶è€Œï¼Œè¿™ç§åšæ³•ä¼šäº§ç”Ÿä¹‹å‰æåˆ°çš„ABAé—®é¢˜ã€‚

```
 def releaseCopy(e: Entry): Copying = e.state.get match {
    case c: Copying =>
      val nstate = if (c.n == 1) new Idle else new Copying(c.n - 1)
      if (e.state.compareAndSet(c, nstate)) c
      else releaseCopy(e)
  }
  def acquireCopy(e: Entry, c: Copying) = e.state.get match {
    case i: Idle => {
      c.n = 1
      if (!e.state.compareAndSet(i, c)) acquire(e, c)
     }
    case oc: Copying => {
      c.n = oc.n + 1
      if (!e.state.compareAndSet(oc, c)) acquire(e, c)
    }
  }
```

![image.png](assets/casç¤ºæ„å›¾.png)

1. è§£å†³åŠæ³•ï¼š
   1. åªèƒ½å…·ä½“é—®é¢˜ï¼Œå…·ä½“åˆ†æã€‚æ­¤å¤„æ˜¯Atomicå¯¹è±¡ä¸­ä¿å­˜çš„æ˜¯copyä½œä¸ºäº†å¯å˜å¯¹è±¡(æœ¬æ¥nåº”è¯¥è®¾ç½®ä¸ºvalç±»å‹)ã€‚
   2. JVMä¸Šçš„å¸¸è§„åšæ³•ï¼š
      1. ç”Ÿæˆæ–°çš„å¯¹è±¡ï¼Œç„¶åå°†å®ƒä»¬èµ‹å€¼ç»™AtomicReferenceå¯¹è±¡
      2. åœ¨AtomicReferenceå¯¹è±¡å†…ä¿å­˜ä¸å¯å˜å¯¹è±¡
      3. é¿å…å°†ä¹‹å‰å·²ç»èµ‹å€¼ç»™åŸå­æ€§å˜é‡çš„å€¼è¢«é‡æ–°èµ‹å€¼ã€‚
      4. åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œå•è°ƒé€’å¢æ•°å€¼å‹åŸå­æ€§å˜é‡ï¼Œå³è¦ä¹ˆä¸¥æ ¼é€’å‡ï¼Œè¦ä¹ˆä¸¥æ ¼é€’å¢

### 3.3æ‡’å€¼

å¹¶å‘ç¨‹åºä¸­çš„æ‡’å€¼ä¼šäº§ç”Ÿæ„æ–™å¤–çš„è¡Œä¸ºï¼Œå¤šçº¿ç¨‹ç¨‹åºä¸­çš„æ‡’å€¼å¿…é¡»ä¿æŒç›¸åŒçš„è¯­ä¹‰ï¼›æ‡’å€¼åªæœ‰åœ¨è¢«æŸä¸ªçº¿ç¨‹è®¿é—®æ—¶æ‰ä¼šåˆå§‹åŒ–ï¼Œè€Œä¸”è‡³å¤šåˆå§‹åŒ–ä¸€æ¬¡ã€‚

scalaä½¿ç”¨åŒæ£€æŸ¥é”æœºåˆ¶ï¼Œä¿è¯æ‡’å€¼åœ¨è¢«çº¿ç¨‹è®¿é—®æ—¶æœ€å¤šè¢«åˆå§‹åŒ–ä¸€æ¬¡

ç»å¯¹ä¸è¦åœ¨å…¬å…±å¯¹è±¡ä¸Šä½¿ç”¨synchronizedè¯­å¥ï¼›åšæŒåœ¨ç‹¬ç«‹ä¸”ç§æœ‰çš„ç®€å•å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥æ“ä½œã€‚

```
object LazyValsCreate extends App {
  lazy val obj = new AnyRef
  lazy val non = s"made by ${Thread.currentThread.getName}"
  execute {
    log(s"EC sees obj = $obj")
    log(s"EC sees non = $non")
  }
  log(s"Main sees obj = $obj")
  log(s"Main sees non = $non")
  Thread.sleep(500)
}
```

### 3.4 å¹¶å‘å®¹å™¨

scalaçš„æ ‡å‡†å®¹å™¨çš„å®ç°æ²¡æœ‰ä½¿ç”¨çº¿ç¨‹é”ï¼ŒåŒæ—¶å¯å˜å®¹å™¨èƒŒåçš„æ•°æ®ç»“æ„å¯èƒ½éå¸¸å¤æ‚

#### å¹¶å‘æ–¹æ¡ˆ

```
//é”™è¯¯ç¤ºä¾‹ï¼šç›´æ¥å¤šçº¿ç¨‹è®¿é—®å¯å˜å®¹å™¨ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨åŒæ­¥æœºåˆ¶
import scala.collection._
object CollectionsBad extends App {
  val buffer = mutable.ArrayBuffer[Int]()
  def asyncAdd(numbers: Seq[Int]) = execute {
    buffer ++= numbers
    log(s"buffer = $buffer")
  }
  asyncAdd(0 until 10)
  asyncAdd(10 until 20)
  Thread.sleep(500)
}
```

* æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸å¯å˜å®¹å™¨
  * æ€è·¯ï¼šå°†ä¸å¯å˜å®¹å™¨ä¸åŸå­å˜é‡çš„CASæ“ä½œç›¸ç»“åˆã€‚ä½†æ˜¯å¦‚æœå¤ªå¤šçº¿ç¨‹è®¿é—®åŸå­å˜é‡ï¼Œå¯èƒ½æœ‰å¯æ‰©å±•æ€§é—®é¢˜ã€‚

```
class AtomicBuffer[T] {
  private val buffer = new AtomicReference[List[T]](Nil)
  def preappend(x: T): Unit = {
    val xs = buffer.get
    val nxs = x::xs
    if(!buffer.compareAndSet(xs,nxs)) preappend(x) // tail-recursive
  }
}
```

* æ–¹æ¡ˆ2ï¼šä½¿ç”¨å¯å˜å®¹å™¨
  * æ€è·¯ï¼šå¿…é¡»å°†ç›¸å…³æ“ä½œæ”¾å…¥synchronizedè¯­å¥ä¸­

```
def asyncAdd(numbers: Seq[Int]) = execute {
  buffer.synchronized {
    buffer ++= numbers
    log(s"buffer = $buffer")
  }
}
```

#### å¹¶å‘é˜Ÿåˆ—å’Œå¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI

1. æ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼

å¹¶å‘ç¼–ç¨‹ä¸­é‡‡ç”¨çš„ä¸€ç§å¸¸è§æ¨¡å¼æ˜¯ç”Ÿäº§è€…â€”æ¶ˆè´¹è€…æ¨¡å¼ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œä¸åŒéƒ¨åˆ†çš„è®¡ç®—ä»»åŠ¡çš„è´£ä»»è¢«åˆ’åˆ†ç»™ä¸åŒçš„çº¿ç¨‹ã€‚æ¯”å¦‚ï¼Œåœ¨FTPæœåŠ¡å™¨ä¸­ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è´Ÿè´£ä»ç£ç›˜ä¸Šè¯»å–å¤§æ–‡ä»¶çš„æ•°æ®å—ã€‚è¿™äº›çº¿ç¨‹è¢«ç§°ä¸ºç”Ÿäº§è€…ã€‚å¦å¤–ä¸€äº›çº¿ç¨‹åˆ™è´Ÿè´£å°†æ•°æ®å—å‘é€åˆ°ç½‘ç»œä¸­ï¼Œè¿™ç±»çº¿ç¨‹ç§°ä¸ºæ¶ˆè´¹è€…ã€‚

1. å¹¶å‘é˜Ÿåˆ—çš„ä¸‰ç§æ“ä½œï¼š
   1. ç”Ÿäº§è€…å‘é˜Ÿåˆ—åŠ å…¥å·¥ä½œè¦ç´ çš„enqueueæ“ä½œ
   2. æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·¥ä½œè¦ç´ çš„dequeueæ“ä½œ
   3. inspectæ“ä½œï¼šç”¨äºæ¢æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œå¹¶æ£€æŸ¥ä¸‹ä¸€ä¸ªå…ƒç´ çš„å€¼
   4. å¹¶å‘é˜Ÿåˆ—å¯ä»¥æœ‰ç•Œï¼Œå¯ä»¥æ— ç•Œã€‚ä¸åŒçš„å¹¶å‘é˜Ÿåˆ—çš„ä¸»è¦åŒºåˆ«æ˜¯å¯¹äºé˜Ÿåˆ—æ»¡ä»¥åŠé˜Ÿåˆ—ç©ºçš„æ“ä½œä¸åŒï¼Œå¯ä»¥ä½¿ç”¨é˜»å¡å¼ï¼Œæ¯”å¦‚JDKåœ¨java.util.concurrentåŒ…ä¸­æä¾›äº†BlockingQueueã€‚scalaçš„é˜»å¡å¼å¹¶å‘é˜Ÿåˆ—åœ¨scala.concurrentåŒ…ä¸‹ã€‚

![image.png](assets/queue-api.png)

1. å…·ä½“å®ç°ç±»ï¼š
   1. ArrayBlockingQueue ç±»æ˜¯ä¸€ç§æœ‰ç•Œé˜»å¡é˜Ÿåˆ—çš„å…·ä½“å®ç°ã€‚åœ¨åˆ›å»ºçš„æ—¶å€™éœ€è¦æŒ‡å®šå¤§å°ã€‚å¦‚æœç”Ÿäº§è€…æ½œåœ¨çš„ç”Ÿäº§é€Ÿåº¦è¶…è¿‡äº†æ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ï¼Œåˆ™éœ€è¦ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚å¦åˆ™ï¼Œé˜Ÿåˆ—ä¼šä¸æ–­å¢å¤§ï¼Œä»¥è‡³äºè€—å°½æ‰€æœ‰ç³»ç»Ÿå†…å­˜ã€‚
   2. LinkedBlockingQueueæ˜¯æ— ç•Œçš„ã€‚å…¶åº”ç”¨äºæ¶ˆè´¹è€…æ€»æ˜¯æ¯”ç”Ÿäº§è€…æ•ˆç‡æ›´é«˜çš„æƒ…å†µã€‚
2. å¹¶å‘å®¹å™¨çš„è¿­ä»£å™¨éƒ½åªæ˜¯è®°å½•æŸä¸€æ—¶åˆ»çš„çŠ¶æ€ã€‚
3. å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPIçš„è¿›ä¸€æ­¥å®ç°
4. å¯¹äºå¹¶å‘FS çš„APIå‘å‡ºçš„å„ç§æ¶ˆæ¯ï¼Œä½¿ç”¨LInkedBlockingQueueè¿›è¡Œç¼“å­˜ã€‚è¯¥å¹¶å‘é˜Ÿåˆ—æ˜¯é˜»å¡æ–¹å¼çš„ã€‚

```
//ç¼“å­˜é˜Ÿåˆ—
private val messages = new LinkedBlockingQueue[String]
//ç‹¬ç«‹çš„å®ˆæŠ¤è¿›ç¨‹
val logger = new Thread {
  setDaemon(true)
  override def run() = while (true) log(messages.take())
}
logger.start()
def logMessage(msg: String): Unit = messages.offer(msg)
```

#### å¹¶å‘æ˜ å°„ ä»¥åŠå¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI

ä¸å¹¶å‘é˜Ÿåˆ—ä¸åŒï¼Œå› ä¸ºå¹¶å‘é˜Ÿåˆ—ä¸»è¦ç”¨äºæ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼ï¼Œä½†æ˜¯å¹¶å‘é›†åˆä¸æ˜ å°„ä¸»è¦ç”¨äºç¨‹åºçš„çŠ¶æ€ç¼–ç ã€‚æ‰€ä»¥å¹¶å‘é›†åˆä»¥åŠæ˜ å°„å¹¶æ²¡æœ‰é˜»å¡çš„ç‰ˆæœ¬ã€‚

å¹¶å‘æ–‡ä»¶ç³»ç»Ÿè¿›ä¸€æ­¥è®¾è®¡

* å°†java.util.concurrentåŒ…ä¸‹çš„å¹¶å‘æ˜ å°„é€šè¿‡asScalaæ–¹æ³•è½¬æ¢ä¸ºscalaé›†åˆæ¡†æ¶
* é€šè¿‡ä½¿ç”¨Mapç»“æ„å°†æ–‡ä»¶è·¯å¾„ä¸æ–‡ä»¶å¯¹è±¡å¯¹åº”
* ä½¿ç”¨org.apache.commons.io.FileUtilså·¥å…·ç±»æ¥å¯¹æ–‡ä»¶è¿›è¡Œè¿­ä»£ï¼Œæ–¹å¼æ˜¯éé€’å½’

```
import scala.collection.convert.decorateAsScala._
import java.io.File
import org.apache.commons.io.FileUtils
class FileSystem(val root: String) {
  val rootDir = new File(root)
  val files: concurrent.Map[String, Entry] =
    new ConcurrentHashMap().asScala
  for (f <- FileUtils.iterateFiles(rootDir, null, false).asScala)
  files.put(f.getName, new Entry(false))
}
```

å¹¶å‘æ˜ å°„çš„API

![image.png](assets/con-map-api.png)

å¹¶å‘æ–‡ä»¶ç³»ç»Ÿçš„copyçŠ¶æ€å˜åŒ–ä»¥åŠæ“ä½œ

å‰ç½®æ“ä½œï¼š

* copyæ“ä½œä»…ä»…å‘ç”Ÿåœ¨æ–‡ä»¶å¤„äº Idle æˆ– CopyingçŠ¶æ€æ—¶ï¼Œç„¶åè¿˜éœ€è¦åŸå­æ€§åœ°å°†æ–‡ä»¶çŠ¶æ€ä»Idleå˜æˆCopyingï¼Œæˆ–å°†Copyingå˜æˆå¦ä¸€ç§CopyingçŠ¶æ€ï¼Œå¹¶å°†né€’å¢ã€‚
* releaseæ“ä½œï¼Œå®ƒå°†é€’å‡CopyingçŠ¶æ€çš„è®¡æ•°ï¼Œæˆ–å°†CopyingçŠ¶æ€ä¿®æ”¹ä¸ºIdleçŠ¶æ€ã€‚æ³¨æ„ï¼Œæ­¤æ–¹æ³•å¿…é¡»åœ¨æ–‡ä»¶åˆ›å»ºä¹‹åè°ƒç”¨ï¼Œä»¥ä¾¿å°†CreatingçŠ¶æ€åˆ‡æ¢è‡³IdleçŠ¶æ€ã€‚

copyFileæ–¹æ³•å®ç°ï¼š

* æç«¯æ­¤æ–¹æ³•ä¼šå…ˆæ£€æŸ¥filesæ˜ å°„ä¸­æ˜¯å¦å­˜åœ¨srcé¡¹ï¼Œå¦‚æœå­˜åœ¨ï¼ŒcopyFileä¼šå¯åŠ¨ä¸€ä¸ªå¹¶å‘ä»»åŠ¡æ¥å¤åˆ¶æ–‡ä»¶ã€‚
* æ­¤å¹¶å‘ä»»åŠ¡å°è¯•è·å¾—æ­¤æ–‡ä»¶çš„æ§åˆ¶æƒï¼Œå¤åˆ¶æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå¤„äº Creating çŠ¶æ€çš„æ–°çš„destEntryæ–‡ä»¶é¡¹ã€‚
* ç„¶åè°ƒç”¨putIfAbsentæ–¹æ³•ï¼Œå®ƒä¼šåŸå­æ€§åœ°æ£€æŸ¥ç›®æ ‡æ–‡ä»¶è·¯å¾„æ˜¯å¦ä½äºæ˜ å°„ä¸­ã€‚å¦‚æœä¸åœ¨ï¼Œåˆ™æ·»åŠ (dest,destEntry)ã€‚
* æ­¤æ—¶ï¼ŒsrcEntry å’ŒdestEntryè¿™ä¸¤é¡¹éƒ½å¤„äºé”å®šçŠ¶æ€ï¼Œæ‰€ä»¥CommonsIOåº“ä¸­çš„FileUtils.copyFileå¯ç”¨äºè¿›è¡Œç£ç›˜ä¸Šçš„å¤åˆ¶æ“ä½œã€‚ä¸€æ—¦å¤åˆ¶å®Œæˆï¼ŒsrcEntryå’ŒdestEntryéƒ½ä¼šè¢«é‡Šæ”¾ã€‚

```
  //copyFileçš„å‡†å¤‡1
  @tailrec private def acquire(entry: Entry): Boolean = {
    val s0 = entry.state.get
    s0 match {
      case _: Creating | _: Deleting => {
        logMessage("File inaccessible, cannot copy.")
        false
      }
      case i: Idle => {
        if (entry.state.compareAndSet(s0, new Copying(1))) true else acquire(entry)
      }
      case c: Copying => {
        if (entry.state.compareAndSet(s0, new Copying(c.n + 1))) true else acquire(entry)
      }
    }
  }

  //copyFileçš„å‡†å¤‡2
  @tailrec private def release(entry: Entry): Unit = {
    val s0 = entry.state.get
    s0 match {
      case _: Creating => {
        if (!entry.state.compareAndSet(s0, new Idle)) release(entry)
      }
      case c: Copying => {
        val nstate = if (c.n == 1) new Idle else new Copying(c.n - 1)
        if (!entry.state.compareAndSet(s0, nstate)) release(entry)
      }
    }
  }

  //copyFile
  def copyFile(src: String, dest: String): Unit = {
    files.get(src) match {
      case None => logMessage(s"Path '$src' does not exist!")
      case Some(srcEntry) => {
        if (!srcEntry.isDir) {
          //åˆ›å»ºæ–°çš„å¤åˆ¶æ–‡ä»¶çº¿ç¨‹
          execute {
            if (acquire(srcEntry)) try {
              val destEntry = new Entry(isDir = false)
              //çŠ¶æ€æ˜¯æ­£åœ¨è¢«å¤åˆ¶ç”Ÿæˆ
              destEntry.state.set(new Creating)
              //è¿™é‡Œä½¿ç”¨çš„æ˜¯åŸå­æ“ä½œputIfAbsentï¼Œæ˜¯å°‘æœ‰çš„å¤æ‚çº¿æ€§åŒ–æ“ä½œ
              files.putIfAbsent(dest, destEntry) match {
                case None => {
                  try {
                    FileUtils.copyFile(new File(src), new File(dest))
                  } finally release(destEntry)
                }
                case _ => logMessage("File already exists!")
              }
            } finally release(srcEntry)
          }
        }
      }
    }
  }
```

#### å¹¶å‘é›†åˆ

Set[T]ç±»å‹çš„å¹¶å‘é›†åˆå¯ç”¨ConcurrentMap[T,Unit]ç±»å‹æ¥æ¨¡æ‹Ÿï¼Œä¿ç•™é”®è€Œå¿½ç•¥å€¼å³å¯ã€‚è¿™ä¹Ÿæ˜¯å¹¶å‘æ¡†æ¶ä¸­è¾ƒå°‘å‡ºç°å¹¶å‘é›†åˆçš„å®ç°çš„åŸå› ã€‚

æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»å¯¹ä¸è¦ä½¿ç”¨nullä½œä¸ºå¹¶å‘æ˜ å°„/é›†åˆä¸­çš„é”®æˆ–å€¼ã€‚å¾ˆå¤šJVMä¸Šå®ç°çš„å¹¶å‘æ•°æ®ç»“æ„å°†nullè§†ä¸ºä¸€ç§ç‰¹æ®Šæ ‡è¯†ç¬¦ï¼Œç”¨æ¥è¡¨ç¤ºå…ƒç´ ä¸å­˜åœ¨ã€‚

#### å¹¶å‘éå†(é›†åˆ) ä¸å¹¶å‘æ–‡ä»¶ç³»ç»ŸAPI

1. Scala åœ¨å¹¶å‘å®¹å™¨çš„è®¿é—®ä¸Šæœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚scala.collection. concurrentåŒ…ä¸­çš„TrieMapå®¹å™¨åŸºäºå¹¶å‘çš„Trieæ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ç§å¹¶å‘çš„æ˜ å°„æ•°æ®ç»“æ„ï¼Œå¯ä»¥äº§ç”Ÿå…·æœ‰ä¸€è‡´æ€§çš„éå†å™¨ã€‚

å½“å…¶iteratoræ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒTrieMapå®¹å™¨ä¼šåŸå­æ€§åœ°å¯¹æ‰€æœ‰å…ƒç´ å®ç°ä¸€ä¸ªå¿«ç…§ã€‚å¿«ç…§æŒ‡çš„æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„çš„çŠ¶æ€çš„å®Œæ•´ä¿¡æ¯ã€‚ç„¶åï¼Œéå†å™¨ä½¿ç”¨è¿™ä¸ªå¿«ç…§æ¥éå†å…ƒç´ ã€‚å¦‚æœ TrieMap å®¹å™¨ä¹‹åè¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ­¤æ”¹åŠ¨åœ¨ä¹‹å‰çš„å¿«ç…§ä¸­æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤å¿«ç…§å’Œéå†å™¨å¹¶æ²¡æœ‰å‘ç°è¿™ä¸ªæ”¹åŠ¨

å®ƒå¯ç¡®ä¿åªå¤åˆ¶é‚£äº›è¢«ä¿®æ”¹çš„éƒ¨åˆ†ã€‚å¦‚æœæ²¡æœ‰å†å‘ç”Ÿå¹¶å‘çš„ä¿®æ”¹ï¼Œåˆ™TrieMapå®¹å™¨ä¹Ÿä¸å†éœ€è¦è¿›è¡Œå¤åˆ¶ã€‚

1. ä½œç”¨ï¼š
   * æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­éœ€è¦è·å¾—ä¸€ä¸ªä¸€è‡´æ€§çš„å¿«ç…§ï¼ŒåŒ…å«æŸä¸€æ—¶åˆ»æ–‡ä»¶ç®¡ç†å™¨æˆ– FTP æœåŠ¡å™¨çœ‹åˆ°çš„æ‰€æœ‰æ–‡ä»¶ã€‚
   * TrieMap å®¹å™¨å¯ä¿è¯åˆ é™¤æˆ–å¤åˆ¶æ–‡ä»¶çš„çº¿ç¨‹ä¸ä¼šå¹²æ¶‰æå–æ–‡ä»¶çš„çº¿ç¨‹
   * å¯ç”¨TrieMapå®¹å™¨å­˜å‚¨æ–‡ä»¶ï¼Œç„¶åï¼Œå®šä¹‰ä¸€ä¸ªç®€å•çš„allFilesæ–¹æ³•ï¼Œç”¨äºè¿”å›æ‰€æœ‰æ–‡ä»¶ã€‚åœ¨foræ¨å¯¼å¼ä¸­çš„filesæ˜ å°„ä¼šäº§ç”Ÿä¸€ä¸ªå¿«ç…§ï¼Œé‡Œé¢åŒ…å«äº†æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚

å¦‚æœåº”ç”¨ç¨‹åºéœ€è¦ä¸€è‡´æ€§éå†å™¨ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ TrieMap å®¹å™¨ã€‚

ä½†å¦‚æœä¸€è‡´æ€§éå†å™¨ä¸æ˜¯å¿…éœ€çš„ï¼Œå¹¶ä¸”å®¹å™¨æå°‘å‘ç”Ÿä¿®æ”¹ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨ConcurrentHashMapå®¹å™¨ï¼Œå› ä¸ºå®ƒçš„æŸ¥è¯¢æ“ä½œé€Ÿåº¦è¦ç¨å¾®å¿«ä¸€äº›ã€‚

### 3.5 å®šåˆ¶å¹¶å‘æ•°æ®ç»“æ„

#### å®ç°ä¸€ä¸ªæ— é”çš„å¹¶å‘æ± 

1. åŠŸèƒ½ï¼šæ± æ˜¯ä¸€ç§ç®€å•çš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œå®ƒåªæœ‰ä¸¤ä¸ªæ“ä½œï¼Œå³addå’Œremoveæ“ä½œã€‚å…¶ä¸­addå°±æ˜¯æ± ä¸­æ·»åŠ ä¸€ä¸ªå…ƒç´ ã€‚æ± ä¸Šçš„removeæ“ä½œé™åˆ¶æ›´å¤šã€‚removeå¹¶ä¸æ˜¯ä»æ± ä¸­åˆ é™¤ä¸€ä¸ªå…·ä½“çš„å…ƒç´ ï¼Œè€Œæ˜¯åœ¨æ± éç©ºæ—¶åˆ é™¤ä»»æ„å…ƒç´ ã€‚é¡¾åæ€ä¹‰ï¼Œæ— é”çš„æ± æŒ‡çš„æ˜¯æ“ä½œä¸ç”¨ä¸Šé”çš„æ± ã€‚
2. ä½¿ç”¨åœºæ™¯ï¼šå› ä¸ºå®ƒå¯ç”¨äºä¸´æ—¶å­˜å‚¨ä¸€äº›é‡æ–°åˆ›å»ºä»£ä»·å¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚å·¥ä½œçº¿ç¨‹æˆ–æ•°æ®åº“è¿æ¥ã€‚å¯¹äºè¿™äº›åº”ç”¨åœºæ™¯ï¼Œç”¨æˆ·å¹¶ä¸å…³å¿ƒremoveåˆ é™¤çš„æ˜¯å“ªä¸ªå…ƒç´ ï¼Œåªè¦è¿”å›æŸä¸ªå…ƒç´ å³å¯ã€‚
3. æ•°æ®ç»“æ„çš„è¡¨è¾¾æ–¹å¼ï¼š

   1. ä½¿ç”¨ä¸€ä¸ªä¸å¯å˜é“¾è¡¨è¿›è¡Œç»´æŠ¤
      * å› ä¸ºè¦æ±‚æ¯ä¸ªæ“ä½œéƒ½æ˜¯æ— é”çš„ï¼Œæ‰€ä»¥ä½¿ç”¨CASè¿›è¡Œè®¾è®¡ã€‚å°†çŠ¶æ€ç¼–ç ä¸ºä¸€ä¸ªAtomicReferenceå¯¹è±¡ï¼Œç”¨å®ƒæ¥ä¿å­˜ä¸€ä¸ªä¸å¯å˜é“¾è¡¨çš„æŒ‡é’ˆã€‚
      * ä½¿ç”¨addæ–¹æ³•ï¼Œå°±æ˜¯å…ˆè¯»å–æ—§é“¾è¡¨ï¼Œåœ¨é“¾è¡¨å¤´éƒ¨æ·»åŠ å…ƒç´ ï¼Œè§¦å‘CASæ“ä½œï¼ŒåŒäºæ›¿æ¢æ—§é“¾è¡¨ï¼Œå¤±è´¥åˆ™è¿›è¡Œé‡è¯•ã€‚
      * removeæ–¹æ³•è¿‡ç¨‹ä¸addç±»ä¼¼ã€‚
      * ç¼ºç‚¹ï¼šè¿™ç§å®ç°æ–¹å¼çš„å¯æ‰©å±•æ€§å¹¶ä¸å¥½ã€‚å¤šä¸ªå¤„ç†å™¨éœ€è¦è®¿é—®åŒä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œä»è€Œä¼šå¯¼è‡´é‡è¯•è¿‡äºé¢‘ç¹ã€‚é¢„æœŸçš„æ“ä½œæ—¶é—´æ˜¯O(P)ï¼Œå…¶ä¸­ Pä¸ºå¹¶å‘æ‰§è¡Œaddå’Œremoveæ“ä½œçš„å¤„ç†å™¨æ•°ç›®
   2. ä½¿ç”¨å¤šä¸ªä¸å¯å˜é“¾è¡¨è¿›è¡Œç»´æŠ¤

   * éœ€è¦ä¸åŒçš„å¤„ç†å™¨æ›´æ–°æ•°æ®çš„æ—¶å€™è®¿é—®ä¸åŒçš„å†…å­˜ä½ç½®ã€‚
   * removeæ“ä½œå¹¶ä¸éœ€è¦æœç´¢å“ªä¸ªå…·ä½“çš„å…ƒç´ ï¼Œå®ƒåªè¦èƒ½è¿”å›ä»»æ„ä¸€ä¸ªå…ƒç´ å³å¯ã€‚è€Œadd æ“ä½œå¯ä»¥å°†å…ƒç´ æ·»åŠ åˆ°æ­¤æ•°æ®ç»“æ„ä¸­çš„ä»»æ„ä½ç½®
   * å†…éƒ¨æ•°æ®è¡¨ç¤ºå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŸå­æ€§å¼•ç”¨çš„æ•°ç»„ï¼Œæ¯ä¸ªå¼•ç”¨æŒ‡å‘ä¸€ä¸ªä¸å¯å˜é“¾è¡¨ã€‚å› æ­¤ï¼Œä¸åŒçš„å¤„ç†å™¨å¯ä»¥åœ¨å¤šä¸ªåŸå­æ€§å¼•ç”¨ä¸­ä»»é€‰ä¸€ä¸ªè¿›è¡Œæ›´æ–°ã€‚
4. ä»£ç å®ç°
5. å­˜å‚¨éƒ¨åˆ†

```
  val parallelism = Runtime.getRuntime.availableProcessors * 32
  val buckets = new Array[AtomicReference[(List[T],Long)]](parallelism)
  for(i<-buckets.indices){
    //æ¯ä¸ªåŸå­å¼•ç”¨ä¸ä»…ä¿å­˜äº†ä¸€ä¸ªé“¾è¡¨ï¼Œè¿˜ä¿å­˜äº†ä¸€ä¸ªå”¯ä¸€çš„æ—¶é—´æˆ³ï¼Œæ¯æ¬¡æ›´æ–°çš„æ—¶å€™ä¼šé€’å¢
    buckets(i) = new AtomicReference((Nil,0L))
  }
```

1. addæ–¹æ³•

addæ“ä½œå¿…é¡»åœ¨æ•°ç»„ä¸­é€‰ä¸€ä¸ªåŸå­æ€§å¼•ç”¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„é“¾è¡¨ï¼Œç”¨äºåŒ…å«æ–°å…ƒç´ ï¼Œç„¶åè§¦å‘CASæŒ‡ä»¤ï¼Œç›´åˆ°ç›¸åº”çš„åŸå­æ€§å¼•ç”¨è¢«æ›´æ–°ã€‚é€‰æ‹©æ•°ç»„ä¸­çš„æŸä¸€é¡¹æ—¶ï¼Œå½“å‰å¤„ç†å™¨å¿…é¡»ç¡®ä¿æ²¡æœ‰å…¶ä»–å¤„ç†å™¨åœ¨å ç”¨å®ƒï¼Œä»¥é¿å…ç«äº‰å’Œé‡è¯•ã€‚

ä½¿ç”¨IDå’Œå…ƒç´ çš„hashcodeå€¼è¿›è¡Œå¼‚æˆ–ï¼Œè®¡ç®—å‡ºæ•°ç»„ç´¢å¼•ã€‚å¯ä»¥è¾ƒå¤§ç¨‹åº¦ä¿è¯åˆ†å¸ƒåˆ†æ•£ï¼Œå‡å°‘å“ˆå¸Œå†²çªã€‚

```
  def add(x:T):Unit = {
    //éšæœºå¢åŠ ä¸€ä¸ªä½ç½®ï¼ŒCASé‡è¯•çš„æ¦‚ç‡æ¯”è¾ƒå°
    val i = ((Thread.currentThread.getId ^ x.##) % buckets.length).toInt
    @tailrec def retry():Unit = {
      val bucket = buckets(i)
      val v  = bucket.get
      val nv = (x::v._1,v._2+1)
      if(!bucket.compareAndSet(v,nv)) retry()
    }
    retry()
  }
```

1. removeæ–¹æ³•

ä¸èƒ½ä½¿ç”¨ä¸€æ¬¡æ‰«æçš„æ–¹å¼ï¼Œå› ä¸ºå¹¶å‘æƒ…å†µä¸‹å¯èƒ½åˆšæ‰ä¸ºç©ºçš„é¡¹ä¸‹ä¸€æ—¶åˆ»å°±æœ‰å…ƒç´ ã€‚æç«¯æƒ…å†µä¸‹é€ æˆçš„æ˜¯æ‰«æä¸€éï¼Œè®¤ä¸ºä¸ºç©ºï¼Œä½†æ˜¯å®é™…ä¸Šå…¨éƒ¨éƒ½æœ‰å…ƒç´ ã€‚

å¯ä»¥ä½¿ç”¨æ—¶é—´æˆ³ï¼Œæ—¶é—´æˆ³ä¸å˜å°±è¯æ˜æ²¡æœ‰è¢«æ“ä½œã€‚æ‰«æä¸¤è¾¹æ£€æŸ¥æ—¶é—´æˆ³ä¹‹å’Œï¼Œæ¥ç¡®å®šç»ˆæ­¢ä¿¡æ¯ã€‚

```
    def remove(): Option[T] = {
      val start =
        (Thread.currentThread.getId % buckets.length).toInt
      @tailrec def scan(witness: Long): Option[T] = {
        var i = (start + 1) % buckets.length
        var sum = 0L
        while (i != start) {
          val bucket = buckets(i)
          @tailrec def retry(): Option[T] = {
            bucket.get match {
              case (Nil, stamp) =>
                sum += stamp
                None
              case v @ (lst, stamp) =>
                val nv = (lst.tail, stamp + 1)
                if (bucket.compareAndSet(v, nv)) Some(lst.head)
                else retry()
            }
          }
          retry() match {
            case Some(v) => return Some(v)
            case None =>
          }
          i = (i + 1) % buckets.length
        }
        if (sum == witness) None
        else scan(sum)
      }
      scan(-1L)
    }
```

#### è¿›ç¨‹çš„åˆ›å»ºå’Œå¤„ç†

åªè¦æœºå™¨å†…å­˜è¶³å¤Ÿå¤šï¼Œç‹¬ç«‹è¿›ç¨‹ä¸­çš„åƒåœ¾å›æ”¶æˆ–å³æ—¶ç¼–è¯‘ï¼ˆjust-in-time compilationï¼‰å°±åº”è¯¥ä¸ä¼šå½±å“è¿›ç¨‹çš„è¿è¡Œã€‚

scala.sys.processåŒ…ä¸­åŒ…å«å¤„ç†å…¶ä»–è¿›ç¨‹çš„ä¸€å¥—ç²¾ç®€APIã€‚ç”¨æˆ·å¯ä»¥åŒæ­¥è¿è¡Œå­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ä¸­è¿è¡Œå­è¿›ç¨‹çš„é‚£ä¸ªçº¿ç¨‹ä¼šç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚ä¹Ÿå¯ä»¥å¼‚æ­¥ï¼Œå³å­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹ä¸­çš„è°ƒç”¨çº¿ç¨‹å¹¶å‘è¿è¡Œã€‚

## 4.åŸºäºFutureå’ŒPromiseçš„å¼‚æ­¥ç¼–ç¨‹

### 4.1 Future

#### åŸºæœ¬æ¦‚å¿µ

1. é˜»å¡çº¿ç¨‹çš„åŸå› ï¼š
   1. èµ„æºæ˜¯æœ‰é™çš„ã€‚
   2. è®¡ç®—æ‰€éœ€è¦çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæ¯”å¦‚çº¿ç¨‹é€šè¿‡ç½‘ç»œè¯·æ±‚èµ„æº
2. Futureæ˜¯ä¸€ç§å ä½ç¬¦ï¼Œå³æŸä¸ªå€¼çš„å†…å­˜ä½ç½®ã€‚å½“åˆ›å»ºFutureæ—¶ï¼Œç›¸åº”çš„å ä½ç¬¦ä¸­ä¸éœ€è¦æœ‰å€¼ï¼›å¯ä»¥éšç€getWebpageæ–¹æ³•çš„æ‰§è¡Œï¼Œåœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´å°†å€¼æ”¾è¿›å»ã€‚Future[]ç±»å‹éšå«äº†ç¨‹åºçš„å»¶æ—¶è¿‡ç¨‹ï¼Œå…¶ç¨‹åºè¯­ä¹‰æ˜¯ï¼Œèµ„æºè¿‡ä¸€ä¼šå„¿æ‰å¯ç”¨ã€‚å½“Futureå¯¹è±¡è·å¾—æŸä¸ªå€¼ä¹‹åï¼Œå®ƒå°±ä¸å†å˜åŒ–äº†ã€‚

```
//è¿”å›å€¼è¡¨ç¤ºFutureå¯¹è±¡æœ€ç»ˆä¼šåŒ…å«ä¸€ä¸ªStringç±»å‹çš„å€¼
def getWebpage(url: String): Future[String]
```

1. Futureå€¼çš„æå–æ–¹å¼ï¼šåœ¨å½“å‰çš„è°ƒç”¨çº¿ç¨‹ä¸­ï¼Œè¿›è¡Œè½®è¯¢(polling)ï¼Œè®©çº¿ç¨‹åœ¨å€¼å¯ç”¨ä¹‹å‰å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å°†é˜»å¡è½¬ç§»åˆ°äº†è°ƒç”¨çº¿ç¨‹ä¸­ã€‚Future[T]è¡¨ç¤ºä¸€ä¸ªå½“å‰å¯èƒ½ä¸å¯ç”¨ï¼Œä½†æ˜¯è¿‡ä¸€æ®µæ—¶é—´å¯ç”¨çš„ç±»å‹ä¸ºTçš„å€¼ã€‚è€ŒFutureè®¡ç®—è¡¨ç¤ºèƒ½äº§ç”ŸFutureå€¼çš„å¼‚æ­¥è®¡ç®—ã€‚

```
//åœ¨å¤–å›´ä½œç”¨åŸŸæœç´¢ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„å€¼ï¼Œç¡®å®šçº¿ç¨‹ä½•æ—¶ä½•åœ°æ‰§è¡Œ(çº¿ç¨‹æ± )
def apply[T](b: =>T)(implicit e: ExecutionContext): Future[T]
```

#### å¯åŠ¨Futureè®¡ç®—

åœ¨æ­¤ä¾‹ä¸­ï¼Œä¸»çº¿ç¨‹ä½¿ç”¨äº†è½®è¯¢æ³•æ¥è·å¾—Futureçš„å€¼ã€‚Futureå•ä¾‹å¯¹è±¡çš„pollingæ–¹æ³•æ˜¯éé˜»å¡å¼çš„ï¼Œä½†å®ƒä»¬ä¹Ÿæ˜¯éç¡®å®šæ€§çš„ã€‚isCompleted ä¼šè¿”å›falseï¼Œç›´åˆ°Future è®¡ç®—å®Œæˆã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒFuture è®¡ç®—çš„å®Œæˆå¯¹äºè½®è¯¢è°ƒç”¨æ¥è¯´æ˜¯ä¸€ç§å‰å‘ç”Ÿå…³ç³»ã€‚

```
object FutureDataType extends App {
  import scala.concurrent._
  import ExecutionContext.Implicits.global
  val buildFile = Future{
    val f: BufferedSource = Source.fromFile("pom.xml")
    try{
      f.getLines().mkString("\n")
    } finally f.close()
  }
  log(s"start read the file")
  log(s"status:  ${buildFile.isCompleted}")
  Thread.sleep(250)
  log(s"status:  ${buildFile.isCompleted}")
  log(s"value: \n ${buildFile.value}")
}
```

#### Futureå›è°ƒ

æ¦‚å¿µï¼šå›è°ƒæ˜¯æŒ‡ä¸€æ—¦å‚æ•°å¯ç”¨å°±ç«‹å³æ‰§è¡Œçš„å‡½æ•°ã€‚å½“å‘scalaçš„Futureè¾“å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œæ­¤å›è°ƒæ€»æ˜¯ä¼šæ‰§è¡Œï¼Œä½†æ˜¯æ˜¯åœ¨Futureçš„å€¼å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚

```
object FuturesCallbacks extends App {
  def getUrlSpec(): Future[List[String]] = Future {
    val url = "http://www.w3.org/Addressing/URL/url-spec.txt"
    val f = Source.fromURL(url)
    try f.getLines.toList finally f.close()
  }
  val urlSpec: Future[List[String]] = getUrlSpec()
  def find(lines: List[String], keyword: String): String =
    lines.zipWithIndex collect {
      case (line, n) if line.contains(keyword) => (n, line)
  } mkString("\n")

  urlSpec foreach  {
    lines => log(find(lines, "URL"))
  }
  log("callback registered, continuing with other work")
  Thread.sleep(20000)
}
```

å›è°ƒå‡½æ•°çš„ä½¿ç”¨ï¼š

åªèƒ½ç”¨foreachæ–¹æ³•åœ¨Futureå¯¹è±¡ä¸­è£…å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚æ³¨æ„ï¼Œforeachæ–¹æ³•ä¸onSuccessæ–¹æ³•æ˜¯ç­‰ä»·çš„ã€‚foreachæ–¹æ³•çš„å‚æ•°æ˜¯éƒ¨åˆ†å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªFutureå€¼ï¼Œç„¶åä¼šæ‰§è¡ŒæŸä¸ªæ“ä½œ

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ³¨å†Œå›è°ƒçš„è¿‡ç¨‹æ˜¯éé˜»å¡çš„ã€‚ä¸»çº¿ç¨‹ä¸­çš„logè¯­å¥ä¼šåœ¨å›è°ƒæ³¨å†Œå®Œæ¯•åç«‹åˆ»æ‰§è¡Œï¼Œè€Œå›è°ƒé‡Œé¢çš„logè¯­å¥åˆ™ä¼šåœ¨å¾ˆä¹…ä¹‹åæ‰æ‰§è¡Œ

æ³¨æ„ï¼Œå›è°ƒå‡½æ•°ä¸ä¸€å®šä¼šåœ¨Futureå®Œæˆä¹‹åç«‹åˆ»æ‰§è¡Œã€‚å¤§éƒ¨åˆ†æ‰§è¡Œä¸Šä¸‹æ–‡ä¼šå®‰æ’ä¸€ä¸ªä»»åŠ¡ä¸“é—¨å¤„ç†å›è°ƒã€‚å½“Futureå®Œæˆåï¼Œå›è°ƒå‡½æ•°æ€»ä¼šæ‰§è¡Œï¼Œä¸è¿‡åŒä¸€ä¸ªFutureä¸Šçš„ä¸åŒå›è°ƒä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚æ‰§è¡Œä¸Šä¸‹æ–‡å†³å®šäº†ç”±å“ªä¸ªçº¿ç¨‹åœ¨ä½•æ—¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚å®ŒæˆFutureå’Œæ‰§è¡Œå›è°ƒä¹‹é—´å­˜åœ¨å‰å‘ç”Ÿå…³ç³»ã€‚

å›è°ƒå‡½æ•°çš„æ€§è´¨ï¼š

å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æœ‰ä»»ä½•å‰¯ä½œç”¨ï¼Œæ¯”å¦‚æ²¡æœ‰å˜é‡èµ‹å€¼ã€ä¿®æ”¹å¯å˜é›†åˆæˆ–æ‰§è¡Œæ ‡å‡†è¾“å‡ºå†™æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±è¢«ç§°ä¸ºæ˜¯å‚è€ƒé€æ˜çš„ã€‚

Future å¯¹è±¡ä¸Šçš„å›è°ƒå‡½æ•°æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ€§è´¨ï¼Œå³åªä½¿ç”¨Future.applyå’Œforeachè°ƒç”¨å‚è€ƒé€æ˜çš„å›è°ƒå‡½æ•°çš„ç¨‹åºæ˜¯ç¡®å®šçš„ã€‚

#### Futureå’Œå¼‚å¸¸

é¦–å…ˆï¼Œåˆ›å»ºäº†ä¸€ä¸ªFutureï¼Œæ²¡æœ‰æ³¨å†Œä»»ä½•å›è°ƒå‡½æ•°ã€‚ç„¶ååœ¨è¯¥åŸºç¡€ä¹‹ä¸Šæ³¨å†Œå¾ˆå¤šçš„å›è°ƒå‡½æ•°.

![image.png](assets/call-back-api.png)

foreachæ–¹æ³•æ¥æ”¶çš„å›è°ƒå‡½æ•°åªè¢«ç”¨æ¥å¤„ç†æˆåŠŸçš„Futureçš„å€¼ã€‚é¢å¯¹å¤±è´¥çš„Futureçš„å€¼ï¼Œéœ€è¦ä½¿ç”¨failedæ–¹æ³•è¿›è¡Œå¤„ç†

```
object FuturesFailure extends App {
  val urlSpec: Future[String] = Future {
    val invalidUrl = "http://www.w3.org/non-existent-url-spec.txt"
    Source.fromURL(invalidUrl).mkString
  }
  urlSpec.failed foreach {
    case t => log(s"exception occurred - $t")
  }
  Thread.sleep(1000)
}
```

#### ä½¿ç”¨Tryç±»å‹

å’ŒOptionç±»ä¸åŒçš„æ˜¯ï¼ŒOptionåªæŠŠNoneä½œä¸ºä¸åŒ¹é…çš„æ ‡å¿—ï¼Œè€Œä¸èƒ½å­˜å‚¨å¤±è´¥çš„ä¿¡æ¯ã€‚

Tryç±»å‹æœ‰ä¸¤ç§æ ·ä¾‹ç±»å®ç°ï¼šä¸€ç§æ˜¯Success[T]ç±»å‹ï¼Œå®ƒä¿å­˜äº†è®¡ç®—æˆåŠŸåçš„ç»“æœï¼›å¦ä¸€ç§æ˜¯Failure[T]ç±»å‹ï¼Œå®ƒä¿å­˜äº†è®¡ç®—å¤±è´¥æ—¶æŠ›å‡ºçš„Throwableå¯¹è±¡ã€‚

Try[T]å¯¹è±¡æ˜¯åœ¨åŒæ­¥åœºåˆä¸‹ä½¿ç”¨çš„ä¸å¯å˜å¯¹è±¡ï¼Œåœ¨åˆ›å»ºæ—¶å°±å°†å€¼æˆ–å¼‚å¸¸ä¿å­˜ä¸‹æ¥äº†ï¼Œè¿™å’ŒFutureå¯¹è±¡ä¸ä¸€æ ·ã€‚ä¹Ÿå°±æ˜¯è¯´Tryå¯¹è±¡çš„ä½¿ç”¨æ€»æ˜¯åœ¨è°ƒç”¨çº¿ç¨‹ä¸­å®Œæˆã€‚

åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæ¨¡å¼åŒ¹é…ä½¿ç”¨çš„æ˜¯Tryå€¼ã€‚å½“è°ƒç”¨onCompleteå›è°ƒå‡½æ•°æ—¶ï¼Œä¼šä¸ºå®ƒæä¾›åŒ¹é…Successå€¼æˆ–Failureå€¼çš„éƒ¨åˆ†å‡½æ•°ã€‚

```
urlSpec onComplete {
  case Success(txt) => log(find(txt))
  case Failure(err) => log(s"exception occurred - $err")
}
```

#### Futureä¸Šçš„å‡½æ•°å¼ç»„åˆ

ä½œç”¨ï¼š

å‡½æ•°å¼ç»„åˆæ˜¯ç”¨æ¥è¡¥å……å›è°ƒå‡½æ•°çš„ä¸è¶³ã€‚å›è°ƒå‡½æ•°å¾ˆæœ‰ç”¨ï¼Œä½†åœ¨å¤§å‹ç¨‹åºä¸­ä¸åˆ©äºåˆ†ææ§åˆ¶æµã€‚è€Œä¸”ï¼Œå›è°ƒå‡½æ•°ä¸èƒ½å®ç°å¼‚æ­¥ç¼–ç¨‹ä¸­çš„æŸäº›æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯ç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ç›‘å¬å¤šä¸ªFutureå¯¹è±¡æ˜¯æ¯”è¾ƒçƒ¦ççš„ã€‚è¿˜å¥½Scalaæä¾›äº†Futureçš„è§£å†³æ–¹æ¡ˆï¼Œç§°ä¸ºå‡½æ•°å¼ç»„åˆã€‚å‡½æ•°å¼ç»„åˆæ˜¯ä¸€ç§ç¼–ç¨‹æ¨¡å¼ï¼Œå…¶æ€æƒ³æ˜¯ç”¨é«˜é˜¶å‡½æ•°ï¼ˆç§°ä¸ºç»„åˆå­ï¼‰å°†ç®€å•å€¼ç»„åˆæˆå¤æ‚å€¼ã€‚

å¯ä»¥å°†Futureç†è§£ä¸ºä¸€ç§ç‰¹æ®Šå½¢å¼çš„å®¹å™¨ï¼Œåªä¸è¿‡å®ƒæœ€å¤šåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå¯ä»¥å¯¹å…¶åº”ç”¨å‡½æ•°å¼ç»„åˆã€‚

ä½¿ç”¨æ—¶æœº:

å¯¹äºä¾èµ–äºå•ä¸ªFutureçš„æœ‰å‰¯ä½œç”¨çš„è¡Œä¸ºï¼Œä½¿ç”¨å›è°ƒã€‚å…¶ä»–æƒ…å†µä½¿ç”¨å‡½æ•°å¼ç»„åˆã€‚è€Œå‡½æ•°å¼ç»„åˆä¸­å¦‚æœæœ‰flatmapï¼Œä¸€èˆ¬ä¼šä½¿ç”¨foræ¨å¯¼å¼è¿›è¡Œæ›¿ä»£ã€‚åŒæ—¶ï¼Œforæ¨å¯¼å¼ä¸­çš„è¡¨è¾¾å¼æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œå¯èƒ½åœ¨å¹¶å‘å¹¶å‘ç¼–ç¨‹ä¸­éœ€è¦æ³¨æ„é¡ºåºï¼Œå¦‚æœè¾¹è®¡ç®—è¾¹ä½¿ç”¨å¯èƒ½ä¼šå‡ºé—®é¢˜ã€‚

### 4.2 Promise

#### åŸºæœ¬æ¦‚å¿µ

1. æ¦‚å¿µ

Promiseæ˜¯æŒ‡åªèƒ½ä¸€æ¬¡æ€§èµ‹å€¼æˆ–æŠ›å‡ºå¼‚å¸¸çš„ä¸€ç§å¯¹è±¡ã€‚è¿™ä¹Ÿæ˜¯Promiseæœ‰æ—¶å€™åˆè¢«ç§°ä¸ºå•èµ‹å€¼å˜é‡çš„åŸå› ã€‚ä¸»è¦ä½œç”¨æ˜¯æ¢ä¸€ç§æ›´çµæ´»çš„æ–¹å¼ï¼Œå°†ç»“æœèµ‹å€¼ç»™Futureï¼Œè€Œä¸æ˜¯å•ä¸€çš„çº¿ç¨‹è¿”å›å€¼

1. åˆ›å»º

ä¸ºåˆ›å»ºä¸€ä¸ªPromiseå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨Promiseä¼´éšå¯¹è±¡ä¸Šçš„Promise.applyæ–¹æ³•ã€‚ä¸è¿‡ï¼ŒPromise.apply æ–¹æ³•å¹¶ä¸ä¼šå¯åŠ¨å¼‚æ­¥è®¡ç®—ï¼Œå®ƒåªæ˜¯åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„Promiseå¯¹è±¡ã€‚å½“Promiseå¯¹è±¡åˆ›å»ºåï¼Œå®ƒå¹¶ä¸åŒ…å«å€¼æˆ–å¼‚å¸¸ã€‚ä¸ºäº†å°†å€¼æˆ–å¼‚å¸¸èµ‹å€¼ç»™ä¸€ä¸ªPromiseï¼Œéœ€è¦åˆ†åˆ«ä½¿ç”¨successæˆ–failureæ–¹æ³•

1. ä¸Futureçš„è”ç³»

æ¯ä¸ªPromiseå¯¹åº”ä¸€ä¸ªFutureï¼Œä¸ºäº†è·å¾—Promiseå¯¹åº”çš„Futureï¼Œå¯ä»¥è°ƒç”¨Promiseå¯¹è±¡çš„Futureæ–¹æ³•ã€‚è¯¥æ–¹æ³•å¤šæ¬¡è°ƒç”¨ä¹Ÿåªä¼šè¿”å›å¯¹åº”çš„åŒä¸€ä¸ªFutureæ–¹æ³•ã€‚Promiseå’ŒFutureå¯¹åº”ä¸€ä¸ªå•èµ‹å€¼å˜é‡çš„ä¸¤ä¸ªæ–¹é¢ï¼ŒPromiseå¯¹è±¡ç»™ç”¨æˆ·æä¾›ä¸€ä¸ªFutureå¯¹è±¡ã€‚ç”¨æˆ·å¯ä»¥å°†Futureçš„å€¼è¯»å‡ºæ¥ã€‚

**ğŸ””**

å¸¸è§çš„ä½¿ç”¨æ¨¡å¼ï¼šFuture-å›è°ƒæ¡¥

1. åˆ›å»ºPromiseå¯¹è±¡
2. å…¶ä¸­å…¶ä»–è®¡ç®—ä»»åŠ¡(çº¿ç¨‹)å®ŒæˆPromise(ä½¿ç”¨å€¼æˆ–è€…å¼‚å¸¸å€¼æ¥å®Œæˆ)
3. è¿”å›Promiseå¯¹åº”çš„Futureå¯¹è±¡
4. API

promiseçš„successæ–¹æ³•æ˜¯å°†promiseç”¨ä¸€ä¸ªæˆåŠŸçš„ç»“æœå€¼å®Œæˆï¼Œè‡³æ­¤promiseå°±å®Œæˆäº†èµ‹å€¼ï¼Œå…¶å¯¹åº”çš„Futureä¹Ÿå°±ç¡®å®šäº†ã€‚

ç”¨æˆ·è¿˜å¯ä»¥ä½¿ç”¨ trySuccessã€tryFailure å’ŒtryComplete æ–¹æ³•ï¼Œå…¶åˆ†åˆ«å¯¹åº”äº successã€failureå’Œcompleteï¼Œä¸åŒä¹‹å¤„åœ¨äºä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œæ ‡è¯†èµ‹å€¼æ˜¯å¦æˆåŠŸã€‚

1. ä¾‹å­ï¼šå®šåˆ¶Future.applyæ–¹æ³•

```
import scala.util.control.NonFatal
object PromisesCustomAsync extends App {
  def myFuture[T](b: =>T): Future[T] = {
    val p = Promise[T]
    global.execute(new Runnable {
      def run() = try {
        p.success(b)
      } catch {
        case NonFatal(e) => {
          log("here")
          p.failure(e)
        }
      }
    })
    p.future
  }
  val f = myFuture { "naa" + "na" * 8 + " Katamari Damacy!" }
  f foreach { case text:String => log(text) }
  Thread.sleep(1000)
}
```

#### åŒ…è£…åŸºäºå›è°ƒçš„API

1. å¿…è¦æ€§ï¼š

è°ƒç”¨çº¿ç¨‹çš„é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨Futureæˆ–è€…å›è°ƒå‡½æ•°è¿›è¡Œé¿å…ã€‚

æ—§ç‰ˆæœ¬çš„æ¡†æ¶å¸¸ä½¿ç”¨åŸå§‹çš„å›è°ƒå‡½æ•°æ¥å¤„ç†ç¨‹åºä¸­çš„å»¶è¿Ÿé—®é¢˜ã€‚æ‰§è¡Œæ—¶é—´å¾…å®šçš„æ–¹æ³•å¹¶ä¸ä¼šè¿”å›ç»“æœï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ï¼Œå®ƒä»¬æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œæ­¤å›è°ƒå‡½æ•°ç”¨äºè¯»å–å°†æ¥çš„ç»“æœã€‚

å¤§é‡çš„å›è°ƒå‡½æ•°ä½¿ç”¨ä¼šä½¿å¾—ç»“æ„å˜å¾—å¼‚å¸¸å¤æ‚ï¼Œå¯ä»¥é€šè¿‡Promiseä½œä¸ºå›è°ƒå‡½æ•°APIå’ŒFutureä¹‹é—´çš„æ¡¥æ¢ã€‚æ­¤æ¨¡å¼ç§°ä¸ºFuture-å›è°ƒæ¡¥ã€‚

```
  //æ£€æµ‹ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–°åˆ›å»ºçš„æ–‡ä»¶
  def fileCreated(dir:String):Future[String] = {
    val p = Promise[String]
    //æ¯1000msæ¥è¿›è¡Œæ£€æµ‹
    val fileMonitor = new FileAlterationMonitor(1000)
    //æ£€æµ‹çš„æ˜¯dirç›®å½•ä¸‹æ–‡ä»¶
    val fileObserver = new FileAlterationObserver(dir)
    //ä¸‹é¢æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå½“ç›®å½•ä¸‹æ–‡ä»¶è¢«åˆ›å»ºï¼Œè¯¥å¯¹è±¡çš„onFileCreateæ–¹æ³•ä¼šè¢«è°ƒç”¨
    val listener = new FileAlterationListenerAdaptor {
      override def onFileCreate(file: File): Unit = {
        log("File created: " + file.getName)
        //æ£€æµ‹åˆ°æ–‡ä»¶åˆ›å»ºï¼Œå°±å°†æˆåŠŸç»“æœä¼ é€’ç»™promise
        try{
          p.success(file.getName)
        }finally fileMonitor.stop()
      }
    }
    fileObserver.addListener(listener)
    fileMonitor.addObserver(fileObserver)
    fileMonitor.start()
    p.future
  }
```

å®ç°timeoutæ–¹æ³•ï¼Œè°ƒç”¨timeoutæ–¹æ³•ï¼Œä¼ å…¥t msçš„å‚æ•°ï¼Œç„¶åè®©å®ƒè¿”å›ä¸€ä¸ªè‡³å°‘t msä¹‹åæ‰èƒ½å®Œæˆçš„Futureã€‚

```
def timeout(t: Long): Future[Unit] = {
    val p = Promise[Unit]
    //
    timer.schedule(new TimerTask {
      override def run() = {
        p.success()
        //ä¸€æ—¦è°ƒç”¨cancelæ–¹æ³•ï¼ŒTimerTaskå°±ä¸ä¼šå†è¢«æ‰§è¡Œäº†
        timer.cancel()
      }
    }, t)
    p.future
 }
```

### 4.3 Futureå’Œé˜»å¡

é˜»å¡å’ŒFutureï¼Œä¹Ÿå°±æ˜¯é˜»å¡Futureçš„æ–¹å¼æœ‰ä¸¤ç§ï¼šç¬¬ä¸€ç§æ˜¯ç­‰å¾…Futureå®Œæˆï¼Œç¬¬äºŒç§æ˜¯å¼‚æ­¥è®¡ç®—å†…éƒ¨é˜»å¡ã€‚

1. ç­‰å¾…Futureå®Œæˆ

å¯ä½¿ç”¨ scala.concurrent åŒ…ä¸­çš„Await å¯¹è±¡ä¸Šçš„ ready å’Œresultæ–¹æ³•ã€‚

readyæ–¹æ³•é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æŒ‡å®šçš„Futureå®Œæˆä¸ºæ­¢ã€‚

resultæ–¹æ³•ä¹Ÿå¯é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œå¦‚æœFutureæˆåŠŸå®Œæˆï¼Œåˆ™è¿”å›Futureçš„å€¼ï¼›å¦‚æœFutureå¤±è´¥ï¼Œåˆ™æŠ›å‡ºå…¶å¼‚å¸¸ã€‚

è¿™ä¸¤ç§æ–¹æ³•éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªtimeoutå‚æ•°ï¼Œå³è°ƒç”¨çº¿ç¨‹éœ€è¦ç­‰å¾…Futureè®¡ç®—çš„æœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶åä¼šæŠ›å‡ºä¸€ä¸ª TimeoutException å¼‚å¸¸ã€‚

```
import scala.concurrent.{Await, Future}
import scala.concurrent.duration._
import scala.concurrent.ExecutionContext.Implicits.global
import scala.io.Source
object BlockingAwait  extends App {
  val specUrlSizeFuture = Future{
    val specUrl = "http://baidu.com/search?q=helloworld"
    Source.fromURL(specUrl).size
  }
  val urlSize = Await.result(specUrlSizeFuture, 10 seconds)
  println(urlSize)
}
```

1. åœ¨å¼‚æ­¥è®¡ç®—å†…é˜»å¡

æœ‰çš„æ—§ç‰ˆæœ¬çš„APIä¸ä½¿ç”¨å›è°ƒæ¥è¿”å›ä¸€æ­¥çš„ç»“æœï¼Œè€Œæ˜¯ä½¿ç”¨é˜»å¡æ–¹æ³•ã€‚å½“è°ƒç”¨ä¸€ä¸ªé˜»å¡æ–¹æ³•çš„æ—¶å€™ï¼Œç”¨æˆ·å®Œå…¨å¤±å»å¯¹çº¿ç¨‹çš„æ§åˆ¶æƒï¼Œå®Œå…¨ç”±è¿™ä¸ªé˜»å¡æ–¹æ³•æ¥å†³å®šä½•æ—¶å°†çº¿ç¨‹è§£é”å¹¶äº¤è¿˜æ§åˆ¶æƒã€‚

æ‰§è¡Œä¸Šä¸‹æ–‡é€šå¸¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± å®ç°çš„ï¼Œé˜»å¡å·¥ä½œçº¿ç¨‹å¯èƒ½è€—å°½çº¿ç¨‹æ± èµ„æºï¼Œå¯¼è‡´çº¿ç¨‹é¥¥é¥¿ã€‚

å¦‚æœä¸€å®šè¦é˜»å¡ï¼Œåˆ™é˜»å¡çš„é‚£éƒ¨åˆ†ä»£ç åº”è¯¥ç½®äºblockingè°ƒç”¨ä¸­ã€‚è¿™ç›¸å½“äºå‘Šè¯‰æ‰§è¡Œä¸Šä¸‹æ–‡å·¥ä½œçº¿ç¨‹è¢«é˜»å¡äº†ï¼Œå¿…è¦æ—¶å¯ä»¥ä¸´æ—¶å¯åŠ¨å¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚

```
val futures = for (_ <- 0 until 16) yield Future {
  blocking {
    Thread.sleep(1000)
  }
}
```

### 4.4 Scalaçš„Asyncåº“

Scala Async åº“å¼•å…¥äº†ä¸¤ä¸ªæ–°æ–¹æ³•ï¼šasync å’Œ awaitã€‚

async åœ¨æ¦‚å¿µä¸Šç­‰ä»·äºFuture.applyï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªå¼‚æ­¥è®¡ç®—ï¼Œå¹¶è¿”å›ä¸€ä¸ªFutureå¯¹è±¡ã€‚

è€Œå¯¹äºawaitæ–¹æ³•åˆ™ä¸èƒ½å°†å…¶å’Œ Await å¯¹è±¡å¼„æ··äº†ï¼Œåè€…ç”¨äºé˜»å¡Future,await æ–¹æ³•åˆ™ç”¨äºæ¥æ”¶ä¸€ä¸ªFutureå¯¹è±¡å¹¶è¿”å›å®ƒçš„å€¼ã€‚è€Œä¸”å’ŒAwaitå¯¹è±¡ä¸Šçš„æ–¹æ³•ä¸åŒï¼Œawaitæ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œ

### 4.5 å¤šçº¿ç¨‹æ–¹æ¡ˆé€‰æ‹©æ€»ç»“

1. Java
   1. ä¸²è¡Œæ¨¡å¼

é€»è¾‘æœ€ç®€å•ï¼Œæ€§èƒ½æœ€ä½

1. çº¿ç¨‹æ±  + Future å¼‚æ­¥è°ƒç”¨

å¯ä»¥å¹¶è¡Œè®¡ç®—ï¼Œä½†æ˜¯é‡åˆ°Futureä¹‹é—´æœ‰å‰åä¾èµ–å…³ç³»ï¼Œè¿˜æ˜¯éœ€è¦å¤§é‡æ—¶é—´é˜»å¡/è½®è¯¢

1. çº¿ç¨‹æ±  + CompletableFutureå¼‚æ­¥è°ƒç”¨

è¿™ä¸ªFutureæ›´åŠ ç±»ä¼¼äºscalaçš„Futureï¼Œå¯ä»¥å®‰è£…å›è°ƒï¼Œå¯ä»¥è¿›è¡Œä¾èµ–å…³ç³»çš„ç»„åˆ

1. è™šæ‹Ÿçº¿ç¨‹
2. Scala

   1. ä¸²è¡Œæ¨¡å¼

é€»è¾‘æœ€ç®€å•ï¼Œæ€§èƒ½æœ€ä½

1. çº¿ç¨‹æ±  + Future + Promise

æ¯”Javaæ›´çµæ´»

1. async/await
2. è™šæ‹Ÿçº¿ç¨‹
3. æœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿçº¿ç¨‹

[å¾—ç‰©è™šæ‹Ÿçº¿ç¨‹å®è·µ](https://zhuanlan.zhihu.com/p/670651709)

[æ€§èƒ½æµ‹è¯•](https://juejin.cn/post/7280746515526058038)

## 5. å¹¶è¡Œå®¹å™¨

### 5.1 åŸºæœ¬æ¦‚å¿µ

1. é€šç”¨è€—æ—¶æµ‹é‡å‡½æ•°

```
@volatile var dummy: Any = _
def timed[T](body: =>T): Double = {
  val start = System.nanoTime
  dummy = body
  val end = System.nanoTime
  ((end - start) / 1000) / 1000.0
}
```

ç¤ºä¾‹ï¼š

ä¸‹é¢æµ‹é‡çš„æ˜¯å¹¶è¡Œç‰ˆå®¹å™¨å’Œä¸²è¡Œç‰ˆå®¹å™¨çš„è€—æ—¶å¯¹æ¯”ï¼Œå…·æœ‰10%çš„æ€§èƒ½æå‡ã€‚

```
    import scala.collection._
    import scala.util.Random
    object ParBasic extends App {
      val numbers = Random.shuffle(Vector.tabulate(5000000)(i => i))
      val seqtime = timed { numbers.max }
      log(s"Sequential time $seqtime ms")
      val partime = timed { numbers.par.max }
      log(s"Parallel time $partime ms")
    }
```

1. é€šå¸¸çš„æ•°æ®å¹¶è¡Œæ“ä½œæ¶‰åŠæ›´å¤šå¤„ç†å™¨ä¹‹é—´çš„é€šä¿¡ã€‚

æ­¤å¤„ä¸æ˜¯é€šè¿‡å¤šçº¿ç¨‹æ¡†æ¶ï¼Œè€Œæ˜¯é€šè¿‡å¹¶è¡Œå®¹å™¨æ¥å®è¡Œçš„ã€‚

å½“è°ƒç”¨ä¸€ä¸ªå¹¶è¡Œå®¹å™¨çš„ foreach æ–¹æ³•æ—¶ï¼Œå®¹å™¨ä¸­çš„å…ƒç´ å°†å¹¶å‘åœ°å¤„ç†ã€‚å³ä¸åŒçš„å·¥ä½œçº¿ç¨‹åŒæ—¶è§¦å‘æŒ‡å®šçš„å‡½æ•°ï¼Œæ‰€ä»¥è¿˜éœ€è¦æœ‰æ°å½“çš„åŒæ­¥æªæ–½ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼ŒåŒæ­¥æ€§æ˜¯ç”±åŸå­æ€§å˜é‡ä¿è¯çš„ã€‚

```
import java.util.concurrent.atomic._
object ParUid extends App {
  private val uid = new AtomicLong(0L)
  val seqtime = timed {
    for (i <- 0 until 10000000) uid.incrementAndGet()
  }
  log(s"Sequential time $seqtime ms")
  val partime = timed {
    for (i <- (0 until 10000000).par) uid.incrementAndGet()
  }
  log(s"Parallel time $partime ms")
}
```

æœ¬ä¾‹ä¸­å¯èƒ½ä¼šæ…¢æˆ–è€…æ²¡æœ‰æ˜æ˜¾æ”¹è¿›çš„åŸå› ï¼šæ˜¯å› ä¸ºå·¥ä½œçº¿ç¨‹åŒæ—¶è°ƒç”¨äº†åŸå­æ€§å˜é‡uidä¸Šçš„incrementAndGetæ–¹æ³•ï¼Œå¹¶ä¸”å°†ç»“æœç«‹åˆ»å†™å…¥ç›¸åŒçš„å†…å­˜åŒºåŸŸã€‚

**ğŸ””**

åœ¨ç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼Œå†…å­˜å†™å…¥å¹¶ä¸æ˜¯ç›´æ¥æ“ä½œéšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆRandom AccessMemory,RAMï¼‰ï¼Œå› ä¸ºè¿™å¤ªæ…¢äº†ã€‚

ç›¸åï¼Œç°ä»£è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ï¼ŒCPUå’Œå†…å­˜ä¹‹é—´è¿˜æœ‰å¥½å‡ å±‚ç¼“å­˜ï¼š å®¹é‡å°çš„ç¼“å­˜å¾€å¾€é€Ÿåº¦æ›´å¿«ä¹Ÿæ›´è´µï¼Œå®ƒé‡Œé¢å­˜çš„æ˜¯å¤„ç†å™¨å½“å‰å¤„ç†çš„æ•°æ®å¤åˆ¶ã€‚ç¦» CPU æœ€è¿‘çš„ç¼“å­˜å±‚ç§°ä¸º L1ç¼“å­˜ï¼ŒL1ç¼“å­˜åˆè¢«åˆ’åˆ†ä¸ºå¤šä¸ªç§°ä¸ºç¼“å­˜è¡Œï¼ˆcache lineï¼‰çš„è¿ç»­ç©ºé—´ï¼Œå…¶å…¸å‹å¤§å°ä¸º64Bã€‚

åœ¨æ ‡å‡†çš„å¤šæ ¸å¤„ç†å™¨ä¸­ï¼Œå¤šä¸ªå†…æ ¸å¯ä»¥åŒæ—¶è®¿é—®åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œä½†å†™æ“ä½œæ˜¯äº’æ–¥çš„ï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªå†…æ ¸æ‹¥æœ‰æŸä¸ªç¼“å­˜è¡Œã€‚å¦‚æœåŒæ—¶æœ‰å¦ä¸€ä¸ªå†…æ ¸è¯·æ±‚å†™å…¥åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œé‚£ä¹ˆæ­¤ç¼“å­˜è¡Œçš„å†…å®¹å°†ä¼šè¢«å¤åˆ¶åˆ°é‚£ä¸ªå†…æ ¸çš„L1ç¼“å­˜ä¸­ã€‚ç»´æŠ¤è¿™ç§ç¼“å­˜ä¸€è‡´æ€§çš„åè®®ç§°ä¸ºä¿®æ”¹ã€äº’æ–¥ã€å…±äº«ã€éæ³•ï¼ˆModified Exclusive Shared Invalid,MESIï¼‰ã€‚äº¤æ¢ç¼“å­˜è¡Œçš„æ‰€æœ‰æƒçš„ä»£ä»·æ˜¯æ¯”è¾ƒå¤§çš„

å› ä¸ºå˜é‡uidæ˜¯åŸå­æ€§çš„ï¼ŒJVMéœ€è¦ç¡®ä¿uidçš„å†™æ“ä½œå’Œè¯»æ“ä½œä¹‹é—´å…·æœ‰å‰å‘ç”Ÿå…³ç³»ï¼ˆè§ç¬¬2ç« ï¼‰ã€‚ä¸ºä¿è¯å®ç°å‰å‘ç”Ÿå…³ç³»ï¼Œå†…å­˜å†™æ“ä½œå¿…é¡»å¯¹å…¶ä»–å¤„ç†å™¨å¯è§ã€‚

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œå”¯ä¸€çš„åŠæ³•æ˜¯åœ¨å†™ä¹‹å‰è®©ç¼“å­˜è¡Œæ˜¯ç‹¬å çš„ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä¸åŒçš„å¤„ç†å™¨å†…æ ¸åå¤äº¤æ¢ç¼“å­˜è¡Œçš„æ‰€æœ‰æƒï¼Œä»¥å®ç°uidçš„åˆ†é…ï¼Œäºæ˜¯é€ æˆäº†å¹¶è¡Œç‰ˆæœ¬çš„é€Ÿåº¦æ¯”ä¸²è¡Œç‰ˆæœ¬çš„è¿˜æ…¢ã€‚

**ğŸ””**

å¤šä¸ªçº¿ç¨‹å¾€åŒä¸€å†…å­˜åŒºåŸŸå†™å…¥æ•°æ®éœ€è¦æ°å½“çš„åŒæ­¥æªæ–½ï¼Œè¿™ä¼šé€ æˆç«äº‰å’Œæ€§èƒ½ç“¶é¢ˆï¼Œå› æ­¤ï¼Œåœ¨æ•°æ®å¹¶è¡Œæ“ä½œä¸­è¦å°½é‡é¿å…è¿™ç§æƒ…å†µã€‚ç±»ä¼¼çš„æ€§èƒ½ç“¶é¢ˆè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¤šçº¿ç¨‹å¹¶å‘è§¦å‘åŒä¸€å¯¹è±¡çš„synchronizedè¯­å¥ï¼Œé‡å¤ä¿®æ”¹å¹¶å‘æ˜ å°„ä¸­çš„åŒä¸€ä¸ªé”®ï¼Œæˆ–åŒæ—¶å¾€å¹¶å‘é˜Ÿåˆ—ä¸­æ’å…¥å…ƒç´ ã€‚è¿™äº›è¡Œä¸ºéƒ½æ¶‰åŠå¾€åŒä¸€å†…å­˜åŒºåŸŸå†™å…¥æ•°æ®

### 5.2  å¹¶è¡Œå®¹å™¨çš„ä½¿ç”¨

#### ç±»ç»§æ‰¿å…³ç³»

1. å®šä¹‰

å¹¶è¡Œå®¹å™¨ä¸å¯ä»¥æ˜¯ä¸²è¡Œå®¹å™¨çš„å­ç±»å‹ã€‚è®©å¹¶è¡Œå®¹å™¨ç»§æ‰¿æŸä¸ªä¸²è¡Œå®¹å™¨ï¼Œä¼šè¿åLiskovæ›¿æ¢åŸåˆ™ã€‚Liskovæ›¿æ¢åŸåˆ™æŒ‡çš„æ˜¯å¦‚æœç±»å‹Sæ˜¯ç±»å‹Tçš„å­ç±»å‹ï¼Œåˆ™ç±»å‹ä¸ºTçš„å¯¹è±¡å¯ä»¥æ›¿æ¢ä¸ºç±»å‹ä¸ºSçš„å¯¹è±¡ï¼Œè€Œä¸ä¼šå½±å“ç¨‹åºçš„æ­£ç¡®æ€§ã€‚å› ä¸ºå¯¹ä¸²è¡Œå®¹å™¨é€‚åˆçš„è®¡ç®—ï¼Œä½¿ç”¨å¹¶è¡Œå®¹å™¨å¯èƒ½é€ æˆæ•°æ®ç«äº‰ã€‚

![image.png](assets/collection-extends.png)

![]()

1. è½¬æ¢

ä½¿ç”¨ä¸²è¡Œå®¹å™¨çš„paræ–¹æ³•å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ªå¹¶è¡Œå®¹å™¨ã€‚

å¦‚æœéœ€è¦ç¼–å†™ä¸å®¹å™¨ç±»å‹æ— å…³çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨æ³›å‹å®¹å™¨ç±»å‹ï¼Œä»–ä»¬æ¯ä¸ªéƒ½æ˜¯ä¸²è¡Œå®¹å™¨å’Œå¹¶è¡Œå®¹å™¨çš„çˆ¶ç±»ã€‚å¦‚æœç¼–å†™æ³›å‹å®¹å™¨çš„ä»£ç ï¼Œéœ€è¦å‡è®¾å®¹å™¨æ˜¯å¹¶è¡Œçš„ï¼Œå¯ä»¥é˜²æ­¢å¼‚å¸¸æƒ…å†µå‡ºç°ã€‚

#### é…ç½®å¹¶è¡Œå±‚æ¬¡

å¹¶è¡Œå®¹å™¨é»˜è®¤çº¿ç¨‹æ•°å’Œå¤„ç†å™¨æ•°ç›®ä¸€æ ·å¤šï¼Œå³ç¨‹åºæ‰§è¡Œæ—¶ä½¿ç”¨çš„å·¥ä½œçº¿ç¨‹æ•°ç›®ã€‚

è¿™ä¸ªé»˜è®¤è¡Œä¸ºæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œä¿®æ”¹å¹¶è¡Œå®¹å™¨çš„TaskSupportå¯¹è±¡å³å¯ã€‚è¿™é‡Œç”¨åˆ°çš„ä¸€ä¸ªç®€å•çš„ TaskSupport å®ç°æ˜¯ ForkJoinTaskSupport ç±»ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªForkJoinPoolå®¹å™¨ï¼Œç”¨æ¥è°ƒåº¦å¹¶è¡Œæ“ä½œã€‚

ä¸€ä¸ª TaskSupport å®ä¾‹å¯ä»¥ç”¨äºä¸åŒçš„å¹¶è¡Œå®¹å™¨ï¼Œå°†å…¶èµ‹å€¼ç»™æ¯ä¸ªå¹¶è¡Œå®¹å™¨çš„tasksupportå­—æ®µå³å¯ã€‚

```
import SUC.{log, timed}

import scala.collection.parallel
import scala.concurrent.forkjoin.ForkJoinPool
import scala.util.Random
object ParConfig extends App {
  val fjpool = new ForkJoinPool(2)
  val customTaskSupport = new parallel.ForkJoinTaskSupport(fjpool)
  val numbers = Random.shuffle(Vector.tabulate(5000000)(i => i))
  val partime = timed {
    val parnumbers = numbers.par
    parnumbers.tasksupport = customTaskSupport
    val n = parnumbers.max
    println(s"largest number $n")
  }
  log(s"Parallel time $partime ms")
}
```

### 5.3 å¹¶è¡Œå®¹å™¨çš„ç¼ºç‚¹

#### ä¸å¯å¹¶è¡Œå®¹å™¨

1. å¯å¹¶è¡Œçš„å®¹å™¨ï¼šæœ‰äº› Scala å®¹å™¨ä¸Šçš„æ“ä½œæ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œæ¯”å¦‚Arrayã€ArrayBufferã€å¯å˜HashMapã€å¯å˜HashSetã€Rangeã€Vectorã€ä¸å¯å˜HashMapã€ä¸å¯å˜HashSetä»¥åŠå¹¶å‘TrieMapã€‚åœ¨è¿™ç±»å®¹å™¨ä¸Šè°ƒç”¨paræ–¹æ³•å¯ä»¥ç”Ÿæˆä¸€ä¸ªå¹¶è¡Œå®¹å™¨ï¼Œä¸”ä¸åŸä¸²è¡Œå®¹å™¨å…±äº«åŒä¸€ä»½æ•°æ®ï¼Œå› ä¸ºä¸éœ€è¦å¤åˆ¶æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªè½¬æ¢è¿‡ç¨‹å¾ˆå¿«ã€‚
2. ä¸å¯å¹¶è¡Œçš„å®¹å™¨ï¼šå…¶ä»–Scalaå®¹å™¨åœ¨è°ƒç”¨paræ—¶éœ€è¦è½¬æ¢æ•°æ®ï¼Œè¢«ç§°ä¸ºä¸å¯å¹¶è¡Œå®¹å™¨ã€‚åœ¨ä¸å¯å¹¶è¡Œå®¹å™¨ä¸Šè°ƒç”¨ par æ–¹æ³•éœ€è¦å°†æ•°æ®å…ƒç´ å¤åˆ¶åˆ°æ–°å®¹å™¨ä¸­ã€‚æ¯”å¦‚ï¼Œåœ¨ List å®¹å™¨ä¸Šè°ƒç”¨ paræ–¹æ³•éœ€è¦å°†æ•°æ®å…ƒç´ å¤åˆ¶åˆ°Vectorå®¹å™¨ä¸­

#### ä¸å¯å¹¶è¡Œçš„æ“ä½œ

scalaçš„APi foldLeftå°±æ˜¯åŒä¸€ä¸ªä¸å¯å¹¶è¡Œçš„æ“ä½œ.æ¯”å¦‚æ­¤æ–¹æ³•ä»å·¦è‡³å³è®¿é—®å®¹å™¨ä¸­çš„å…ƒç´ ï¼Œå°†å®ƒä»¬åŠ åˆ°ç±»å‹ä¸ºSçš„ç´¯åŠ å™¨ä¸Šï¼Œç´¯åŠ å™¨åˆå§‹å€¼ä¸ºzï¼Œç„¶åå‡½æ•°få°†å½“å‰ç´¯åŠ å™¨å’Œç±»å‹ä¸ºTçš„å…ƒç´ ç›¸åŠ ï¼Œå¾—åˆ°æ–°çš„ç´¯åŠ å™¨ï¼Œå¹¶å‚ä¸ä¸‹ä¸€æ¬¡è®¡ç®—ã€‚

```
//scalaçš„APi foldLeft
def foldLeft[S](z: S)(f: (S, T) => S): S

List(1, 2, 3).foldLeft(0)((acc, x) => acc + x)
```

foldLeftçš„ä¸€ä¸ªå…³é”®æ€§è´¨æ˜¯å®ƒä»å·¦è‡³å³è®¿é—®é“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œè¿™ä¸€ç‚¹åæ˜ åœ¨å‡½æ•°fçš„å‚æ•°ä¸Šï¼Œå…¶å‚æ•°æ˜¯ä¸€ä¸ªç±»å‹ä¸ºSçš„ç´¯åŠ å™¨å’Œä¸€ä¸ªç±»å‹ä¸ºTçš„é“¾è¡¨å…ƒç´ ã€‚å‡½æ•°fä¸èƒ½å°†ä¸¤ä¸ªç´¯åŠ å™¨åˆå¹¶ä¸ºä¸€ä¸ªç´¯åŠ å™¨ã€‚

è§£å†³åŠæ³•ï¼š

ä¸ºäº†èƒ½å¤Ÿå°†ä¸åŒå¤„ç†å™¨äº§ç”Ÿçš„ç´¯åŠ å™¨åˆå¹¶èµ·æ¥ï¼Œéœ€è¦ç”¨åˆ° aggregate æ–¹æ³•ã€‚aggregate æ–¹æ³•ç±»ä¼¼äºfoldLeftï¼Œåªä¸è¿‡å®ƒæ²¡æœ‰æŒ‰ä»å·¦è‡³å³çš„æ–¹å¼æŒ‡å®šæ•´ä¸ªé“¾è¡¨ä¸­çš„å…ƒç´ ï¼Œè€Œæ˜¯æŒ‡å®šä¸€ä¸ªå­é›†ï¼ˆè®¿é—®é¡ºåºä»ç„¶æ˜¯ä»å·¦è‡³å³ï¼‰ã€‚æ¯ä¸ªå­é›†å¯ç”Ÿæˆä¸€ä¸ªç‹¬ç«‹çš„ç´¯åŠ å™¨ã€‚

#### å¹¶è¡Œå®¹å™¨çš„å‰¯ä½œç”¨

ä¸ºé¿å…ä½¿ç”¨åŒæ­¥ï¼Œå¹¶è·å¾—æ›´å¥½çš„å¯æ‰©å±•æ€§ï¼Œåº”å°½é‡ä½¿ç”¨å£°æ˜å¼çš„å¹¶è¡Œæ“ä½œï¼Œè€Œéåœ¨å¾ªç¯ä¸­ä½¿ç”¨å¹¶è¡Œæ“ä½œï¼ˆæœ‰å‰¯ä½œç”¨ï¼‰

ç±»ä¼¼åœ°ï¼Œç”¨æˆ·éœ€ç¡®ä¿å¹¶è¡Œæ“ä½œè¯»å–çš„å†…å­˜ä½ç½®ä¸Šä¸èƒ½æœ‰å¹¶å‘çš„å†™æ“ä½œã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå½“å‰å¹¶å‘æ“ä½œæ­£åœ¨æ‰§è¡Œæ—¶ï¼Œå­é›†bä¸åº”è¯¥è¢«å…¶ä»–çº¿ç¨‹å¹¶å‘åœ°ä¿®æ”¹ï¼Œå¦åˆ™ä¼šå¯¼è‡´å’Œå¯å˜å˜é‡ä¸€æ ·çš„é”™è¯¯ç»“æœã€‚

#### éç¡®å®šæ€§å¹¶è¡Œæ“ä½œï¼Œå¯äº¤æ¢çš„æ“ä½œ

åªè¦ç”¨äºæ§åˆ¶å¹¶è¡Œçš„çŠ¶æ€æ˜¯å¯ç¡®å®šçš„ã€‚

## 8. è§’è‰²æ¨¡å‹

åœ¨è§’è‰²æ¨¡å‹ä¸­ï¼Œç¨‹åºç”±å¤§é‡å®ä½“æ„æˆï¼Œå®ƒä»¬å„è‡ªç‹¬ç«‹è¿è¡Œï¼Œç›¸äº’ä¹‹é—´é€šè¿‡æ¶ˆæ¯ä¼ é€’æ¥é€šä¿¡ã€‚è¿™ç§ç‹¬ç«‹çš„å®ä½“ç§°ä¸ºè§’è‰²ã€‚

è§’è‰²æ¨¡å‹ä¸»è¦ç”¨äºè§£å†³å…±äº«å†…å­˜å¸¦æ¥çš„é—®é¢˜ï¼Œæ¯”å¦‚æ•°æ®äº‰ç”¨æˆ–åŒæ­¥ï¼Œå› ä¸ºå®ƒå¹²è„†å°±å®Œå…¨ä¸ç”¨å…±äº«å†…å­˜ã€‚å¯å˜çŠ¶æ€è¢«é™åˆ¶åœ¨è§’è‰²å†…éƒ¨ï¼Œå½“è§’è‰²æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯ä¹‹åï¼Œè¿™äº›çŠ¶æ€ä¼šè¢«æ½œåœ¨åœ°ä¿®æ”¹ã€‚è§’è‰²æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯è¢«ä¸²è¡Œä¾æ¬¡å¤„ç†çš„ã€‚è¿™ä¿è¯äº†è§’è‰²ä¸­çš„å¯å˜çŠ¶æ€ç»ä¸ä¼šè¢«å¹¶å‘è®¿é—®ã€‚

è§’è‰²çš„åˆ›å»ºå’Œæ¶ˆæ¯çš„å‘é€ä¸å…³å¿ƒè§’è‰²çš„ä½ç½®ã€‚åœ¨åˆ†å¸ƒå¼ç¼–ç¨‹ä¸­ï¼Œè¿™è¢«ç§°ä¸ºä½ç½®é€æ˜ï¼ˆlocation transparencyï¼‰ã€‚

### 8.1 ä½¿ç”¨è§’è‰²æ¨¡å‹

å°†è§’è‰²ç³»ç»Ÿç±»æ¯”ä¸ºä¸€ä¸ªå…¬å¸

1. è§’è‰²ç³»ç»Ÿ

   1. å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªè§’è‰²çš„åˆ†å±‚ç»“æ„ï¼Œä¸”è¿™äº›è§’è‰²ä¹‹é—´å…±äº«ä¸€äº›é…ç½®é€‰é¡¹ã€‚
   2. ä½œç”¨ï¼šè§’è‰²ç³»ç»Ÿè´Ÿè´£åˆ›å»ºæ–°çš„è§’è‰²ã€æŸ¥æ‰¾è§’è‰²ã€è®°å½•é‡è¦äº‹ä»¶ç­‰ã€‚è§’è‰²ç³»ç»Ÿç±»ä¼¼äºè½¯ä»¶å…¬å¸ã€‚
2. è§’è‰²ç±»
3. å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªæè¿°è§’è‰²å†…éƒ¨çŠ¶æ€å’ŒæŒ‡å¯¼è§’è‰²å¤„ç†æ¶ˆæ¯çš„æ¨¡æ¿ã€‚
4. ä½œç”¨ï¼šåŒä¸€ä¸ªè§’è‰²ç±»å¯ä»¥åˆ›å»ºå‡ºå¤šä¸ªè§’è‰²ï¼Œè§’è‰²ç±»ç±»ä¼¼äºå…¬å¸å†…çš„ç‰¹å®šèŒä½ï¼Œæ¯”å¦‚è½¯ä»¶å·¥ç¨‹å¸ˆã€è¥é”€ç»ç†æˆ–äººäº‹ç»ç†ã€‚
5. è§’è‰²å®ä¾‹
6. å®šä¹‰ï¼šè§’è‰²å®ä¾‹æ˜¯ä¸€ä¸ªå­˜åœ¨äºè¿è¡Œæ—¶å¹¶è´Ÿè´£æ¥æ”¶æ¶ˆæ¯çš„å®ä½“ã€‚è§’è‰²å®ä¾‹ä¸­å¯èƒ½åŒ…å«å¯å˜çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥å‘å…¶ä»–è§’è‰²å®ä¾‹å‘é€æ¶ˆæ¯ã€‚
7. ä½œç”¨ï¼šç±»æ¯”ä¸ºå…·ä½“çš„å‘˜å·¥ã€‚
8. æ¶ˆæ¯
9. å®šä¹‰ï¼šæ¶ˆæ¯æ˜¯è§’è‰²ä¹‹é—´é€šä¿¡çš„åŸºæœ¬å•å…ƒã€‚åœ¨ Akka ä¸­ï¼Œæ¶ˆæ¯å¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ã€‚æ¶ˆæ¯ç±»ä¼¼äºå…¬å¸å†…çš„ç”µå­é‚®ä»¶ã€‚
10. é‚®ç®±ï¼šé‚®ç®±æ˜¯ç”¨æ¥ç¼“å†²æ¶ˆæ¯çš„ä¸€éƒ¨åˆ†å†…å­˜ï¼Œåªä¸è¿‡å®ƒå±äºæ¯ä¸ªç‰¹å®šçš„è§’è‰²å®ä¾‹ã€‚è¿™ä¸ªç¼“å†²åŒºæ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå…¶ä»–è§’è‰²å®ä¾‹åªèƒ½ä¸€æ¬¡å¤„ç†ä¸€ä¸ªæ¶ˆæ¯ã€‚é‚®ç®±å¯¹åº”äºé›‡å‘˜çš„ç”µå­é‚®ä»¶å®¢æˆ·ç«¯ã€‚
11. è§’è‰²å¼•ç”¨
12. å®šä¹‰ï¼šè§’è‰²å¼•ç”¨æ˜¯ä¸€ç§æ”¯æŒè§’è‰²å‘ä¸€ä¸ªå…·ä½“è§’è‰²å‘é€æ¶ˆæ¯çš„å¯¹è±¡ã€‚
13. ä½œç”¨ï¼šæ­¤å¯¹è±¡å‘ç¨‹åºå‘˜éšè—äº†è§’è‰²çš„å…·ä½“ä½ç½®ä¿¡æ¯ã€‚è§’è‰²å¯èƒ½è¿è¡Œåœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨ä¸åŒçš„è®¡ç®—æœºä¸Š
14. ä»è½¯ä»¶å…¬å¸çš„è§’åº¦çœ‹ï¼Œè§’è‰²å¼•ç”¨å¯¹åº”äºé›‡å‘˜çš„ç”µå­é‚®ä»¶åœ°å€ã€‚é€šè¿‡ç”µå­é‚®ä»¶åœ°å€ï¼Œé›‡å‘˜ä¹‹é—´å°±å¯ä»¥å‘é€ç”µå­é‚®ä»¶äº†ã€‚
15. è°ƒåº¦å™¨
16. å®šä¹‰ï¼šæ˜¯ä¸€ä¸ªç”¨æ¥è°ƒåº¦è§’è‰²çš„ç»„ä»¶ï¼Œå®ƒå†³å®šäº†è§’è‰²ä½•æ—¶å¯ä»¥å¤„ç†æ¶ˆæ¯å¹¶ä¸ºä¹‹åˆ†é…è®¡ç®—èµ„æºã€‚
17. åœ¨Akka ä¸­ï¼Œè°ƒåº¦å™¨åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚è°ƒåº¦å™¨ç¡®ä¿äº†é‚£äº›é‚®ç®±éç©ºçš„è§’è‰²æ€»èƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è¿è¡Œèµ·æ¥ï¼Œå¹¶çº¿æ€§åœ°å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚

**ğŸ””**

æ‰§è¡Œä¸Šä¸‹æ–‡ï¼šæ‰§è¡Œä¸Šä¸‹æ–‡å¯ä»¥å†³å®šä»»åŠ¡æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸Šè¿è¡Œï¼Œä»¥åŠå¦‚ä½•ç®¡ç†è¿™äº›çº¿ç¨‹ã€‚

åœ¨ Scala ä¸­ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡é€šå¸¸ä½œä¸ºéšå¼å‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œè¿™æ ·å‡½æ•°å¯ä»¥åœ¨ä¸éœ€è¦æ˜¾å¼ä¼ å…¥æ‰§è¡Œä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚

1. ç±»æ¯”ï¼šè°ƒåº¦å™¨çš„ç±»æ¯”å¯¹è±¡ä¹‹ä¸€æ˜¯è½¯ä»¶å…¬å¸å†…çš„ç”µå­é‚®ä»¶å›å¤æ”¿ç­–ï¼Œä¹Ÿå°±æ˜¯è§„å®šä¸åŒèŒå‘˜çš„é‚®ä»¶ç›¸åº”æ—¶æœºã€‚

#### åˆ›å»ºè§’è‰²ç³»ç»Ÿå’Œè§’è‰²å®ä¾‹

Akkaä¸­çš„è§’è‰²å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹å’Œå¯¹è±¡å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹å¤§è‡´ç±»ä¼¼ã€‚é¦–å…ˆä¹Ÿè¦å®šä¹‰ä¸€ä¸ªè§’è‰²ç±»ï¼Œå®ƒå®šä¹‰äº†è§’è‰²çš„è¡Œä¸ºã€‚ç„¶åï¼Œè¿˜éœ€è¦æŒ‡å®šç‰¹å®šè§’è‰²å®ä¾‹çš„é…ç½®ã€‚æœ€åï¼Œè¿˜è¦å‘Šè¯‰è§’è‰²ç³»ç»Ÿç”¨æŒ‡å®šçš„é…ç½®å®ä¾‹åŒ–è§’è‰²ï¼Œè§’è‰²ç³»ç»Ÿæ‰ä¼šåˆ›å»ºä¸€ä¸ªè§’è‰²å®ä¾‹ï¼Œå¹¶è¿”å›æ­¤å®ä¾‹çš„è§’è‰²å¼•ç”¨ã€‚

1. è§’è‰²ç±»çš„å£°æ˜

* è§’è‰²ç±»ç”¨äºæŒ‡å®šè§’è‰²çš„è¡Œä¸ºã€‚

å®ƒæè¿°äº†è§’è‰²å¦‚ä½•å“åº”æ¶ˆæ¯å’Œä¸å…¶ä»–è§’è‰²é€šä¿¡ã€‚å£°æ˜ä¸€ä¸ªæ–°çš„è§’è‰²ç±»éœ€è¦æ‰©å±•akka.actoråŒ…ä¸­çš„Actorç‰¹è´¨ã€‚å¹¶å®ç°receiveæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å‡¡è¿”å›ä¸€ä¸ªåå‡½æ•°å¯¹è±¡ã€‚å½“è§’è‰²æ”¶é›†åˆ°Anyç±»å‹çš„ä¿¡æ¯çš„æ—¶å€™ï¼Œè¯¥éƒ¨åˆ†å‡½æ•°å¯¹è±¡å°±ä¼šè¢«è°ƒç”¨ã€‚å¦åˆ™è¯¥æ¶ˆæ¯ä¼šè¢«å¿½ç•¥ã€‚

* è§’è‰²ç±»è¿˜å°è£…äº†è¿™ä¸ªè§’è‰²ä¼šç”¨åˆ°çš„å¯¹è±¡çš„å¼•ç”¨ã€‚è¿™äº›å¯¹è±¡è¡¨ç¤ºäº†è§’è‰²çš„çŠ¶æ€ã€‚

**ğŸ“Œ**

å®šä¹‰: PartialFunction åå‡½æ•° å…è®¸ä½ å®šä¹‰ä¸€ä¸ªåªå¯¹æŸäº›è¾“å…¥æœ‰å®šä¹‰çš„å‡½æ•°ã€‚

åº”ç”¨: å¸¸ç”¨äºå¤„ç†é‚£äº›ä¸éœ€è¦ä¸ºæ‰€æœ‰å¯èƒ½çš„è¾“å…¥éƒ½æä¾›æœ‰æ„ä¹‰è¾“å‡ºçš„æƒ…å†µã€‚

å®ç°: é€šè¿‡ case è¯­å¥æˆ–è€… if æ¡ä»¶æ¥å®ç°æ¨¡å¼åŒ¹é…ã€‚

ä½¿ç”¨: å¯ä»¥ç›´æ¥åº”ç”¨äº foreach æˆ–è€… collect ç­‰é›†åˆæ“ä½œä¸Šã€‚

PartialFunction åœ¨å¤„ç†å¦‚é”™è¯¯å¤„ç†ã€æ•°æ®è½¬æ¢ç­‰åœºæ™¯æ—¶éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä¼˜é›…åœ°å¤„ç†æ— æ•ˆè¾“å…¥çš„æƒ…å†µä¸‹ã€‚

ä¾‹å­ï¼šä¸‹é¢çš„Actorç±»å¯ä»¥ç›¸åº”æ¶ˆæ¯helloã€‚

```
    import akka.actor._
    import akka.event.Logging
    class HelloActor(val hello: String) extends Actor {
      //è¯¥loggingå¯¹è±¡å¼•ç”¨äº†å½“å‰è§’è‰²ç³»ç»Ÿä»¥åŠå½“å‰è§’è‰²
      val log = Logging(context.system, this)
      //éƒ¨åˆ†å‡½æ•°
      def receive = {
        //å¯ä»¥ç›¸åº”æ¶ˆæ¯hello
        case `hello` =>
          log.info(s"Received a '$hello'... $hello!")
        case msgã€€ã€€ =>
          log.info(s"Unexpected message '$msg'")
          //åœæ­¢å½“å‰è§’è‰²
          context.stop(self)
      }
    }
```

1. è§’è‰²é…ç½®
   1. ä¸€ä¸ªè§’è‰²é…ç½®ä¸­çš„ä¿¡æ¯åŒ…æ‹¬è§’è‰²ç±»ã€å…¶æ„é€ å‡½æ•°å‚æ•°ã€é‚®ç®±ã€è°ƒåº¦å™¨çš„å®ä¾‹ã€‚
   2. åœ¨Akkaä¸­ï¼Œè§’è‰²é…ç½®ç”±Propsç±»è¡¨ç¤ºã€‚Propså¯¹è±¡å°è£…äº†åˆ›å»ºè§’è‰²å®ä¾‹ æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶ä¸”å¯ä»¥åœ¨åºåˆ—åŒ–ä¹‹åé€šè¿‡ç½‘ç»œå‘é€ã€‚
   3. ä½¿ç”¨æ–¹æ³•ï¼šä¸ºäº†åˆ›å»ºPropså¯¹è±¡ï¼Œæ¨èçš„åšæ³•æ˜¯åœ¨è§’è‰²ç±»çš„ä¼´ç”Ÿå¯¹è±¡ä¸­å£°æ˜ä¸€äº›å·¥å‚æ–¹æ³•

```
object HelloActor {
//props æ–¹æ³•ç”¨åˆ° Props.apply å·¥å‚æ–¹æ³•çš„ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œ
//å®ƒé€šè¿‡åˆ›å»ºHelloActorç±»æ¥æ¥æ”¶ä¸€ä¸ªä»£ç å—ã€‚
  def props(hello: String): Props = Props(new HelloActor(hello))
//propsAltæ–¹æ³•ç”¨åˆ°äº†Props.applyçš„å¦å¤–ä¸€ä¸ªé‡è½½æ–¹æ³•ï¼Œ
//å®ƒç”±è§’è‰²ç±»çš„Classå¯¹è±¡å’Œæ„é€ å‡½æ•°å‚æ•°é“¾è¡¨åˆ›å»ºå‡ºä¸€ä¸ªè§’è‰²å®ä¾‹ã€‚è¿™ä¸¤ä¸ªé‡è½½æ–¹æ³•åœ¨è¯­ä¹‰ä¸Šæ˜¯ç­‰ä»·çš„
  def propsAlt(hello: String): Props = Props(classOf[HelloActor], hello)
}
```

**ğŸ“Œ**

ç¬¬ä¸€ä¸ªProps.applyæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯ä»¥è°ƒç”¨è§’è‰²ç±»æ„é€ å‡½æ•°çš„é—­åŒ…ã€‚å¦‚æœç”¨æˆ·ä¸å¤Ÿä»”ç»†ï¼Œè¿™ä¸ªé—­åŒ…å¾ˆå®¹æ˜“æ•æ‰åˆ°å¤–å±‚çš„å¼•ç”¨ï¼Œè¿™æ—¶ï¼Œè¿™äº›å¼•ç”¨ä¼šå˜æˆPropså¯¹è±¡çš„ä¸€éƒ¨åˆ†ã€‚ä¼šå¯¼è‡´ç½‘ç»œä¼ è¾“çš„æ—¶å€™ä¸€åŒå‘é€ï¼Œå¯¼è‡´é¢å¤–çš„ç½‘ç»œå¼€é”€

1. è§’è‰²ç³»ç»Ÿä¸è§’è‰²åˆ›å»º

åœ¨å®ä¾‹åŒ–è§’è‰²æ—¶ï¼Œéœ€è¦å°†å…¶è§’è‰²é…ç½®å‘é€ç»™è§’è‰²ç³»ç»Ÿçš„ actorOf æ–¹æ³•ã€‚

```
//åŒ…å¯¹è±¡ï¼šlazy val ourSystem = ActorSystem("OurExampleSystem")  
object ActorCreate extends App{
  private val hiActor: ActorRef = ourSystem.actorOf(HelloActor.props("hi"), name = "greeter")
  //å‘hiActorå‘é€æ¶ˆæ¯"hi"
  hiActor ! "hi"
  Thread.sleep(1000)
  hiActor ! "hola"
  Thread.sleep(1000)
  //å…³é—­hiActor
  ourSystem.terminate()
}
```

#### æœªå¤„ç†æ¶ˆæ¯çš„ç®¡ç†

è§’è‰²å®ä¾‹ä¼šåœ¨é»˜è®¤æƒ…å†µä¸‹å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥åœ¨é»˜è®¤æƒ…å†µä¸‹ä¸äºˆå¤„ç†ï¼Œreceive æ–¹æ³•æœªå¤„ç†çš„æ¶ˆæ¯ä¼šè¢«å°è£…æˆUnhandledMessageå¯¹è±¡ï¼Œç„¶åè½¬å‘ç»™è§’è‰²ç³»ç»Ÿçš„äº‹ä»¶æµï¼Œè¿™å¸¸ç”¨äºæ—¥å¿—è®°å½•ã€‚

```
import akka.actor._
import akka.event.{Logging, LoggingAdapter}

// å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ¥æ¼”ç¤ºæœªå¤„ç†æ¶ˆæ¯çš„å¤„ç†
object ActorsUnhandled extends App{
  // åˆ›å»ºä¸€ä¸ªä¸ä¼šå¤„ç†ä»»ä½•æ¶ˆæ¯çš„æ¼”å‘˜
  private val deafActor: ActorRef = ourSystem.actorOf(Props[DeafActor], name = "deafy")
  
  // å‘æ¼”å‘˜å‘é€ä¸€ä¸ªå­—ç¬¦ä¸²æ¶ˆæ¯
  deafActor ! "hi"
  // ç­‰å¾…1ç§’
  Thread.sleep(1000)
  
  // å‘æ¼”å‘˜å‘é€ä¸€ä¸ªæ•´æ•°æ¶ˆæ¯
  deafActor ! 12010
  // å†æ¬¡ç­‰å¾…1ç§’
  Thread.sleep(1000)
  
  // ç»ˆæ­¢ç³»ç»Ÿ
  ourSystem.terminate()
}

// å®šä¹‰ä¸€ä¸ªæ¼”å‘˜ç±»ï¼Œè¯¥ç±»ä¸ä¼šå¤„ç†ä»»ä½•æ¶ˆæ¯
class DeafActor extends Actor{
  // åˆå§‹åŒ–æ—¥å¿—é€‚é…å™¨
  private val log: LoggingAdapter = Logging(context.system, this)
  
  // å®šä¹‰æ¥æ”¶æ¶ˆæ¯çš„è¡Œä¸ºï¼Œæ­¤å¤„ä¸å¤„ç†ä»»ä½•æ¶ˆæ¯
  override def receive: Receive = PartialFunction.empty
  
  // é‡å†™unhandledæ–¹æ³•æ¥å¤„ç†æœªå¤„ç†çš„æ¶ˆæ¯
  override def unhandled(message: Any) = {
    // æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†
    message match{
      case msg:String => log.info(s"unhandled msg : $msg")
      case other => super.unhandled(other)
    }
  }
}
```

#### è§’è‰²è¡Œä¸ºå’ŒçŠ¶æ€åˆ‡æ¢

Actorç±»çš„receiveæ–¹æ³•å¿…é¡»è¿”å›åå‡½æ•°ï¼Œä½†æ˜¯ä¸å®œæ ¹æ®è§’è‰²çš„çŠ¶æ€è¿”å›ä¸åŒçš„åå‡½æ•°ã€‚

å¦‚ä¸‹è¡Œä¸ºæ˜¯ä¸è¢«å…è®¸çš„

```
class CountdownActor extends Actor {
  var n = 10
  def receive = if (n > 0) { // ä¸è¦è¿™æ ·åš
    case "count" =>
      log(s"n = $n")
      n -= 1
  } else PartialFunction.empty
}
```

æ­£ç¡®æ–¹å¼:

å½“ä¸€ä¸ªçŠ¶æ€åŒ–çš„è§’è‰²éœ€è¦ä¿®æ”¹è¡Œä¸ºæ—¶ï¼Œä¸ºæ¯ä¸€ç§è¡Œä¸ºå£°æ˜ä¸€ä¸ªç‹¬ç«‹çš„åå‡½æ•°ï¼Œç„¶ååœ¨receiveæ–¹æ³•ä¸­è¿”å›åˆå§‹è¡Œä¸ºå¯¹åº”çš„åå‡½æ•°ã€‚

```
class CountdownActor extends Actor {
  val log = Logging(context.system, this)
  var n = 10
//æ³¨æ„ï¼Œè¿™é‡Œç”¨åˆ°ä¼´ç”Ÿå¯¹è±¡Actorä¸­çš„ç±»å‹åˆ«åReceiveï¼Œ
//å®ƒåªä¸è¿‡æ˜¯PartialFunction[Any,Unit]ç±»å‹çš„ç¼©å†™ã€‚

  def counting: Actor.Receive = {
    case "count" =>
      n -= 1
      log.info(s"n = $n")
      if (n == 0) context.become(done)
  }
  def done = PartialFunction.empty
  def receive = counting
}
```

å½“ä¸ºå¤æ‚è§’è‰²å»ºæ¨¡æ—¶ï¼Œå°†å®ƒä»¬è§†ä¸ºçŠ¶æ€æœºï¼ˆstatemachineï¼‰æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚
